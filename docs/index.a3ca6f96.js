function e(e,t,n,i){Object.defineProperty(e,t,{get:n,set:i,enumerable:!0,configurable:!0})}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function n(e){return e&&e.__esModule?e.default:e}var i={},r={},a=t.parcelRequire94c2;if(null==a&&((a=function(e){if(e in i)return i[e].exports;if(e in r){var t=r[e];delete r[e];var n={id:e,exports:{}};return i[e]=n,t.call(n.exports,n,n.exports),n.exports}var a=new Error("Cannot find module '"+e+"'");throw a.code="MODULE_NOT_FOUND",a}).register=function(e,t){r[e]=t},t.parcelRequire94c2=a),a.register("budCC",(function(t,n){var i,r;e(t.exports,"register",(function(){return i}),(function(e){return i=e})),e(t.exports,"resolve",(function(){return r}),(function(e){return r=e}));var a={};i=function(e){for(var t=Object.keys(e),n=0;n<t.length;n++)a[t[n]]=e[t[n]]},r=function(e){var t=a[e];if(null==t)throw new Error("Could not resolve bundle with id "+e);return t}})),a.register("ecdQ7",(function(t,n){var i;e(t.exports,"getBundleURL",(function(){return i}),(function(e){return i=e}));var r={};function a(e){return(""+e).replace(/^((?:https?|file|ftp):\/\/.+)\/[^/]+$/,"$1")+"/"}i=function(e){var t=r[e];return t||(t=function(){try{throw new Error}catch(t){var e=(""+t.stack).match(/(https?|file|ftp):\/\/[^)\n]+/g);if(e)return a(e[2])}return"/"}(),r[e]=t),t}})),a.register("ktYQh",(function(e,t){e.exports=a("8SADR")(a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("6duT1")).then((()=>a("aVJhe")))})),a.register("8SADR",(function(e,n){var i=a("d3Csj");e.exports=i((function(e){return new Promise((function(n,i){var r="i".concat((""+Math.random()).slice(2));t[r]=function(e){n(e),a()};var a=function(){delete t[r],o.onerror=null,o.remove()},o=document.createElement("script");o.async=!0,o.type="module",o.charset="utf-8",o.textContent="import * as m from '".concat(e,"'; ").concat(r,"(m);"),o.onerror=function(e){i(e),a()},document.head.appendChild(o)}))}))})),a.register("d3Csj",(function(e,t){var n={},i={},r={};function a(e){switch(e){case"preload":return i;case"prefetch":return r;default:return n}}e.exports=function(e,t){return function(n){var i=a(t);return i[n]?i[n]:i[n]=e.apply(null,arguments).catch((function(e){throw delete i[n],e}))}}})),a.register("fEi6m",(function(e,t){e.exports=a("8SADR")(a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("cjfpP")).then((()=>a("7JpA3")))})),a.register("3EP0j",(function(e,t){e.exports=a("8SADR")(a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("8nW2A")).then((()=>a("8atKK")))})),a.register("7w2st",(function(e,t){e.exports=a("8SADR")(a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("aCm7A")).then((()=>a("bsxZ4")))})),a.register("krCjW",(function(e,t){e.exports=a("8SADR")(a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("7BoCh")).then((()=>a("2xCE7")))})),a.register("hROkz",(function(e,t){e.exports=a("8SADR")(a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("29oWk")).then((()=>a("bSmHp")))})),a("budCC").register(JSON.parse('{"86cou":"index.a3ca6f96.js","hCe0g":"check.8d706b11.svg","9ojvT":"cancel.17aa34ea.svg","6duT1":"de.320f79cc.js","cjfpP":"ja.7960a214.js","8nW2A":"zh-CN.5d12068f.js","aCm7A":"zh-TW.038718ac.js","aTp8j":"brush-pressure.f4437531.svg","4nBFo":"copy.4adadd0c.svg","efo6g":"tool-picker.d0e69c3a.svg","56A6t":"angle.f0b557ac.svg","hrhBj":"add-layer.ce1078bb.svg","8JUnX":"duplicate-layer.3314e3c7.svg","hteGn":"merge-layers.19da79a6.svg","dXczd":"remove-layer.4e9b2b7d.svg","joibl":"rename-layer.13b70bac.svg","4AJ8d":"cursor-picker.db2f5b39.png","durb8":"cursor-zoom-ew.fbb85406.png","hzi30":"cursor-fill.8027a243.png","3qgfL":"cursor-text.dcaa5de5.png","blFqq":"cursor-rotate.5b164044.png","4YStb":"klecks-logo.77be0db3.png","fzcgF":"new-image.68a10269.svg","dIqQQ":"import.7a68c844.svg","2tMSi":"export.bc31616f.svg","3RMaM":"share.454898d1.svg","jAUep":"help.208e9032.svg","56U6t":"tool-paint.6cdb3344.svg","eIuuU":"tool-fill.3358320a.svg","6yNrb":"tool-text.1cbd0325.svg","8kiCe":"tool-shape.3de78c3f.svg","gHvP9":"caret-down.68d4cd16.svg","gmsxC":"tool-hand.e7fc81b9.svg","jR3G5":"tool-zoom-in.d413f042.svg","biC0V":"tool-zoom-out.299f4d1f.svg","aCQri":"tool-undo.540bf765.svg","i15sm":"inverted-border.3353c7f3.svg","iANcq":"edit-rotate.fd0e572a.svg","iqarf":"ui-collapse.2b5dfc6a.svg","luRWX":"align-left.4876a845.svg","k4Bji":"align-center.6f56d4bd.svg","hHMHE":"align-right.1521d61c.svg","cuTT0":"typo-italic.39f02a8d.svg","imQcV":"typo-bold.8156fef3.svg","bmX7i":"edit-brightness-contrast.8430cb26.svg","Jn76X":"edit-crop.16c534dd.svg","gHP76":"edit-curves.bbdb97b2.svg","f8hRy":"edit-flip.00fd2c6b.svg","8toNK":"edit-hue-saturation.c9c1c847.svg","eUjmu":"edit-invert.fa435c66.png","cPSrp":"edit-perspective.e23100db.svg","hh6aB":"edit-resize.56391e2b.svg","ka4gi":"edit-tilt-shift.dd20efff.png","du2Qb":"edit-to-alpha.f7a2065a.svg","6TXqp":"edit-transform.c8795430.svg","geGLu":"edit-triangle-blur.9df2dbef.png","jENHo":"edit-unsharp-mask.c58e988c.png","kQgh7":"brush-pen.49a7b91e.svg","5cRgh":"brush-blend.2b9837fa.svg","ehhLu":"brush-sketchy.9e5d0120.png","cNEvL":"brush-pixel.673f3e4c.svg","hc51E":"brush-eraser.a9e10dce.svg","jpbyC":"brush-smudge.45852bcd.svg","cmIJ6":"brush-chemy.a5a188f6.svg","cLtLX":"upload.fb8f9195.svg","htt1j":"loading.7ff8a2ac.gif","7BoCh":"dist.3e7cad96.js","hZeW2":"bitbof-logo.bc5e3ed5.svg","lEWpa":"ui-swap-lr.7f474f51.svg","29oWk":"licenses.6b678ca8.js","3lQWP":"checkmark.5cb0764b.svg","8uSvm":"constrain.62f04e45.svg","eVFTk":"tab-settings.01d01dfb.svg","lJ2Hv":"tab-layers.c8a104e7.svg","5hfiK":"tab-edit.1ad61255.svg","9qnYn":"tab-file.d5937518.svg"}')),function(){function e(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach((function(e){var n=e instanceof Node;t.appendChild(n?e:document.createTextNode(String(e)))})),this.appendChild(t)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach((function(t){t.hasOwnProperty("append")||Object.defineProperty(t,"append",{configurable:!0,enumerable:!0,writable:!0,value:e})}))}(),function(){function e(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach((function(e){var n=e instanceof Node;t.appendChild(n?e:document.createTextNode(String(e)))})),this.insertBefore(t,this.firstChild)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach((function(t){t.hasOwnProperty("prepend")||Object.defineProperty(t,"prepend",{configurable:!0,enumerable:!0,writable:!0,value:e})}))}(),String.prototype.padStart||(String.prototype.padStart=function(e,t){return e>>=0,t=String(t||" "),this.length>e?String(this):((e-=this.length)>t.length&&(t+=t.repeat(e/t.length)),t.slice(0,e)+String(this))}),"scrollTo"in Element.prototype||Object.defineProperty(Element.prototype,"scrollTo",{value:function(e,t){this.scrollLeft=e,this.scrollTop=t}}),"scrollBy"in Element.prototype||Object.defineProperty(Element.prototype,"scrollBy",{value:function(e,t){this.scrollLeft+=e,this.scrollTop+=t}}),!("localStorage"in window))try{window.localStorage={getItem:()=>null,setItem:()=>{},removeItem:()=>{}}}catch(e){}function o(e,t){const n=document.createElement("canvas");return e&&t&&(n.width=e,n.height=t),n}const s=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,l=function(){let e=null;return document.body?function(){const t=new Event("");e=t.timeStamp<36e5}():window.addEventListener("DOMContentLoaded",(function(t){e=t.timeStamp<36e5})),function(){if(null===e)throw"eventUsesHighResTimeStamp not initialized";return e}}(),h=(()=>{if(!("MouseEvent"in window))return!1;let e;try{e=new MouseEvent("mousemove")}catch(e){return!1}return"movementX"in e&&!s})(),c=!!window.PointerEvent,d=function(){const e=function(){const e=o();try{return e.getContext("experimental-webgl",{premultipliedAlpha:!1}),!0}catch(e){return!1}}();return function(){return e}}(),u=function(){const e={chrome:!1,gl:!1};return window.chrome&&window.chrome.app&&(e.chrome=!0),e.gl=d(),function(){return JSON.parse(JSON.stringify(e))}}(),p=function(){let e=null;function t(){const t=document.createElement("div");t.style.position="absolute",t.style.top="0",t.style.left="max(0px, 25px)",document.body.appendChild(t),setTimeout((function(){e=25===t.offsetLeft,document.body.removeChild(t)}),25)}return document.body?t():window.addEventListener("DOMContentLoaded",(function(){t()})),function(){if(null===e)throw new Error("isCssMinMaxSupported not initialized");return e}}(),g=function(e,t,n,i){c||(t=t.replace("pointer","mouse")),e.addEventListener(t,n,i)},m=function(e,t,n,i){c||(t=t.replace("pointer","mouse")),e.removeEventListener(t,n,i)};function f(e,t){const n=Object.keys(t);let i;const r=e.style;for(let e=0;e<n.length;e++)i=n[e],r[i]=t[i],r.alignContent="true","userSelect"===i&&(r.webkitUserSelect=t[i])}function y(e,t){return t?y(t,e%t):e}function x(e,t){const n=y(e,t);return[e/n,t/n]}const b=(()=>{const e={space:[" ","Spacebar"],alt:["Alt","AltGraph"],shift:"Shift",ctrl:"Control",cmd:["Meta","MetaLeft","MetaRight"],enter:"Enter",esc:"Escape",backspace:"Backspace",delete:"Delete",sqbr_open:"[",sqbr_close:"]",a:["a","A"],b:["b","B"],c:["c","C"],e:["e","E"],f:["f","F"],g:["g","G"],r:["r","R"],s:["s","S"],t:["t","T"],u:["u","U"],x:["x","X"],y:["y","Y"],z:["z","Z"],plus:"+",minus:"-",left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",home:"Home",end:"End"},t=Object.keys(e),n={},i={};let r=[],a={};const o=[];for(let r=0;r<t.length;r++){n[t[r]]=!1;const a=e[t[r]];if("string"==typeof a)i[e[t[r]]]=t[r];else for(let e=0;e<a.length;e++)i[a[e]]=t[r]}function s(e,t,n,i){o.forEach((r=>{r[0]&&r[0](e,t,n,i)}))}function l(e,t,n){o.forEach((i=>{i[1]&&i[1](e,t,n)}))}function h(e){const t=e.key,o="code"in e?e.code:e.keyCode;if(t in i){const l=i[t];if(n[l])return void s(l,e,r.join("+"),!0);n[l]=!0,a[o]=l,r.push(l),s(l,e,r.join("+"))}}function c(e){e.key;const t="code"in e?e.code:e.keyCode,i=r.join("+");if(["Meta","MetaLeft","MetaRight","OSLeft","OSRight"].includes(t))d(null);else if(t in a&&null!==a[t]){const o=a[t];n[o]=!1,a[t]=null;for(let e=0;e<r.length;e++)r[e]==o&&(r.splice(e,1),e--);l(o,e,i)}}function d(e){const i=r.join("+");r=[],a={};const s=[];for(let e=0;e<t.length;e++)n[t[e]]&&(n[t[e]]=!1,s.push(t[e]));for(let e=0;e<s.length;e++)l(s[e],{preventDefault:function(){},stopPropagation:function(){}},i);o.forEach((e=>{e[2]&&e[2]()}))}return{add:e=>{if(o.includes(e))return;const t=0===o.length;o.push(e),t&&(g(document,"keydown",h),g(document,"keyup",c),g(window,"blur",d))},remove:e=>{if(!o.includes(e))return;const t=1===o.length;for(let t=0;t<o.length;t++)if(o[t]===e){o.splice(t,1);break}t&&(m(document,"keydown",h),m(document,"keyup",c),m(window,"blur",d))},getIsDown:()=>n,getCombo:()=>r}})();function v(e,t,n){return e*(1-n)+t*n}function w(e,t,n,i){return Math.sqrt(Math.pow(e-n,2)+Math.pow(t-i,2))}function C(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function S(e,t){return 180*C(e,t)/Math.PI}function E(e,t,n){return e<=t?t:e>=n?n:e}function M(e,t,n){const i=n*(Math.PI/180),r=Math.cos(i),a=Math.sin(i);return{x:e*r-t*a,y:e*a+t*r}}const k=function(e){const t=[100];let n,i=0,r=null,a=null,o=null;function s(t){e({deltaY:Math.round(t/r),pageX:o.pageX,pageY:o.pageY,clientX:o.clientX,clientY:o.clientY})}function l(){null!==a&&(s(a),a=null),null===r||t.includes(r)||t.push(r),i=0,r=null}this.process=function(e){o={pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY},clearTimeout(n),n=setTimeout(l,200);let h=e.deltaY;"deltaMode"in e&&1===e.deltaMode&&(h*=100/3);const c=Math.abs(h);if(i>0&&null===r)a=null;else{if(0===i){if(i++,c<50)return;return r=c,void(t.includes(r)?s(h):a=h)}if(0!==c){if(c===r||c/r%1<1e-4);else if(r/c%1<1e-4)r=c;else if(c!==r)return r=null,void(a=null);null!==a&&(s(a),a=null),s(h)}}}},I=function(){const e=[];let t=0,n=null,i=!1,r=1;return function(a){const o=a.target,h=a.onPointer,d=a.onWheel,u=a.onEnterLeave,p="maxPointers"in a?a.maxPointers:1,f={1:"left",2:"right",4:"middle"},y=new k((function(e){if(!x&&d){const t=o.getBoundingClientRect();e.relX=e.clientX-t.left+o.scrollLeft,e.relY=e.clientY-t.top+o.scrollTop,d(e)}}));let x=!1;const b=l()?0:-performance.timing.navigationStart;let w="",C=!1;const S=[],E=[];function M(e){for(let t=0;t<S.length;t++)if(e===S[t].pointerId)return S[t];return null}function I(e){let t=null;for(let n=0;n<E.length;n++)E[n]===e&&(t=S[n],S.splice(n,1),E.splice(n,1),n--);return t}function T(e,a){return 0===e||1===e?e:(t<60?(n=0===t?e:v(e,n,.95),t++):i||(i=!0,n<.13&&(r=2.3)),Math.pow(e,1/r))}function L(t){if(t.corrected)return t.corrected;const n={pointerId:t.pointerId,pointerType:t.pointerType,pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,movementX:t.movementX,movementY:t.movementY,timeStamp:t.timeStamp+b,pressure:T(t.pressure,t.type),buttons:t.buttons,button:t.button,coalescedArr:[],eventPreventDefault:function(){t.preventDefault()},eventStopPropagation:function(){t.stopPropagation()}};t.corrected=n;let i=null;"pointerId"in t?"pressure"in t&&0!==t.buttons&&(["mouse"].includes(t.pointerType)||"touch"===t.pointerType&&0===t.pressure)&&(n.pressure=1,i=1):(n.pointerId=0,n.pointerType="mouse",n.pressure=0!==t.buttons?1:0,i=n.pressure),s&&"mouse"!=t.pointerType&&"pointermove"===t.type&&0===t.buttons&&(n.buttons=1);let r=[];"getCoalescedEvents"in t&&(r=t.getCoalescedEvents());let a=function(t){for(let n=e.length-1;n>=0;n--)if(t.pointerId===e[n].pointerId)return e[n];return null}(n);null===a&&(a=function(t){const n={pointerId:t.pointerId,lastPageX:null,lastPageY:null};return e.push(n),e.length>15&&e.shift(),n}(n));const o=a.lastPageX,l=a.lastPageY;for(let e=0;e<r.length;e++){const t=r[e];n.coalescedArr.push({pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,movementX:null===a.lastPageX?0:t.pageX-a.lastPageX,movementY:null===a.lastPageY?0:t.pageY-a.lastPageY,timeStamp:0===t.timeStamp?n.timeStamp:t.timeStamp+b,pressure:null===i?T(t.pressure):i}),a.lastPageX=t.pageX,a.lastPageY=t.pageY}return a.lastPageX=n.pageX,a.lastPageY=n.pageY,n.movementX=null===o?0:a.lastPageX-o,n.movementY=null===l?0:a.lastPageY-l,n}function R(e,t,n){const i=o.getBoundingClientRect(),r={type:e,pointerId:t.pointerId,pointerType:t.pointerType,pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,relX:t.clientX-i.left+o.scrollLeft,relY:t.clientY-i.top+o.scrollTop,dX:t.movementX,dY:t.movementY,time:t.timeStamp,eventPreventDefault:t.eventPreventDefault,eventStopPropagation:t.eventStopPropagation};if("pointermove"===e&&(r.coalescedArr=[],t.coalescedArr.length>1)){let e;for(let n=0;n<t.coalescedArr.length;n++)e=t.coalescedArr[n],r.coalescedArr.push({pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,relX:e.clientX-i.left+o.scrollLeft,relY:e.clientY-i.top+o.scrollTop,dX:e.movementX,dY:e.movementY,time:e.timeStamp})}if(n){const e=Object.keys(n);for(let t=0;t<e.length;t++)r[e[t]]=n[e[t]]}return r}function A(e,t,n,i){const r=o.getBoundingClientRect(),a={type:e,pointerId:t.identifier,pointerType:"touch",pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,relX:t.pageX-r.left+o.scrollLeft,relY:t.pageY-r.top+o.scrollTop,time:n.timeStamp+b,eventPreventDefault:function(){n.preventDefault()},eventStopPropagation:function(){n.stopPropagation()}};"pointermove"===e&&(a.coalescedArr=[]);const s=Object.keys(i);for(let e=0;e<s.length;e++)a[s[e]]=i[s[e]];return a}function P(){m(document,"pointermove",N),m(document,"pointerup",U),m(document,"pointerleave",X)}let D,O,B,z=0;function H(){z++,u&&u(!0)}function F(){z--,u&&u(!1)}function j(e){e=L(e);const t=w;if(w=e.pointerType,E.includes(e.pointerId)||E.length===p||"touch"===e.pointerType)return void(C=!1);if(!C&&"mouse"===e.pointerType&&"pen"===t)return void(C=!0);C=!1;const n=R("pointermove",e);h(n)}function _(e){if(e=L(e),E.includes(e.pointerId)||E.length===p||![1,2,4].includes(e.buttons))return;0===S.length&&(g(document,"pointermove",N),g(document,"pointerup",U),g(document,"pointerleave",X));const t={pointerId:e.pointerId,pointerType:e.pointerType,downPageX:e.pageX,downPageY:e.pageY,buttons:e.buttons,lastPageX:e.pageX,lastPageY:e.pageY,lastTimeStamp:e.timeStamp};S.push(t),Y(t),E.push(e.pointerId);const n=R("pointerdown",e,{downPageX:e.pageX,downPageY:e.pageY,button:f[e.buttons],pressure:e.pressure});h(n)}function N(e){if(e=L(e),!E.includes(e.pointerId))return;const t=M(e.pointerId);if(V(t),e.buttons!==t.buttons){1===S.length&&P(),I(e.pointerId);const n=R("pointerup",e,{downPageX:t.downPageX,downPageY:t.downPageY});return void h(n)}if(Y(t),"pen"===e.pointerType&&e.pageX===t.lastPageX&&e.pageY===t.lastPageY&&e.timeStamp===t.lastTimeStamp)return;const n=R("pointermove",e,{downPageX:t.downPageX,downPageY:t.downPageY,button:f[e.buttons],pressure:e.pressure});t.lastPageX=e.pageX,t.lastPageY=e.pageY,t.lastTimeStamp=e.timeStamp,h(n)}function U(e){if(e=L(e),!E.includes(e.pointerId))return;1===S.length&&P();const t=I(e.pointerId);V(t);const n=R("pointerup",e,{downPageX:t.downPageX,downPageY:t.downPageY});h(n)}function X(e){if(e=L(e),!E.includes(e.pointerId))return;1===S.length&&P();const t=I(e.pointerId);V(t);const n=R("pointerup",e,{downPageX:t.downPageX,downPageY:t.downPageY});h(n)}function Y(e){"touch"===e.pointerType&&(e.touchTimeout=setTimeout((function(){!function(e){U({pointerId:e.pointerId,pointerType:e.pointerType,type:"pointerup",timeStamp:performance.now(),pageX:0,pageY:0,clientX:0,clientY:0,preventDefault:function(){},stopPropagation:function(){}})}(e)}),2500))}function V(e){e.touchTimeout&&(clearTimeout(e.touchTimeout),e.touchTimeout=null)}u&&(g(o,"pointerenter",H),g(o,"pointerleave",F)),h&&(g(o,"pointermove",j),g(o,"pointerdown",_)),d&&g(o,"wheel",y.process),c?a.fixScribble&&(O=function(e){e.preventDefault()},g(o,"touchmove",O)):(D=function(e){e.preventDefault();const t=e.changedTouches;for(let n=0;n<t.length&&S.length<p;n++){const i=t[n];0===S.length&&(g(document,"touchmove",O),g(document,"touchend",B),g(document,"touchcancel",B)),S.push({pointerId:i.identifier,downPageX:i.pageX,downPageY:i.pageY,buttons:1,lastPageX:i.pageX,lastPageY:i.pageY}),E.push(i.identifier);const r=A("pointerdown",i,e,{dX:0,dY:0,downPageX:i.downPageX,downPageY:i.downPageY,button:"left",pressure:1});h(r)}},O=function(e){e.preventDefault();const t=e.changedTouches;for(let n=0;n<t.length;n++){const i=t[n];if(!E.includes(i.identifier))continue;const r=M(i.identifier),a=A("pointermove",i,e,{dX:i.pageX-r.lastPageX,dY:i.pageY-r.lastPageY,downPageX:r.downPageX,downPageY:r.downPageY,button:"left",isCoalesced:!1,pressure:1});r.lastPageX=i.pageX,r.lastPageY=i.pageY,h(a)}},B=function(e){"touchcancel"!==e.type&&e.preventDefault();const t=e.changedTouches;for(let n=0;n<t.length;n++){const i=t[n];if(!E.includes(i.identifier))continue;1===S.length&&(m(document,"touchmove",O),m(document,"touchend",B),m(document,"touchcancel",B));const r=I(i.identifier),a=A("pointerup",i,e,{dX:i.pageX-r.lastPageX,dY:i.pageY-r.lastPageY,downPageX:r.downPageX,downPageY:r.downPageY});h(a)}},h&&g(o,"touchstart",D)),this.isOver=function(){return z>0},this.destroy=function(){x||(x=!0,m(o,"pointerenter",H),m(o,"pointerleave",F),m(o,"pointermove",j),m(o,"pointerdown",_),m(o,"wheel",y.process),S.length>0&&P(),c?m(o,"touchmove",O):(m(o,"touchstart",D),S.length>0&&(m(document,"touchmove",O),m(document,"touchend",B),m(document,"touchcancel",B))))}}}();var T={};e(T,"EventChain",(function(){return L})),e(T,"DoubleTapper",(function(){return R})),e(T,"NFingerTapper",(function(){return A})),e(T,"PinchZoomer",(function(){return P})),e(T,"CoalescedExploder",(function(){return D})),e(T,"OnePointerLimiter",(function(){return O})),e(T,"LinetoolProcessor",(function(){return B})),e(T,"LineSanitizer",(function(){return z})),e(T,"LineSmoothing",(function(){return H}));const L=function(e){const t=e.chainArr;let n=()=>{};function i(e,i){for(;e<t.length;e++)if(null===(i=t[e].chainIn(i)))return null;return n(i),null}for(let e=0;e<t.length;e++)!function(e){t[e].setChainOut((function(t){i(e+1,t)}))}(e);this.chainIn=function(e){return i(0,e)},this.setChainOut=function(e){n=e}},R=function(e){let t=function(){};let n=["touch","mouse","pen"],i=["left"],r=[];const a=[];let o=0,s=0,l=[];function h(){if(0!==r.length){clearTimeout(d.fail),clearTimeout(d.maxUntilSecondDown),clearTimeout(d.success),d.fail=null,d.maxUntilSecondDown=null,d.success=null;for(let e=0;e<l.length;e++)t(l[e]);l=[],r=[]}}function c(){d.fail=null,d.success=null,l=[];const t=r[r.length-1];r=[],e.onDoubleTap({pageX:t.pageX,pageY:t.pageY})}const d={fail:null,maxUntilSecondDown:null,success:null};function u(e,t,n){const i=n-s;return!(i<=0)&&(d[e]=setTimeout(t,i),!0)}this.chainIn=function(e){return function(e){if("pointerdown"===e.type)a.push(e.pointerId);else if("pointerup"===e.type)for(let t=0;t<a.length;t++)if(a[t]===e.pointerId){a.splice(t,1);break}if(!n.includes(e.pointerType))return void h();s=performance.now();const t=r.length>0?r[r.length-1]:null;if("pointerup"===e.type&&(o=e.time),"pointerdown"===e.type){if(a.length>1)return void h();if(null!==d.success)return void h();if(0===r.length&&s-o<400)return void h();if(!i.includes(e.button))return void h();if(t&&t.isDown||r.length>2)return void h();if(t&&w(t.position[0],t.position[1],e.pageX,e.pageY)>19&&(h(),s-t.time<400))return;if(r.push({isDown:!0,time:s,position:[e.pageX,e.pageY],pointerId:e.pointerId}),r.length>1)clearTimeout(d.maxUntilSecondDown);else if(!u("maxUntilSecondDown",h,e.time+300))return void h();if(clearTimeout(d.fail),!u("fail",h,e.time+300))return void h()}if(t&&"pointermove"===e.type&&t.pointerId===e.pointerId&&w(t.position[0],t.position[1],e.pageX,e.pageY)>10)return void h();if(t&&"pointerup"===e.type){if(t.pointerId!==e.pointerId)return void h();if(s>=t.time+300)return void h();if(clearTimeout(d.fail),r.length<3)return u("fail",h,e.time+500)?void(r=[t,{isUp:!0,time:s,position:[e.pageX,e.pageY]}]):void h();s<r[1].time+500?(r.push({pageX:e.pageX,pageY:e.pageY}),u("success",c,e.time+250)||h()):h()}}(e),0===r.length?(h(),e):(l.push(e),null)},this.setChainOut=function(e){t=e},this.setAllowedPointerTypeArr=function(e){n=e},this.setAllowedButtonArr=function(e){i=e}},A=function(e){const t=e.fingers;let n=function(){};let i,r=[],a=[],o=0;const s=[];function l(){if(0!==a.length){clearTimeout(c.firstLastDownTimeout),clearTimeout(c.tapTimeout);for(let e=0;e<a.length;e++)n(a[e]);a=[],r=[]}}let h;const c={firstLastDownTimeout:null,tapTimeout:null};function d(e,t){const n=t-h;return!(n<=0)&&(c[e]=setTimeout(l,n),!0)}function u(n){const u=o;if(o=n.time,"pointerdown"===n.type)s.push(n.pointerId);else if("pointerup"===n.type)for(let e=0;e<s.length;e++)if(s[e]===n.pointerId){s.splice(e,1);break}if("touch"===n.pointerType){if(h=performance.now(),"pointerdown"===n.type)return r.length+1!==s.length||r.length===t||r.length>0&&n.time-250>r[0].downTime||0===r.length&&n.time-50<u?void l():0!==r.length||(i=n.time,d("firstLastDownTimeout",n.time+250)&&d("tapTimeout",n.time+500))?void r.push({pointerId:n.pointerId,downTime:n.time,downPageX:n.pageX,downPageY:n.pageY}):void l();if("pointermove"===n.type){if(0===r.length)return;let e=null;for(let t=0;t<r.length;t++)if(r[t].pointerId===n.pointerId){e=r[t];break}if(null===e)return void l();if(n.time-500>i)return void l();if(w(n.pageX,n.pageY,e.downPageX,e.downPageY)>12)return void l()}if("pointerup"===n.type){if(0===r.length)return;if(r.length!==t)return void l();let o=null,s=0;for(;s<r.length;s++)if(r[s].pointerId===n.pointerId){o=r[s];break}if(null===o)return;if(n.time-500>i)return void l();if(w(n.pageX,n.pageY,o.downPageX,o.downPageY)>12)return void l();o.isUp=!0;let h=!0;for(let e=0;e<r.length;e++)if(!r[e].isUp){h=!1;break}if(h)return clearTimeout(c.firstLastDownTimeout),clearTimeout(c.tapTimeout),a=[],r=[],e.onTap(),!0}}else r.length>0&&l()}this.chainIn=function(e){return!0===u(e)?null:0===r.length?e:(a.push(e),null)},this.setChainOut=function(e){n=e}},P=function(e){let t=function(){};const n=[];let i,r=null,a=[];function o(){r=null,a=[]}function s(e){if(r){if(clearTimeout(l.secondFingerTimeout),!e)for(let e=0;e<a.length;e++)t(a[e]);o()}}const l={secondFingerTimeout:null};function h(e){if("pointerdown"===e.type)n.push(e.pointerId);else if("pointerup"===e.type)for(let t=0;t<n.length;t++)if(n[t]===e.pointerId){n.splice(t,1);break}if(r||!("touch"!==e.pointerType||"pointermove"===e.type&&n.length>0||n.length>1||"pointerup"===e.type)){if(i=performance.now(),"pointerdown"===e.type)return r?"touch"===e.pointerType?(r.touchPointerArr.push({pointerId:e.pointerId,relX:e.relX,relY:e.relY}),void(r.isInProgress?u(r,{type:"down",index:r.touchPointerArr.length-1}):(clearTimeout(l.secondFingerTimeout),r.isInProgress=!0,d(r)))):void(r.isInProgress?r.otherPointerIdArr.push(e.pointerId):s()):(r={touchPointerArr:[{pointerId:e.pointerId,relX:e.relX,relY:e.relY,downRelX:e.relX,downRelY:e.relY}],otherPointerIdArr:[],isInProgress:!1},function(e,t,n){const r=n-i;return!(r<=0||(l[e]=setTimeout(t,r),0))}("secondFingerTimeout",(function(){s()}),e.time+250)?void 0:void s());if("pointermove"!==e.type||"touch"!==e.pointerType){if("pointerup"===e.type){if("touch"===e.pointerType){let t=0;for(;t<r.touchPointerArr.length;t++)if(r.touchPointerArr[t].pointerId===e.pointerId){r.touchPointerArr.splice(t,1);break}r.touchPointerArr.length>0&&u(r,{type:"up",index:t})}else for(let t=0;t<r.otherPointerIdArr.length;t++)if(r.otherPointerIdArr[t]===e.pointerId){r.otherPointerIdArr.splice(t,1);break}if(0===r.touchPointerArr.length&&0===r.otherPointerIdArr.length)return void(r.isInProgress?(o(),p()):s())}}else{let t=null,n=0;for(;n<r.touchPointerArr.length;n++)if(e.pointerId===r.touchPointerArr[n].pointerId){t=r.touchPointerArr[n];break}if(t.relX=e.relX,t.relY=e.relY,r.isInProgress)n<2&&u(r,{type:"move",index:n});else{if(w(t.downRelX,t.downRelY,t.relX,t.relY)>10)return void s()}}}}let c=[];function d(t){for(let e=0;e<t.touchPointerArr.length;e++){const n=t.touchPointerArr[e];c.push({pointerId:n.pointerId,relX:n.relX,relY:n.relY,downRelX:n.relX,downRelY:n.relY})}const n={type:"move",angleRad:0,scale:1};1===c.length?(n.relX=c[0].downRelX,n.relY=c[0].downRelY):(n.relX=.5*(c[0].downRelX+c[1].downRelX),n.relY=.5*(c[0].downRelY+c[1].downRelY)),n.downRelX=n.relX,n.downRelY=n.relY,e.onPinch(n)}function u(t,n){if(!(n.index>1))if("move"===n.type){let i;if(c[n.index].relX=t.touchPointerArr[n.index].relX,c[n.index].relY=t.touchPointerArr[n.index].relY,1===c.length)i={type:"move",downRelX:c[0].downRelX,downRelY:c[0].downRelY,relX:c[0].relX,relY:c[0].relY,angleRad:0,scale:1};else{const e=w(c[0].downRelX,c[0].downRelY,c[1].downRelX,c[1].downRelY),t=w(c[0].relX,c[0].relY,c[1].relX,c[1].relY),n=C({x:c[0].downRelX,y:c[0].downRelY},{x:c[1].downRelX,y:c[1].downRelY}),r=C({x:c[0].relX,y:c[0].relY},{x:c[1].relX,y:c[1].relY});i={type:"move",downRelX:.5*(c[0].downRelX+c[1].downRelX),downRelY:.5*(c[0].downRelY+c[1].downRelY),relX:.5*(c[0].relX+c[1].relX),relY:.5*(c[0].relY+c[1].relY),angleRad:r-n,scale:t/e}}e.onPinch(i)}else"down"!==n.type&&"up"!==n.type||(p(),d(t))}function p(){c=[],e.onPinch({type:"end"})}this.chainIn=function(e){return h(e),r?(r.isInProgress||a.push(e),null):e},this.setChainOut=function(e){t=e}},D=function(){let e=function(){};this.chainIn=function(t){if("pointermove"!==t.type)return t;if(!(t.coalescedArr.length>0))return t;{let n,i=JSON.parse(JSON.stringify(t));i.coalescedArr=[];for(let r=0;r<t.coalescedArr.length;r++)r>0&&(i=JSON.parse(JSON.stringify(t))),n=t.coalescedArr[r],i.pageX=n.pageX,i.pageY=n.pageY,i.relX=n.relX,i.relY=n.relY,i.dX=n.dX,i.dY=n.dY,i.time=n.time,r<t.coalescedArr.length-1&&(i.isCoalesced=!0),e(i)}return null},this.setChainOut=function(t){e=t}},O=function(e){let t=function(){},n=null;const i=[];this.chainIn=function(e){if(i.includes(e.pointerId)){if("pointerup"===e.type)for(let t=0;t<i.length;t++)if(i[t]===e.pointerId){i.splice(t,1);break}return null}return null===n?("pointerdown"===e.type&&(n=e.pointerId),e):e.pointerId!==n?("pointerdown"===e.type&&i.push(e.pointerId),null):("pointerup"===e.type&&(n=null),e)},this.setChainOut=function(e){e}},B=function(e){let t=null,n=[],i=null;this.process=function(r){if("down"===r.type&&(t=r,i=null,r.shiftIsPressed))return e.onDraw({type:"line",x0:null,y0:null,pressure0:null,x1:r.x,y1:r.y,pressure1:r.pressure}),void n.push(r);if("move"===r.type)if(r.shiftIsPressed){if(null===i){const a=Math.abs(r.x-t.x),o=Math.abs(r.y-t.y);if(a>5||o>5){i=a>o?0:1;for(let r=0;r<n.length;r++){const a=n[r];0===i?a.y=t.y:a.x=t.x,e.onDraw(JSON.parse(JSON.stringify(a)))}n=[]}}if(null===i)return void n.push(r);0===i?r.y=t.y:r.x=t.x}else if(n.length>0){for(let t=0;t<n.length;t++)e.onDraw(JSON.parse(JSON.stringify(n[t])));n=[]}"up"===r.type&&(n=[]),e.onDraw(JSON.parse(JSON.stringify(r)))}},z=function(){let e=function(){},t=!1;this.chainIn=function(n){return"down"===n.type&&(t?e({type:"up",scale:n.scale,shiftIsPressed:n.shiftIsPressed,isCoalesced:!1}):t=!0),t||"move"!==n.type&&"up"!==n.type?("up"===n.type&&t&&(t=!1),n):null},this.setChainOut=function(t){e=t},this.getIsDrawing=function(){return t}},H=function(e){let t,n,i,r=function(){},a=E(e.smoothing,0,1);this.chainIn=function(e){if(e=JSON.parse(JSON.stringify(e)),clearTimeout(i),clearInterval(n),"down"===e.type&&(t={x:e.x,y:e.y,pressure:e.pressure}),"move"===e.type){const o=e.x,s=e.y,l=e.pressure;e.x=v(e.x,t.x,a),e.y=v(e.y,t.y,a),e.pressure=v(e.pressure,t.pressure,a),t={x:e.x,y:e.y,pressure:e.pressure},a>0&&(i=setTimeout((function(){n=setInterval((function(){(e=JSON.parse(JSON.stringify(e))).x=v(o,t.x,a),e.y=v(s,t.y,a),e.pressure=v(l,t.pressure,a),t={x:e.x,y:e.y,pressure:e.pressure},r(e)}),35)}),80))}return e},this.setChainOut=function(e){r=e},this.setSmoothing=function(e){a=E(e,0,1)}};const F=function(e){const t=o();let n;if(e<1){if(t.width=1,t.height=1,n=t.getContext("2d"),!n)throw new Error("2d context not supported or canvas already initialized");n.fillStyle="rgb(128, 128, 128)",n.fillRect(0,0,1,1)}else if(e>200)t.width=401,t.height=401;else{if(t.width=2*e,t.height=2*e,n=t.getContext("2d"),!n)throw new Error("2d context not supported or canvas already initialized");n.fillStyle="rgb(255, 255, 255)",n.fillRect(0,0,2*e,2*e),n.fillStyle="rgb(200, 200, 200)",n.fillRect(0,0,e,e),n.fillRect(e,e,2*e,2*e)}return t},j=function(){const e={8:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVQ4T2M8ceLEfwY8wNzcHJ80A+OoAcMiDP7//483HZw8eRJ/Ohg1gIFx6IcBAIhJUqnarXQ1AAAAAElFTkSuQmCC",4:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAJ0lEQVQoU2M8ceLEfwYkYG5ujsxlYKSDgv///6O44eTJk6huoL0CAGsOKVVu8UYvAAAAAElFTkSuQmCC"};return function(t,n){function i(t){if(t=parseInt(""+t),e[""+t])return e[""+t];const n=F(t).toDataURL("image/png");return e[""+t]=n,n}if(!n)return i(t);setTimeout((function(){n(i(t))}),1)}}();const _=function(){function e(e,t){return[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15]]}return{getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiplyMatrixAndPoint:e,multiplyMatrices:function(t,n){const i=[n[0],n[1],n[2],n[3]],r=[n[4],n[5],n[6],n[7]],a=[n[8],n[9],n[10],n[11]],o=[n[12],n[13],n[14],n[15]],s=e(t,i),l=e(t,r),h=e(t,a),c=e(t,o);return[s[0],s[1],s[2],s[3],l[0],l[1],l[2],l[3],h[0],h[1],h[2],h[3],c[0],c[1],c[2],c[3]]},createTranslationMatrix:function(e,t){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,0,1]},createRotationMatrix:function(e){return[Math.cos(-e),-Math.sin(-e),0,0,Math.sin(-e),Math.cos(-e),0,0,0,0,1,0,0,0,0,1]},createScaleMatrix:function(e){return[e,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1]}}}(),N={add:function(e,t){return{x:e.x+t.x,y:e.y+t.y}},sub:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},nor:function(e){const t=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));return{x:e.x/t,y:e.y/t}},len:function(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))},dist:function(e,t){return N.len(N.sub(e,t))},mul:function(e,t){return{x:e.x*t,y:e.y*t}},angle:function(e,t){return Math.atan2(t.y-e.y,t.x-e.x)},dot:function(e,t){const n=[e.x,e.y],i=[t.x,t.y];return n.map(((e,t)=>n[t]*i[t])).reduce(((e,t)=>e+t))}},U=function(e){const t=[],n=this;for(let n=0;n<e.points.length;n++)!function(n){let i;n<e.points.length-1&&(i=w(e.points[n].x,e.points[n].y,e.points[n+1].x,e.points[n+1].y)),t[n]={x:e.points[n].x,y:e.points[n].y,length:i}}(n);this.getAtDist=function(e){let i=Math.min(n.getLength(),e),r=0;for(;i>t[r].length&&r<t.length-2;r++)i-=t[r].length;const a=Math.min(1,Math.max(0,i/t[r].length));return{x:t[r].x*(1-a)+t[r+1].x*a,y:t[r].y*(1-a)+t[r+1].y*a}},this.getLength=function(){let e=0;for(let n=0;n<t.length-1;n++)e+=t[n].length;return e}},X=function(e){const t=e.length;let n;this.xa=[],this.ya=[],this.u=[],this.y2=[];const i=e[0][0],r=e[e.length-1][0];for(e.sort((function(e,t){return e[0]-t[0]})),n=0;n<t;n++)this.xa.push(e[n][0]),this.ya.push(e[n][1]);for(this.u[0]=0,this.y2[0]=0,n=1;n<t-1;++n){const e=this.xa[n+1]-this.xa[n-1],t=(this.xa[n]-this.xa[n-1])/e,i=t*this.y2[n-1]+2;this.y2[n]=(t-1)/i;const r=(this.ya[n+1]-this.ya[n])/(this.xa[n+1]-this.xa[n])-(this.ya[n]-this.ya[n-1])/(this.xa[n]-this.xa[n-1]);this.u[n]=(6*r/e-t*this.u[n-1])/i}for(this.y2[t-1]=0,n=t-2;n>=0;--n)this.y2[n]=this.y2[n]*this.y2[n+1]+this.u[n];this.getFirstX=function(){return i},this.getLastX=function(){return r}};X.prototype.interpolate=function(e){let t=0,n=this.ya.length-1;for(;n-t>1;){const i=n+t>>1;this.xa[i]>e?n=i:t=i}const i=this.xa[n]-this.xa[t],r=(this.xa[n]-e)/i,a=(e-this.xa[t])/i;return r*this.ya[t]+a*this.ya[n]+((r*r*r-r)*this.y2[t]+(a*a*a-a)*this.y2[n])*(i*i)/6},X.prototype.findX=function(e,t){let n=null,i=null;for(let r=0;r<=t;r++){const a=r/t,o=this.interpolate(a);if(null===n){n=a,i=Math.abs(o-e);continue}const s=Math.abs(o-e);if(!(s<i))break;n=a,i=s}return n};class Y{constructor(e,t,n){this.h=Math.max(0,Math.min(360,e)),this.s=Math.max(.001,Math.min(100,t)),this.v=Math.max(0,Math.min(100,n))}}class V{constructor(e,t,n){this.r=Math.max(0,Math.min(255,e)),this.g=Math.max(0,Math.min(255,t)),this.b=Math.max(0,Math.min(255,n))}}class W{constructor(e,t,n,i){this.c=Math.max(0,Math.min(100,e)),this.m=Math.max(0,Math.min(100,t)),this.y=Math.max(0,Math.min(100,n)),this.k=Math.max(0,Math.min(100,i))}}const G={_RGBtoHSV:function(e){const t=new Y(0,0,0),n=e.r/255,i=e.g/255,r=e.b/255,a=Math.min(n,i,r),o=Math.max(n,i,r),s=o-a;if(t.v=o,0==s)t.h=0,t.s=0;else{t.s=s/o;const e=((o-n)/6+s/2)/s,a=((o-i)/6+s/2)/s,l=((o-r)/6+s/2)/s;n==o?t.h=l-a:i==o?t.h=1/3+e-l:r==o&&(t.h=2/3+a-e),t.h<0&&(t.h+=1),t.h>1&&(t.h-=1)}return t.h=Math.round(360*t.h),t.s=Math.round(100*t.s),t.v=Math.round(100*t.v),t},_HSVtoRGB:function(e){const t=new V(0,0,0);let n,i,r,a,o,s,l,h;const c=e.h/360%1,d=e.s/100,u=e.v/100;return 0==d?(t.r=255*u,t.g=255*u,t.b=255*u):(n=6*c,i=Math.floor(n),r=u*(1-d),a=u*(1-d*(n-i)),o=u*(1-d*(1-(n-i))),0==i?(s=u,l=o,h=r):1==i?(s=a,l=u,h=r):2==i?(s=r,l=u,h=o):3==i?(s=r,l=a,h=u):4==i?(s=o,l=r,h=u):(s=u,l=r,h=a),t.r=255*s,t.g=255*l,t.b=255*h,t.r=Math.round(t.r),t.g=Math.round(t.g),t.b=Math.round(t.b)),t},_CMYKtoRGB:function(e){const t=new V(0,0,0),n=e.c/100,i=e.m/100,r=e.y/100,a=e.k/100;return t.r=1-Math.min(1,n*(1-a)+a),t.g=1-Math.min(1,i*(1-a)+a),t.b=1-Math.min(1,r*(1-a)+a),t.r=Math.round(255*t.r),t.g=Math.round(255*t.g),t.b=Math.round(255*t.b),t},_RGBtoCMYK:function(e){const t=new W(0,0,0,0),n=e.r/255,i=e.g/255,r=e.b/255;return t.k=Math.min(1-n,1-i,1-r),t.c=(1-n-t.k)/(1-t.k),t.m=(1-i-t.k)/(1-t.k),t.y=(1-r-t.k)/(1-t.k),t.c=Math.round(100*t.c),t.m=Math.round(100*t.m),t.y=Math.round(100*t.y),t.k=Math.round(100*t.k),t},toRGB:function(e){return e instanceof V?e:e instanceof Y?this._HSVtoRGB(e):e instanceof W?this._CMYKtoRGB(e):void 0},toHSV:function(e){return e instanceof Y?e:e instanceof V?this._RGBtoHSV(e):e instanceof W?this._RGBtoHSV(this._CMYKtoRGB(e)):void 0},toCMYK:function(e){return e instanceof W?e:e instanceof V?this._RGBtoCMYK(e):e instanceof Y?this._RGBtoCMYK(this._HSVtoRGB(e)):void 0},toHexString:function(e){if(e instanceof V){let t=parseInt(""+e.r).toString(16),n=parseInt(""+e.g).toString(16),i=parseInt(""+e.b).toString(16);return 1==t.length&&(t="0"+t),1==n.length&&(n="0"+n),1==i.length&&(i="0"+i),t+n+i}},toRgbStr:function(e){return"rgb("+Math.round(e.r)+", "+Math.round(e.g)+", "+Math.round(e.b)+")"},toRgbaStr:function(e){return"rgba("+Math.round(e.r)+", "+Math.round(e.g)+", "+Math.round(e.b)+", "+e.a+")"},hexToRGB:function(e){e=(e=e.trim()).replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(e,t,n,i){return t+t+n+n+i+i}));const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?new V(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)):null}};const K=function(){function e(e){e.preventDefault();let t=!1;if(e.relatedTarget)try{e.relatedTarget.focus(),t=!0}catch(e){console.error("failed to focus")}t||e.currentTarget.blur()}return function(t){t.setAttribute("tabindex","-1"),g(t,"focus",e)}}(),Q=[];class q{static subscribe(e){q.listeners.includes(e)||q.listeners.push(e)}static unsubscribe(e){for(let t=0;t<q.listeners.length;t++)if(e===q.listeners[t])return void q.listeners.splice(t,1)}static emit(e){q.listeners.forEach((t=>{t(e)}))}constructor(){}}q.listeners=[];class J{static getItem(e){let t=null;try{t=localStorage.getItem(e)}catch(e){this.error=e}return t}static setItem(e,t){try{localStorage.setItem(e,t)}catch(e){this.error=e}}static removeItem(e){try{localStorage.removeItem(e)}catch(e){this.error=e}}static getError(){return this.error}}const $={eventUsesHighResTimeStamp:l,mouseEventHasMovement:h,hasPointerEvents:c,hasWebGl:d,getVisitor:u,isCssMinMaxSupported:p,canShareFiles:function(){return"share"in navigator&&"canShare"in navigator},insertAfter:function(e,t){e.parentNode&&e.parentNode.insertBefore(t,e.nextSibling)},loadImage:function(e,t){let n=0;!function i(){1e3!==n?e.complete?(n++,t()):setTimeout(i,1):alert("couldn't load")}()},css:f,setAttributes:function(e,t){const n=Object.keys(t);let i;for(let r=0;r<n.length;r++)i=n[r],e.setAttribute(i,t[i])},addClassName:function(e,t){const n=e.getAttribute("class"),i=null===n?[]:n.split(" ");i.includes(t)||(i.push(t),e.setAttribute("class",i.join(" ")))},removeClassName:function(e,t){const n=e.getAttribute("class"),i=null===n?[]:n.split(" ");if(i.includes(t)){for(let e=0;e<i.length;e++)i[e]===t&&(i.splice(e,1),e--);e.setAttribute("class",i.join(" "))}},append:function(e,t){const n=document.createDocumentFragment();t.forEach((e=>e?n.append(e):null)),e.append(n)},fitInto:function(e,t,n,i,r){let a=e*n,o=t*n;return a>n&&(o*=n/a,a=n),o>i&&(a*=i/o,o=i),r&&(a=Math.max(r,a),o=Math.max(r,o)),{width:a,height:o}},centerWithin:function(e,t,n,i){return{x:e/2-n/2,y:t/2-i/2}},getDate:function(){const e=new Date;return e.getFullYear()+"_"+(e.getMonth()+1).toString().padStart(2,"0")+"_"+e.getDate().toString().padStart(2,"0")+"_"+(60*e.getHours()+e.getMinutes()).toString(36).padStart(3,"0")+"_"},gcd:y,reduce:x,decToFraction:function(e){const t=e.toString().length-2,n=Math.pow(10,t);return x(e*n,n)},imageBlobToUrl:function(e){if(!e)throw new Error("blobObj is undefined or null");if(window.Blob&&e instanceof Blob)return URL.createObjectURL(e);if("Object"===e.constructor.name){const t=e;return"data:"+t.type+";"+t.encoding+","+t.data}throw new Error("unknown blob format")},dateDayDifference:function(e,t){return e=new Date(e),t=new Date(t),e.setHours(0,0,0,0),t.setHours(0,0,0,0),(t.getTime()-e.getTime())/864e5},copyObj:function(e){return JSON.parse(JSON.stringify(e))},shareCanvas:function(e){const t="image/png",n=()=>alert("sharing not supported");e.canvas.toBlob((function(i){if(null===i)return n(),void e.callback();try{const r=[new File([i],e.fileName,{type:t})];navigator.share({title:e.title,files:r}).then((e=>{})).catch((e=>{n()}))}catch(e){n()}e.callback()}),t)},handleClick:function(e){const t=e.target;return!!t&&(!(!["A","LABEL","INPUT"].includes(t.tagName)&&!t.allowClick)||(e.preventDefault(),!1))},createSvg:function e(t){const n=document.createElementNS("http://www.w3.org/2000/svg",t.elementType),i=Object.keys(t);let r;for(let a=0;a<i.length;a++)if(r=i[a],"childrenArr"===r)for(let i=0;i<t.childrenArr.length;i++)n.appendChild(e(t.childrenArr[i]));else"elementType"!==r&&n.setAttribute(r,t[r]);return n},BbLog:q,LocalStorage:J,mix:v,dist:w,distSquared:function(e,t,n,i){return Math.pow(e-n,2)+Math.pow(t-i,2)},lenSquared:function(e,t){return e*e+t*t},pointsToAngleRad:C,pointsToAngleDeg:S,clamp:E,rotate:M,rotateAround:function(e,t,n){const i=M(t.x-e.x,t.y-e.y,n);return i.x+=e.x,i.y+=e.y,i},Matrix:_,Vec2:N,intDxy:function(e,t,n){e.x+=t,e.y+=n;const i=Math.round(e.x),r=Math.round(e.y);return e.x-=i,e.y-=r,{dX:i,dY:r}},roundEven:function(e){if(e%1==0)return e%2==0?e:e+1;const t=Math.ceil(e),n=Math.floor(e);return t%2==0?t:n},roundUneven:function(e){if(e%1==0)return e%2==0?e+1:e;const t=Math.ceil(e),n=Math.floor(e);return t%2==1?t:n},updateBounds:function(e,t){return t?(e?(e.x1=Math.min(e.x1,t.x1),e.y1=Math.min(e.y1,t.y1),e.x2=Math.max(e.x2,t.x2),e.y2=Math.max(e.y2,t.y2)):e={x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2},e):e},boundsInArea:function(e,t,n){let i=Math.max(0,e.x1),r=Math.max(0,e.y1),a=Math.min(t-1,e.x2),o=Math.min(n-1,e.y2);return i>a||r>o?null:{x1:i,y1:r,x2:a,y2:o}},projectPointOnLine:function(e,t,n){let i,r;if(e.x===t.x)return i=e.x,r=n.y,{x:i,y:r};const a=(t.y-e.y)/(t.x-e.x),o=e.y-a*e.x;return i=(a*n.y+n.x-a*o)/(a*a+1),r=(a*a*n.y+a*n.x+o)/(a*a+1),{x:i,y:r}},PointLine:U,BezierLine:function(){const e=this,t=[];let n,i,r,a=0,o=null;this.add=function(e,s,l,h,c){if(n&&e===n.x&&s===n.y)return;if(n={x:e,y:s},t[t.length]={x:e,y:s,spacing:l},1===t.length)return void(o=l);if(2===t.length)return t[0].dir=N.nor(N.sub(t[1],t[0])),a=l,void(o=l);{const e=t[t.length-1],n=t[t.length-2],i=t[t.length-3];n.dir=N.nor(N.sub(e,i)),(isNaN(n.dir.x)||isNaN(n.dir.y))&&(n.dir=JSON.parse(JSON.stringify(i.dir)))}const d=t[t.length-3],u=t[t.length-2],p=d,g=N.add(d,N.mul(d.dir,N.dist(d,u)/4)),m=N.sub(u,N.mul(u.dir,N.dist(d,u)/4)),f=u;let y;if(h){let e;e=function(e,t,n,i,r){const a=[];let o,s;for(let l=0;l<=r;l++)o=l/r,s={},s.x=Math.pow(1-o,3)*e.x+3*Math.pow(1-o,2)*o*t.x+3*(1-o)*Math.pow(o,2)*n.x+Math.pow(o,3)*i.x,s.y=Math.pow(1-o,3)*e.y+3*Math.pow(1-o,2)*o*t.y+3*(1-o)*Math.pow(o,2)*n.y+Math.pow(o,3)*i.y,a[a.length]=s;return a}(p,g,m,f,20),y=new U({points:e})}else y=new U({points:[p,f]});const x=y.getLength();let b=v(o,l,E(a/x,0,1)),w=a;for(;w<=x;w+=b){b=v(o,l,E(w/x,0,1));const e=y.getAtDist(w),t=i?S(i,e):void 0;h&&h({x:e.x,y:e.y,t:w/x,angle:t,dAngle:i?t-r:0}),i=e,r=t}h?a=w-x:(a=0,c({p1:p,p2:g,p3:m,p4:f})),o=l},this.addFinal=function(n,i,r){if(t.length<2)return;const a=t[t.length-2],o=t[t.length-1],s=N.add(o,N.sub(o,a));e.add(s.x,s.y,n,i,r)}},SplineInterpolator:X,quadraticSplineInput:function(e,t,n){function i(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}const r=[];for(let a=0;a<=1;a+=n)r.push([i(a,4),i(e+Math.pow(a,2)*(t-e),4)]);return r},canvas:o,copyCanvas:function(e){const t=o(e.width,e.height),n=t.getContext("2d");if(!n)throw new Error("2d context not supported or canvas already initialized");return n.drawImage(e,0,0),t},testShouldPixelate:function(e,t,n){if(![1,-1].includes(t)||![1,-1].includes(n)||e.width%1!=0||e.height%1!=0||Math.abs(e.angleDeg)%90!=0)return!1;const i=Math.abs(e.angleDeg-90)%180==0,r=i?e.height:e.width,a=i?e.width:e.height;return(Math.abs(r)%2==0&&e.x%1==0||Math.abs(r)%2==1&&e.x%1==.5)&&(Math.abs(a)%2==0&&e.y%1==0||Math.abs(a)%2==1&&e.y%1==.5)},drawTransformedImageWithBounds:function(e,t,n,i,r){i||(i={x:0,y:0,width:t.width,height:t.height}),e.save(),r?e.imageSmoothingEnabled=!1:(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high"),e.translate(n.x,n.y),e.rotate(n.angleDeg/180*Math.PI),e.scale(n.width>0?1:-1,n.height>0?1:-1),e.drawImage(t,i.x,i.y,i.width,i.height,-Math.abs(n.width)/2,-Math.abs(n.height)/2,Math.abs(n.width),Math.abs(n.height)),e.restore()},drawTransformedImageOnCanvas:function(e,t,n){(n=JSON.parse(JSON.stringify(n))).center||(n.center={x:t.width/2,y:t.height/2}),n.scale||(n.scale={x:1,y:1}),n.angleDegree||(n.angleDegree=0),n.translate||(n.translate={x:0,y:0});const i=e.getContext("2d");if(!i)throw new Error("2d context not supported or canvas already initialized");i.save(),Math.abs(n.scale.x-1)>1e-6||Math.abs(n.scale.y-1)>1e-6||Math.abs(n.angleDegree%90)>1e-6?(i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high"):i.imageSmoothingEnabled=!1,i.translate(n.translate.x,n.translate.y),i.translate(n.center.x,n.center.y),i.rotate(n.angleDegree/180*Math.PI),i.scale(n.scale.x,n.scale.y),i.translate(-n.center.x,-n.center.y),i.drawImage(t,0,0,t.width,t.height),i.restore()},createCheckerCanvas:F,createCheckerDataUrl:j,resizeCanvas:function e(t,n,i,r,a){if(n&&i&&(n!==t.width||i!==t.height))if(n=Math.max(n,1),i=Math.max(i,1),n<=t.width&&i<=t.height){r=r||o(),a=a||o();const e=function(e,t,n,i){const r={oldWidthEx:Math.round(Math.log2(e)),oldHeightEx:Math.round(Math.log2(t)),newWidthEx:Math.ceil(Math.log2(n)),newHeightEx:Math.ceil(Math.log2(i))};return r.oldWidthEx=Math.max(r.oldWidthEx,r.newWidthEx),r.oldHeightEx=Math.max(r.oldHeightEx,r.newHeightEx),r}(t.width,t.height,n,i);let s,l;a.width=e.oldWidthEx>e.newWidthEx?Math.pow(2,e.oldWidthEx):n,a.height=e.oldHeightEx>e.newHeightEx?Math.pow(2,e.oldHeightEx):i,r.getContext("2d").save(),a.getContext("2d").save();let h=r,c=a;s=e.oldWidthEx,l=e.oldHeightEx;let d=c.getContext("2d");d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.globalCompositeOperation="copy",d.drawImage(t,0,0,c.width,c.height);let u=c.width,p=c.height;for(;s>e.newWidthEx||l>e.newHeightEx;s--,l--){d=h.getContext("2d"),d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.globalCompositeOperation="copy";const t=s>e.newWidthEx?u/2:u,n=l>e.newHeightEx?p/2:p;h.width=t,h.height=n,d.drawImage(c,0,0,u,p,0,0,t,n),u=t,p=n;const i=h;h=c,c=i}t.width=n,t.height=i;const g=t.getContext("2d");g.save(),g.imageSmoothingEnabled=!0,g.imageSmoothingQuality="high",g.drawImage(c,0,0,u,p,0,0,n,i),g.restore(),r.getContext("2d").restore(),a.getContext("2d").restore()}else if(n>=t.width&&i>=t.height){(r=r||o()).width=n,r.height=i;const e=r.getContext("2d");e.save(),e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high",e.drawImage(t,0,0,n,i),e.restore(),t.width=n,t.height=i,t.getContext("2d").drawImage(r,0,0)}else e(t,n,t.height,r,a),e(t,n,i,r,a)},convertToAlphaChannelCanvas:function(e){const t=e.getContext("2d").getImageData(0,0,e.width,e.height);for(let e=0;e<t.data.length;e+=4)0!==t.data[e+3]&&(t.data[e+3]=(t.data[e]+t.data[e+1]+t.data[e+2])/3*(t.data[e+3]/255));e.getContext("2d").putImageData(t,0,0)},freeCanvas:function(e){e.width=1,e.height=1;const t=e.getContext("2d");t&&t.clearRect(0,0,1,1)},HSV:Y,RGB:V,CMYK:W,ColorConverter:G,testIsWhiteBestContrast:function(e){return.299*e.r+.587*e.g+.114*e.b<125},appendTextDiv:function(e,t){const n=document.createElement("div");return n.innerHTML=t,e.appendChild(n),n},clearSelection:function(){if(window.getSelection){const e=window.getSelection();e&&(e.empty?e.empty():e.removeAllRanges&&e.removeAllRanges())}else"selection"in document&&document.selection.empty()},makeUnfocusable:K,el:function(e){const t=document.createElement(e.tagName?e.tagName:"div");e.css&&f(t,e.css),e.content&&("string"==typeof e.content?t.innerHTML=e.content:Array.isArray(e.content)?$.append(t,e.content):t.appendChild(e.content)),e.textContent&&(t.textContent=e.textContent),e.className&&(t.className=e.className),e.id&&(t.id=e.id),e.parent&&e.parent.appendChild(t),"title"in e&&void 0!==e.title&&(t.title=e.title);const n=[];if("onClick"in e&&(g(t,"click",e.onClick),n.push(["click",e.onClick])),"onChange"in e&&(g(t,"change",e.onChange),n.push(["change",e.onChange])),n.length>0&&Q.push({el:t,listeners:n}),"custom"in e){const n=Object.keys(e.custom);for(let i=0;i<n.length;i++)t.setAttribute(n[i],e.custom[n[i]])}return t},destroyEl:function(e){for(let t=0;t<Q.length;t++){const n=Q[t];if(n.el===e)return n.listeners.forEach((t=>{e.removeEventListener(t[0],t[1])})),void Q.splice(t,1)}},isInputFocused:function(e=!1){let t=document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName);return e?t:t&&!document.activeElement.getAttribute("data-ignore-focus")},addEventListener:g,removeEventListener:m,setEventListener:function(e,t,n){c||(t=t.replace("pointer","mouse")),e[t]=n},KeyListener:class{isPressed(e){if(!(e in b.getIsDown()))throw'key "'+e+'" not found';return b.getIsDown()[e]}getComboStr(){return b.getCombo().join("+")}comboOnlyContains(e){for(let t=0;t<b.getCombo().length;t++)if(!e.includes(b.getCombo()[t]))return!1;return!0}destroy(){b.remove(this.ref)}constructor(e){this.onDown=e.onDown,this.onUp=e.onUp,this.onBlur=e.onBlur,this.ref=[this.onDown,this.onUp,this.onBlur],b.add(this.ref)}},PointerListener:I,sameKeys:function(e,t){return e.split("+").sort().join("+")===t.split("+").sort().join("+")},EventChain:T};let Z=!1;class ee{pause(e){}addListener(e){}push(e){}undo(){return[]}redo(){return[]}getAll(){return[]}canRedo(){return!1}canUndo(){return!1}getState(){return 0}getActionNumber(){return 0}}const te=new class{broadcast(e){setTimeout((()=>{for(let t=0;t<this.listeners.length;t++)this.listeners[t](e);this.state++}),1)}pause(e){!1===e?this.pauseStack=Math.max(0,this.pauseStack-1):this.pauseStack++}addListener(e){this.listeners.push(e)}push(e){if(this.pauseStack>0)return;for(;this.actionNumber<this.dataArr.length-1;)this.dataArr.pop();const t=this.dataArr[this.dataArr.length-1];if("layerOpacity"===e.action&&t&&"layerOpacity"===t.action&&t.params[0]===e.params[0])return this.dataArr[this.dataArr.length-1]=e,void this.state++;if("focusLayer"===e.action&&t&&"focusLayer"===t.action)return this.dataArr[this.dataArr.length-1]=e,void this.state++;this.dataArr[this.dataArr.length]=e,this.actionNumber=this.dataArr.length-1;const n=this.maxState;this.maxState=Math.max(this.maxState,this.actionNumber-this.max),n<this.maxState?this.broadcast({bufferUpdate:this.dataArr[this.maxState]}):this.broadcast(null),this.maxState>=0&&(this.dataArr[this.maxState]=null)}undo(){let e;if(this.canUndo()){e=[];for(let t=this.maxState+1;t<this.actionNumber;t++)e.push(this.dataArr[t]);this.actionNumber--,this.broadcast(null)}return e}redo(){const e=[];return this.canRedo()&&(this.actionNumber++,e.push(this.dataArr[this.actionNumber]),this.broadcast(null)),e}getAll(){return[].concat(this.dataArr)}canRedo(){return this.actionNumber<this.dataArr.length-1}canUndo(){return this.actionNumber>this.maxState}getState(){return this.state}getActionNumber(){return this.actionNumber+1}constructor(){if(this.max=20,Z)throw new Error("klHistory already instantiated");Z=!0,this.state=0,this.dataArr=[],this.listeners=[],this.pauseStack=0,this.maxState=-1,this.actionNumber=-1}};const ne=new class{emit(){this.listeners.forEach((e=>{e(this.count)}))}increase(e){void 0!==e?this.count+=e:this.count++,this.emit()}decrease(e){void 0!==e?this.count-=e:this.count--,this.emit()}get(){return this.count}subscribe(e){this.listeners.push(e)}constructor(){this.listeners=[],this.count=0}};var ie;ie=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hCe0g");var re;re=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("9ojvT");const ae=n(JSON.parse('{"switch-ui-left-right":"Switch left/right UI","toggle-show-tools":"Show/Hide Tools","scroll":"Scroll","donate":"Donate","home":"Home","modal-new-tab":"Open in new tab","tab-layers":"Layers","tab-edit":"Edit","tab-file":"File","tool-brush":"Brush","tool-paint-bucket":"Paint Bucket","tool-shape":"Shape","tool-text":"Text","tool-hand":"Hand Tool","tool-zoom":"Zoom","tool-undo-redo":"Undo / Redo","undo":"Undo","redo":"Redo","brush-pen":"Pen","brush-blend":"Blend","brush-sketchy":"Sketchy","brush-pixel":"Pixel","brush-chemy":"Chemy","brush-smudge":"Smudge","brush-size":"Size","brush-blending":"Blending","brush-toggle-pressure":"Toggle Pressure Sensitivity","brush-lock-alpha":"Lock Alpha","brush-lock-alpha-title":"Locks layer\'s alpha channel","brush-pen-circle":"Circle","brush-pen-chalk":"Chalk","brush-pen-calligraphy":"Calligraphy","brush-pen-square":"Square","brush-sketchy-scale":"Scale","brush-pixel-dither":"Dither","brush-chemy-fill":"Fill","brush-chemy-stroke":"Stroke","brush-chemy-mirror-x":"Horizontal Symmetry","brush-chemy-mirror-y":"Vertical Symmetry","brush-chemy-gradient":"Gradient","brush-eraser-transparent-bg":"Transparent Background","stabilizer":"Stabilizer","stabilizer-title":"Stroke Stabilizer","eyedropper":"Eyedropper","secondary-color":"Secondary Color","manual-color-input":"Manual Color Input","mci-hex":"Hex","mci-copy":"Copy","modal-ok":"Ok","modal-cancel":"Cancel","modal-close":"Close","layers-active-layer":"Active Layer","layers-layer":"Layer","layers-copy":"copy","layers-blending":"Blending","layers-new":"New Layer","layers-remove":"Remove Layer","layers-duplicate":"Duplicate Layer","layers-merge":"Merge with layer below","layers-rename":"Rename","layers-blend-normal":"normal","layers-blend-darken":"darken","layers-blend-multiply":"multiply","layers-blend-color-burn":"color burn","layers-blend-lighten":"lighten","layers-blend-screen":"screen","layers-blend-color-dodge":"color dodge","layers-blend-overlay":"overlay","layers-blend-soft-light":"soft light","layers-blend-hard-light":"hard light","layers-blend-difference":"difference","layers-blend-exclusion":"exclusion","layers-blend-hue":"hue","layers-blend-saturation":"saturation","layers-blend-color":"color","layers-blend-luminosity":"luminosity","layers-rename-title":"Rename Layer","layers-rename-name":"Name","layers-rename-clear":"Clear Name","layers-rename-sketch":"Sketch","layers-rename-colors":"Colors","layers-rename-lines":"Lines","layers-rename-foreground":"Foreground","layers-merge-modal-title":"Merge/Mix Layers","layers-merge-description":"Merges the selected layer with the one underneath. Select the mix mode:","file-no-autosave":"No autosave, no cloud storage","file-new":"New","file-import":"Import","file-save":"Save","file-save-png":"Save PNG","file-save-psd":"Save PSD","file-save-layers":"Save Layers","file-copy":"Copy","file-copy-title":"Copy To Clipboard","file-share":"Share","file-storage":"Browser Storage","file-storage-thumb-title":"Restores when reopening page","file-storage-about":"About Browser Storage","file-storage-cant-access":"Can\'t access","file-storage-empty":"Empty","file-storage-store":"Store","file-storage-clear":"Clear","file-storage-storing":"Storing","file-storage-overwrite":"Overwrite","file-storage-min-ago":"{x}min ago","file-storage-hours-ago":"{x}h ago","file-storage-days-ago":"{x}d ago","file-storage-month-ago":"> 1month ago","file-storage-restored":"Restored from Browser Storage","file-storage-stored":"Stored to Browser Storage","file-storage-failed":"Failed to store to Browser Storage","file-storage-failed-1":"Failed to store. Possible causes:","file-storage-failed-2":"Out of disk space","file-storage-failed-3":"Storage disabled in incognito tab","file-storage-failed-4":"Browser doesn\'t support storage","file-storage-failed-clear":"Failed to clear.","file-upload":"Upload","cleared-layer":"Cleared layer","filled":"Filled","new-title":"New Image","new-current":"Current","new-fit":"Fit","new-oversize":"Oversize","new-square":"Square","new-landscape":"Landscape","new-portrait":"Portrait","new-screen":"Screen","new-video":"Video","new-din-paper":"DIN Paper","new-px":"px","new-ratio":"Ratio","upload-title":"Upload to Imgur","upload-link-notice":"Anyone with the link to your uploaded image will be able to view it.","upload-name":"Title","upload-title-untitled":"Untitled","upload-caption":"Caption","upload-tos":"Terms of Service","upload-tos-2":"for imgur.com","upload-submit":"Upload","upload-uploading":"Uploading...","upload-success":"Upload Successful","upload-failed":"Upload failed.","upload-delete":"To delete your image from Imgur visit:","cropcopy-title-copy":"Copy To Clipboard","cropcopy-title-crop":"Crop","cropcopy-btn-copy":"To Clipboard","cropcopy-copied":"Copied.","cropcopy-btn-crop":"Apply Crop","crop-drag-to-crop":"Drag to crop","filter-crop-extend":"Crop/Extend","filter-flip":"Flip","filter-perspective":"Perspective","filter-resize":"Resize","filter-rotate":"Rotate","filter-transform":"Transform","filter-bright-contrast":"Bright/Contrast","filter-curves":"Curves","filter-hue-sat":"Hue/Saturation","filter-invert":"Invert","filter-tilt-shift":"Tilt Shift","filter-to-alpha":"To Alpha","filter-triangle-blur":"Triangle Blur","filter-unsharp-mask":"Unsharp Mask","filter-crop-title":"Crop / Extend","filter-crop-description":"Crop or extend the image.","filter-crop-left":"Left","filter-crop-right":"Right","filter-crop-top":"Top","filter-crop-bottom":"Bottom","filter-crop-rule-thirds":"Rule of Thirds","filter-crop-fill":"Fill","filter-flip-title":"Flip","filter-flip-description":"Flips layer or whole image.","filter-flip-horizontal":"Horizontal","filter-flip-vertical":"Vertical","filter-flip-image":"Flip Image","filter-flip-layer":"Flip Layer","filter-perspective-title":"Perspective","filter-perspective-description":"Transforms the selected layer.","filter-perspective-before":"Before","filter-perspective-after":"After","filter-resize-title":"Resize","filter-resize-description":"Resizes the image.","filter-rotate-title":"Rotate","filter-rotate-description":"Rotates the image.","filter-transform-empty":"Layer is empty.","filter-transform-title":"Transform","filter-transform-description":"Transforms selected layer. Hold Shift for additional behavior.","filter-transform-rotation":"Rotation","filter-transform-flip":"Flip","filter-transform-center":"Center","filter-transform-constrain":"Constrain","filter-transform-snap":"Snap","filter-transform-snap-title":"Snap Rotation And Position","filter-bright-contrast-title":"Brightness / Contrast","filter-bright-contrast-description":"Change brightness and contrast for the selected layer.","filter-bright-contrast-brightness":"Brightness","filter-bright-contrast-contrast":"Contrast","filter-curves-title":"Curves","filter-curves-description":"Apply curves on the selected layer.","filter-curves-all":"All","filter-hue-sat-title":"Hue / Saturation","filter-hue-sat-description":"Change hue and saturation for the selected layer.","filter-hue-sat-hue":"Hue","filter-hue-sat-saturation":"Saturation","filter-applied":"applied","filter-tilt-shift-title":"Tilt Shift","filter-tilt-shift-description":"Applies tilt shift on the selected layer.","filter-tilt-shift-blur":"Blur Radius","filter-tilt-shift-gradient":"Gradient Radius","filter-to-alpha-title":"To Alpha","filter-to-alpha-description":"Generates alpha channel for selected layer from:","filter-to-alpha-inverted-lum":"Inverted Luminance","filter-to-alpha-lum":"Luminance","filter-to-alpha-replace":"Replace RGB","filter-triangle-blur-title":"Triangle Blur","filter-triangle-blur-description":"Applies triangle blur on the selected layer.","filter-unsharp-mask-title":"Unsharp Mask","filter-unsharp-mask-description":"Sharpens the selected layer by scaling pixels away from the average of their neighbors.","filter-unsharp-mask-strength":"Strength","import-opening":"Opening file...","import-title":"Import Image","import-too-large":"Image too large, will be downscaled.","import-btn-as-layer":"As Layer","import-btn-as-image":"As Image","import-as-layer-title":"Import Image as New Layer","import-as-layer-description":"Adjust the position of the imported image.","import-as-layer-limit-reached":"Layer limit reached. Image will be placed on existing layer.","import-as-layer-fit":"Fit","import-flatten":"Flatten image","import-unsupported-file":"Unsupported file type. See Help for supported types.","import-broken-file":"Couldn\'t load image. File might be corrupted.","import-psd-unsupported":"Unsupported features. PSD had to be flattened.","import-psd-limited-support":"PSD support is limited. Flattened will more likely look correct.","import-psd-too-large":"Image exceeds maximum dimensions of {x} x {x} pixels. Unable to import.","import-psd-size":"Image size","hand-reset":"Reset","hand-fit":"Fit","bucket-tolerance":"Tolerance","bucket-sample":"Sample","bucket-sample-title":"Which layers to sample color from","bucket-sample-all":"All","bucket-sample-active":"Active","bucket-sample-above":"Above","bucket-grow":"Grow","bucket-grow-title":"Grow filled area (in pixels)","bucket-contiguous":"Contiguous","bucket-contiguous-title":"Only fill connected areas","shape-stroke":"Stroke","shape-fill":"Fill","shape-rect":"Rectangle","shape-ellipse":"Ellipse","shape-line":"Line","shape-line-width":"Line Width","shape-outwards":"Outwards","shape-fixed":"Fixed 1:1","shape-snap":"Snap","shape-snap-title":"45° Angle Snapping","text-instruction":"Click canvas to place text","text-title":"Add Text","text-placeholder":"Your text (multiline Shift+Enter)","text-color":"Color","text-size":"Size","text-left":"Left","text-center":"Center","text-right":"Right","text-italic":"Italic","text-bold":"Bold","save-reminder-title":"Unsaved Work","save-reminder-text":"Image was not saved in {a} minutes{b}. Save now to prevent eventual loss.","save-reminder-save-psd":"Save As PSD","save-reminder-psd-layers":"PSD will remember all layers.","submit":"Submit","submit-title":"Submit Drawing","submit-prompt":"Submit drawing?","submit-submitting":"Submitting","embed-init-loading":"Loading app","embed-init-waiting":"Waiting for image","unsaved":"Unsaved","help":"Help","tab-settings":"Settings","settings-language":"Language","settings-preferred-language":"Preferred Language","settings-language-reload":"Will update after reloading.","licenses":"Licenses","source-code":"Source Code","auto":"auto","zoom-in":"Zoom In","zoom-out":"Zoom Out","radius":"Radius","constrain-proportions":"Constrain Proportions","width":"Width","height":"Height","opacity":"Opacity","red":"Red","green":"Green","blue":"Blue","eraser":"Eraser","center":"Center","background":"Background","scaling-algorithm":"Scaling Algorithm","algorithm-smooth":"Smooth","algorithm-pixelated":"Pixelated","preview":"Preview"}')),oe=[{code:"en",name:"English"},{code:"de",name:"Deutsch"},{code:"ja",name:"日本語"},{code:"zh-CN",name:"简体中文"},{code:"zh-TW",name:"繁體中文"}],se=async e=>{if("en"===e)return ae;if("de"===e)return await a("ktYQh");if("ja"===e)return await a("fEi6m");if("zh-CN"===e)return await a("3EP0j");if("zh-TW"===e)return await a("7w2st");throw new Error("unknown language code")};let le="en";{const e=[];(navigator.languages?navigator.languages:[navigator.language]).forEach((t=>{const n=t.split("-");e.push(t),2===n.length&&e.push(n[0])}));try{localStorage.getItem("klecks-language")&&e.unshift(localStorage.getItem("klecks-language"))}catch(e){}e.splice(0),e.push("zh-TW");for(let t=0;t<e.length;t++){const n=e[t],i=oe.find((e=>e.code.toLowerCase()===n.toLowerCase()));if(i){le=i.code;break}}}const he=new class{async setLanguage(e){this.data="en"===e?{...ae}:{...ae,...await se(e)},this.code=e,document.documentElement.setAttribute("lang",e),this.listeners.forEach((e=>{e()}))}get(e){if(!(e in this.data))throw new Error("translation code doesn't exist: "+e);return this.data[e]}getLanguage(){return oe.find((e=>e.code===this.code))}getCode(){return this.code}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){for(let t=0;t<this.listeners.length;t++)if(e===this.listeners[t])return void this.listeners.splice(t,1)}constructor(){this.listeners=[],this.data={...ae},this.code="en"}},ce=(e,t)=>{if(t){let n=he.get(e);return Object.keys(t).forEach((e=>{n=n.replace(`{${e}}`,t[e])})),n}return he.get(e)};function de(e){ne.increase();let t=!1;const i=$.el({parent:e.target||document.body,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",overflow:"hidden"}}),r=$.el({parent:i,className:"kl-popup"}),a=$.el({parent:r,css:{width:"100%",minHeight:"100%",position:"relative",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}}),o=$.el({parent:a,onClick:()=>{e.ignoreBackground||f("Cancel")},css:{position:"absolute",left:"0",top:"0",zIndex:"0",width:"100%",height:"100%"}}),s=$.el({tagName:"button",className:"popup-x",content:`<img alt="${ce("modal-close")}" height="20" src="${n(re)}">`,title:ce("modal-close"),onClick:()=>{f("Cancel")},css:{width:"40px",height:"40px",lineHeight:"40px",position:"absolute",right:"0",top:"0",background:"none",boxShadow:"none"}}),l=["kl-popup-box"];l.push("kl-popup-box--sm");const h=$.el({content:[s,$.el({content:e.message,css:{marginBottom:e.div?"10px":null,marginRight:"15px"}}),e.div],className:l.join(" "),css:e.style?e.style:null});a.append($.el({css:{flex:"0.5"}}),h,$.el({css:{flex:"1"}})),"error"===e.type&&$.addClassName(h,"poperror"),"ok"===e.type&&$.addClassName(h,"popok"),"warning"===e.type&&$.addClassName(h,"popwarning"),"upload"===e.type&&$.addClassName(h,"popupload");const c=new $.KeyListener({onDown:function(e,n,i){t||(g&&"enter"===i&&!$.isInputFocused()&&(n.stopPropagation(),setTimeout((function(){g.click()}),10)),"esc"===i&&(n.stopPropagation(),f("Cancel")))}}),d=e=>{c.isPressed("ctrl")&&e.preventDefault()};$.addEventListener(r,"wheel",d),r.onclick=$.handleClick;let u=null;u=e.autoFocus?e.autoFocus:!1===e.autoFocus?null:"Ok";const p=e.buttons&&e.buttons.length>0?$.el({parent:h,css:{display:"flex",flexWrap:"wrap",justifyContent:"flex-end",marginTop:"12px",marginLeft:"-8px"}}):null;let g;const m=[];function f(n){if(!t){t=!0,$.clearSelection();{const e=$.el({parent:document.body,tagName:"input",css:{opacity:"0",width:"0",height:"0"}});setTimeout((()=>{e.select(),e.focus(),e.parentNode.removeChild(e)}),10)}i.parentNode.removeChild(i),ne.decrease(),$.destroyEl(s),$.destroyEl(o),c.destroy(),$.removeEventListener(r,"wheel",d),r.onclick=null,m.forEach((e=>{$.destroyEl(e)})),m.splice(0,m.length),e.callback&&e.callback(n)}}e.buttons&&e.buttons.forEach((t=>{const i=["kl-popup__btn"];let a;("Ok"===t||e.primaries&&e.primaries.includes(t))&&i.push("kl-button-primary");let o=t;"Ok"===t&&(o=ce("modal-ok"),a=n(ie)),"Cancel"===t&&(o=ce("modal-cancel"),a=n(re));let s=null;a&&(s=$.el({tagName:"img",custom:{src:a,height:"17"}}));const l=$.el({parent:p,tagName:"button",className:i.join(" "),content:[s,o],onClick:()=>{f(t)}});m.push(l),u===t&&(setTimeout((()=>{l.focus(),r.scrollTo(0,0)}),10),setTimeout((()=>{r.scrollTo(0,0)}),20)),t===e.clickOnEnter&&(g=l)})),e.closefunc&&e.closefunc((function(){f("Cancel")}))}window.onscroll=e=>{e.preventDefault()};const ue=function(e){ne.increase();const t=e.target||document.body,i=$.el({parent:t,css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0",background:"rgba(0, 0, 0, 0.45)",overflow:"auto",animationName:"consoleIn",animationDuration:"0.3s",animationTimingFunction:"ease-out"}});function r(){ne.decrease(),i.onclick=null,t.removeChild(i),clearInterval(undefined),window.removeEventListener("resize",s),d.destroy(),$.destroyEl(h),$.destroyEl(a),e.onClose&&e.onClose()}i.onclick=$.handleClick;const a=$.el({parent:i,css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"},onClick:r}),o=$.el({parent:i,css:{position:"absolute",width:$.isCssMinMaxSupported()?"min(calc(100% - 40px), "+(e.width?e.width:400)+"px)":(e.width?e.width:400)+"px",height:"calc(100% - 40px)",background:"#eee",borderRadius:"10px",overflow:"hidden",boxShadow:"rgba(0, 0, 0, 0.25) 0px 5px 60px"}});function s(){const t=e.target?e.target.clientWidth||e.target.offsetWidth:window.innerWidth,n=e.target?e.target.clientHeight||e.target.offsetHeight:window.innerHeight,i=o.offsetWidth,r=o.offsetHeight;$.css(o,{left:Math.max(0,(t-i)/2)+"px",top:Math.max(20,(n-r)/2-.2*r)+"px"})}s(),window.addEventListener("resize",s);const l=$.el({parent:o,css:{height:"40px",display:"flex",justifyContent:"space-between",alignItems:"center",paddingLeft:"20px"}});e.title&&l.appendChild(e.title);const h=$.el({parent:l,tagName:"button",className:"popup-x",content:`<img alt="${ce("modal-close")}" height="20" src="${n(re)}">`,title:ce("modal-close"),onClick:r,css:{width:"40px",height:"40px",lineHeight:"40px",background:"none",boxShadow:"none"},custom:{tabindex:"0"}}),c=$.el({parent:o,css:{height:"calc(100% - 40px)"}});e.content&&c.appendChild(e.content);const d=new $.KeyListener({onDown:function(e,t){"esc"===e&&(t.stopPropagation(),r())}});this.close=function(){r()}};class pe{getValue(){return this.check.checked}getElement(){return this.element}destroy(){this.check.onchange=null}constructor(e){this.element=$.el({className:"kl-checkbox"});const t=$.el({parent:this.element,tagName:"label",className:"kl-checkbox__inner"});this.check=$.el({parent:t,tagName:"input",css:{marginLeft:"0",display:"inline-block"},custom:{type:"checkbox"}}),this.check.checked=e.init,e.doHighlight&&this.check.checked&&$.addClassName(this.element,"kl-checkbox--highlight"),e.allowTab||(this.check.tabIndex=-1),e.title&&(t.title=e.title);const n=document.createElement("div");n.style.display="inline-block",n.innerHTML=e.label,n.allowClick=!0,t.appendChild(n),this.check.onchange=()=>{e.doHighlight&&(this.check.checked?$.addClassName(this.element,"kl-checkbox--highlight"):$.removeClassName(this.element,"kl-checkbox--highlight")),e.callback(this.check.checked),setTimeout((()=>{this.check.blur()}),0)},e.css&&$.css(this.element,e.css)}}const ge=function(e){const t=document.createElement("input");if(e.type)try{t.type=e.type}catch(e){}else t.type="text";return void 0!==e.min&&(t.min=""+e.min),void 0!==e.max&&(t.max=""+e.max),t.value=""+e.init,e.callback&&(t.onchange=function(){e.callback(t.value)}),e.css&&$.css(t,e.css),t};class me{setValue(e){this.selectEl.value=e}getValue(){return this.selectEl.value}setDeltaValue(e){let t=0;for(let e=0;e<this.optionArr.length;e++)if(""+this.optionArr[e][0]===this.selectEl.value){t=e;break}t=Math.max(0,Math.min(this.optionArr.length-1,t+e)),this.selectEl.value=this.optionArr[t][0],this.onChange(this.selectEl.value)}getElement(){return this.selectEl}constructor(e){this.destroy=()=>{this.selectEl.removeEventListener("change",this.changeListener)},this.selectEl=$.el({tagName:"select",title:e.title,css:{cursor:"pointer",fontSize:"15px",padding:"3px",background:"#fff",colorScheme:"only light"}}),e.css&&$.css(this.selectEl,e.css);const t=e.isFocusable;t||(this.selectEl.tabIndex=-1),this.optionArr=e.optionArr;for(let e=0;e<this.optionArr.length;e++){if(null===this.optionArr[e])continue;const t=document.createElement("option");t.value=this.optionArr[e][0],t.textContent=this.optionArr[e][1],this.selectEl.append(t)}this.onChange=e.onChange,this.changeListener=e=>{t||this.selectEl.blur(),this.onChange(this.selectEl.value)},this.selectEl.addEventListener("change",this.changeListener),this.selectEl.value="initValue"in e?e.initValue:null}}const fe=function(e){let t=!!e.initValue;const n=$.el({className:"image-toggle",title:e.title,css:{backgroundImage:"url('"+e.image+"')"},onClick:function(n){n.preventDefault(),e.isRadio&&t||(t=!t,i(),e.onChange(t))}});function i(){t?$.addClassName(n,"image-toggle-active"):$.removeClassName(n,"image-toggle-active")}i(),this.setValue=function(e){t=!!e,i()},this.getElement=function(){return n},this.getValue=function(){return t},this.destroy=()=>{$.destroyEl(n)}},ye=function(e){const t=$.el({className:"image-radio-wrapper",css:{display:"flex"}});let n;const i=[];function r(r,a){a.id===e.initId&&(n=r);const o=new fe({image:a.image,title:a.title,initValue:a.id===e.initId,isRadio:!0,onChange:function(){!function(t,r){n=t;for(let e=0;e<i.length;e++)i[e].setValue(e===n);e.onChange(r)}(r,a.id)}});return t.appendChild(o.getElement()),o}for(let t=0;t<e.optionArr.length;t++)i.push(r(t,e.optionArr[t]));this.getElement=function(){return t},this.getValue=function(){return e.optionArr[n].id},this.destroy=()=>{i.forEach((e=>{e.destroy()}))}};var xe;xe=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("aTp8j");const be=function(e,t){const i=$.el({css:{cssFloat:"right",borderRadius:"3px",width:"18px",height:"18px",backgroundImage:'url("'+n(xe)+'")',backgroundSize:"contain",backgroundRepeat:"no-repeat",cursor:"pointer",boxSizing:"border-box",colorScheme:"only light"}});function r(){e?$.css(i,{backgroundColor:"#fff",opacity:"0.9",border:"1px solid var(--active-highlight-color)"}):$.css(i,{backgroundColor:"transparent",opacity:"0.5",border:"1px solid #666"})}return $.hasPointerEvents||(i.style.display="none"),i.title=ce("brush-toggle-pressure"),i.onclick=function(){e=!e,r(),t(e)},r(),t(e),i},ve=function(e,t){let n=Math.min(10,1+Math.pow(Math.floor(e/50),2));return t&&(n*=2),1/n},we=function(e){const t=this;let n,i=!1!==e.isEnabled,r=!!e.curve;if(!e.label||!e.onChange)throw"PcSlider missing params";if(!(0==e.min||0==e.max||0==e.initValue||e.min&&e.max&&e.initValue))throw"PcSlider broken params";if(e.min>=e.max)throw"PcSlider broken params";const a=e.width,o=e.height,s=e.resolution?e.resolution:a;let l=e.min,h=e.max;const c=e.onChange,d=!!e.isChangeOnFinal,u=e.formatFunc,p=e.eventResMs;if(r){const t="quadratic"===e.curve?$.quadraticSplineInput(l,h,.1):e.curve;n=new $.SplineInterpolator(t)}function g(e){return r?n.findX(e,Math.floor(1.5*s)):(e-l)/(h-l)}const m=$.el({className:"sliderWrapper",css:{overflow:"hidden",position:"relative",width:a+"px",height:o+"px",userSelect:"none"}}),f=e.label,y=document.createElement("div"),x=document.createElement("div"),b=document.createElement("div");let v=g(e.initValue);m.appendChild(x),m.appendChild(y),x.appendChild(b),x.className="sliderInner",m.oncontextmenu=function(){return!1},y.innerHTML=f,x.style.position="absolute",x.style.left="0",x.style.top="0",x.style.width=v*a+"px",x.style.height=o+"px";const w=o-14;function C(){i?$.css(m,{opacity:null,pointerEvents:null}):$.css(m,{opacity:"0.5",pointerEvents:"none"})}function S(){let e=l+v*(h-l);return r&&(e=n.interpolate(v)),e}function E(){let e=function(e){let t=l+e*(h-l);return r&&(t=n.interpolate(e)),t}(v);e=u?u(e):parseInt(e),e=e.toLocaleString(he.getCode()),y.innerHTML=f+'&nbsp;&nbsp;<span style="font-weight:bold">'+e+"</span>",x.style.width=v*a+"px"}$.css(y,{position:"absolute",left:"7px",top:o/2-w/2+1+"px",lineHeight:w+"px",fontSize:w+"px",pointerEvents:"none"}),C();let M,k,I=0;function T(e){if(e||!d)if(p&&!e){const e=performance.now();e-I>=p&&(I=e,c(S()))}else c(S())}function L(e){if(e.eventPreventDefault(),i){if("pointerdown"===e.type&&(m.className="sliderWrapper sliderWrapperActive","left"===e.button&&(v=e.relX/a,v=Math.max(0,Math.min(1,v)),E(),T(!1)),M=v),"pointermove"===e.type&&["left","right"].includes(e.button)){let t=e.dX;const n=Math.abs(e.pageY-e.downPageY);t*=ve(n,"right"===e.button),t/=a,M+=t,v=Math.max(0,Math.min(1,M)),E(),T(!1)}"pointerup"===e.type&&(m.className="sliderWrapper",T(!0))}}const R=setTimeout((()=>{k=new $.PointerListener({target:m,maxPointers:1,fixScribble:!0,onPointer:L,onWheel:function(e){r?(v+=-e.deltaY*(n.getLastX()-n.getFirstX())/40,v=Math.max(n.getFirstX(),Math.min(n.getLastX(),v))):(v+=-e.deltaY/40,v=Math.max(0,Math.min(1,v))),E(),c(S())}}),E()}),1);this.increaseValue=function(e){v=Math.min(1,v+Math.abs(e)),E(),c(S())},this.decreaseValue=function(e){v=Math.max(0,v-Math.abs(e)),E(),c(S())},this.setValue=function(e){v=g(e),E()},this.getValue=function(){return S()},this.update=function(e){if(l=e.min,h=e.max,r=!!e.curve,r){const t="quadratic"===e.curve?$.quadraticSplineInput(l,h,.1):e.curve;n=new $.SplineInterpolator(t)}else n=null;t.setIsEnabled(!e.isDisabled)},this.setIsEnabled=function(e){i=!!e,C()},this.destroy=function(){clearTimeout(R),k&&k.destroy()},this.getElement=function(){return m}};var Ce;Ce=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("4nBFo");const Se=function(e){let t=new $.RGB(e.color.r,e.color.g,e.color.b);const i=$.el({}),r=$.el({css:{width:"20px",height:"20px",marginBottom:"10px",boxShadow:"inset 0 0 0 1px #fff, 0 0 0 1px #000",background:"#"+$.ColorConverter.toHexString(t),colorScheme:"only light"}});i.appendChild(r);const a=$.el({css:{display:"flex",alignItems:"center",marginBottom:"15px"}}),o=$.el({content:ce("mci-hex"),css:{width:"60px"}}),s=ge({init:"#"+$.ColorConverter.toHexString(t),css:{width:"80px"},callback:function(){let e=$.ColorConverter.hexToRGB(s.value);null===e?(e=t,s.value="#"+$.ColorConverter.toHexString(t)):t=e,r.style.background="#"+$.ColorConverter.toHexString(e);for(let e=0;e<c.length;e++)c[e].update()}}),l=$.el({tagName:"button",content:'<img src="'+n(Ce)+'" height="20"/>',title:ce("mci-copy"),css:{marginLeft:"10px"},onClick:function(){s.select(),document.execCommand("copy")}});function h(e,n){const a={},o=$.el({css:{display:"flex",alignItems:"center",marginTop:"5px"}}),l=$.el({content:e,css:{width:"60px"}}),h=ge({init:t[n],min:0,max:255,type:"number",css:{width:"80px"},callback:function(){""===h.value||parseFloat(h.value)<0||parseFloat(h.value)>255?a.update():(h.value=""+Math.round(parseFloat(h.value)),t[n]=h.value,r.style.background="#"+$.ColorConverter.toHexString(t),s.value="#"+$.ColorConverter.toHexString(t))}});return o.appendChild(l),o.appendChild(h),i.appendChild(o),a.update=function(){h.value=t[n]},a.destroy=()=>{h.onchange=null},a}a.appendChild(o),a.appendChild(s),a.appendChild(l),i.appendChild(a),setTimeout((function(){s.focus(),s.select()}),0);const c=[];c.push(h(ce("red"),"r")),c.push(h(ce("green"),"g")),c.push(h(ce("blue"),"b")),de({target:e.klRootEl,message:`<b>${ce("manual-color-input")}</b>`,div:i,autoFocus:!1,clickOnEnter:"Ok",buttons:["Ok","Cancel"],callback:function(t){$.destroyEl(l),c.forEach((e=>e.destroy())),c.splice(0,c.length),e.onClose("Ok"===t?$.ColorConverter.hexToRGB(s.value):null)}})};var Ee;Ee=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("efo6g");const Me=function(e){const t=document.createElement("div");t.oncontextmenu=function(e){e.preventDefault()};let n=$.ColorConverter.toHSV(new $.RGB(e.color.r,e.color.g,e.color.b));$.css(t,{width:e.width+"px",position:"relative",overflow:"hidden",userSelect:"none"});const i=$.canvas(10,10);function r(){const e=i.getContext("2d");for(let t=0;t<i.height;t+=1){const r=e.createLinearGradient(0,0,i.width,0),a=$.ColorConverter.toRGB(new $.HSV(n.h,1,100-t/i.height*100)),o=$.ColorConverter.toRGB(new $.HSV(n.h,100,100-t/i.height*100));r.addColorStop(0,"#"+$.ColorConverter.toHexString(a)),r.addColorStop(1,"#"+$.ColorConverter.toHexString(o)),e.fillStyle="#ff0000",e.fillStyle=r,e.fillRect(0,t,i.width,1)}}i.style.width=e.width+"px",i.style.height=e.heightSV+"px",i.style.cursor="crosshair",r();const a=$.canvas(e.width,e.heightH);a.style.cursor="ew-resize",function(){const t=a.getContext("2d"),n=t.createLinearGradient(0,0,e.width,0);for(let e=0;e<1;e+=.01){const t=$.ColorConverter.toRGB(new $.HSV(360*e,100,100));n.addColorStop(e,"rgba("+parseInt(""+t.r)+", "+parseInt(""+t.g)+", "+parseInt(""+t.b)+", 1)")}t.fillStyle=n,t.fillRect(0,0,e.width,e.heightH)}(),$.css(i,{width:e.width+"px",height:e.heightSV+"px",overflow:"hidden",position:"relative"}),i.style.cssFloat="left",a.style.cssFloat="left",t.appendChild(i),t.appendChild(a);const o=document.createElement("div");$.css(o,{width:"8px",height:"8px",borderRadius:"8px",position:"absolute",pointerEvents:"none",boxShadow:"0 0 0 1px #000, inset 0 0 0 1px #fff"}),t.appendChild(o);const s=document.createElement("div");function l(){const t=n.s/100*e.width-4,i=(1-n.v/100)*e.heightSV-4;$.css(o,{left:t+"px",top:i+"px"})}function h(){s.style.left=n.h/359.999*e.width-1+"px"}$.css(s,{width:"0",height:e.heightH+"px",borderLeft:"1px solid #fff",borderRight:"1px solid #000",position:"absolute",top:e.heightSV+"px",pointerEvents:"none"}),t.appendChild(s),l(),h();const c={h:0,s:0,v:0};let d=null;const u=new $.PointerListener({target:i,maxPointers:1,fixScribble:!0,onPointer:function(t){if("pointerdown"===t.type&&(d=t.pointerId,"left"===t.button?(c.s=t.relX/e.width*100,c.v=100-t.relY/e.heightSV*100,n=new $.HSV(n.h,c.s,c.v),l(),e.callback($.ColorConverter.toRGB(n))):(c.s=n.s,c.v=n.v)),"pointermove"===t.type&&["left","right"].includes(t.button)&&d===t.pointerId){let i=1;"right"===t.button&&(i=.5),c.s+=t.dX/e.width*100*i,c.v-=t.dY/e.heightSV*100*i,n=new $.HSV(n.h,c.s,c.v),l(),e.callback($.ColorConverter.toRGB(n))}"pointerup"===t.type&&(d=null)}});let p=null;const g=new $.PointerListener({target:a,maxPointers:1,fixScribble:!0,onPointer:function(t){if("pointerdown"===t.type&&(p=t.pointerId,"left"===t.button?(c.h=t.relX/e.width*359.99,n=new $.HSV(c.h,n.s,n.v),r(),h(),e.callback($.ColorConverter.toRGB(n))):c.h=n.h),"pointermove"===t.type&&["left","right"].includes(t.button)&&p===t.pointerId){const i=Math.abs(t.pageY-t.downPageY),a=ve(i,"right"===t.button);c.h+=t.dX/e.width*359.99*a,"right"===t.button&&(c.h=c.h%359.99,c.h<0&&(c.h+=359.99)),c.h=Math.min(359.99,c.h),n=new $.HSV(c.h,n.s,n.v),r(),h(),e.callback($.ColorConverter.toRGB(n))}"pointerup"===t.type&&(p=null)}}),m=document.createElement("div");m.style.clear="both",t.appendChild(m),this.setColor=function(e){n=$.ColorConverter.toHSV(new $.RGB(e.r,e.g,e.b)),r(),l(),h()},this.getColor=function(){return $.ColorConverter.toRGB(n)},this.getElement=function(){return t},this.destroy=function(){u.destroy(),g.destroy()},this.end=function(){d=null,p=null}},ke=function(e){const t=document.createElement("div");t.style.position="relative";const n=$.el({}),i=$.el({css:{colorScheme:"only light"}});let r;t.appendChild(n),t.appendChild(i);let a=!1;$.css(n,{marginTop:parseInt(""+(e.pointSize/2-1))+"px",height:"2px",background:"#aaa",width:e.width+"px"});$.el({parent:i,css:{margin:"-7px 0 0 -7px",width:"calc(100% + 14px)",height:"calc(100% + 7px)"}});function o(){i.style.left=r+"px",i.style.boxShadow=a?"0 0 6px rgba(0,0,0,1)":"0 0 3px rgba(0,0,0,0.8)"}function s(){return r/(e.width-e.pointSize)}let l;{let t,n;r=$.clamp(e.init*(e.width-e.pointSize),0,e.width-e.pointSize),$.css(i,{position:"absolute",top:"0px",backgroundColor:"#eaeaea",boxShadow:"0 0 3px rgba(0,0,0,0.8)",width:e.pointSize+"px",height:e.pointSize+"px",borderRadius:e.pointSize+"px",cursor:"ew-resize",transition:"box-shadow 0.2s ease-in-out"}),o(),l=new $.PointerListener({target:i,fixScribble:!0,onPointer:function(i){"pointerdown"===i.type&&"left"===i.button?(t=!0,a=!0,n=r,o(),i.eventStopPropagation()):"pointermove"===i.type&&"left"===i.button&&(i.eventStopPropagation(),n+=i.dX,r=parseInt(""+$.clamp(n,0,e.width-e.pointSize)),o(),e.callback(s(),t,!1),t=!1),"pointerup"===i.type&&(i.eventStopPropagation(),a=!1,o(),e.callback(s(),!1,!0))}})}this.getEl=function(){return t},this.setActive=function(e){i.style.backgroundColor=e?"#fff":"#eaeaea"},this.destroy=function(){l.destroy()}},Ie=function(e){const t=$.el({content:e.label?e.label:"",css:{display:"flex",alignItems:"center",colorScheme:"only light"}});let n=0;const i=[],r=[],a=$.createCheckerDataUrl(5);for(let t=0;t<e.colorArr.length;t++){const r=e.colorArr[t];let a=!1;for(let e=0;e<i.length;e++){const t=i[e];if(null!==t&&null!==r&&(t.r===r.r&&t.g===r.g&&t.b===r.b&&t.a===r.a)){a=!0;break}}a||(i.push(r),"initialIndex"in e&&e.initialIndex===t&&(n=i.length-1))}for(let s=0;s<i.length;s++)!function(s){const l=$.el({content:i[s]?"":"X",css:{width:"22px",height:"22px",backgroundColor:i[s]?$.ColorConverter.toRgbaStr(i[s]):"transparent",marginLeft:"7px",boxShadow:"0 0 0 1px #aaa",cursor:"pointer",userSelect:"none",textAlign:"center",lineHeight:"23px",color:"#aaa"}});i[s]&&0===i[s].a&&(l.style.backgroundImage="url("+a+")"),l.onclick=function(t){t.preventDefault(),n=s,o(),e.onChange(i[s])},l.setIsSelected=function(e){e?$.css(l,{boxShadow:"0 0 0 2px var(--active-highlight-color), 0 0 5px 0 var(--active-highlight-color)",pointerEvents:"none"}):$.css(l,{boxShadow:"0 0 0 1px #aaa",pointerEvents:""})},t.appendChild(l),r.push(l)}(s);function o(){for(let e=0;e<r.length;e++)r[e].setIsSelected(e===n)}o(),this.getElement=function(){return t},this.destroy=()=>{r.forEach((e=>{e.onclick=null})),r.splice(0,r.length)}},Te=function(e){const t=$.el({}),n=$.el({parent:t,className:"kl-option-wrapper",css:{display:"flex"}}),i=[];let r="initialId"in e?e.initialId:e.optionArr[0].id;function a(t){const a={id:t.id,el:null},s=["kl-option"];e.isSmall&&s.push("kl-option--small"),"string"!=typeof t.label&&(s.push("kl-option--custom-el"),$.css(t.label,{display:"block",pointerEvents:"none"})),a.el=$.el({parent:n,content:t.label,className:s.join(" "),onClick:function(){r!==a.id&&(r=a.id,o(),e.onChange(r))}}),t.title&&(a.el.title=t.title),i.push(a)}function o(){for(let e=0;e<i.length;e++)i[e].id===r?$.addClassName(i[e].el,"kl-option-selected"):$.removeClassName(i[e].el,"kl-option-selected")}for(let t=0;t<e.optionArr.length;t++)a(e.optionArr[t]);function s(){for(let e=0;e<i.length;e++)if(i[e].id===r)return e}o(),e.changeOnInit&&setTimeout((function(){e.onChange(r)}),0),this.getElement=function(){return t},this.getValue=function(){return r},this.next=function(){r=i[(s()+1)%i.length].id,o(),e.onChange(r)},this.previous=function(){r=i[(i.length+s()-1)%i.length].id,o(),e.onChange(r)},this.destroy=()=>{i.forEach((e=>{$.destroyEl(e.el)})),i.splice(0,i.length)}};var Le;Le=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("56A6t");function Re(e){const t=document.createElement("div");let n;function i(){n={x:0,y:0,width:e.canvas.width,height:e.canvas.height}}function r(){o.width=Math.round(n.width),o.height=Math.round(n.height),o.getContext("2d").drawImage(e.canvas,Math.round(-n.x),Math.round(-n.y)),l&&(l.src=o.toDataURL("image/png")),e.onChange&&e.onChange(o.width,o.height)}function a(){$.css(y,{left:m+n.x*u+"px",top:f+n.y*p+"px",width:n.width*u+"px",height:n.height*p+"px"}),e.onChange&&e.onChange(Math.round(n.width),Math.round(n.height))}$.css(t,{position:"relative",height:e.height+"px",width:e.width+"px",overflow:"hidden",colorScheme:"only light"}),t.style.position="relative",i();const o=$.canvas();let s=o,l=null;e.isNotCopy||(l=new Image,s=l),$.css(s,{height:e.height+"px",width:e.width+"px"}),t.appendChild(s),r();const h=$.el({css:{width:e.width+"px",height:e.height+"px",position:"absolute",left:"0",top:"0",pointerEvents:"none"}});t.appendChild(h),$.createCheckerDataUrl(4,(function(e){h.style.backgroundImage="url("+e+")"}));const c=$.fitInto(e.canvas.width,e.canvas.height,e.width-40,e.height-40,1),d=$.canvas(Math.round(c.width),Math.round(c.height));d.style.imageRendering="pixelated";const u=d.width/e.canvas.width,p=d.height/e.canvas.height,g=d.getContext("2d");g.imageSmoothingEnabled=!1,g.drawImage(e.canvas,0,0,d.width,d.height),h.appendChild(d);const m=parseInt(""+(e.width-d.width)/2),f=parseInt(""+(e.height-d.height)/2);$.css(d,{position:"absolute",left:m+"px",top:f+"px"});const y=$.el({css:{position:"absolute",boxShadow:"0 0 0 1px #fff, 0 0 0 2px #000, 0 0 40px 1px #000"}});function x(t){return{x:$.clamp((t.x-m)/u,0,e.canvas.width),y:$.clamp((t.y-f)/p,0,e.canvas.height)}}function b(e,t){let n={x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)},i={x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)},r=x(n),a=x(i);return r.x=Math.floor(r.x),r.y=Math.floor(r.y),a.x=Math.ceil(a.x),a.y=Math.ceil(a.y),{x:r.x,y:r.y,width:a.x-r.x,height:a.y-r.y}}function v(){return 0===n.x&&0===n.y&&n.width===e.canvas.width&&n.height===e.canvas.height}let w;h.appendChild(y),a();let C,S=null,E=!1,M=!1;const k=new $.PointerListener({target:s,fixScribble:!0,onPointer:function(t){"pointerdown"===t.type&&"left"===t.button?(t.eventPreventDefault(),E=!0,w={x:t.relX,y:t.relY},!v()&&function(e){let t=Math.round(m+n.x*u),i=Math.round(f+n.y*p),r=Math.round(n.width*u),a=Math.round(n.height*p);return t<=e.x&&e.x<=t+r&&i<=e.y&&e.y<=i+a}(w)?S={x:n.x,y:n.y,width:n.width,height:n.height}:n=b(w,w)):"pointermove"===t.type&&"left"===t.button?(t.eventPreventDefault(),M=!0,S?(n.x=S.x+Math.round((t.relX-w.x)/u),n.y=S.y+Math.round((t.relY-w.y)/p),n.x=$.clamp(n.x,0,e.canvas.width-n.width),n.y=$.clamp(n.y,0,e.canvas.height-n.height)):n=b(w,{x:t.relX,y:t.relY}),a()):"pointerup"===t.type&&w&&(t.eventPreventDefault(),E=!1,S=null,w=null,0!==n.width&&0!==n.height&&M||(i(),a()),M=!1,C=setTimeout(r,1))}}),I=new $.KeyListener({onDown:function(t,i,o){if(E)return;let s=!1,l=Math.max(1,1/u),h=I.isPressed("shift");"left"===t&&(h?n.width=$.clamp(n.width-l,1,e.canvas.width-n.x):n.x=$.clamp(n.x-l,0,e.canvas.width-n.width),s=!0),"right"===t&&(h?n.width=$.clamp(n.width+l,1,e.canvas.width-n.x):n.x=$.clamp(n.x+l,0,e.canvas.width-n.width),s=!0),"up"===t&&(h?n.height=$.clamp(n.height-l,1,e.canvas.height-n.y):n.y=$.clamp(n.y-l,0,e.canvas.height-n.height),s=!0),"down"===t&&(h?n.height=$.clamp(n.height+l,1,e.canvas.height-n.y):n.y=$.clamp(n.y+l,0,e.canvas.height-n.height),s=!0),s&&(i.preventDefault(),a(),clearTimeout(C),C=setTimeout(r,100))}});this.getEl=function(){return t},this.reset=function(){i(),r(),a()},this.destroy=function(){s.style.removeProperty("width"),s.style.removeProperty("height"),I.destroy(),k.destroy()},this.isReset=function(){return v()},this.getRect=function(){return JSON.parse(JSON.stringify(n))},this.getCroppedImage=function(){return o}}var Ae;Ae=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hrhBj");var Pe;Pe=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("8JUnX");var De;De=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hteGn");var Oe;Oe=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("dXczd");var Be;function ze(e,t,n,i,r,a){for(let o=n;o<=r;o++)for(let n=i;n<=a;n++)255!==e[n*t+o]&&(e[n*t+o]=254)}let He,Fe;function je(e,t,n,i,r){return He=n%e+i,Fe=Math.floor(n/e)+r,He<0||Fe<0||He>=e||Fe>=t?null:Fe*e+He}function _e(e,t,n,i,r,a,o){return null!==o&&255!==t[o]&&((e[4*o]===r[0]&&e[4*o+1]===r[1]&&e[4*o+2]===r[2]&&e[4*o+3]===r[3]||a>0&&Math.abs(e[4*o]-r[0])<=a&&Math.abs(e[4*o+1]-r[1])<=a&&Math.abs(e[4*o+2]-r[2])<=a&&Math.abs(e[4*o+3]-r[3])<=a)&&(t[o]=255,!0))}function Ne(e,t,n,i,r,a,o,s){i=Math.round(i),r=Math.round(r);let l=new Uint8Array(new ArrayBuffer(t*n));return function(e,t,n,i,r,a,o,s,l){let h,c,d,u,p,g,m,f,y,x,b,v,w=[e[4*(a*n+r)],e[4*(a*n+r)+1],e[4*(a*n+r)+2],e[4*(a*n+r)+3]];if(l){let s,l,h=[];for(h.push(a*n+r),t[a*n+r]=255;h.length;)s=h.pop(),l=je(n,i,s,-1,0),_e(e,t,0,0,w,o,l)&&h.push(l),l=je(n,i,s,1,0),_e(e,t,0,0,w,o,l)&&h.push(l),l=je(n,i,s,0,-1),_e(e,t,0,0,w,o,l)&&h.push(l),l=je(n,i,s,0,1),_e(e,t,0,0,w,o,l)&&h.push(l)}else for(let r=0;r<n*i;r++)_e(e,t,0,0,w,o,r);if(0!==s){for(let e=0;e<n;e++)for(let r=0;r<i;r++)255===t[r*n+e]&&(h=e,c=e,d=r,u=r,p=255!==t[r*n+e-1],g=255!==t[(r-1)*n+e-1],m=255!==t[(r-1)*n+e],f=255!==t[(r-1)*n+e+1],y=255!==t[r*n+e+1],x=255!==t[(r+1)*n+e+1],b=255!==t[(r+1)*n+e],v=255!==t[(r+1)*n+e-1],p&&(h=e-s),p&&g&&m&&(h=e-s,d=r-s),m&&(d=Math.min(d,r-s)),m&&f&&y&&(d=Math.min(d,r-s),c=e+s),y&&(c=Math.max(c,e+1*s)),y&&x&&b&&(c=Math.max(c,e+1*s),u=Math.max(u,r+1*s)),b&&(u=Math.max(u,r+1*s)),b&&v&&p&&(h=Math.min(h,e-1*s),u=Math.max(u,r+1*s)),(p||g||m||f||y||x||b||v)&&ze(t,n,Math.max(0,h),Math.max(0,d),Math.min(n-1,c),Math.min(i-1,u)));for(let e=0;e<n*i;e++)254===t[e]&&(t[e]=255)}}(e,l,t,n,i,r,a,o,s),{data:l}}function Ue(e,t){if(!["rect","ellipse","line"].includes(t.type))throw new Error("unknown shape");{const n=Math.round(t.lineWidth),i=180*t.angleRad/Math.PI;e.save(),t.opacity&&(e.globalAlpha=t.opacity),t.isEraser&&(e.globalCompositeOperation="destination-out"),e.rotate(-t.angleRad),t.fillRgb?e.fillStyle=$.ColorConverter.toRgbStr(t.fillRgb):t.strokeRgb&&(e.strokeStyle=$.ColorConverter.toRgbStr(t.strokeRgb),e.lineWidth=n);let r=t.x1,a=t.y1,o=t.x2,s=t.y2;if(t.isAngleSnap){let e=$.rotate(r,a,t.angleRad/Math.PI*180),n=$.rotate(o,s,t.angleRad/Math.PI*180),l=$.pointsToAngleDeg(e,n)+90,h=45*Math.round(l/45),c=$.rotateAround({x:r,y:a},{x:o,y:s},h-l);o=c.x,s=c.y,(i+h)%90==0&&(Math.round((i-h)/90)%2==0?o=r:s=a)}let l,h,c=r,d=a,u=o-r,p=s-a;if("line"!==t.type&&t.isFixedRatio){let e=$.rotate(t.x1,t.y1,t.angleRad/Math.PI*180),n=$.rotate(t.x2,t.y2,t.angleRad/Math.PI*180),i=e.x,l=e.y,h=n.x-e.x,g=n.y-e.y;Math.abs(h)<Math.abs(g)?g=Math.abs(h)*(g<0?-1:1):h=Math.abs(g)*(h<0?-1:1),n.x=i+h,n.y=l+g,e=$.rotate(e.x,e.y,-t.angleRad/Math.PI*180),n=$.rotate(n.x,n.y,-t.angleRad/Math.PI*180),r=e.x,a=e.y,o=n.x,s=n.y,c=r,d=a,u=o-r,p=s-a}if(t.isOutwards&&(c-=u,d-=p,u*=2,p*=2,r=c,a=d,o=c+u,s=d+p),"line"===t.type){const i=Math.round(r),c=Math.round(a),d=Math.round(o),u=Math.round(s),p=Math.floor(r),g=Math.floor(a),m=Math.floor(o),f=Math.floor(s);n%2==0?c===u?(l={x:p,y:c},h={x:m,y:u},p<m?h.x+=1:l.x+=1):i===d?(l={x:i,y:g},h={x:d,y:f},g<f?h.y+=1:l.y+=1):(l={x:r,y:a},h={x:o,y:s}):(l={x:p,y:g},h={x:m,y:f},g===f?(p<m?h.x+=1:l.x+=1,l.y+=.5,h.y+=.5):p===m?(g<f?h.y+=1:l.y+=1,l.x+=.5,h.x+=.5):(l.x=r,l.y=a,h.x=o,h.y=s)),l=$.rotate(l.x,l.y,t.angleRad/Math.PI*180),h=$.rotate(h.x,h.y,t.angleRad/Math.PI*180),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(h.x,h.y),e.stroke()}else if("rect"===t.type){const c=Math.floor(r),d=Math.floor(a),u=Math.floor(o),p=Math.floor(s);i%90==0?t.fillRgb?(r%1==0&&(r+=1),a%1==0&&(a+=1),o%1==0&&(o+=1),s%1==0&&(s+=1),l={x:r<o?c:u,y:a<s?d:p},h={x:Math.ceil((r<o?o:r)-l.x),y:Math.ceil((a<s?s:a)-l.y)},h.x=l.x+h.x,h.y=l.y+h.y):n%2==0?(l={x:c,y:d},h={x:u,y:p}):(l={x:c+.5,y:d+.5},h={x:u+.5,y:p+.5}):(l={x:r,y:a},h={x:o,y:s}),l=$.rotate(l.x,l.y,t.angleRad/Math.PI*180),h=$.rotate(h.x,h.y,t.angleRad/Math.PI*180),h.x=h.x-l.x,h.y=h.y-l.y,t.fillRgb?e.fillRect(l.x,l.y,h.x,h.y):e.strokeRect(l.x,l.y,h.x,h.y)}else l=$.rotate(r,a,t.angleRad/Math.PI*180),h=$.rotate(o,s,t.angleRad/Math.PI*180),c=l.x,d=l.y,u=h.x-l.x,p=h.y-l.y,e.beginPath(),e.ellipse(c+u/2,d+p/2,Math.abs(u/2),Math.abs(p/2),0,0,2*Math.PI),t.fillRgb?e.fill():e.stroke();e.restore()}}function Xe(e,t){let n=""===t.textStr?" ":t.textStr,i=$.el({css:{position:"fixed",left:"0",top:"0",width:"100000px",fontSize:t.size+"px",lineHeight:t.lineHeight?t.lineHeight+"px":"default"}}),r=$.el({parent:i,css:{display:"inline-block",textAlign:t.align?t.align:"left",fontFamily:t.font?t.font:"sans-serif",fontSize:t.size+"px",fontWeight:t.isBold?"bold":"normal",fontStyle:t.isItalic?"italic":"normal",lineHeight:t.lineHeight?t.lineHeight+"px":"default",opacity:"0",pointerEvents:"none"}}),a="";for(let e=0;e<n.length;e++)"\n"!==n[e]?a+=n[e].replace("\t","    "):(r.appendChild($.el({tagName:"span",textContent:a,css:{whiteSpace:"pre"}})),a="",r.appendChild($.el({tagName:"br"})));r.appendChild($.el({tagName:"span",textContent:a,css:{whiteSpace:"pre"}})),document.body.appendChild(i);let o={x0:99999999,y0:99999999,x1:0,y1:0};for(let e=0;e<r.children.length;e++){let t=r.children[e];o.x0=Math.min(o.x0,t.offsetLeft),o.y0=Math.min(o.y0,t.offsetTop),o.x1=Math.max(o.x1,t.offsetLeft+t.offsetWidth),o.y1=Math.max(o.y1,t.offsetTop+t.offsetHeight)}let s=e.getContext("2d");s.save();let l=[];t.isItalic&&l.push("italic"),t.isBold&&l.push("bold"),l.push(t.size+"px "+(t.font?t.font:"sans-serif")),s.font=l.join(" "),s.fillStyle=t.color?t.color:"#000";let h=t.x,c=t.y;"right"===t.align&&(h+=-o.x1+o.x0),"center"===t.align&&(h+=(-o.x1+o.x0)/2),s.translate(t.x,t.y),s.rotate(t.angleRad?-t.angleRad:0),s.translate(-t.x,-t.y),s.translate(h,c);for(let e=0;e<r.children.length;e++){let t=r.children[e];s.fillText(t.innerText,t.offsetLeft,t.offsetTop)}return t.isDebug?(s.lineWidth=1,s.strokeRect(0,.85*-t.size,o.x1,o.y1),s.restore(),s.fillRect(t.x-1,t.y-1,2,2)):s.restore(),document.body.removeChild(i),{x:h-t.x,y:c-t.y-.85*t.size,width:o.x1-o.x0,height:o.y1-o.y0}}function Ye(e,t){let n=$.canvas(Math.max(1,Math.round(e.width*t)),Math.max(1,Math.round(e.height*t))),i=n.getContext("2d");i.save(),t>1&&(i.imageSmoothingEnabled=!1);for(let t=0;t<e.layers.length;t++)0!==e.layers[t].opacity&&(i.globalAlpha=e.layers[t].opacity,i.globalCompositeOperation=e.layers[t].mixModeStr?e.layers[t].mixModeStr:"source-over",i.drawImage(e.layers[t].image,0,0,n.width,n.height));return i.restore(),n}Be=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("joibl");const Ve=["source-over","darken","multiply","color-burn","lighten","screen","color-dodge","overlay","soft-light","hard-light","difference","exclusion","hue","saturation","color","luminosity"];function We(e){if(!e)return ce("layers-blend-normal");const t={"source-over":"layers-blend-normal",darken:"layers-blend-darken",multiply:"layers-blend-multiply","color-burn":"layers-blend-color-burn",lighten:"layers-blend-lighten",screen:"layers-blend-screen","color-dodge":"layers-blend-color-dodge",overlay:"layers-blend-overlay","soft-light":"layers-blend-soft-light","hard-light":"layers-blend-hard-light",difference:"layers-blend-difference",exclusion:"layers-blend-exclusion",hue:"layers-blend-hue",saturation:"layers-blend-saturation",color:"layers-blend-color",luminosity:"layers-blend-luminosity"};if(!(e in t))throw new Error("unknown blend mode");return ce(t[e])}class Ge{getElement(){return this.rootElement}setSize(e,t){this.rootElement.setAttribute("width",""+e),this.rootElement.setAttribute("height",""+t),this.compass.setAttribute("transform","translate("+e/2+", "+t/2+")")}updateCursor(e){"x"in e&&(this.brushCircleOuter.setAttribute("cx",""+e.x),this.brushCircleInner.setAttribute("cx",""+e.x)),"y"in e&&(this.brushCircleOuter.setAttribute("cy",""+e.y),this.brushCircleInner.setAttribute("cy",""+e.y)),"radius"in e&&(this.brushCircleOuter.setAttribute("r",""+Math.max(0,e.radius)),this.brushCircleInner.setAttribute("r",""+Math.max(0,e.radius-1))),"isVisible"in e&&(this.brushCircleOuter.style.opacity=e.isVisible?"1":"0",this.brushCircleInner.style.opacity=e.isVisible?"1":"0")}updateColorPreview(e){if("x"in e&&(this.pickerPreviewCol.setAttribute("cx",""+e.x),this.pickerPreviewBorder.setAttribute("cx",""+e.x)),"y"in e&&(this.pickerPreviewCol.setAttribute("cy",""+e.y),this.pickerPreviewBorder.setAttribute("cy",""+e.y)),"color"in e){this.pickerPreviewCol.setAttribute("stroke",$.ColorConverter.toRgbStr(e.color));let t=$.testIsWhiteBestContrast(e.color)?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)";this.pickerPreviewBorder.setAttribute("stroke",t)}"isVisible"in e&&(this.pickerPreviewCol.style.opacity=e.isVisible?"1":"0",this.pickerPreviewBorder.style.opacity=e.isVisible?"1":"0")}updateCompass(e){"angleDeg"in e&&(this.compassInner.setAttribute("transform","rotate("+e.angleDeg+")"),this.compassLineCircle.style.opacity=e.angleDeg%90==0?"1":"0"),"isVisible"in e&&(this.compass.style.opacity=e.isVisible?"1":"0")}constructor(e){this.rootElement=$.createSvg({elementType:"svg",width:""+e.width,height:""+e.height}),$.css(this.rootElement,{position:"absolute",left:"0",top:"0",pointerEvents:"none",userSelect:"none"}),this.brushCircleOuter=$.createSvg({elementType:"circle",r:"10",stroke:"rgba(0,0,0,0.7)","stroke-width":"1",fill:"none"}),this.brushCircleInner=$.createSvg({elementType:"circle",r:"9",stroke:"rgba(255,255,255,0.7)","stroke-width":"1",fill:"none"}),this.rootElement.append(this.brushCircleOuter,this.brushCircleInner),this.pickerPreviewBorder=$.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"22",fill:"none"}),this.pickerPreviewBorder.style.opacity="0",this.pickerPreviewCol=$.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"20",fill:"none"}),this.pickerPreviewCol.style.opacity="0",this.rootElement.append(this.pickerPreviewBorder,this.pickerPreviewCol),this.compassSize=30,this.compass=$.createSvg({elementType:"g",transform:"translate("+e.width/2+", "+e.height/2+")"}),$.css(this.compass,{transition:"opacity 0.25s ease-in-out",opacity:"0"}),this.compassInner=$.createSvg({elementType:"g",transform:"rotate(45)"}),this.compassBaseCircle=$.createSvg({elementType:"circle",fill:"rgba(0,0,0,0.9)",stroke:"none",cx:"0",cy:"0",r:""+this.compassSize}),this.compassLineCircle=$.createSvg({elementType:"circle",fill:"none",stroke:"rgba(255,255,255,0.75)","stroke-width":"1",cx:"0",cy:"0",r:""+.9*this.compassSize}),this.compassUpperTriangle=$.createSvg({elementType:"path",fill:"#f00",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,-"+.9*this.compassSize+" z"}),this.compassLowerTriangle=$.createSvg({elementType:"path",fill:"#fff",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,"+.9*this.compassSize+" z"}),this.compassInner.append(this.compassBaseCircle,this.compassLineCircle,this.compassUpperTriangle,this.compassLowerTriangle),this.compass.append(this.compassInner),this.rootElement.append(this.compass)}}var Ke;Ke=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("4AJ8d");var Qe;Qe=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("durb8");var qe;qe=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hzi30");var Je;Je=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("3qgfL");let $e;var Ze;(Ze=$e||($e={}))[Ze.Draw=0]="Draw",Ze[Ze.Hand=1]="Hand",Ze[Ze.HandGrabbing=2]="HandGrabbing",Ze[Ze.Pick=3]="Pick",Ze[Ze.Zoom=4]="Zoom",Ze[Ze.Rotate=5]="Rotate",Ze[Ze.Rotating=6]="Rotating",Ze[Ze.Fill=7]="Fill",Ze[Ze.Text=8]="Text",Ze[Ze.Shape=9]="Shape";function et(e){const t=e.width/e.layers[0].image.width,n=t>1?e.layers[0].image.width:e.width,i=t>1?e.layers[0].image.height:e.height;let r=$.canvas(n,i);r.style.backgroundImage="url("+$.createCheckerDataUrl(8)+")";let a=r.getContext("2d");function o(){a.save(),a.clearRect(0,0,r.width,r.height);for(let t=0;t<e.layers.length;t++)a.globalAlpha=e.layers[t].opacity,a.globalCompositeOperation=e.layers[t].mixModeStr,r.width>e.layers[t].image.width&&(a.imageSmoothingEnabled=!1),a.drawImage(e.layers[t].image,0,0,r.width,r.height);a.restore()}$.css(r,{width:"100%",height:"100%",imageRendering:t>1?"pixelated":null}),setTimeout(o,0),this.getElement=function(){return r},this.render=function(){o()}}var tt;function nt(e){if(Math.abs(e.angleDeg)%90!=0)return;e.width=Math.round(e.width),e.height=Math.round(e.height);const t=Math.abs(e.angleDeg-90)%180==0;e.x=(t?e.height:e.width)%2==0?Math.round(e.x):Math.round(e.x-.5)+.5,e.y=(t?e.width:e.height)%2==0?Math.round(e.y):Math.round(e.y-.5)+.5}function it(e){return{x:e.x,y:e.y,width:e.width,height:e.height,angleDeg:e.angleDeg}}function rt(e,t,n){let i,r;i=e-n.x,r=t-n.y;const a=$.rotateAround({x:0,y:0},{x:i,y:r},-n.angleDeg);return i=a.x,r=a.y,{x:i,y:r}}function at(e,t,n){const i=$.rotateAround({x:0,y:0},{x:e,y:t},n.angleDeg);return{x:i.x+n.x,y:i.y+n.y}}tt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("blFqq");class ot{updateScaled(){this.scaled.x=this.transform.x*this.scale,this.scaled.y=this.transform.y*this.scale,this.scaled.width=this.transform.width*this.scale,this.scaled.height=this.transform.height*this.scale,this.scaled.corners=this.corners.map((e=>({x:e.x*this.scale,y:e.y*this.scale})))}snapCorner(e,t){if(!this.snappingEnabled)return{x:e,y:t};let n;const i={x:null,y:null,dist:{x:null,y:null}};for(let t=0;t<this.snapX.length;t++)n=Math.abs(e-this.snapX[t]),n<this.minSnapDist/this.scale&&(null===i.x||n<i.dist.x)&&(i.x=this.snapX[t],i.dist.x=n);for(let e=0;e<this.snapY.length;e++)n=Math.abs(t-this.snapY[e]),n<this.minSnapDist/this.scale&&(null===i.y||n<i.dist.y)&&(i.y=this.snapY[e],i.dist.y=n);return null===i.x&&null===i.y?{x:e,y:t}:{x:null!==(r=i.x)&&void 0!==r?r:e,y:null!==(a=i.y)&&void 0!==a?a:t};var r,a}constrainCorner(e,t,n){if(!this.isConstrained)return{x:t,y:n};const i=this.transform.width*this.transform.height<0?-1:1;return $.projectPointOnLine({x:this.transform.x,y:this.transform.y},at(this.ratio,i*([0,2].includes(e)?1:-1),this.transform),{x:t,y:n})}updateCornerPositions(){this.corners[0].x=-this.transform.width/2,this.corners[0].y=-this.transform.height/2,this.corners[1].x=this.transform.width/2,this.corners[1].y=-this.transform.height/2,this.corners[2].x=this.transform.width/2,this.corners[2].y=this.transform.height/2,this.corners[3].x=-this.transform.width/2,this.corners[3].y=this.transform.height/2}restoreRatio(e,t){if(!this.isConstrained)return;const n=Math.abs(this.transform.angleDeg)%90==0,i=Math.abs(this.transform.angleDeg-90)%180==0;if(t&&!e){const e=Math.abs(this.corners[3].y-this.corners[0].y);let t=this.ratio*e;n&&(t=0==(i?this.transform.y%1:this.transform.x%1)?$.roundEven(t):$.roundUneven(t)),this.corners[1].x-this.corners[0].x<0&&(t*=-1),this.corners[0].x=-t/2,this.corners[3].x=-t/2,this.corners[1].x=t/2,this.corners[2].x=t/2}if(!t&&e){let e=Math.abs(this.corners[0].x-this.corners[1].x)/this.ratio;n&&(e=0==(i?this.transform.x%1:this.transform.y%1)?$.roundEven(e):$.roundUneven(e)),this.corners[3].y-this.corners[0].y<0&&(e*=-1),this.corners[0].y=-e/2,this.corners[1].y=-e/2,this.corners[2].y=e/2,this.corners[3].y=e/2}}updateTransformViaCorners(){const e=$.rotateAround({x:0,y:0},{x:(this.corners[0].x+this.corners[1].x)/2,y:(this.corners[0].y+this.corners[3].y)/2},this.transform.angleDeg);this.transform.x=e.x+this.transform.x,this.transform.y=e.y+this.transform.y,this.transform.width=this.corners[1].x-this.corners[0].x,this.transform.height=this.corners[3].y-this.corners[0].y,this.updateCornerPositions(),this.updateDOM()}updateDOM(e){this.updateScaled(),$.css(this.transEl,{left:this.scaled.x+"px",top:this.scaled.y+"px",transformOrigin:"0 0",transform:"rotate("+this.transform.angleDeg+"deg)"}),$.css(this.boundsEl,{width:Math.abs(this.scaled.width)+"px",height:Math.abs(this.scaled.height)+"px",left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px"}),this.corners[0].updateDOM(),this.corners[1].updateDOM(),this.corners[2].updateDOM(),this.corners[3].updateDOM(),this.edges[0].updateDOM(),this.edges[1].updateDOM(),this.edges[2].updateDOM(),this.edges[3].updateDOM(),this.angleGrip.x=0,this.angleGrip.y=-Math.abs(this.transform.height*this.scale)/2-20,this.angleGrip.updateDOM(),e||this.callback&&this.callback(it(this.transform))}getTransform(){return it(this.transform)}setConstrained(e){this.isConstrained=!!e,e&&0!==this.transform.width&&0!==this.transform.height&&(this.ratio=Math.abs(this.transform.width/this.transform.height))}setSnapping(e){this.snappingEnabled=!!e}setPos(e){this.transform.x=e.x,this.transform.y=e.y,this.updateDOM(!0)}move(e,t){this.transform.x+=e,this.transform.y+=t,this.updateDOM(!1)}setSize(e,t){this.transform.width=e,this.transform.height=t,Math.abs(this.transform.angleDeg)%90==0&&nt(this.transform),this.updateCornerPositions(),this.updateDOM(!1)}setAngleDeg(e){this.transform.angleDeg=e,Math.abs(this.transform.angleDeg)%90==0&&(nt(this.transform),this.updateCornerPositions()),this.updateDOM(!0)}getElement(){return this.rootEl}getRatio(){return this.ratio}destroy(){this.keyListener.destroy(),this.boundsPointerListener.destroy(),this.corners[0].pointerListener.destroy(),this.corners[1].pointerListener.destroy(),this.corners[2].pointerListener.destroy(),this.corners[3].pointerListener.destroy(),this.edges[0].pointerListener.destroy(),this.edges[1].pointerListener.destroy(),this.edges[2].pointerListener.destroy(),this.edges[3].pointerListener.destroy(),this.anglePointerListener.destroy()}constructor(e){this.scaled={x:0,y:0,width:0,height:0,corners:[{x:0,y:0}]},this.minSnapDist=7,this.cornerCursors=["nw","n","ne","e","se","s","sw","w"],this.gripSize=14,this.edgeSize=10,this.corners=[],this.edges=[],this.transform={x:e.x,y:e.y,width:e.width,height:e.height,angleDeg:e.angleDeg},this.isConstrained=!!e.isConstrained,this.snapX=e.snapX,this.snapY=e.snapY,this.callback=e.callback,this.scale=e.scale,this.snappingEnabled=!0,this.ratio=this.transform.width/this.transform.height,this.rootEl=$.el({className:"kl-free-transform",css:{userSelect:"none"}}),this.transEl=$.el({parent:this.rootEl,css:{position:"absolute"}}),this.boundsEl=$.el({css:{position:"absolute",cursor:"move",boxShadow:"rgba(255, 255, 255, 0.5) 0 0 0 1px inset, rgba(0, 0, 0, 0.5) 0 0 0 1px"}});const t={x:0,y:0};this.keyListener=new $.KeyListener({});let i,r={x:0,y:0};this.boundsPointerListener=new $.PointerListener({target:this.boundsEl,fixScribble:!0,onPointer:e=>{if(e.eventPreventDefault(),"pointerdown"===e.type&&(r={x:this.transform.x,y:this.transform.y}),"pointermove"===e.type&&"left"===e.button){let t;this.transform.x=r.x+(e.pageX-e.downPageX)/this.scale,this.transform.y=r.y+(e.pageY-e.downPageY)/this.scale;let n={};if(this.snappingEnabled){let e,i;for(e=0;e<this.snapX.length;e++)t=Math.abs(this.transform.x-this.snapX[e]),t<this.minSnapDist/this.scale&&(!n.x||t<n.distX)&&(n.x=this.snapX[e],n.distX=t);for(e=0;e<this.snapY.length;e++)t=Math.abs(this.transform.y-this.snapY[e]),t<this.minSnapDist/this.scale&&(!n.y||t<n.distY)&&(n.y=this.snapY[e],n.distY=t);for(e=0;e<4;e++){let r;for(i=at(this.corners[e].x,this.corners[e].y,this.transform),r=0;r<this.snapX.length;r++)t=Math.abs(i.x-this.snapX[r]),t<this.minSnapDist/this.scale&&(!n.x||t<n.distX)&&(n.x=this.snapX[r]-(i.x-this.transform.x),n.distX=t);for(r=0;r<this.snapY.length;r++)t=Math.abs(i.y-this.snapY[r]),t<this.minSnapDist/this.scale&&(!n.y||t<n.distY)&&(n.y=this.snapY[r]-(i.y-this.transform.y),n.distY=t)}}if("shift"===this.keyListener.getComboStr()){let e=$.projectPointOnLine({x:0,y:r.y},{x:10,y:r.y},{x:this.transform.x,y:this.transform.y}),t=$.dist(e.x,e.y,this.transform.x,this.transform.y);n={},n.x=e.x,n.y=e.y,n.distX=t,n.distY=t,e=$.projectPointOnLine({x:r.x,y:0},{x:r.x,y:10},{x:this.transform.x,y:this.transform.y}),t=$.dist(e.x,e.y,this.transform.x,this.transform.y),t<n.distX&&(n.x=e.x,n.y=e.y,n.distX=t,n.distY=t),e=$.projectPointOnLine({x:r.x,y:r.y},{x:r.x+1,y:r.y+1},{x:this.transform.x,y:this.transform.y}),t=$.dist(e.x,e.y,this.transform.x,this.transform.y),t<n.distX&&(n.x=e.x,n.y=e.y,n.distX=t,n.distY=t),e=$.projectPointOnLine({x:r.x,y:r.y},{x:r.x+1,y:r.y-1},{x:this.transform.x,y:this.transform.y}),t=$.dist(e.x,e.y,this.transform.x,this.transform.y),t<n.distX&&(n.x=e.x,n.y=e.y,n.distX=t,n.distY=t)}null!=n.x&&(this.transform.x=n.x),null!=n.y&&(this.transform.y=n.y),Math.abs(this.transform.angleDeg)%90==0&&(nt(this.transform),this.updateCornerPositions()),this.updateDOM()}}});for(let e=0;e<4;e++)(e=>{const t=this.corners[e]={i:e,el:$.el({css:{width:this.gripSize+"px",height:this.gripSize+"px",background:"#fff",borderRadius:this.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,virtualPos:{x:0,y:0},updateDOM:null,pointerListener:null};t.updateDOM=()=>{const n=[[-1,-1],[1,-1],[1,1],[-1,1]].map((e=>(e[0]*=this.transform.width>0?1:-1,e[1]*=this.transform.height>0?1:-1,e))),i=Math.abs(this.scaled.width)<20||Math.abs(this.scaled.height)<20?10:0;$.css(t.el,{left:this.scaled.corners[t.i].x-this.gripSize/2+n[e][0]*i+"px",top:this.scaled.corners[t.i].y-this.gripSize/2+n[e][1]*i+"px"});let r=$.pointsToAngleDeg({x:this.transform.x,y:this.transform.y},at(t.x,t.y,this.transform))+135;for(;r<0;)r+=360;let a=Math.round(r/45)%this.cornerCursors.length;$.css(t.el,{cursor:this.cornerCursors[a]+"-resize"})},t.pointerListener=new $.PointerListener({target:this.corners[e].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointerdown"===t.type&&"left"===t.button)this.corners[e].virtualPos=at(this.corners[e].x,this.corners[e].y,this.transform);else if("pointermove"===t.type&&"left"===t.button){this.corners[e].virtualPos.x+=t.dX/this.scale,this.corners[e].virtualPos.y+=t.dY/this.scale;let n={x:this.corners[e].virtualPos.x,y:this.corners[e].virtualPos.y};n=this.constrainCorner(e,n.x,n.y),this.isConstrained||(n=this.snapCorner(n.x,n.y)),Math.abs(this.transform.angleDeg)%90==0&&(n.x=Math.round(n.x),n.y=Math.round(n.y));const i=rt(n.x,n.y,this.transform),r=i.x-this.corners[e].x,a=i.y-this.corners[e].y;this.corners[e].x=i.x,this.corners[e].y=i.y;let o=[];0===e?o=[3,1,2]:1===e?o=[2,0,3]:2===e?o=[1,3,0]:3===e&&(o=[0,2,1]),this.corners[o[0]].x=this.corners[e].x,this.corners[o[1]].y=this.corners[e].y,this.keyListener.isPressed("shift")&&(this.corners[o[2]].x-=r,this.corners[o[2]].y-=a,this.corners[o[1]].x=this.corners[o[2]].x,this.corners[o[0]].y=this.corners[o[2]].y),this.updateTransformViaCorners()}}})})(e);this.updateCornerPositions(),this.updateScaled();for(let e=0;e<4;e++)(e=>{this.edges[e]={el:$.el({css:{width:this.edgeSize+"px",height:this.edgeSize+"px",position:"absolute"}}),updateDOM:null,pointerListener:null};const n=this.edges[e];n.updateDOM=()=>{0===e?$.css(n.el,{left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)-this.edgeSize+"px",width:Math.abs(this.scaled.width)+"px",height:this.edgeSize+"px"}):1===e?$.css(n.el,{left:Math.max(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[1].y,this.scaled.corners[2].y)+"px",width:this.edgeSize+"px",height:Math.abs(this.scaled.height)+"px"}):2===e?$.css(n.el,{left:Math.min(this.scaled.corners[3].x,this.scaled.corners[2].x)+"px",top:Math.max(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px",width:Math.abs(this.scaled.width)+"px",height:this.edgeSize+"px"}):3===e&&$.css(n.el,{left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)-this.edgeSize+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px",width:this.edgeSize+"px",height:Math.abs(this.scaled.height)+"px"});let t=Math.round(this.transform.angleDeg/45);for(;t<0;)t+=8;t=(2*e+1+t)%this.cornerCursors.length,n.el.style.cursor=this.cornerCursors[t]+"-resize"};const r=[0,2].includes(e);n.pointerListener=new $.PointerListener({target:this.edges[e].el,fixScribble:!0,onPointer:n=>{if(n.eventPreventDefault(),"pointerdown"===n.type&&"left"===n.button&&(i=r?this.corners[0].y>=this.corners[3].y:this.corners[0].x>=this.corners[1].x,t.x=0,t.y=0),"pointermove"===n.type&&"left"===n.button){const a=$.rotateAround({x:0,y:0},{x:n.dX/this.scale,y:n.dY/this.scale},-this.transform.angleDeg);let o={dX:a.x,dY:a.y};Math.abs(this.transform.angleDeg)%90==0&&(o=$.intDxy(t,a.x,a.y));let s=[];0===e?s=[2,3,0,1]:1===e?s=[0,3,1,2]:2===e?s=[0,1,2,3]:3===e&&(s=[1,2,0,3]);let l=r?"y":"x",h=r?o.dY:o.dX;i?(this.corners[s[0]][l]+=h,this.corners[s[1]][l]+=h):(this.corners[s[2]][l]+=h,this.corners[s[3]][l]+=h),this.keyListener.isPressed("shift")&&(i?(this.corners[s[2]][l]-=h,this.corners[s[3]][l]-=h):(this.corners[s[0]][l]-=h,this.corners[s[1]][l]-=h)),r?this.restoreRatio(!1,!0):this.restoreRatio(!0,!1),this.updateTransformViaCorners()}}})})(e);this.angleGrip={el:$.el({css:{cursor:"url("+n(tt)+") 10 10, move",width:this.gripSize+"px",height:this.gripSize+"px",background:"#0ff",borderRadius:this.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,snap:!1,updateDOM:()=>{$.css(this.angleGrip.el,{left:this.angleGrip.x-this.gripSize/2+"px",top:this.angleGrip.y-this.gripSize/2+"px"})}},$.el({parent:this.angleGrip.el,css:{width:"2px",height:"13px",left:this.gripSize/2-1+"px",top:this.gripSize+"px",background:"#0ff",position:"absolute"}}),this.anglePointerListener=new $.PointerListener({target:this.angleGrip.el,fixScribble:!0,onPointer:e=>{if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const t=this.rootEl.getBoundingClientRect(),n={x:t.left-this.rootEl.scrollLeft,y:t.top-this.rootEl.scrollTop},i={x:(e.clientX-n.x)/this.scale,y:(e.clientY-n.y)/this.scale},r=$.pointsToAngleDeg({x:this.transform.x,y:this.transform.y},i)+90;this.transform.angleDeg=r;const a=45*Math.round(r/360*8);("shift"===this.keyListener.getComboStr()||this.snappingEnabled&&Math.abs(a-r)<8)&&(this.transform.angleDeg=a),this.updateDOM()}"pointerup"===e.type&&Math.abs(this.transform.angleDeg)%90==0&&(nt(this.transform),this.updateCornerPositions(),this.updateDOM())}}),nt(this.transform),this.updateDOM(!0),$.append(this.transEl,[this.boundsEl,this.edges[0].el,this.edges[1].el,this.edges[2].el,this.edges[3].el,this.corners[0].el,this.corners[1].el,this.corners[2].el,this.corners[3].el,this.angleGrip.el])}}function st(e){let t=$.fitInto(e.imageWidth,e.imageHeight,e.elementWidth-20,e.elementHeight-60,1),n=t.width/e.imageWidth,i=$.el({css:{width:e.elementWidth+"px",height:e.elementHeight+"px",backgroundColor:"#9e9e9e",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",userSelect:"none",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"}});i.oncontextmenu=function(){return!1};let r=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:t.width+"px",height:t.height+"px"}});i.appendChild(r);let a=e.layers.map((e=>({image:e.image,mixModeStr:e.mixModeStr,opacity:e.opacity})));a[a.length-1].image=$.canvas(n>1?e.imageWidth:t.width,n>1?e.imageHeight:t.height);let o,s,l=new et({width:t.width,height:t.height,layers:a});function h(){if(!o)return;let t=o.getTransform();n<1&&(t.x*=n,t.y*=n,t.width*=n,t.height*=n);let i=a[e.transformIndex].image,r=i.getContext("2d");r.save(),r.clearRect(0,0,i.width,i.height),$.drawTransformedImageWithBounds(r,e.layers[e.transformIndex].image,t,null,$.testShouldPixelate(t,t.width/s.width,t.height/s.height)),r.restore(),l.render()}r.appendChild(l.getElement());{let i={width:e.layers[e.transformIndex].image.width*n,height:e.layers[e.transformIndex].image.height*n};(i.width>t.width||i.height>t.height)&&(i=$.fitInto(e.layers[e.transformIndex].image.width,e.layers[e.transformIndex].image.height,t.width,t.height,1)),s={x:e.imageWidth/2,y:e.imageHeight/2,width:e.layers[e.transformIndex].image.width,height:e.layers[e.transformIndex].image.height},o=new ot({x:s.x,y:s.y,width:s.width,height:s.height,angleDeg:0,isConstrained:!0,snapX:[0,e.imageWidth],snapY:[0,e.imageHeight],scale:n,callback:e=>{h()}})}$.css(o.getElement(),{position:"absolute",left:"0",top:"0"}),r.appendChild(o.getElement()),setTimeout(h,0),this.move=function(e,t){o.move(e,t)},this.reset=function(){let t=e.layers[e.transformIndex].image.width,n=e.layers[e.transformIndex].image.height;o.setSize(t,n),o.setPos({x:t/2,y:n/2}),o.setAngleDeg(0),h()},this.setTransformFit=function(){let t=$.fitInto(e.layers[e.transformIndex].image.width,e.layers[e.transformIndex].image.height,e.imageWidth,e.imageHeight,1);o.setSize(t.width,t.height),o.setPos({x:t.width/2,y:t.height/2}),o.setAngleDeg(0),h()},this.setTransformCenter=function(){o.setPos({x:e.imageWidth/2,y:e.imageHeight/2}),o.setAngleDeg(0),h()},this.getTransformation=function(){return!!o&&o.getTransform()},this.getIsPixelated=()=>{const e=o.getTransform();return $.testShouldPixelate(e,e.width/s.width,e.height/s.height)},this.getElement=function(){return i},this.destroy=function(){o.destroy()}}function lt(e){let t=e.x,n=e.y,i=e.width,r=e.height,a=e.scale,o=e.callback,s=e.maxW,l=e.maxH,h=document.createElement("div"),c=["nw","n","ne","e","se","s","sw","w"],d=new $.KeyListener({});$.css(h,{position:"absolute",left:t*a+"px",top:n*a+"px"});let u=document.createElement("div");$.css(u,{position:"absolute",border:"1px dashed #fff",cursor:"move"}),u.update=function(){$.css(u,{left:x[0].x*a-1+"px",top:x[0].y*a-1+"px",width:(x[2].x-x[0].x)*a+"px",height:(x[2].y-x[0].y)*a+"px"})};let p={x:0,y:0},g=new $.PointerListener({target:u,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);x[0].x+=t,x[0].y+=n,x[1].x+=t,x[1].y+=n,x[2].x+=t,x[2].y+=n,x[3].x+=t,x[3].y+=n,z()}"pointerup"===e.type&&S()}}),m=document.createElement("div");$.css(m,{position:"absolute",borderTop:"1px solid #0ff",borderBottom:"1px solid #0ff"}),m.update=function(){$.css(m,{left:x[0].x*a+"px",top:(x[0].y+(x[2].y-x[0].y)/3)*a+"px",width:(x[2].x-x[0].x)*a+"px",height:(x[2].y-x[0].y)/3*a+"px"})};let f=document.createElement("div");$.css(f,{position:"absolute",borderLeft:"1px solid #0ff",borderRight:"1px solid #0ff"}),f.update=function(){$.css(f,{left:(x[0].x+(x[2].x-x[0].x)/3)*a+"px",top:x[0].y*a+"px",width:(x[2].x-x[0].x)/3*a+"px",height:(x[2].y-x[0].y)*a+"px"})};const y=10;let x=[{x:0,y:0},{x:i,y:0},{x:i,y:r},{x:0,y:r}];function b(e){x[0].y+=e,x[0].y=Math.max(x[3].y-l,Math.min(x[3].y-1,x[0].y)),x[1].y=x[0].y}function v(e){x[1].x+=e,x[1].x=Math.min(x[0].x+s,Math.max(x[0].x+1,x[1].x)),x[2].x=x[1].x}function w(e){x[2].y+=e,x[2].y=Math.min(x[1].y+l,Math.max(x[1].y+1,x[2].y)),x[3].y=x[2].y}function C(e){x[0].x+=e,x[0].x=Math.max(x[1].x-s,Math.min(x[1].x-1,x[0].x)),x[3].x=x[0].x}function S(){p.x=0,p.y=0,o(B())}let E=[];for(let e=0;e<4;e++)!function(e){E[e]=document.createElement("div");let t=E[e];t.style.width="40px",t.style.height="40px",t.style.position="absolute",t.update=function(){0===e?(t.style.left=x[0].x*a+y+"px",t.style.top=x[0].y*a-80+y+"px",t.style.width=(x[1].x-x[0].x)*a-20+"px",t.style.height="80px"):1===e?(t.style.left=x[1].x*a-y+"px",t.style.top=x[1].y*a+y+"px",t.style.width="80px",t.style.height=(x[2].y-x[1].y)*a-20+"px"):2===e?(t.style.left=x[3].x*a+y+"px",t.style.top=x[3].y*a-y+"px",t.style.width=(x[2].x-x[3].x)*a-20+"px",t.style.height="80px"):3===e&&(t.style.left=x[0].x*a-80+y+"px",t.style.top=x[0].y*a+y+"px",t.style.width="80px",t.style.height=(x[3].y-x[0].y)*a-20+"px");let n=2*e+1;t.style.cursor=c[n]+"-resize"}}(e);let M=[];for(let e=0;e<4;e++)!function(e){M[e]=document.createElement("div");let t=M[e];t.style.position="absolute",t.style.background="#000",t.style.opacity="0.5",t.update=function(){0===e?(t.style.left=x[0].x*a+"px",t.style.top=x[0].y*a-8e3+"px",t.style.width=(x[1].x-x[0].x)*a+"px",t.style.height="8000px"):1===e?(t.style.left=x[1].x*a+"px",t.style.top=x[1].y*a-8e3+"px",t.style.width="8000px",t.style.height="16000px"):2===e?(t.style.left=x[3].x*a+"px",t.style.top=x[3].y*a+"px",t.style.width=(x[2].x-x[3].x)*a+"px",t.style.height="8000px"):3===e&&(t.style.left=x[0].x*a-8e3+"px",t.style.top=x[0].y*a-8e3+"px",t.style.width="8000px",t.style.height="16000px")}}(e);let k=new $.PointerListener({target:E[0],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);b(n),d.isPressed("shift")&&w(-n),z()}"pointerup"===e.type&&S()}}),I=new $.PointerListener({target:E[1],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);v(t),d.isPressed("shift")&&C(-t),z()}"pointerup"===e.type&&S()}}),T=new $.PointerListener({target:E[2],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);w(n),d.isPressed("shift")&&b(-n),z()}"pointerup"===e.type&&S()}}),L=new $.PointerListener({target:E[3],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);C(t),d.isPressed("shift")&&v(-t),z()}"pointerup"===e.type&&S()}}),R=[];!function(){for(let e=0;e<4;e++)!function(e){R[e]=document.createElement("div");let t=R[e];$.css(t,{width:"80px",height:"80px",position:"absolute"}),t.style.cursor=["nwse-resize","nesw-resize"][e%2],t.update=function(){0===e?$.css(t,{left:x[0].x*a-80+y+"px",top:x[0].y*a-80+y+"px"}):1===e?$.css(t,{left:x[1].x*a-y+"px",top:x[1].y*a-80+y+"px"}):2===e?$.css(t,{left:x[1].x*a-y+"px",top:x[2].y*a-y+"px"}):3===e&&$.css(t,{left:x[0].x*a-80+y+"px",top:x[2].y*a-y+"px"})}}(e)}();let A=new $.PointerListener({target:R[0],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);C(t),b(n),d.isPressed("shift")&&(v(-t),w(-n)),z()}"pointerup"===e.type&&S()}}),P=new $.PointerListener({target:R[1],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);v(t),b(n),d.isPressed("shift")&&(C(-t),w(-n)),z()}"pointerup"===e.type&&S()}}),D=new $.PointerListener({target:R[2],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);v(t),w(n),d.isPressed("shift")&&(C(-t),b(-n)),z()}"pointerup"===e.type&&S()}}),O=new $.PointerListener({target:R[3],fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){const{dX:t,dY:n}=$.intDxy(p,e.dX/a,e.dY/a);C(t),w(n),d.isPressed("shift")&&(v(-t),b(-n)),z()}"pointerup"===e.type&&S()}});function B(){return x[1].x-=x[0].x,x[1].y-=x[0].y,x[2].x-=x[0].x,x[2].y-=x[0].y,x[3].x-=x[0].x,x[3].y-=x[0].y,t+=x[0].x,n+=x[0].y,x[0].x=0,x[0].y=0,{x:t,y:n,width:x[1].x,height:x[2].y}}function z(){E[0].update(),E[1].update(),E[2].update(),E[3].update(),R[0].update(),R[1].update(),R[2].update(),R[3].update(),M[0].update(),M[1].update(),M[2].update(),M[3].update(),u.update(),m.update(),f.update()}h.append(M[1],M[0],M[2],M[3],m,f,u,E[1],E[0],E[2],E[3],R[0],R[1],R[2],R[3]),z(),this.getTransform=B,this.setTransform=function(e){t=e.x,n=e.y,i=e.width,r=e.height,$.css(h,{left:t*a+"px",top:n*a+"px"}),x[0].x=0,x[0].y=0,x[1].x=i,x[1].y=0,x[2].x=i,x[2].y=r,x[3].x=0,x[3].y=r,z(),S()},this.setScale=function(e){a=e,$.css(h,{left:t*a+"px",top:n*a+"px"}),z()},this.showThirds=function(e){e?(m.style.display="block",f.style.display="block"):(m.style.display="none",f.style.display="none")},this.getElement=function(){return h},this.destroy=function(){d.destroy(),g.destroy(),A.destroy(),P.destroy(),D.destroy(),O.destroy(),k.destroy(),I.destroy(),T.destroy(),L.destroy()}}var ht;ht=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("4YStb");var ct;ct=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("fzcgF");var dt;dt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("dIqQQ");var ut;ut=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("2tMSi");var pt;pt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("3RMaM");var gt;gt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("jAUep");var mt;mt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("56U6t");var ft;ft=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("eIuuU");var yt;yt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("6yNrb");var xt;xt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("8kiCe");var bt;function vt(e){let t=["draw","fill","text","shape"],i=[n(mt),n(ft),n(yt),n(xt)],r=[`${ce("tool-brush")} [B]`,`${ce("tool-paint-bucket")} [G]`,`${ce("tool-text")} [T]`,`${ce("tool-shape")} [U]`],a=0,o=!0,s=!1;setTimeout((function(){for(let e=1;e<i.length;e++){(new Image).src=i[e]}}),100);let l,h,c,d,u="6px 0",p=$.el({css:{position:"relative",flexGrow:"1"}}),g=!1;$.hasPointerEvents&&(d=new $.PointerListener({target:p,maxPointers:1,onPointer:function(n){if("pointerdown"===n.type){if(s)return;l=setTimeout((function(){S()}),400),g=!0,h=n.pageX,c=n.pageY}else if("pointermove"===n.type)g&&!s&&$.dist(h,c,n.pageX,n.pageY)>5&&(clearTimeout(l),S());else if("pointerup"===n.type){if(clearTimeout(l),s&&g){let i=document.elementFromPoint(n.pageX,n.pageY);for(let n=0;n<v.length;n++)if(i===v[n].wrapper){E(),o=!0,a=n,M(),e.onChange(t[a]);break}}g=!1}}}));let m=$.el({parent:p,className:"toolspace-row-button nohighlight toolspace-row-button-activated",title:r[a],onClick:function(n){if(o&&!s)return n.preventDefault(),n.stopPropagation(),void S();o=!0,e.onChange(t[a]),s&&E()},css:{padding:"10px 0",pointerEvents:"auto",height:"100%",boxSizing:"border-box"}}),f=$.el({parent:m,css:{backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",width:"calc(100% - 7px)",height:"100%",pointerEvents:"none",opacity:"0.75"}}),y=$.el({parent:m,css:{position:"absolute",right:"1px",bottom:"1px",width:"18px",height:"18px",cursor:"pointer",backgroundImage:"url('"+n(bt)+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"60%"},title:"More Tools",onClick:function(e){e.preventDefault(),e.stopPropagation(),S()}}),x=$.el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}}),b=(new $.PointerListener({target:x,pointers:1,onPointer:function(e){"pointerdown"===e.type&&(e.eventPreventDefault(),E())}}),$.el({className:"tool-dropdown-wrapper",css:{position:"absolute",width:"100%",height:100*(t.length-1)+"%",top:"100%",left:"0",zIndex:"1",boxSizing:"border-box",cursor:"pointer",transition:"height 0.1s ease-in-out, opacity 0.1s ease-in-out",borderBottomLeftRadius:"5px",borderBottomRightRadius:"5px",overflow:"hidden"}})),v=[];function w(e){let n={},i=$.el({parent:b,className:"tool-dropdown-button",title:e.title,css:{padding:"10px 0",height:100/(t.length-1)+"%",boxSizing:"border-box"},onClick:function(t){t.preventDefault(),t.stopPropagation(),e.onClick(e.index,e.id)}});n.wrapper=i;$.el({parent:i,css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",height:"100%",pointerEvents:"none",opacity:"0.75"}});return n.show=function(e){i.style.display=e?"block":"none"},n.setIsSmall=function(e){i.style.padding=e?u:"10px 0"},n}function C(n,i){E(),o=!0,a=n,M(),e.onChange(t[a])}for(let e=0;e<t.length;e++)v.push(w({index:e,id:t[e],image:i[e],title:r[e],onClick:C}));function S(){ne.increase(.5),s=!0;for(let e=0;e<t.length;e++)v[e].show(a!==e);y.style.display="none",p.style.zIndex="1",e.klRootEl.appendChild(x),p.appendChild(b)}function E(){ne.decrease(.5),s=!1,y.style.removeProperty("display"),p.style.removeProperty("z-index"),e.klRootEl.removeChild(x),p.removeChild(b)}function M(){m.title=r[a],f.style.backgroundImage="url('"+i[a]+"')"}M(),this.setIsSmall=function(e){m.style.padding=e?u:"10px 0";for(let n=0;n<t.length;n++)v[n].setIsSmall(e);e?(y.style.width="14px",y.style.height="14px"):(y.style.width="18px",y.style.height="18px")},this.setActive=function(e){if(t.includes(e)){o=!0;for(let n=0;n<t.length;n++)if(t[n]===e){a=n;break}$.addClassName(m,"toolspace-row-button-activated"),M()}else o=!1,$.removeClassName(m,"toolspace-row-button-activated")},this.getActive=function(){return t[a]},this.getElement=function(){return p}}bt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("gHvP9");var wt;wt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("gmsxC");var Ct;Ct=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("jR3G5");var St;St=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("biC0V");var Et;Et=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("aCQri");var Mt;Mt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("i15sm");var kt;kt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("iANcq");var It;It=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("iqarf");var Tt;Tt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("luRWX");var Lt;Lt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("k4Bji");var Rt;Rt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hHMHE");var At;At=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("cuTT0");var Pt;Pt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("imQcV");var Dt={};let Ot,Bt;function zt(){if(Ot)return;Ot={"source-over":"normal",darken:"darken",multiply:"multiply","color-burn":"color burn",lighten:"lighten",screen:"screen","color-dodge":"color dodge",overlay:"overlay","soft-light":"soft light","hard-light":"hard light",difference:"difference",exclusion:"exclusion",hue:"hue",saturation:"saturation",color:"color",luminosity:"luminosity"},Bt={};let e=Object.keys(Ot);for(let t=0;t<e.length;t++)Bt[Ot[e[t]]]=e[t]}function Ht(e){return zt(),Bt[e]}function Ft(e){return zt(),Ot[e]}function jt(e){let t={type:"psd",canvas:e.canvas,width:e.width,height:e.height};function n(e){t.warningArr||(t.warningArr=[]),t.warningArr.includes(e)||t.warningArr.push(e)}function i(e){let t=Ht(e);return t||(n("blend-mode"),t="source-over"),t}if(8!==e.bitsPerChannel&&n("bits-per-channel"),!e.children)return t.error=!0,t;let r=0;if(r+=function e(t){let i=0;if(t.blendMode){let e=Ht(t.blendMode);if(e&&"source-over"!==e)return 1}for(let r=0;r<t.children.length;r++){let a=t.children[r];a.clipping||a.adjustment||(a.children?(n("group"),i+=e(a)):i++)}return i}(e),r>16)return t.error=!0,t;function a(e,t){const n=e.getContext("2d");let i=n.getImageData(0,0,e.width,e.height);if(0===t)for(let e=0;e<i.data.length;e+=4)i.data[e+3]=i.data[e];else for(let e=0;e<i.data.length;e+=4)i.data[e+3]=255-i.data[e];n.putImageData(i,0,0)}return t.layers=[],t.layers=function e(r){let s,l,h=[],c=r.hidden?0:r.opacity,d=i(r.blendMode);"source-over"!==d&&(s=o(t.width,t.height),l=s.getContext("2d")),r.mask&&(n("mask"),a(r.mask.canvas,r.mask.defaultColor));for(let d=0;d<r.children.length;d++){let u=r.children[d];if(u.clipping)continue;if(u.adjustment){n("adjustment");continue}let p=(u.children||u.canvas)&&r.children[d+1]&&r.children[d+1].clipping;if(p&&n("clipping"),u.children){let n=e(u);for(let e=0;e<n.length;e++){let a=n[e],u=a.image.getContext("2d");if(p){let e=o(t.width,t.height),n=e.getContext("2d");n.drawImage(a.image,0,0);for(let e=d+1;e<r.children.length&&r.children[e].clipping;e++){let t=r.children[e];0===t.opacity||t.hidden||(n.globalCompositeOperation=i(t.blendMode),n.globalAlpha=t.opacity,n.drawImage(t.canvas,t.left,t.top))}u.globalCompositeOperation="source-atop",u.drawImage(e,0,0)}r.mask&&(u.globalCompositeOperation=0===r.mask.defaultColor?"destination-in":"destination-out",u.drawImage(r.mask.canvas,r.mask.left,r.mask.top)),s?(l.globalCompositeOperation=a.mixModeStr,l.globalAlpha=a.opacity,l.drawImage(a.image,0,0)):(a.opacity=a.opacity*c,h.push(a))}continue}let g=o(t.width,t.height),m=g.getContext("2d");if(u.canvas&&m.drawImage(u.canvas,u.left,u.top),u.effects&&n("layer-effect"),u.mask&&(n("mask"),a(u.mask.canvas,u.mask.defaultColor),m.globalCompositeOperation=0===u.mask.defaultColor?"destination-in":"destination-out",m.drawImage(u.mask.canvas,u.mask.left,u.mask.top)),p){let e=o(u.right-u.left,u.bottom-u.top),t=e.getContext("2d");t.drawImage(u.canvas,0,0);for(let e=d+1;e<r.children.length&&r.children[e].clipping;e++){let n=r.children[e];0===n.opacity||n.hidden||(t.globalCompositeOperation=i(n.blendMode),t.globalAlpha=n.opacity,t.drawImage(n.canvas,n.left-u.left,n.top-u.top))}m.globalCompositeOperation="source-atop",m.drawImage(e,u.left,u.top)}r.mask&&(m.globalCompositeOperation=0===r.mask.defaultColor?"destination-in":"destination-out",m.drawImage(r.mask.canvas,r.mask.left,r.mask.top)),s?c>0&&(l.globalCompositeOperation=i(u.blendMode),l.globalAlpha=u.hidden?0:u.opacity,l.drawImage(g,0,0)):h.push({name:u.name,opacity:(u.hidden?0:u.opacity)*c,mixModeStr:i(u.blendMode),image:g})}return s&&(h=[{name:r.name,opacity:c,mixModeStr:d,image:s}]),h}({name:"root",opacity:1,blendMode:"normal",children:e.children}),t}function _t(e){const t={width:e.width,height:e.height,layers:[]};return e.layers?t.layers=t.layers.concat(e.layers.map((e=>({name:e.name,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e.image})))):t.layers.push({name:ce("background"),opacity:1,mixModeStr:"source-over",image:e.canvas}),t}e(Dt,"blendPsdToKl",(function(){return Ht})),e(Dt,"blendKlToPsd",(function(){return Ft})),e(Dt,"readPsd",(function(){return jt})),e(Dt,"klPsdToKlProject",(function(){return _t}));var Nt={};e(Nt,"setDbName",(function(){return Yt})),e(Nt,"getKlProjectObj",(function(){return Wt})),e(Nt,"storeKlProjectObj",(function(){return Gt})),e(Nt,"clear",(function(){return Kt}));const Ut=!!window.indexedDB;let Xt="Klecks";function Yt(e){Xt=""+e}function Vt(e,t,n){let i,r=!1;function a(e){r||(r=!0,n(e))}if(Ut){try{i=window.indexedDB.open(Xt,1)}catch(e){return void a(e.message)}i.onupgradeneeded=function(e){try{i.result.createObjectStore("ProjectStore",{keyPath:"id"}).createIndex("id","id",{unique:!0})}catch(e){a(e.message)}},i.onerror=function(e){a("indexedDB.open failed, "+i.error)},i.onsuccess=function(n){let o,s,l;try{if(o=i.result,!o.objectStoreNames.contains("ProjectStore"))return window.indexedDB.deleteDatabase(Xt),void a("object store ProjectStore missing. destroying db");s=o.transaction("ProjectStore","readwrite"),l=s.objectStore("ProjectStore"),l.index("id")}catch(e){return void a(e.message)}o.onerror=function(e){a("database error, "+o.error)};try{e(l)}catch(e){return void a(e.message)}s.oncomplete=function(){r||(r=!0,t()),o.close()},s.onerror=function(){a("transaction error, "+s.error)}}}else setTimeout((function(){a("no indexed db available")}),0)}function Wt(e,t){if(Ut){let n;Vt((function(e){n=e.get(1)}),(function(){e(n.result)}),(function(e){t("execIndexedDBTransaction error, "+e)}))}else e(null)}function Gt(e,t,n){Vt((function(t){t.put(e)}),(function(){t()}),(function(e){n(e)}))}function Kt(e,t){Vt((function(e){e.delete(1)}),(function(){e()}),(function(e){t(e)}))}var Qt;Qt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("bmX7i");var qt;qt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("Jn76X");var Jt;Jt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("gHP76");var $t;$t=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("f8hRy");var Zt;Zt=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("8toNK");var en;en=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("eUjmu");var tn;tn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("cPSrp");var nn;nn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hh6aB");var rn;rn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("ka4gi");var an;an=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("du2Qb");var on;on=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("6TXqp");var sn;sn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("geGLu");var ln;ln=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("jENHo");const hn={isLoaded:!1},cn={glBrightnessContrast:{lang:{name:"filter-bright-contrast-title",button:"filter-bright-contrast"},name:"",buttonLabel:"",webgl:!0,updateContext:!0,icon:n(Qt),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},cropExtend:{lang:{name:"filter-crop-title",button:"filter-crop-extend"},name:"",buttonLabel:"",icon:n(qt),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!0,getDialog:null,apply:null,inEmbed:!1},glCurves:{lang:{name:"filter-curves-title",button:"filter-curves"},name:"",buttonLabel:"",icon:n(Jt),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},flip:{lang:{name:"filter-flip-title",button:"filter-flip"},name:"",buttonLabel:"",icon:n($t),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},glHueSaturation:{lang:{name:"filter-hue-sat-title",button:"filter-hue-sat"},name:"",buttonLabel:"",icon:n(Zt),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},invert:{lang:{name:"filter-invert",button:"filter-invert"},name:"",icon:n(en),webgl:!0,updateContext:!0,updatePos:!1,isInstant:!0,getDialog:null,apply:null,inEmbed:!0},glPerspective:{lang:{name:"filter-perspective-title",button:"filter-perspective"},name:"",buttonLabel:"",icon:n(tn),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},resize:{lang:{name:"filter-resize-title",button:"filter-resize"},name:"",buttonLabel:"",icon:n(nn),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!0,getDialog:null,apply:null,inEmbed:!1},rotate:{lang:{name:"filter-rotate-title",button:"filter-rotate"},name:"",buttonLabel:"",icon:n(kt),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!0,getDialog:null,apply:null,inEmbed:!1},glTiltShift:{lang:{name:"filter-tilt-shift-title",button:"filter-tilt-shift"},name:"",buttonLabel:"",icon:n(rn),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},toAlpha:{lang:{name:"filter-to-alpha-title",button:"filter-to-alpha"},name:"",buttonLabel:"",icon:n(an),webgl:!0,updateContext:!1,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},transform:{lang:{name:"filter-transform-title",button:"filter-transform"},name:"",buttonLabel:"",icon:n(on),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!1,ieFails:!0,getDialog:null,apply:null,inEmbed:!0},glBlur:{lang:{name:"filter-triangle-blur-title",button:"filter-triangle-blur"},name:"",buttonLabel:"",icon:n(sn),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},glUnsharpMask:{lang:{name:"filter-unsharp-mask-title",button:"filter-unsharp-mask"},name:"",buttonLabel:"",icon:n(ln),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0}};function dn(){Object.keys(cn).forEach((e=>{cn[e].name=ce(cn[e].lang.name),cn[e].buttonLabel=ce(cn[e].lang.button)}))}dn(),he.subscribe((()=>{dn()}));const un={};function pn(e,t,n){this.x=e,this.y=t,this.z=n}pn.prototype.dot2=function(e,t){return this.x*e+this.y*t};let gn=[new pn(1,1,0),new pn(-1,1,0),new pn(1,-1,0),new pn(-1,-1,0),new pn(1,0,1),new pn(-1,0,1),new pn(1,0,-1),new pn(-1,0,-1),new pn(0,1,1),new pn(0,-1,1),new pn(0,1,-1),new pn(0,-1,-1)],mn=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],fn=new Array(512),yn=new Array(512);un.seed=function(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(let t=0;t<256;t++){let n;n=1&t?mn[t]^255&e:mn[t]^e>>8&255,fn[t]=fn[t+256]=n,yn[t]=yn[t+256]=gn[n%12]}},un.seed(0);let xn=.5*(Math.sqrt(3)-1),bn=(3-Math.sqrt(3))/6;un.simplex2=function(e,t){let n,i,r,a,o,s=(e+t)*xn,l=Math.floor(e+s),h=Math.floor(t+s),c=(l+h)*bn,d=e-l+c,u=t-h+c;d>u?(a=1,o=0):(a=0,o=1);let p=d-a+bn,g=u-o+bn,m=d-1+2*bn,f=u-1+2*bn;l&=255,h&=255;let y=yn[l+fn[h]],x=yn[l+a+fn[h+o]],b=yn[l+1+fn[h+1]],v=.5-d*d-u*u;v<0?n=0:(v*=v,n=v*v*y.dot2(d,u));let w=.5-p*p-g*g;w<0?i=0:(w*=w,i=w*w*x.dot2(p,g));let C=.5-m*m-f*f;return C<0?r=0:(C*=C,r=C*C*b.dot2(m,f)),70*(n+i+r)};const vn=un;function wn(e){const t=e/500,n=e,i=$.canvas(e,n),r=i.getContext("2d"),a=r.createImageData(e,n);for(let i=0;i<e;i++)for(let r=0;r<n;r++){let o=4*(r*e+i);const s=t+.04*vn.simplex2(i/50/t,r/50/t);let l=100+(vn.simplex2(i/50/s,r/50/s)+1)/2*100;l-=(vn.simplex2(i/10/t,r/10/t)+1)/2*100;const h=$.dist(e/2,n/2,i,r);l*=$.clamp(1-((h-e/2.5)/(e/14)+vn.simplex2(i/22/s,r/22/s)),0,1);l*=2*$.clamp(1-h/e,0,1),a.data[o]=0,a.data[o+1]=0,a.data[o+2]=0,a.data[o+3]=$.clamp(l,0,255)}return r.putImageData(a,0,0),i}function Cn(e,t,n){let i=$.Vec2.sub(n,t),r=$.Vec2.sub(e,t),a=$.clamp($.Vec2.dot(r,i)/$.Vec2.dot(i,i),0,1);return $.Vec2.len($.Vec2.sub(r,$.Vec2.mul(i,a)))}function Sn(e){const t=.25;let n=2/3,i=1/3;n*=t,i*=t;const r={x:t*e,y:e-e*t},a={x:e-e*t,y:t*e},o=e,s=$.canvas(e,o);let l=s.getContext("2d");const h=l.createImageData(e,o);for(let t=0;t<e;t++)for(let n=0;n<o;n++){const i=4*(n*e+t);let o=Cn({x:t,y:n},r,a);o=$.clamp(255-(o-.16666666666666666*e)/(.08333333333333333*e)*255,0,255),h.data[i]=0,h.data[i+1]=0,h.data[i+2]=0,h.data[i+3]=o}return l.putImageData(h,0,0),s}const En=[];En[1]=wn(128),En[2]=Sn(128);function Mn(e,t,n){return e<=t?t:e>=n?n:e}const kn=$.canvas(32,32),In=kn.getContext("2d");function Tn(e,t){const n=(t=$.copyObj(t)).brush.size,i=t.brush.center.x,r=t.brush.center.y;let a=t.aP.y*e.width+t.aP.x;const o=4*(t.bP.y*e.width+t.bP.x-a);let s=0;const l=n>30?1024:512,h=[];for(let e=0;e<l;e++)h[e]=(Math.random()-.5)/1.001+.5;const c=Math.max(3,Math.min(8,t.brush.size-8)),d=(a,o,d,u)=>{const p=$.dist(i,r,d,u),g=1-t.brush.opacity*(1-(y=1,(m=(p-(n-c))/c)<=(f=0)?f:m>=y?y:m));var m,f,y;if(1!==g){if(e.data[a+3])if(e.data[o+3]){let t;t=e.data[a+3]<e.data[o+3]?1-e.data[a+3]/e.data[o+3]*(1-g):e.data[o+3]/e.data[a+3]*g,e.data[o]=Math.floor($.mix(e.data[a],e.data[o+0],t)+h[s]),e.data[o+1]=Math.floor($.mix(e.data[a+1],e.data[o+1],t)+h[s]),e.data[o+2]=Math.floor($.mix(e.data[a+2],e.data[o+2],t)+h[s]),s=(s+1)%l}else e.data[o]=e.data[a+0],e.data[o+1]=e.data[a+1],e.data[o+2]=e.data[a+2];else;t.brush.alphaLock||(e.data[o+3]=Math.floor($.mix(e.data[a+3],e.data[o+3],g)+.5))}},u=4*t.bP.x,p=u+4*(t.size.w-1);if(t.aP.y<t.bP.y)for(let n=t.size.h-1,i=t.bP.y+t.size.h-1;n>=0;n--,i--){const r=(n+t.bP.y)*e.width*4;for(let e=p+r,n=p+r-o,a=t.bP.x+t.size.w-1;e>=u+r;e-=4,n-=4,a--)d(n,e,a,i)}else if(t.aP.y>t.bP.y)for(let n=0,i=t.bP.y;n<t.size.h;n++,i++){const r=(n+t.bP.y)*e.width*4;for(let e=p+r,n=p+r-o,a=t.bP.x+t.size.w-1;e>=u+r;e-=4,n-=4,a--)d(n,e,a,i)}else if(t.aP.x<t.bP.x)for(let n=t.size.h-1,i=t.bP.y+t.size.h-1;n>=0;n--,i--){const r=(n+t.bP.y)*e.width*4;for(let e=p+r,n=p+r-o,a=t.bP.x+t.size.w-1;e>=u+r;e-=4,n-=4,a--)d(n,e,a,i)}else for(let n=0,i=t.bP.y;n<t.size.h;n++,i++){const r=(n+t.bP.y)*e.width*4;for(let e=u+r,n=u+r-o,a=t.bP.x;e<p+r;e+=4,n+=4,a++)d(n,e,a,i)}}const Ln={PenBrush:function(){let e,t,n,i,r,a,o=new si.DecoyKlHistory,s=2,l=.8489,h=1,c=!0,d=!1,u=!1,p=0,g={x:0,y:0,pressure:0},m={x:0,y:0,pressure:0},f=!1,y=[1,.9,1,1],x=$.canvas(128,128),b=$.canvas(64,64),v=$.canvas(32,32),w=null,C=2*Math.PI,S=!1;function E(e){return h*(d?e*e:1)}function M(){if(0===p||3===p)return;let e,t=[[x,128],[b,64],[v,32]];for(let i=0;i<t.length;i++)e=t[i][0].getContext("2d"),e.save(),e.clearRect(0,0,t[i][1],t[i][1]),e.fillStyle="rgba("+n.r+", "+n.g+", "+n.b+", "+y[p]+")",e.fillRect(0,0,t[i][1],t[i][1]),e.globalCompositeOperation="destination-in",e.imageSmoothingQuality="high",e.drawImage(En[p],0,0,t[i][1],t[i][1]),e.restore()}function k(t,n,r,a,o,s){if(!(r<=0))if(u&&(e.globalCompositeOperation="source-atop"),s&&s[3]===a||(e.globalAlpha=a),s||0!==p&&3!==p||(e.fillStyle=i),0===p)e.beginPath(),e.arc(t,n,r,0,C),e.closePath(),e.fill(),S=!0;else if(3===p)void 0!==o&&(e.save(),e.translate(t,n),e.rotate(o/180*Math.PI),e.fillRect(-r,-r,2*r,2*r),e.restore(),S=!0);else{e.save(),e.translate(t,n);let i=x;r<=32&&r>16?i=b:r<=16&&(i=v),e.scale(r,r),1===p&&e.rotate(53123*(t+n)%C),e.drawImage(i,-1,-1,2,2),e.restore(),S=!0}}function I(t,n,i,r){null===w&&(w=new $.BezierLine,w.add(g.x,g.y,0,(function(){})));let a=[];function o(e){let t=$.mix(m.pressure,r,e.t),n=E(t),i=Math.max(.1,s*(c?t:1));a.push([e.x,e.y,i,n,e.angle])}let h,d=i*l;null===t?w.addFinal(d,o):w.add(t,n,d,o),e.save();for(let e=0;e<a.length;e++){let t=a[e];k(t[0],t[1],t[2],t[3],t[4],h),h=t}e.restore()}this.startLine=function(i,o,y){t={tool:["brush","PenBrush"],actions:[]},t.actions.push({action:"opacityPressure",params:[d]}),t.actions.push({action:"sizePressure",params:[c]}),t.actions.push({action:"setSize",params:[s]}),t.actions.push({action:"setSpacing",params:[l]}),t.actions.push({action:"setOpacity",params:[h]}),t.actions.push({action:"setColor",params:[n]}),t.actions.push({action:"setAlpha",params:[p]}),t.actions.push({action:"setLockAlpha",params:[u]});let x=E(y=$.clamp(y,0,1)),b=c?Math.max(.1,y*s):Math.max(.1,s);S=!1,f=!0,e.save(),k(i,o,b,x),e.restore(),r=b*l,g.x=i,g.y=o,g.pressure=y,m.pressure=y,a=[{x:i,y:o,pressure:y}],t.actions.push({action:"startLine",params:[i,o,y]})},this.goLine=function(n,i,r){if(!f)return;t.actions.push({action:"goLine",params:[n,i,r]});let o=$.clamp(r,0,1),l=c?Math.max(.1,g.pressure*s):Math.max(.1,s);e.save(),I(n,i,l,g.pressure),e.restore(),g.x=n,g.y=i,m.pressure=g.pressure,g.pressure=o,a.push({x:n,y:i,pressure:r})},this.endLine=function(n,i){let r=c?Math.max(.1,g.pressure*s):Math.max(.1,s);if(e.save(),I(null,null,r,g.pressure),e.restore(),f=!1,3===p&&!S){let t=a[0];a.forEach((e=>{e.pressure>t.pressure&&(t=e)})),e.save();let n=E($.clamp(t.pressure,0,1));k(t.x,t.y,r,n,0),e.restore()}w=null,t&&(t.actions.push({action:"endLine",params:[n,i]}),o.push(t),t=void 0),S=!1,a=[]},this.drawLineSegment=function(t,i,a,m){if(g.x=a,g.y=m,g.pressure=1,f||void 0===t)return;let y,x=$.pointsToAngleDeg({x:t,y:i},{x:a,y:m}),b=Math.sqrt(Math.pow(a-t,2)+Math.pow(m-i,2)),v=(a-t)/b,w=(m-i)/b,C=s*l;for(r=s*l,e.save(),y=r;y<=b;y+=C)k(t+v*y,i+w*y,s,h,x);e.restore();let S={tool:["brush","PenBrush"],actions:[]};S.actions.push({action:"opacityPressure",params:[d]}),S.actions.push({action:"sizePressure",params:[c]}),S.actions.push({action:"setSize",params:[s]}),S.actions.push({action:"setSpacing",params:[l]}),S.actions.push({action:"setOpacity",params:[h]}),S.actions.push({action:"setColor",params:[n]}),S.actions.push({action:"setAlpha",params:[p]}),S.actions.push({action:"setLockAlpha",params:[u]}),S.actions.push({action:"drawLineSegment",params:[t,i,a,m]}),o.push(S)},this.isDrawing=function(){return f},this.setAlpha=function(e){p!==e&&(p=e,M())},this.setColor=function(e){n!==e&&(n={r:e.r,g:e.g,b:e.b},i="rgb("+n.r+","+n.g+","+n.b+")",M())},this.setContext=function(t){e=t},this.setHistory=function(e){o=e},this.setSize=function(e){s=e},this.setOpacity=function(e){h=e},this.setSpacing=function(e){l=e},this.sizePressure=function(e){c=e},this.opacityPressure=function(e){d=e},this.setLockAlpha=function(e){u=e},this.getSpacing=function(){return l},this.getSize=function(){return s},this.getOpacity=function(){return h},this.getLockAlpha=function(e){return u}},BlendBrush:class{updateRedrawBounds(e){this.redrawBounds=$.updateBounds(this.redrawBounds,e)}getCellsWidth(){return Math.ceil(this.context.canvas.width/256)}drawChangedCells(){const e=this.cells.map((e=>null));this.getTouchedCells(this.redrawBounds).forEach(((t,n)=>{t&&(e[n]=this.cells[n])})),this.drawCells(e),this.redrawBounds=null}getTouchedCells(e){const t=this.cells.map((e=>!1)),n=this.getCellsWidth();for(let i=(e={x1:Math.floor(e.x1/256),y1:Math.floor(e.y1/256),x2:Math.floor(e.x2/256),y2:Math.floor(e.y2/256)}).x1;i<=e.x2;i++)for(let r=e.y1;r<=e.y2;r++)t[r*n+i]=!0;return t}sliceBounds(e){const t=this.getCellsWidth(),n=[];return this.getTouchedCells(e).forEach(((i,r)=>{if(!i)return;const a=r%t*256,o=256*Math.floor(r/t),s=this.cells[r].width,l=this.cells[r].height,h={x1:Math.max(0,e.x1-a),y1:Math.max(0,e.y1-o),x2:Math.min(s-1,e.x2-a),y2:Math.min(l-1,e.y2-o)};h.x1>h.x2||h.y1>h.y2||n.push({index:r,bounds:h})})),n}copyFromCanvas(e){if(!e)return;const t=this.getTouchedCells(e),n=this.getCellsWidth();t.forEach(((e,t)=>{if(!e||this.cells[t])return;const i=t%n,r=Math.floor(t/n),a=(Math.min(256*i+256,this.context.canvas.width)-1)%256+1,o=(Math.min(256*r+256,this.context.canvas.height)-1)%256+1,s=$.canvas(a,o).getContext("2d");s.drawImage(this.context.canvas,256*-i,256*-r),this.cells[t]=s.getImageData(0,0,a,o)}))}getAverage(e,t,n){n=Math.max(.5,.75*n);const i=Math.max(0,Math.floor(e-n)),r=Math.max(0,Math.floor(t-n)),a=Math.min(this.context.canvas.width-1,Math.ceil(e+n)),o=Math.min(this.context.canvas.height-1,Math.ceil(t+n));if(i>a||r>o)return{r:0,g:0,b:0,a:0};let s,l=0,h=0,c=0,d=0;return this.sliceBounds({x1:i,y1:r,x2:a,y2:o}).forEach((e=>{const t=this.cells[e.index].width,n=this.cells[e.index].data,i=e.bounds;for(let e=i.y1;e<=i.y2;e+=4)for(let r=i.x1,a=e*t*4+4*i.x1;r<=i.x2;r+=4,a+=16)s=n[a+3],l+=n[a]*s,h+=n[a+1]*s,c+=n[a+2]*s,d+=s})),0!==d&&(l/=d,h/=d,c/=d,d=Math.min(1,d)),{r:l,g:h,b:c,a:d}}prepDot(e,t,n){n=Math.max(.5,n);let i=Math.max(0,Math.floor(e-n)),r=Math.max(0,Math.floor(t-n)),a=Math.min(this.context.canvas.width-1,Math.ceil(e+n)),o=Math.min(this.context.canvas.height-1,Math.ceil(t+n));return i>a||r>o?null:{x1:i,y1:r,x2:a,y2:o}}drawDot(e){let t=0;const n=e.size>30?1024:512,i=[];for(let e=0;e<n;e++)i[e]=(Math.random()-.5)/1.001+.5;const r=[8,4,4,4,2,2,2,2,2,2][Math.floor(2*e.size)],a=r?r*r:0,o=[];if(r){let e=0;for(let t=0;t<r;t++)for(let n=0;n<r;n++,e+=2)o[e]=(t+1)/r,o[e+1]=(n+1)/r}const s=.8*Math.pow(e.opacity,2),l=1-s,h=s/l,c=e.size*e.size,d=c*l/e.opacity,u=(1+h)*e.opacity,p=this.sliceBounds({x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}),g=this.getCellsWidth();p.forEach((r=>{const s=r.index%g*256,l=256*Math.floor(r.index/g),h=this.cells[r.index].width,p=this.cells[r.index].data;for(let g=r.bounds.y1,m=g+l-e.y;g<=r.bounds.y2;g++,m++)for(let l=r.bounds.x1,f=g*h*4+4*r.bounds.x1,y=l+s-e.x;l<=r.bounds.x2;l++,f+=4,y++){let r=0;if(a){for(let t=0;t<o.length;t+=2){const n=$.lenSquared(y+o[t],m+o[t+1]);n>=c||(r+=Mn(u-n/d,0,e.opacity))}if(!r)continue;r/=a}else{const t=Math.pow(y,2)+Math.pow(m,2);if(t>=c)continue;r=Mn(u-t/d,0,e.opacity)}const s=1-r,l=p[f+3]/255;if(this.settingLockLayerAlpha){const n=e.r*r+p[f]*s,a=e.g*r+p[f+1]*s,o=e.b*r+p[f+2]*s;l&&(p[f]=Math.floor(n+i[t]),p[f+1]=Math.floor(a+i[t]),p[f+2]=Math.floor(o+i[t]))}else{const n=e.r*r+p[f]*l*s,a=e.g*r+p[f+1]*l*s,o=e.b*r+p[f+2]*l*s;let h=1-s*(1-l);p[f+3]=Math.floor(Math.min(255,255*h)+.5),h&&(p[f]=Math.floor(n/h+i[t]),p[f+1]=Math.floor(a/h+i[t]),p[f+2]=Math.floor(o/h+i[t]))}t=(t+1)%n}}))}calcSpacing(e){return $.mix(2*e/2,2*e/9,$.clamp((e-2.7)/9.3,0,1))}continueLine(e,t,n,i){let r,a;this.drawBuffer=[];let o,s=this.settingSizePressure?Math.max(1,n*this.size):Math.max(1,this.size),l=this.calcSpacing(s),h=e,c=t;if(null===e&&(h=this.lastInput.x,c=this.lastInput.y),0===this.blending)this.mixr=this.color.r,this.mixg=this.color.g,this.mixb=this.color.b;else{let e;if(i)e={r:this.localColOld.r,g:this.localColOld.g,b:this.localColOld.b,a:0};else{const t=[h,c,this.settingSizePressure?Math.max(.5,n*this.size):Math.max(.5,this.size)],i=this.prepDot(t[0],t[1],t[2]);this.copyFromCanvas(i),e=this.getAverage(t[0],t[1],t[2])}o={r:0,g:0,b:0,a:0},e.a>0&&0===this.blendCol.a?(this.blendCol.r=e.r,this.blendCol.g=e.g,this.blendCol.b=e.b,this.blendCol.a=e.a,o.r=this.blendCol.r,o.g=this.blendCol.g,o.b=this.blendCol.b,o.a=this.blendCol.a):(0===e.a&&(e.r=this.color.r,e.g=this.color.g,e.b=this.color.b,e.a=1-this.blending),this.blendCol.r=$.mix(this.blendCol.r,$.mix(this.blendCol.r,e.r,this.blendMix),e.a),this.blendCol.g=$.mix(this.blendCol.g,$.mix(this.blendCol.g,e.g,this.blendMix),e.a),this.blendCol.b=$.mix(this.blendCol.b,$.mix(this.blendCol.b,e.b,this.blendMix),e.a),this.blendCol.a=Math.min(1,this.blendCol.a+e.a),o.r=this.blendCol.r,o.g=this.blendCol.g,o.b=this.blendCol.b,o.a=this.blendCol.a)}const d=e=>{if(this.blending>=1&&this.blendCol.a<=0)return;let t=e.t;r=this.lastInput2.pressure*(1-t)+n*t,a=this.settingOpacityPressure?this.opacity*r*r:this.opacity,s=this.settingSizePressure?Math.max(.1,r*this.size):Math.max(.1,this.size),0!=this.blending&&(this.mixr=$.mix(this.localColOld.r,o.r,t),this.mixg=$.mix(this.localColOld.g,o.g,t),this.mixb=$.mix(this.localColOld.b,o.b,t)),1===this.blending&&0===this.localColOld.a&&(this.mixr=o.r,this.mixg=o.g,this.mixb=o.b);const i=this.prepDot(e.x,e.y,s);i&&(this.updateRedrawBounds(i),this.drawBuffer.push({x:e.x,y:e.y,size:s,opacity:a,x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,r:$.mix(this.color.r,this.mixr,this.blending),g:$.mix(this.color.g,this.mixg,this.blending),b:$.mix(this.color.b,this.mixb,this.blending)}))};null===e?this.bezierLine.addFinal(l,d):this.bezierLine.add(e,t,l,d),this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach((e=>{this.drawDot(e)})),this.drawBuffer=[],this.localColOld=o}setHistory(e){this.history=e}getSize(){return this.size}setSize(e){this.size=e}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e}getBlending(){return this.blending}setBlending(e){this.blending=e}setColor(e){this.color=$.copyObj(e)}setContext(e){this.context=e}setSizePressure(e){this.settingSizePressure=!!e}setOpacityPressure(e){this.settingOpacityPressure=!!e}getLockAlpha(){return this.settingLockLayerAlpha}setLockAlpha(e){this.settingLockLayerAlpha=!!e}getIsDrawing(){return this.isDrawing}setIsTesting(e){this.isTesting=!!e}startLine(e,t,n){this.historyEntry={tool:["brush","BlendBrush"],actions:[]};const i=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(i).split("").map((e=>null)),this.isDrawing=!0,n=Math.max(0,Math.min(1,n));let r=this.settingOpacityPressure?this.opacity*n*n:this.opacity,a=this.settingSizePressure?Math.max(.1,n*this.size):Math.max(.1,this.size);if(0===this.blending)this.mixr=this.color.r,this.mixg=this.color.g,this.mixb=this.color.b;else{this.copyFromCanvas(this.prepDot(e,t,a));let i=this.getAverage(e,t,this.settingSizePressure?Math.max(.1,n*this.size):Math.max(.1,this.size));0===i.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:i.r,g:i.g,b:i.b,a:i.a},this.mixr=this.blendCol.r,this.mixg=this.blendCol.g,this.mixb=this.blendCol.b}if(this.localColOld={r:this.mixr,g:this.mixg,b:this.mixb,a:this.blendCol.a},this.redrawBounds=null,this.drawBuffer=[],this.blending<1||this.blendCol.a>0){const n=this.prepDot(e,t,a);n&&(this.updateRedrawBounds(n),this.drawBuffer.push({x:e,y:t,size:a,opacity:r,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,r:$.mix(this.color.r,this.mixr,this.blending),g:$.mix(this.color.g,this.mixg,this.blending),b:$.mix(this.color.b,this.mixb,this.blending)}))}this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach((e=>{this.drawDot(e)})),this.drawBuffer=[],this.bezierLine=new $.BezierLine,this.bezierLine.add(e,t,0,(function(){})),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=n,this.lastInput2=$.copyObj(this.lastInput),this.redrawBounds&&!this.isTesting&&this.drawChangedCells()}goLine(e,t,n,i){this.isDrawing&&(this.continueLine(e,t,this.lastInput.pressure,i),this.lastInput2=$.copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=n,this.redrawBounds&&!this.isTesting&&this.drawChangedCells())}endLine(){this.bezierLine&&this.continueLine(null,null,this.lastInput.pressure,!1),this.isDrawing=!1,this.bezierLine=null,this.redrawBounds&&this.drawChangedCells(),this.historyEntry&&this.history&&this.cells.find((e=>!!e))&&(this.historyEntry.actions.push({action:"drawCells",params:[this.cells]}),this.history.push(this.historyEntry),this.historyEntry=null),this.cells=null}drawCells(e){const t=this.getCellsWidth();e.forEach(((e,n)=>{if(!e)return;const i=n%t*256,r=256*Math.floor(n/t);this.context.putImageData(e,i,r)}))}drawLineSegment(e,t,n,i){if(this.lastInput.x=n,this.lastInput.y=i,this.isDrawing||void 0===e)return;const r=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(r).split("").map((e=>null)),this.redrawBounds=null,this.drawBuffer=[],this.copyFromCanvas(this.prepDot(e,t,Math.max(.1,this.size)));let a=this.getAverage(e,t,Math.max(.1,this.size));0===a.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:a.r,g:a.g,b:a.b,a:a.a},this.mixr=this.color.r*(1-this.blendCol.a)+(this.blending*this.blendCol.r+this.color.r*(1-this.blending))*this.blendCol.a,this.mixg=this.color.g*(1-this.blendCol.a)+(this.blending*this.blendCol.g+this.color.g*(1-this.blending))*this.blendCol.a,this.mixb=this.color.b*(1-this.blendCol.a)+(this.blending*this.blendCol.b+this.color.b*(1-this.blending))*this.blendCol.a;const o=this.settingOpacityPressure?1*this.opacity*1:this.opacity,s=this.settingSizePressure?Math.max(.1,1*this.size):Math.max(.1,this.size),l=Math.sqrt(Math.pow(n-e,2)+Math.pow(i-t,2)),h=(n-e)/l,c=(i-t)/l,d=this.calcSpacing(s);for(let n=0;n<=l;n+=d){const i=this.prepDot(e+h*n,t+c*n,s);i&&(this.copyFromCanvas(i),this.drawBuffer.push({x:e+h*n,y:t+c*n,size:s,opacity:o,x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,r:$.mix(this.color.r,this.mixr,this.blending),g:$.mix(this.color.g,this.mixg,this.blending),b:$.mix(this.color.b,this.mixb,this.blending)}))}this.drawBuffer.forEach((e=>{this.drawDot(e)})),this.drawBuffer=[],this.history&&this.cells.find((e=>!!e))&&(this.drawCells(this.cells),this.historyEntry={tool:["brush","BlendBrush"],actions:[{action:"drawCells",params:[this.cells]}]},this.history.push(this.historyEntry),this.historyEntry=null),this.cells=null}constructor(){this.isTesting=!1,this.size=29,this.opacity=.6,this.blending=.65,this.settingLockLayerAlpha=!1,this.settingSizePressure=!0,this.settingOpacityPressure=!1,this.blendCol={r:0,g:0,b:0,a:1},this.blendMix=.45,this.isDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0}}},SketchyBrush:function(){let e,t,n,i,r,a=1,o=.2,s=.5,l=1,h=!1,c={x:0,y:0,pressure:0},d=new si.DecoyKlHistory,u=0;this.setHistory=function(e){d=e},this.setSeed=function(e){u=parseInt(e)},this.getSeed=function(){return parseInt(""+u)};let p=[],g=0,m=[function(e,t){return e},function(e,t){let n=new $.RGB(e.r,e.g,e.b);return n.r*=t.r/255,n.g*=t.g/255,n.b*=t.b/255,n},function(e,t){let n=new $.RGB(e.r,e.g,e.b);return n.r*=t.r/255,n.g*=t.g/255,n.b*=t.b/255,n}];this.getSize=function(){return a/2},this.setColor=function(e){t=e},this.getOpacity=function(){return o},this.setOpacity=function(e){o=e},this.getBlending=function(){return s},this.setBlending=function(e){s=e},this.setSize=function(e){a=2*e},this.getScale=function(){return l},this.setScale=function(e){l=e},this.setContext=function(t){e=t},this.startLine=function(e,d,u,p){if(p&&c.x){c.x,c.y;h=!0,this.endLine()}else h=!0,n=e,i=d,c.x=e,c.y=d,r={tool:["brush","SketchyBrush"],actions:[]},r.actions.push({action:"setScale",params:[l]}),r.actions.push({action:"setSize",params:[a/2]}),r.actions.push({action:"setOpacity",params:[o]}),r.actions.push({action:"setColor",params:[t]}),r.actions.push({action:"setBlending",params:[s]}),r.actions.push({action:"startLine",params:[e,d,u]})},this.goLine=function(d,f,y,x){if(!h||d===c.x&&f===c.y)return;let b,v,w,C,S=parseInt(d),E=parseInt(f);p.push([S,E]);let M=t.r,k=t.g,I=t.b;if(null!==x)M=x.r,k=x.g,I=x.b;else if(0!==s&&S+5>=0&&E+5>=0&&S-5<e.canvas.width-1&&E-5<e.canvas.height-1){M=0,k=0,I=0;let n=Math.min(e.canvas.width-1,Math.max(0,S-5)),i=Math.min(e.canvas.height-1,Math.max(0,E-5)),r=Math.min(e.canvas.width-1,Math.max(0,S+5)),a=Math.min(e.canvas.height-1,Math.max(0,E+5));if(r-=n,a-=i,r>0&&a>0){let t=e.getImageData(n,i,r,a),o=0;for(let e=0;e<t.data.length;e+=4)M+=t.data[e+0],k+=t.data[e+1],I+=t.data[e+2],o++;M/=o,k/=o,I/=o}let o=m[0](new $.RGB(M,k,I),t);M=parseInt(""+$.mix(t.r,o.r,s)),k=parseInt(""+$.mix(t.g,o.g,s)),I=parseInt(""+$.mix(t.b,o.b,s))}for(e.save(),e.strokeStyle="rgba("+M+", "+k+", "+I+", "+o+")",e.lineWidth=a,e.beginPath(),e.moveTo(n,i),e.lineTo(S,E),b=0;b<p.length;b++)v=p[b][0]-p[g][0],w=p[b][1]-p[g][1],C=v*v+w*w,C<4e3*l*l&&(u++,.5*Math.sin(6324634.2345*Math.cos(5342.3423*u))+.5>C/2e3/l/l)&&(e.moveTo(p[g][0]+.3*v,p[g][1]+.3*w),e.lineTo(p[b][0]-.3*v,p[b][1]-.3*w));e.stroke(),e.restore(),g++,n=S,i=E,c.x=S,c.y=E,r.actions.push({action:"goLine",params:[d,f,y,{r:M,g:k,b:I}]})},this.endLine=function(){h=!1,g=0,p=[],r&&(r.actions.push({action:"endLine",params:[]}),d.push(r),r=void 0)},this.drawLineSegment=function(n,i,r,u){if(c.x=r,c.y=u,h||void 0===n)return;e.save(),e.lineWidth=a;let p=t.r,g=t.g,f=t.b;if(n+5>=0&&i+5>=0&&n-5<e.canvas.width-1&&i-5<e.canvas.height-1){p=0,g=0,f=0;let t=Math.min(e.canvas.width-1,Math.max(0,n-5)),r=Math.min(e.canvas.height-1,Math.max(0,i-5)),a=Math.min(e.canvas.width-1,Math.max(0,n+5)),o=Math.min(e.canvas.height-1,Math.max(0,i+5));if(a-=t,o-=r,a>0&&o>0){let n=Math.min(kn.width,a),i=Math.min(kn.height,o);In.save(),In.globalCompositeOperation="copy",In.drawImage(e.canvas,t,r,a,o,0,0,n,i),In.restore();let s=In.getImageData(t,r,a,o),l=0;for(let e=0;e<s.data.length;e+=4)p+=s.data[e+0],g+=s.data[e+1],f+=s.data[e+2],l++;p/=l,g/=l,f/=l}}let y=m[0](new $.RGB(p,g,f),t);p=parseInt(""+(s*y.r+t.r*(1-s))),g=parseInt(""+(s*y.g+t.g*(1-s))),f=parseInt(""+(s*y.b+t.b*(1-s))),e.strokeStyle="rgba("+p+", "+g+", "+f+", "+o+")",e.beginPath(),e.moveTo(n,i),e.lineTo(r,u),e.stroke(),e.strokeStyle="rgba("+p+", "+g+", "+f+", "+o+")",e.restore();let x={tool:["brush","SketchyBrush"],actions:[]};x.actions.push({action:"setScale",params:[l]}),x.actions.push({action:"setSize",params:[a/2]}),x.actions.push({action:"setOpacity",params:[o]}),x.actions.push({action:"setColor",params:[t]}),x.actions.push({action:"setBlending",params:[s]}),x.actions.push({action:"drawLineSegment",params:[n,i,r,u]}),d.push(x)},this.isDrawing=function(){return h}},PixelBrush:function(){let e,t,n,i,r,a,o=new si.DecoyKlHistory,s=.5,l=.9,h=1,c=!0,d=!1,u=!1,p=!1,g=!0,m={x:0,y:0,pressure:0},f={x:0,y:0,pressure:0},y=!1,x=null,b=(Math.PI,$.canvas(4,4)),v=b.getContext("2d"),w=[[3,2],[1,0],[3,0],[1,2],[2,1],[0,3],[0,1],[2,3],[2,0],[0,2],[0,0],[2,2],[1,1],[3,3],[3,1],[1,3]];function C(){v.clearRect(0,0,4,4),v.fillStyle=p?"#fff":i;for(let e=0;e<Math.max(1,Math.round(h*w.length));e++)v.fillRect(w[e][0],w[e][1],1,1);a=e.createPattern(b,"repeat")}function S(t,n,r,o,s){e.save(),p?(e.fillStyle=g?a:"#fff",e.globalCompositeOperation=u?"source-atop":"destination-out"):(e.fillStyle=g?a:i,u&&(e.globalCompositeOperation="source-atop")),e.globalAlpha=g?1:h,t=Math.floor(t),n=Math.floor(n),r=Math.floor(r),o=Math.floor(o);let l=Math.abs(r-t),c=t<r?1:-1,d=-Math.abs(o-n),m=n<o?1:-1,f=l+d;for(;s?s=!1:e.fillRect(t,n,1,1),t!==r||n!==o;){let e=2*f;e>=d&&(f+=d,t+=c),e<=l&&(f+=l,n+=m)}e.restore()}function E(e,t,n,i){let r=function(e,t,n,i,r){let a=$.Vec2.nor({x:i.x-e.x,y:i.y-e.y}),o=$.Vec2.nor({x:t.x-e.x,y:t.y-e.y}),s=$.Vec2.nor({x:i.x-n.x,y:i.y-n.y});return Math.abs($.Vec2.angle(a,o)%Math.PI),Math.PI,Math.abs($.Vec2.angle(a,s)%Math.PI),Math.PI,Math.max($.Vec2.dist(a,o),$.Vec2.dist(a,s))>r}(e,t,n,i,.1);e.x=Math.floor(e.x),e.y=Math.floor(e.y),i.x=Math.floor(i.x),i.y=Math.floor(i.y);let a=$.dist(e.x,e.y,i.x,i.y);if(!r||a<7)return void S(e.x,e.y,i.x,i.y,!0);let o=Math.max(2,Math.round(a/4)),s=[];for(let r=0;r<=o;r++){let a=r/o,l=Math.pow(1-a,3),h=3*a*Math.pow(1-a,2),c=3*Math.pow(a,2)*(1-a),d=Math.pow(a,3);s.push({x:l*e.x+h*t.x+c*n.x+d*i.x,y:l*e.y+h*t.y+c*n.y+d*i.y})}for(let e=0;e<o;e++)S(Math.round(s[e].x),Math.round(s[e].y),Math.round(s[e+1].x),Math.round(s[e+1].y),!0)}function M(t,n,r,o,s){e.save(),p?(e.fillStyle=g?a:"#fff",e.globalCompositeOperation=u?"source-atop":"destination-out"):(e.fillStyle=g?a:i,u&&(e.globalCompositeOperation="source-atop")),e.globalAlpha=g?1:o,e.fillRect(Math.round(t+-r),Math.round(n+-r),Math.round(2*r),Math.round(2*r)),e.restore()}function k(t,n,i,r){function a(e){let t=$.mix(f.pressure,r,e.t),n=h*(d?t*t:1),i=Math.max(.5,s*(c?t:1));M(e.x,e.y,i,n,e.angle)}function o(e){E(e.p1,e.p2,e.p3,e.p4)}if(null===x&&(x=new $.BezierLine,x.add(m.x,m.y,0,(function(){}))),e.save(),1===Math.round(2*s))null===t?x.addFinal(4,null,o):x.add(t,n,4,null,o);else{let e=i*l;null===t?x.addFinal(e,a):x.add(t,n,e,a)}e.restore()}this.startLine=function(e,i,a){t={tool:["brush","PixelBrush"],actions:[]},t.actions.push({action:"sizePressure",params:[c]}),t.actions.push({action:"setSize",params:[s]}),t.actions.push({action:"setSpacing",params:[l]}),t.actions.push({action:"setOpacity",params:[h]}),t.actions.push({action:"setColor",params:[n]}),t.actions.push({action:"setLockAlpha",params:[u]}),t.actions.push({action:"setIsEraser",params:[p]}),t.actions.push({action:"setUseDither",params:[g]}),g&&C(),a=Math.max(0,Math.min(1,a));let o=d?h*a*a:h,x=c?Math.max(.5,a*s):Math.max(.5,s);y=!0,M(e,i,x,o),r=x*l,m.x=e,m.y=i,m.pressure=a,f=$.copyObj(m),t.actions.push({action:"startLine",params:[e,i,a]})},this.goLine=function(e,n,i){if(!y)return;t.actions.push({action:"goLine",params:[e,n,i]});let r=$.clamp(i,0,1);k(e,n,c?Math.max(.1,m.pressure*s):Math.max(.1,s),m.pressure),f=$.copyObj(m),m.x=e,m.y=n,m.pressure=r},this.endLine=function(e,n){k(null,null,c?Math.max(.1,m.pressure*s):Math.max(.1,s),m.pressure),y=!1,x=null,t&&(t.actions.push({action:"endLine",params:[e,n]}),o.push(t),t=void 0)},this.drawLineSegment=function(e,t,i,a){if(m.x=i,m.y=a,m.pressure=1,y||void 0===e)return;if(g&&C(),1===Math.round(2*s))S(e,t,i,a,!0);else{$.pointsToAngleDeg({x:e,y:t},{x:i,y:a});let n,o=Math.sqrt(Math.pow(i-e,2)+Math.pow(a-t,2)),c=(i-e)/o,d=(a-t)/o,u=s*l;for(r=s*l,n=r;n<=o;n+=u)M(e+c*n,t+d*n,s,h)}let d={tool:["brush","PixelBrush"],actions:[]};d.actions.push({action:"sizePressure",params:[c]}),d.actions.push({action:"setSize",params:[s]}),d.actions.push({action:"setSpacing",params:[l]}),d.actions.push({action:"setOpacity",params:[h]}),d.actions.push({action:"setColor",params:[n]}),d.actions.push({action:"setLockAlpha",params:[u]}),d.actions.push({action:"setIsEraser",params:[p]}),d.actions.push({action:"setUseDither",params:[g]}),d.actions.push({action:"drawLineSegment",params:[e,t,i,a]}),o.push(d)},this.isDrawing=function(){return y},this.setColor=function(e){n!==e&&(n=e,i="rgb("+n.r+","+n.g+","+n.b+")")},this.setContext=function(t){e=t},this.setHistory=function(e){o=e},this.setSize=function(e){s=e},this.setOpacity=function(e){h=e},this.setSpacing=function(e){l=e},this.sizePressure=function(e){c=e},this.opacityPressure=function(e){d=e},this.setLockAlpha=function(e){u=e},this.setIsEraser=function(e){p=!!e},this.setUseDither=function(e){g=!!e},this.getSpacing=function(){return l},this.getSize=function(){return s},this.getOpacity=function(){return h},this.getLockAlpha=function(){return u},this.getIsEraser=function(){return p},this.getUseDither=function(){return g}},ChemyBrush:class{updateCompleteRedrawBounds(e,t){let n={x1:e,y1:t,x2:e,y2:t};this.settingXSymmetry&&(n=$.updateBounds(n,{x1:-e+this.copyCanvas.width,y1:t,x2:-e+this.copyCanvas.width,y2:t})),this.settingYSymmetry&&(n=$.updateBounds(n,{x1:e,y1:-t+this.copyCanvas.height,x2:e,y2:-t+this.copyCanvas.height}));const i="stroke"===this.settingMode?this.settingSize+1:1;n.x1=Math.floor(n.x1-i),n.y1=Math.floor(n.y1-i),n.x2=Math.ceil(n.x2+i),n.y2=Math.ceil(n.y2+i),this.completeRedrawBounds=$.updateBounds(this.completeRedrawBounds,n)}drawShape(){this.context.save(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.drawImage(this.copyCanvas,0,0);let e={...this.settingColor};if(this.settingIsEraser?(e.r=255,e.g=255,e.b=255,this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),this.path){const t=new Path2D;this.path.forEach(((e,n)=>{0===n?t.moveTo(e.x,e.y):t.lineTo(e.x,e.y)}));let n=$.ColorConverter.toRgbaStr({r:e.r,g:e.g,b:e.b,a:this.settingOpacity});if(this.settingGradient){const t=this.path[0].x>this.path[this.path.length-1].x,i=this.context.createLinearGradient(0,t?this.minY:this.maxY,0,t?this.maxY:this.minY);i.addColorStop(0,$.ColorConverter.toRgbaStr({r:e.r,g:e.g,b:e.b,a:this.settingOpacity})),i.addColorStop(1,$.ColorConverter.toRgbaStr({r:e.r,g:e.g,b:e.b,a:0})),n=i}"fill"===this.settingMode?this.context.fillStyle=n:(this.context.lineWidth=2*this.settingSize,this.context.lineJoin="bevel",this.context.strokeStyle=n);const i=()=>{"fill"===this.settingMode?this.context.fill(t):this.context.stroke(t)};i(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,0),this.context.scale(-1,1),this.context.translate(-this.context.canvas.width/2,0),i(),this.context.restore()),this.settingYSymmetry&&(this.context.save(),this.context.translate(0,this.context.canvas.height/2),this.context.scale(1,-1),this.context.translate(0,-this.context.canvas.height/2),i(),this.context.restore(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,this.context.canvas.height/2),this.context.scale(-1,-1),this.context.translate(-this.context.canvas.width/2,-this.context.canvas.height/2),i(),this.context.restore()))}this.context.restore()}setHistory(e){this.history=e}getSize(){return"stroke"===this.settingMode?this.settingSize:0}setSize(e){this.settingSize=e}getOpacity(){return this.settingOpacity}setOpacity(e){this.settingOpacity=e}setColor(e){this.settingColor=$.copyObj(e)}setContext(e){this.context=e}setMode(e){this.settingMode=e}getMode(){return this.settingMode}setDistort(e){this.settingDistort=$.clamp(e,0,1)}getDistort(){return this.settingDistort}setXSymmetry(e){this.settingXSymmetry=!!e}getXSymmetry(){return this.settingXSymmetry}setYSymmetry(e){this.settingYSymmetry=!!e}getYSymmetry(){return this.settingYSymmetry}setGradient(e){this.settingGradient=!!e}getGradient(){return this.settingGradient}getLockAlpha(){return this.settingLockLayerAlpha}setLockAlpha(e){this.settingLockLayerAlpha=!!e}getIsEraser(){return this.settingIsEraser}setIsEraser(e){this.settingIsEraser=!!e}getIsDrawing(){return this.isDrawing}startLine(e,t){this.isDrawing=!0,this.path=[{x:e,y:t}],this.minY=t,this.maxY=t,this.copyCanvas=$.canvas(this.context.canvas.width,this.context.canvas.height),this.copyCanvas.getContext("2d").drawImage(this.context.canvas,0,0),this.completeRedrawBounds=null,this.updateCompleteRedrawBounds(e,t)}goLine(e,t){if(!this.isDrawing)return;let n={x:e,y:t};this.settingDistort>0&&(n.x+=(Math.random()-.5)*this.settingDistort*80,n.y+=(Math.random()-.5)*this.settingDistort*80),this.minY=Math.min(this.minY,n.y),this.maxY=Math.max(this.maxY,n.y),this.path.push(n),this.updateCompleteRedrawBounds(e,t),this.drawShape()}endLine(){if(this.isDrawing=!1,this.completeRedrawBounds=$.boundsInArea(this.completeRedrawBounds,this.copyCanvas.width,this.copyCanvas.height),this.path.length>1&&this.completeRedrawBounds){const e=$.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);e.getContext("2d").drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),this.history.push({tool:["brush","ChemyBrush"],actions:[{action:"drawImage",params:[e,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}]})}this.path=null,this.copyCanvas=null}drawImage(e,t,n){this.context.save(),this.context.clearRect(t,n,e.width,e.height),this.context.drawImage(e,t,n),this.context.restore()}drawLineSegment(e,t,n,i){}constructor(){this.settingSize=.25,this.settingOpacity=1,this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingMode="fill",this.settingDistort=0,this.settingXSymmetry=!1,this.settingYSymmetry=!1,this.settingGradient=!1,this.isDrawing=!1}},SmudgeBrush:class{updateRedrawBounds(e){this.redrawBounds=$.updateBounds(this.redrawBounds,e)}updateCompleteRedrawBounds(e,t,n,i){this.completeRedrawBounds=$.updateBounds(this.completeRedrawBounds,{x1:e,y1:t,x2:n,y2:i})}copyFromCanvas(){const e=this.copiedCells.map((e=>!1)),t=[],n=Math.ceil(this.copyImageData.width/256);this.redrawBounds&&(t.push({x1:Math.floor(this.redrawBounds.x1/256),y1:Math.floor(this.redrawBounds.y1/256),x2:Math.floor(this.redrawBounds.x2/256),y2:Math.floor(this.redrawBounds.y2/256)}),t.forEach((t=>{for(let i=t.x1;i<=t.x2;i++)for(let r=t.y1;r<=t.y2;r++)e[r*n+i]=!0})),e.forEach(((e,t)=>{if(!e||this.copiedCells[t])return;this.copiedCells[t]=!0;const i=t%n,r=Math.floor(t/n),a=(Math.min(256*i+256,this.copyImageData.width)-1)%256+1,o=(Math.min(256*r+256,this.copyImageData.height)-1)%256+1,s=$.canvas(a,o).getContext("2d");s.drawImage(this.context.canvas,256*-i,256*-r);const l=s.getImageData(0,0,a,o);for(let e=0;e<o;e++)for(let t=0,n=e*a*4,o=4*((256*r+e)*this.copyImageData.width+256*i);t<a;t++,n+=4,o+=4)this.copyImageData.data[o]=l.data[n],this.copyImageData.data[o+1]=l.data[n+1],this.copyImageData.data[o+2]=l.data[n+2],this.copyImageData.data[o+3]=l.data[n+3]})))}prepDot(e,t,n,i){if(!this.lastDot)return void(this.lastDot={x:e,y:t});n=Math.round(n);const r=Math.round(2*n),a=Math.round(2*n),o=function(e,t,n,i,r){if(n.x===i.x&&n.y===i.y)return null;n=$.copyObj(n),i=$.copyObj(i),r=$.copyObj(r);{let a=0,o=0,s=0,l=0;if(n.x<0&&(l=-n.x),n.y<0&&(a=-n.y),i.x<0&&(l=Math.max(l,-i.x)),i.y<0&&(a=Math.max(a,-i.y)),n.x+r.w>e&&(o=n.x+r.w-e),n.y+r.h>t&&(s=n.y+r.h-t),i.x+r.w>e&&(o=Math.max(o,i.x+r.w-e)),i.y+r.h>t&&(s=Math.max(s,i.y+r.h-t)),n.x+=l,i.x+=l,n.y+=a,i.y+=a,r.w=r.w-l-o,r.h=r.h-a-s,r.w<=0||r.h<=0)return null}return{aP:{x:n.x,y:n.y},bP:{x:i.x,y:i.y},size:{w:r.w,h:r.h}}}(this.copyImageData.width,this.copyImageData.height,{x:Math.round(this.lastDot.x-n),y:Math.round(this.lastDot.y-n)},{x:Math.round(e-n),y:Math.round(t-n)},{w:r,h:a});if(o){const r={aP:o.aP,bP:o.bP,size:o.size,brush:{center:{x:e,y:t},size:n,opacity:i,alphaLock:this.settingLockLayerAlpha}};this.updateRedrawBounds({x1:r.bP.x,y1:r.bP.y,x2:r.bP.x+2*r.brush.size,y2:r.bP.y+2*r.brush.size}),this.drawBuffer.push(r)}this.lastDot={x:e,y:t}}continueLine(e,t,n,i){this.drawBuffer=[],null===this.bezierLine&&(this.bezierLine=new $.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,(function(){})));const r=[],a=e=>{const t=$.mix(this.lastInput2.pressure,i,e.t),n=this.settingOpacity*(this.settingHasOpacityPressure?t*t:1),a=Math.max(.1,this.settingSize*(this.settingHasSizePressure?t:1));r.push([e.x,e.y,a,n,e.angle])},o=n*this.settingSpacing/3;let s;null===e?this.bezierLine.addFinal(o,a):this.bezierLine.add(e,t,o,a);for(let e=0;e<r.length;e++){const t=r[e];this.prepDot(t[0],t[1],t[2],t[3]),s=t}this.copyFromCanvas();for(let e=0;e<this.drawBuffer.length;e++)Tn(this.copyImageData,this.drawBuffer[e])}startLine(e,t,n){this.historyEntry={tool:["brush","SmudgeBrush"],actions:[]},n=$.clamp(n,0,1);const i=this.settingHasOpacityPressure?this.settingOpacity*n*n:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.1,n*this.settingSize):Math.max(.1,this.settingSize);this.lastDot=null,this.isDrawing=!0,this.copyImageData=new ImageData(this.context.canvas.width,this.context.canvas.height);const a=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.copiedCells="0".repeat(a).split("").map((e=>!1)),this.prepDot(e,t,r,i),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=n,this.lastInput2.pressure=n,this.completeRedrawBounds=null}goLine(e,t,n){if(!this.isDrawing)return;this.redrawBounds=null;const i=$.clamp(n,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(e,t,r,this.lastInput.pressure),this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.lastInput.x=e,this.lastInput.y=t,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=i}endLine(){this.redrawBounds=null;const e=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(null,null,e,this.lastInput.pressure),this.context.restore(),this.isDrawing=!1,this.bezierLine=null,this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.historyEntry&&this.completeRedrawBounds){let e=this.copyImageData;if(!(0===this.completeRedrawBounds.x1&&0===this.completeRedrawBounds.y1&&this.completeRedrawBounds.x2>=this.context.canvas.width-1&&this.completeRedrawBounds.y2>=this.context.canvas.height-1)){const t=$.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);t.getContext("2d").drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),e=t}this.historyEntry.actions.push({action:"drawImage",params:[e,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}),this.history.push(this.historyEntry),this.historyEntry=void 0}this.copyImageData=null}drawImage(e,t,n){e instanceof ImageData?this.context.putImageData(e,t,n):(this.context.clearRect(t,n,e.width,e.height),this.context.drawImage(e,t,n))}drawLineSegment(e,t,n,i){}getIsDrawing(){return this.isDrawing}setColor(e){this.settingColor.r===e.r&&this.settingColor.g===e.g&&this.settingColor.b===e.b||(this.settingColor={r:e.r,g:e.g,b:e.b},this.settingColorStr=$.ColorConverter.toRgbStr(this.settingColor))}setContext(e){this.context=e}setHistory(e){this.history=e}setSize(e){this.settingSize=e}setOpacity(e){this.settingOpacity=e}setSpacing(e){this.settingSpacing=e}sizePressure(e){this.settingHasSizePressure=!!e}opacityPressure(e){this.settingHasOpacityPressure=!!e}setLockAlpha(e){this.settingLockLayerAlpha=!!e}getSpacing(){return this.settingSpacing}getSize(){return this.settingSize}getOpacity(){return this.settingOpacity}getLockAlpha(){return this.settingLockLayerAlpha}constructor(){this.history=new si.DecoyKlHistory,this.settingColor={r:0,g:0,b:0},this.settingSize=35,this.settingSpacing=.20446882736951905,this.settingOpacity=.8,this.settingHasSizePressure=!1,this.settingHasOpacityPressure=!1,this.settingLockLayerAlpha=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.isDrawing=!1,this.bezierLine=null,this.drawBuffer=[]}},EraserBrush:function(){let e,t,n,i,r=new si.DecoyKlHistory,a=30,o=1,s=!0,l=!1,h={x:0,y:0,pressure:0},c={x:0,y:0,pressure:0},d=!1,u=!1,p=!1;function g(t,n,i,r){e.save(),e.globalCompositeOperation=u?p?"destination-out":"source-atop":"destination-out";let a=e.createRadialGradient(i,i,0,i,i,i),o=Math.pow(r,2);o=Math.max(0,Math.min((i-1)/i,o));let s=Math.max(0,Math.min(1,r)),l=2*s-s*s;a.addColorStop(o,"rgba(255, 255, 255, "+l+")"),a.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=a,e.translate(t-i,n-i),e.fillRect(0,0,2*i,2*i),e.restore()}function m(e,t,n){let r,h;n=Math.max(0,Math.min(1,n));let d=s?Math.max(.1,n*a):Math.max(.1,a),u=Math.max(1,Math.max(.5,1-o)*d*.4);function p(e){let t=e.t;r=c.pressure*(1-t)+n*t,h=l?o*r*r:o,d=s?Math.max(.1,r*a):Math.max(.1,a),g(e.x,e.y,d,h)}null===e?i.addFinal(u,p):i.add(e,t,u,p)}this.startLine=function(r,m,f){t={tool:["brush","EraserBrush"],actions:[]},t.actions.push({action:"opacityPressure",params:[l]}),t.actions.push({action:"sizePressure",params:[s]}),t.actions.push({action:"setSize",params:[a]}),t.actions.push({action:"setOpacity",params:[o]}),t.actions.push({action:"setTransparentBG",params:[p]}),u=0===e.canvas.index,f=Math.max(0,Math.min(1,f));let y=l?o*f*f:o,x=s?Math.max(.1,f*a):Math.max(.1,a);d=!0,x>1&&g(r,m,x,y),n=.4*x,h.x=r,h.y=m,h.pressure=f,c=$.copyObj(h),i=new $.BezierLine,i.add(r,m,0,(function(){})),t.actions.push({action:"startLine",params:[r,m,f]})},this.goLine=function(e,n,i){d&&(t.actions.push({action:"goLine",params:[e,n,i]}),m(e,n,h.pressure),c=$.copyObj(h),h.x=e,h.y=n,h.pressure=i)},this.endLine=function(){i&&m(null,null,h.pressure),d=!1,i=void 0,t&&(t.actions.push({action:"endLine",params:[]}),r.push(t),t=void 0)},this.drawLineSegment=function(t,i,c,m){if(u=0===e.canvas.index,h.x=c,h.y=m,d||void 0===t)return;let f,y=Math.sqrt(Math.pow(c-t,2)+Math.pow(m-i,2)),x=(c-t)/y,b=(m-i)/y,v=Math.max(1,Math.max(.5,1-o)*a*.4);for(n=0,f=n;f<=y;f+=v)g(t+x*f,i+b*f,a,o);let w={tool:["brush","EraserBrush"],actions:[]};w.actions.push({action:"opacityPressure",params:[l]}),w.actions.push({action:"sizePressure",params:[s]}),w.actions.push({action:"setSize",params:[a]}),w.actions.push({action:"setOpacity",params:[o]}),w.actions.push({action:"setTransparentBG",params:[p]}),w.actions.push({action:"drawLineSegment",params:[t,i,c,m]}),r.push(w)},this.isDrawing=function(){return d},this.setContext=function(t){e=t},this.setHistory=function(e){r=e},this.setSize=function(e){a=e},this.setOpacity=function(e){o=e},this.sizePressure=function(e){s=e},this.opacityPressure=function(e){l=e},this.setTransparentBG=function(e){p=1==e},this.getSize=function(){return a},this.getOpacity=function(){return o}}};var Rn;Rn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("kQgh7");const An=function(){let e={image:n(Rn),tooltip:ce("brush-pen"),sizeSlider:{min:.5,max:100,curve:$.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:0,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null},t=[ce("brush-pen-circle"),ce("brush-pen-chalk"),ce("brush-pen-calligraphy"),ce("brush-pen-square")];return he.subscribe((()=>{e.tooltip=ce("brush-pen"),t=[ce("brush-pen-circle"),ce("brush-pen-chalk"),ce("brush-pen-calligraphy"),ce("brush-pen-square")]})),e.Ui=function(n){let i,r,a=document.createElement("div"),o=new Ln.PenBrush;o.setHistory(te),n.onSizeChange(o.getSize());let s=[],l=0;for(let e=0;e<4;e++)!function(e){let n=$.el({title:t[e],onClick:()=>{c(e)}}),i=$.canvas(70,70),r=i.getContext("2d");0===e||3===e?0===e?(r.beginPath(),r.arc(35,35,30,0,2*Math.PI),r.closePath(),r.fill()):r.fillRect(5,5,60,60):1===e?r.drawImage(wn(60),5,5):2===e&&r.drawImage(Sn(60),5,5),n.style.backgroundImage="url("+i.toDataURL("image/png")+")",s.push(n)}(e);function h(){for(let e=0;e<s.length;e++)s[e].className=e===l?"brush-alpha-selected":"brush-alpha"}function c(e){l=e,o.setAlpha(e),h()}h();let d=new pe({init:o.getLockAlpha(),label:ce("brush-lock-alpha"),callback:function(e){o.setLockAlpha(e)},doHighlight:!0,title:ce("brush-lock-alpha-title"),css:{cssFloat:"right",textAlign:"right"}}),u=new $.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function p(e){o.setSize(e),o.setSpacing(Math.max(2,u.interpolate(e))/15)}!function(){i=new we({label:ce("brush-size"),width:225,height:30,min:e.sizeSlider.min,max:e.sizeSlider.max,initValue:o.getSize(),eventResMs:20,onChange:function(e){p(e),n.onSizeChange(e)},curve:e.sizeSlider.curve,formatFunc:function(e){return(e*=2)<10?Math.round(10*e)/10:Math.round(e)}}),r=new we({label:ce("opacity"),width:225,height:30,min:e.opacitySlider.min,max:e.opacitySlider.max,initValue:e.opacitySlider.max,eventResMs:20,onChange:function(e){o.setOpacity(e),n.onOpacityChange(e)},curve:e.opacitySlider.curve,formatFunc:function(e){return Math.round(100*e)}});let t=be(!0,(function(e){o.sizePressure(e)})),l=be(!1,(function(e){o.opacityPressure(e)}));a.append($.el({content:[i.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),$.el({content:[r.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}));let h=document.createElement("div");for(let e=0;e<s.length;e++)h.appendChild(s[e]);h.style.marginTop="10px",a.appendChild(h),h.appendChild(d.getElement())}(),this.increaseSize=function(e){o.isDrawing()||i.increaseValue(e)},this.decreaseSize=function(e){o.isDrawing()||i.decreaseValue(e)},this.getSize=function(){return o.getSize()},this.setSize=function(e){p(e),i.setValue(e)},this.getOpacity=function(){return o.getOpacity()},this.setOpacity=function(e){o.setOpacity(e),r.setValue(e)},this.setColor=function(e){o.setColor(e)},this.setContext=function(e){o.setContext(e)},this.startLine=function(e,t,n){o.startLine(e,t,n)},this.goLine=function(e,t,n){o.goLine(e,t,n)},this.endLine=function(e,t){o.endLine(e,t)},this.getBrush=function(){return o},this.isDrawing=function(){return o.isDrawing()},this.getElement=function(){return a}},e}();var Pn;Pn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("5cRgh");const Dn=function(){let e={image:n(Pn),tooltip:ce("brush-blend"),sizeSlider:{min:.5,max:100,curve:$.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1},Ui:null};return he.subscribe((()=>{e.tooltip=ce("brush-blend")})),e.Ui=function(t){let n,i,r=document.createElement("div"),a=new Ln.BlendBrush;function o(e){a.setSize(e)}a.setHistory(te),t.onSizeChange(a.getSize()),function(){n=new we({label:ce("brush-size"),width:225,height:30,min:e.sizeSlider.min,max:e.sizeSlider.max,initValue:29,eventResMs:20,onChange:function(e){o(e),t.onSizeChange(e)},curve:e.sizeSlider.curve,formatFunc:function(e){return e*=2,Math.round(e)}}),i=new we({label:ce("opacity"),width:225,height:30,min:e.opacitySlider.min,max:e.opacitySlider.max,initValue:a.getOpacity(),eventResMs:20,onChange:function(e){a.setOpacity(e),t.onOpacityChange(e)},formatFunc:function(e){return Math.round(100*e)}});let s=new we({label:ce("brush-blending"),width:225,height:30,min:0,max:100,initValue:100*a.getBlending(),eventResMs:20,onChange:function(e){a.setBlending(e/100)}});s.getElement().style.marginTop="10px";let l=be(!0,(function(e){a.setSizePressure(e)})),h=be(!1,(function(e){a.setOpacityPressure(e)})),c=new pe({init:a.getLockAlpha(),label:ce("brush-lock-alpha"),callback:function(e){a.setLockAlpha(e)},doHighlight:!0,title:ce("brush-lock-alpha-title"),css:{marginTop:"10px",display:"inline-block"}});r.append($.el({content:[n.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),$.el({content:[i.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),s.getElement(),c.getElement())}(),this.increaseSize=function(e){a.getIsDrawing()||n.increaseValue(e)},this.decreaseSize=function(e){a.getIsDrawing()||n.decreaseValue(e)},this.getSize=function(){return a.getSize()},this.setSize=function(e){o(e),n.setValue(e)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(e){a.setOpacity(e),i.setValue(e)},this.setColor=function(e){a.setColor(e)},this.setContext=function(e){a.setContext(e)},this.startLine=function(e,t,n){a.startLine(e,t,n)},this.goLine=function(e,t,n,i){a.goLine(e,t,n,i)},this.endLine=function(){a.endLine()},this.getBrush=function(){return a},this.isDrawing=function(){return a.getIsDrawing()},this.getElement=function(){return r}},e}();var On;On=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("ehhLu");const Bn=function(){let e={image:n(On),tooltip:ce("brush-sketchy"),sizeSlider:{min:.5,max:10},opacitySlider:{min:.01,max:1},Ui:null};return he.subscribe((()=>{e.tooltip=ce("brush-sketchy")})),e.Ui=function(t){let n,i,r=document.createElement("div"),a=new Ln.SketchyBrush;a.setHistory(te),t.onSizeChange(a.getSize()),function(){n=new we({label:ce("brush-size"),width:250,height:30,min:e.sizeSlider.min,max:e.sizeSlider.max,initValue:a.getSize(),eventResMs:20,onChange:function(e){a.setSize(e),t.onSizeChange(a.getSize())},formatFunc:function(e){return(e*=2)<10?Math.round(10*e)/10:Math.round(e)}}),i=new we({label:ce("opacity"),width:250,height:30,min:e.opacitySlider.min,max:e.opacitySlider.max,initValue:a.getOpacity(),eventResMs:20,onChange:function(e){a.setOpacity(e),t.onOpacityChange(e)},formatFunc:function(e){return Math.round(100*e)}});let o=new we({label:ce("brush-blending"),width:250,height:30,min:0,max:100,initValue:100*a.getBlending(),eventResMs:20,onChange:function(e){a.setBlending(e/100)}}),s=new we({label:ce("brush-sketchy-scale"),width:250,height:30,min:1,max:20,initValue:a.getScale(),eventResMs:20,onChange:function(e){a.setScale(e)}});i.getElement().style.marginTop="10px",o.getElement().style.marginTop="10px",s.getElement().style.marginTop="10px",r.appendChild(n.getElement()),r.appendChild(i.getElement()),r.appendChild(o.getElement()),r.appendChild(s.getElement())}(),this.increaseSize=function(e){a.isDrawing()||n.increaseValue(e)},this.decreaseSize=function(e){a.isDrawing()||n.decreaseValue(e)},this.getSize=function(){return a.getSize()},this.setSize=function(e){!function(e){a.setSize(e)}(e),n.setValue(e)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(e){a.setOpacity(e),i.setValue(e)},this.setColor=function(e){a.setColor(e)},this.setContext=function(e){a.setContext(e)},this.startLine=function(e,t,n){a.startLine(e,t,n)},this.goLine=function(e,t,n){a.goLine(e,t,n,null)},this.endLine=function(){a.endLine()},this.getSeed=function(){return parseInt(a.getSeed())},this.setSeed=function(e){a.setSeed(parseInt(e))},this.getBrush=function(){return a},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},e}();var zn;zn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("cNEvL");const Hn=function(){let e={image:n(zn),tooltip:ce("brush-pixel"),sizeSlider:{min:.5,max:100,curve:$.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:0,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null};return he.subscribe((()=>{e.tooltip=ce("brush-pixel")})),e.Ui=function(t){let n,i,r=document.createElement("div"),a=new Ln.PixelBrush;a.setHistory(te),t.onSizeChange(a.getSize());let o=new pe({init:a.getLockAlpha(),label:ce("brush-lock-alpha"),callback:function(e){a.setLockAlpha(e)},doHighlight:!0,title:ce("brush-lock-alpha-title"),css:{marginRight:"10px"}}),s=new pe({init:a.getIsEraser(),label:ce("eraser"),callback:function(e){a.setIsEraser(e)},css:{marginRight:"10px"}}),l=new pe({init:a.getUseDither(),label:ce("brush-pixel-dither"),callback:function(e){a.setUseDither(e)}}),h=new $.SplineInterpolator([[.5,.45],[100,4]]);function c(e){a.setSize(e),a.setSpacing(h.interpolate(e)/e)}!function(){n=new we({label:ce("brush-size"),width:225,height:30,min:e.sizeSlider.min,max:e.sizeSlider.max,initValue:a.getSize(),eventResMs:20,onChange:function(e){c(e=Math.round(2*e)/2),t.onSizeChange(e)},curve:e.sizeSlider.curve,formatFunc:function(e){return e*=2,Math.round(e)}}),i=new we({label:ce("opacity"),width:225,height:30,min:e.opacitySlider.min,max:e.opacitySlider.max,initValue:e.opacitySlider.max,eventResMs:20,onChange:function(e){a.setOpacity(e),t.onOpacityChange(e)},curve:e.opacitySlider.curve,formatFunc:function(e){return Math.round(100*e)}});let h=be(!0,(function(e){a.sizePressure(e)}));r.append($.el({content:[n.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),i.getElement());let d=$.el({parent:r,css:{display:"flex",marginTop:"10px"}});d.appendChild(o.getElement()),d.appendChild(s.getElement()),d.appendChild(l.getElement())}(),this.increaseSize=function(e){a.isDrawing()||n.increaseValue(e)},this.decreaseSize=function(e){a.isDrawing()||n.decreaseValue(e)},this.getSize=function(){return a.getSize()},this.setSize=function(e){c(e),n.setValue(e)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(e){a.setOpacity(e),i.setValue(e)},this.setColor=function(e){a.setColor(e)},this.setContext=function(e){a.setContext(e)},this.startLine=function(e,t,n){a.startLine(e,t,n)},this.goLine=function(e,t,n){a.goLine(e,t,n)},this.endLine=function(e,t){a.endLine(e,t)},this.getBrush=function(){return a},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},e}();var Fn;Fn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hc51E");const jn=function(){let e={image:n(Fn),tooltip:ce("eraser")+" [E]",sizeSlider:{min:.5,max:200,curve:$.quadraticSplineInput(.5,200,.1)},opacitySlider:{min:.01,max:1},Ui:null};return he.subscribe((()=>{e.tooltip=ce("eraser")+" [E]"})),e.Ui=function(t){let n,i,r=document.createElement("div"),a=new Ln.EraserBrush;a.setHistory(te),t.onSizeChange(a.getSize());let o=!1;function s(e){a.setSize(e)}!function(){n=new we({label:ce("brush-size"),width:225,height:30,min:e.sizeSlider.min,max:e.sizeSlider.max,initValue:30,eventResMs:20,onChange:function(e){s(e),t.onSizeChange(e)},curve:e.sizeSlider.curve,formatFunc:function(e){return(e*=2)<10?Math.round(10*e)/10:Math.round(e)}}),i=new we({label:ce("opacity"),width:225,height:30,min:e.opacitySlider.min,max:e.opacitySlider.max,initValue:1,eventResMs:20,onChange:function(e){a.setOpacity(e),t.onOpacityChange(e)},formatFunc:function(e){return Math.round(100*e)}});let l=be(!0,(function(e){a.sizePressure(e)})),h=be(!1,(function(e){a.opacityPressure(e)}));r.append($.el({content:[n.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),$.el({content:[i.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}));let c=new pe({init:!1,label:ce("brush-eraser-transparent-bg"),callback:function(e){o=e,a.setTransparentBG(e)},css:{marginTop:"10px"}});r.appendChild(c.getElement())}(),this.increaseSize=function(e){a.isDrawing()||n.increaseValue(e)},this.decreaseSize=function(e){a.isDrawing()||n.decreaseValue(e)},this.getSize=function(){return a.getSize()},this.setSize=function(e){s(e),n.setValue(e)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(e){a.setOpacity(e),i.setValue(e)},this.setColor=function(e){},this.setContext=function(e){a.setContext(e)},this.startLine=function(e,t,n){a.startLine(e,t,n)},this.goLine=function(e,t,n){a.goLine(e,t,n)},this.endLine=function(){a.endLine()},this.getBrush=function(){return a},this.getIsTransparentBg=function(){return o},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},e}();var _n;_n=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("jpbyC");const Nn=function(){let e={image:n(_n),tooltip:ce("brush-smudge"),sizeSlider:{min:.5,max:100,curve:$.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:0,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null};return he.subscribe((()=>{e.tooltip=ce("brush-smudge")})),e.Ui=function(t){let n,i,r=document.createElement("div"),a=new Ln.SmudgeBrush;a.setHistory(te),t.onSizeChange(a.getSize());let o=new pe({init:a.getLockAlpha(),label:ce("brush-lock-alpha"),callback:function(e){a.setLockAlpha(e)},doHighlight:!0,title:ce("brush-lock-alpha-title")}),s=new $.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function l(e){a.setSize(e),a.setSpacing(Math.max(2,s.interpolate(e))/15)}!function(){n=new we({label:ce("brush-size"),width:225,height:30,min:e.sizeSlider.min,max:e.sizeSlider.max,initValue:a.getSize(),eventResMs:20,onChange:function(e){l(e),t.onSizeChange(e)},curve:e.sizeSlider.curve,formatFunc:function(e){return(e*=2)<10?Math.round(10*e)/10:Math.round(e)}}),i=new we({label:ce("opacity"),width:225,height:30,min:e.opacitySlider.min,max:e.opacitySlider.max,initValue:a.getOpacity(),eventResMs:20,onChange:function(e){a.setOpacity(e),t.onOpacityChange(e)},curve:e.opacitySlider.curve,formatFunc:function(e){return Math.round(100*e)}});let s=be(!1,(function(e){a.sizePressure(e)})),h=be(!1,(function(e){a.opacityPressure(e)}));r.append($.el({content:[n.getElement(),s],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),$.el({content:[i.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),$.el({parent:r,css:{marginTop:"10px"}}).append(o.getElement())}(),this.increaseSize=function(e){a.getIsDrawing()||n.increaseValue(e)},this.decreaseSize=function(e){a.getIsDrawing()||n.decreaseValue(e)},this.getSize=function(){return a.getSize()},this.setSize=function(e){l(e),n.setValue(e)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(e){a.setOpacity(e),i.setValue(e)},this.setColor=function(e){a.setColor(e)},this.setContext=function(e){a.setContext(e)},this.startLine=function(e,t,n){a.startLine(e,t,n)},this.goLine=function(e,t,n){a.goLine(e,t,n)},this.endLine=function(e,t){a.endLine()},this.getBrush=function(){return a},this.isDrawing=function(){return a.getIsDrawing()},this.getElement=function(){return r}},e}();var Un;Un=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("cmIJ6");class Xn{update(){this.value?$.addClassName(this.el,"kl-box-toggle--active"):$.removeClassName(this.el,"kl-box-toggle--active")}getValue(){return this.value}setValue(e){this.value=!!e,this.update()}getElement(){return this.el}destroy(){$.destroyEl(this.el)}constructor(e){this.value=!!e.init,this.el=$.el({content:e.label,title:e.title,className:"string"==typeof e.label?"kl-box-toggle":"kl-box-toggle kl-box-toggle--custom-el",onClick:()=>{this.value=!this.value,this.update(),e.onChange(this.value)},css:{cursor:"pointer"}}),"string"!=typeof e.label&&$.css(e.label,{display:"block",pointerEvents:"none"}),this.update()}}const Yn=function(){const e={image:n(Un),tooltip:ce("brush-chemy"),sizeSlider:{min:.25,max:25,curve:$.quadraticSplineInput(.25,25,.1),isDisabled:!0},opacitySlider:{min:.01,max:1},Ui:null};return he.subscribe((()=>{e.tooltip=ce("brush-chemy")})),e.Ui=function(t){const n=document.createElement("div"),i=new Ln.ChemyBrush;let r,a;function o(e){i.setSize(e)}i.setHistory(te),t.onSizeChange(i.getSize()),function(){r=new we({label:ce("brush-size"),width:250,height:30,min:e.sizeSlider.min,max:e.sizeSlider.max,initValue:i.getSize(),eventResMs:20,isEnabled:"stroke"===i.getMode(),onChange:function(e){o(e),t.onSizeChange(i.getSize())},curve:e.sizeSlider.curve,formatFunc:function(e){return(e*=2)<5?Math.round(10*e)/10:Math.round(e)}}),a=new we({label:ce("opacity"),width:250,height:30,min:e.opacitySlider.min,max:e.opacitySlider.max,initValue:i.getOpacity(),eventResMs:20,onChange:function(e){i.setOpacity(e),t.onOpacityChange(e)},formatFunc:function(e){return Math.round(100*e)}}),$.css(a.getElement(),{marginTop:"10px"});let s=new pe({init:i.getIsEraser(),label:ce("eraser"),callback:function(e){i.setIsEraser(e)},css:{marginTop:"10px",marginLeft:"10px"}});const l=new pe({init:i.getLockAlpha(),label:ce("brush-lock-alpha"),callback:function(e){i.setLockAlpha(e)},doHighlight:!0,title:ce("brush-lock-alpha-title"),css:{marginTop:"10px"}}),h=$.el({css:{display:"flex",marginTop:"10px"}}),c=new Te({optionArr:[{id:"fill",label:$.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"#000",style:"transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)",d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:ce("brush-chemy-fill")},{id:"stroke",label:$.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 0.12px; transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)",d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:ce("brush-chemy-stroke")}],initId:i.getMode(),onChange:n=>{i.setMode(n),e.sizeSlider.isDisabled="fill"===i.getMode(),r.setIsEnabled(!e.sizeSlider.isDisabled),r.setValue(i.getSize()),t.onSizeChange(i.getSize()),t.onConfigChange()}}),d=new Xn({label:$.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M 17.5,8 17.5,27"}]}),title:ce("brush-chemy-mirror-x"),init:i.getXSymmetry(),onChange:e=>{i.setXSymmetry(e)}}),u=new Xn({label:$.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M 8,17.5 27,17.5"}]}),title:ce("brush-chemy-mirror-y"),init:i.getYSymmetry(),onChange:e=>{i.setYSymmetry(e)}}),p=new Xn({label:$.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"defs",childrenArr:[{elementType:"linearGradient",id:"gradient",x1:"0",y1:"0",x2:"0",y2:"1",childrenArr:[{elementType:"stop",offset:"0%","stop-color":"rgba(0,0,0,0)"},{elementType:"stop",offset:"100%","stop-color":"rgba(0,0,0,1)"}]}]},{elementType:"rect",fill:"url('#gradient')",x:"8",y:"8",width:"19",height:"19"}]}),title:ce("brush-chemy-gradient"),init:i.getGradient(),onChange:e=>{i.setGradient(e)}});$.css(d.getElement(),{marginLeft:"10px"});{const e={marginLeft:"4px"};$.css(u.getElement(),e),$.css(p.getElement(),e)}h.append(c.getElement(),d.getElement(),u.getElement(),p.getElement()),n.append(r.getElement(),a.getElement(),h,$.el({content:[l.getElement(),s.getElement()],css:{display:"flex"}}))}(),this.increaseSize=function(e){i.getIsDrawing()||"stroke"!==i.getMode()||r.increaseValue(e)},this.decreaseSize=function(e){i.getIsDrawing()||"stroke"!==i.getMode()||r.decreaseValue(e)},this.getSize=function(){return i.getSize()},this.setSize=function(e){o(e),r.setValue(e)},this.getOpacity=function(){return i.getOpacity()},this.setOpacity=function(e){i.setOpacity(e),a.setValue(e)},this.setColor=function(e){i.setColor(e)},this.setContext=function(e){i.setContext(e)},this.startLine=function(e,t,n){i.startLine(e,t)},this.goLine=function(e,t,n,r){i.goLine(e,t)},this.endLine=function(){i.endLine()},this.getBrush=function(){return i},this.isDrawing=function(){return i.getIsDrawing()},this.getElement=function(){return n}},e}(),Vn={penBrush:An,blendBrush:Dn,sketchyBrush:Bn,pixelBrush:Hn,chemyBrush:Yn,smudgeBrush:Nn,eraserBrush:jn};function Wn(e,t,n,i){if(!t&&((i.height||window.innerHeight)<500||(i.width||window.innerWidth)<700))return void window.open(e);let r,a=$.el({tagName:"iframe",custom:{src:e},css:{width:"100%",height:"100%"}}),o=$.el({});t||(r=$.el({tagName:"a",parent:o,content:ce("modal-new-tab"),custom:{href:"help",target:"_blank"},onClick:function(){s.close()}}),a.onload=function(){$.setAttributes(r,{href:""+a.contentWindow.location})});let s=new ue({target:n,title:o,content:a,width:880,isMaxHeight:!0,onClose:()=>{r&&$.destroyEl(r)}})}class Gn{updateAge(){if(!this.timestamp)return;let e,t=(new Date).getTime()-this.timestamp;t=Math.floor(t/1e3/60),e=ce("file-storage-min-ago").replace("{x}",""+t),t>60&&(t=Math.floor(t/60),e=ce("file-storage-hours-ago").replace("{x}",""+t),t>24&&(t=Math.floor(t/24),e=ce("file-storage-days-ago").replace("{x}",""+t),t>31&&(e=ce("file-storage-month-ago")))),this.ageEl.textContent=e}resetButtons(){this.timestamp?(this.storeEl.textContent=ce("file-storage-overwrite"),this.storeEl.disabled=!1,this.clearEl.disabled=!1):(this.storeEl.textContent=ce("file-storage-store"),this.storeEl.disabled=!1,this.clearEl.disabled=!0)}updateThumb(e,t){this.timestamp=e,this.timestamp?($.css(t,{display:"block",maxWidth:"calc(100% - 2px)",maxHeight:"calc(100% - 2px)",margin:"0 auto",background:"url('"+$.createCheckerCanvas(4).toDataURL("image/png")+"')",boxShadow:"0 0 0 1px #aaa",pointerEvents:"none"}),this.previewEl.innerHTML="",this.updateAge(),this.previewEl.append(t,this.ageEl)):this.previewEl.innerHTML=ce("file-storage-empty"),this.resetButtons()}async store(){const e=this.getProject();if(e){this.storeEl.textContent=ce("file-storage-storing"),this.storeEl.disabled=!0,this.clearEl.disabled=!0,await new Promise((e=>{setTimeout((()=>e(null)),20)}));try{await this.projectStore.store(e),this.saveReminder.reset()}catch(e){this.resetButtons(),si.popup({target:this.saveReminder.getEl(),type:"error",message:[`${ce("file-storage-failed-1")}<ul>`,`<li>${ce("file-storage-failed-2")}</li>`,`<li>${ce("file-storage-failed-3")}</li>`,`<li>${ce("file-storage-failed-4")}</li>`,"</ul>"].join(""),buttons:["Ok"]}),setTimeout((()=>{throw new Error("storage-ui: failed to store browser storage, "+e)}),0)}}}async clear(){this.storeEl.disabled=!0,this.clearEl.disabled=!0;try{await this.projectStore.clear()}catch(e){this.resetButtons(),si.popup({target:this.saveReminder.getEl(),type:"error",message:ce("file-storage-failed-clear"),buttons:["Ok"]}),setTimeout((()=>{throw new Error("storage-ui: failed to clear browser storage, "+e)}),0)}}getElement(){return this.element}show(){}hide(){}destroy(){$.destroyEl(this.infoEl),$.destroyEl(this.storeEl),$.destroyEl(this.clearEl),this.projectStore.unsubscribe(this.storeListener)}constructor(e,t,i,r){var a;this.projectStore=e,this.getProject=t,this.saveReminder=i,this.options=r,this.element=$.el({css:{display:"grid",gridTemplateColumns:"1fr 0fr",gridTemplateRows:"0fr 0fr 0fr",gap:"0 0",gridTemplateAreas:'"title title" "preview store" "preview clear"'}});const o=$.el({parent:this.element,content:ce("file-storage"),css:{gridArea:"title",display:"flex",margin:"-5px 0"}});this.infoEl=$.el({parent:o,content:"?",title:ce("file-storage-about"),css:{cursor:"pointer",marginLeft:"5px",width:"19px",height:"19px",borderRadius:"100%",textAlign:"center",lineHeight:"19px",fontWeight:"bold",boxShadow:"inset 0 0 0 1px #000"},onClick:()=>{Wn("./help/#help-browser-storage",!1,i.getEl(),i.getBBox())}}),this.projectStore.isBroken()?$.el({parent:this.element,content:"🔴 "+ce("file-storage-cant-access"),css:{marginTop:"10px"}}):(this.previewEl=$.el({parent:this.element,title:ce("file-storage-thumb-title"),css:{gridArea:"preview",display:"flex",alignItems:"center",justifyContent:"center",marginTop:"10px",position:"relative",boxShadow:"inset 0 0 0 1px #aaa",background:"#cdcdcd",color:"#545454",colorScheme:"only light",minHeight:"67px"}}),this.ageEl=$.el({css:{position:"absolute",right:"0",bottom:"0",width:"100%",textAlign:"center",background:"rgba(0,0,0,0.7)",color:"#fff",textSize:"13px"}}),this.storeEl=$.el({parent:this.element,tagName:"button",className:"gridButton",content:ce("file-storage-store"),css:{gridArea:"store"},custom:{tabIndex:-1},onClick:()=>this.store()}),this.storeEl.tabIndex=-1,this.clearEl=$.el({parent:this.element,tagName:"button",className:"gridButton",content:'<img src="'+n(Oe)+'" height="20"/> '+ce("file-storage-clear"),css:{gridArea:"clear"},custom:{tabIndex:-1},onClick:()=>this.clear()}),(null===(a=this.options)||void 0===a?void 0:a.hideClearButton)&&(this.clearEl.style.display="none"),this.storeListener={onUpdate:(e,t)=>{this.updateThumb(e,t)}},this.projectStore.subscribe(this.storeListener),setInterval((()=>this.updateAge()),6e4),(async()=>{try{const e=await this.projectStore.read();e?this.updateThumb(e.timestamp,e.thumbnail):this.updateThumb()}catch(e){setTimeout((()=>{throw new Error("storage-ui: failed initial read browser storage, "+e)}),0)}})())}}function Kn(e){let t=e.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),n=atob(t[3]),i=new ArrayBuffer(n.length),r=new Uint8Array(i);for(let e=0;e<r.length;e++)r[e]=n.charCodeAt(e);return new Blob([r],{type:t[1]})}function Qn(e){return new Promise(((t,n)=>{const i=new Image;try{i.src=$.imageBlobToUrl(e)}catch(e){return void n("imageBlobToUrl, "+e.message)}i.onload=()=>{URL.revokeObjectURL(i.src),t(i)},i.onabort=function(){n("layer image failed loading")},i.onerror=function(){n("layer image failed loading")}}))}class qn{static createThumbnail(e){return Ye(e,$.fitInto(e.width,e.height,240,240).width/e.width)}static createStorageProject(e){return{id:1,timestamp:(new Date).getTime(),thumbnail:Kn(qn.createThumbnail(e).toDataURL("image/png")),width:e.width,height:e.height,layers:e.layers.map((e=>{let t;if(!(e.image instanceof HTMLCanvasElement))throw new Error("Not implemented");return t=Kn(e.image.toDataURL("image/png")),{name:e.name,opacity:e.opacity,mixModeStr:e.mixModeStr,blob:t}}))}}static async readStorageProject(e){if(!e.width||!e.height||isNaN(e.width)||isNaN(e.height)||e.width<1||e.height<1)throw new Error("readStorageProject invalid canvas size: "+e.width+", "+e.height);const t={width:e.width,height:e.height,layers:(await Promise.all(e.layers.map((e=>Qn(e.blob))))).map(((t,n)=>({name:e.layers[n].name,opacity:e.layers[n].opacity,mixModeStr:e.layers[n].mixModeStr,image:t})))};let n;return n=e.thumbnail?await Qn(e.thumbnail):qn.createThumbnail(t),{project:t,timestamp:e.timestamp,thumbnail:n}}}function Jn(e){return new Promise(((t,n)=>{e(t,n)}))}var $n;$n=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("cLtLX");var Zn;let ei;Zn=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("htt1j");var ti,ni,ii={};ti=ii,ni=function(){function e(e,t,n){var i=new XMLHttpRequest;i.open("GET",e),i.responseType="blob",i.onload=function(){o(i.response,t,n)},i.onerror=function(){console.error("could not download file")},i.send()}function n(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function i(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(n){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var r="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof t&&t.global===t?t:void 0,a=r.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),o=r.saveAs||("object"!=typeof window||window!==r?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(t,a,o){var s=r.URL||r.webkitURL,l=document.createElement("a");a=a||t.name||"download",l.download=a,l.rel="noopener","string"==typeof t?(l.href=t,l.origin===location.origin?i(l):n(l.href)?e(t,a,o):i(l,l.target="_blank")):(l.href=s.createObjectURL(t),setTimeout((function(){s.revokeObjectURL(l.href)}),4e4),setTimeout((function(){i(l)}),0))}:"msSaveOrOpenBlob"in navigator?function(t,r,a){if(r=r||t.name||"download","string"!=typeof t)navigator.msSaveOrOpenBlob((s=t,void 0===(l=a)?l={autoBom:!1}:"object"!=typeof l&&(console.warn("Deprecated: Expected third argument to be a object"),l={autoBom:!l}),l.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(s.type)?new Blob(["\ufeff",s],{type:s.type}):s),r);else if(n(t))e(t,r,a);else{var o=document.createElement("a");o.href=t,o.target="_blank",setTimeout((function(){i(o)}))}var s,l}:function(t,n,i,o){if((o=o||open("","_blank"))&&(o.document.title=o.document.body.innerText="downloading..."),"string"==typeof t)return e(t,n,i);var s="application/octet-stream"===t.type,l=/constructor/i.test(r.HTMLElement)||r.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent);if((h||s&&l||a)&&"undefined"!=typeof FileReader){var c=new FileReader;c.onloadend=function(){var e=c.result;e=h?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=e:location=e,o=null},c.readAsDataURL(t)}else{var d=r.URL||r.webkitURL,u=d.createObjectURL(t);o?o.location=u:location.href=u,o=null,setTimeout((function(){d.revokeObjectURL(u)}),4e4)}});r.saveAs=o.saveAs=o,ii=o},"function"==typeof define&&define.amd?define([],ni):void 0!==ii?ni():(ni(),ti.FileSaver={});class ri{emit(e,t){for(let n=0;n<this.subscriberArr.length;n++)this.subscriberArr[n]!==t&&this.subscriberArr[n](e)}emitColor(e,t){this.emit({type:"color",value:e},t)}emitSize(e,t){this.emit({type:"size",value:e},t)}emitOpacity(e,t){this.emit({type:"opacity",value:e},t)}emitSliderConfig(e,t){this.emit({type:"sliderConfig",value:e},t)}setColor(e,t){this.onSetColor(e),this.emitColor(e,t)}setSize(e,t){this.onSetSize(e)}setOpacity(e,t){this.onSetOpacity(e)}getColor(){return this.onGetColor()}getSize(){return this.onGetSize()}getOpacity(){return this.onGetOpacity()}getSliderConfig(){return this.onGetSliderConfig()}subscribe(e){this.subscriberArr.includes(e)||this.subscriberArr.push(e)}unsubscribe(e){for(let t=0;t<this.subscriberArr.length;t++)e===this.subscriberArr[t]&&(this.subscriberArr.splice(t,1),t--)}constructor(e,t,n,i,r,a,o){if(this.onSetColor=e,this.onSetSize=t,this.onSetOpacity=n,this.onGetColor=i,this.onGetSize=r,this.onGetOpacity=a,this.onGetSliderConfig=o,this.subscriberArr=[],ri.instance)throw new Error("BrushSettingService already instantiated");ri.instance=this}}var ai;ai=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("hZeW2");var oi;oi=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("lEWpa");const si={brushes:Ln,brushesUI:Vn,BrushSettingService:ri,KlCanvas:class{init(e,t){if(!e||!t||isNaN(e)||isNaN(t)||e<1||t<1)throw new Error("init - invalid canvas size: "+e+", "+t);this.width=e,this.height=t}emitChange(){this.changeListenerArr.forEach((e=>e()))}updateIndices(){this.layerCanvasArr.forEach(((e,t)=>{e.index=t}))}setHistory(e){this.history=e}reset(e){if(!e.width||!e.height||e.width<1||e.height<1||isNaN(e.width)||isNaN(e.height))throw new Error("invalid canvas size");if(this.history.pause(!0),this.width=e.width,this.height=e.height,this.layerCanvasArr.splice(1,Math.max(0,this.layerCanvasArr.length-1)),e.layers)for(let t=0;t<e.layers.length;t++){let n=e.layers[t];this.layerCanvasArr[t]||this.addLayer(),this.layerCanvasArr[t].name=n.name,this.layerCanvasArr[t].width=this.width,this.layerCanvasArr[t].height=this.height,this.layerCanvasArr[t].mixModeStr=n.mixModeStr?n.mixModeStr:"source-over",this.layerCanvasArr[t].getContext("2d").drawImage(n.image,0,0),this.layerOpacity(t,n.opacity)}else this.layerCanvasArr[0].name=e.layerName?e.layerName:ce("layers-layer")+" 1",this.layerCanvasArr[0].width=this.width,this.layerCanvasArr[0].height=this.height,this.layerCanvasArr[0].mixModeStr="source-over",this.layerOpacity(0,1),e.color?this.layerFill(0,e.color):e.image&&this.layerCanvasArr[0].getContext("2d").drawImage(e.image,0,0);return this.updateIndices(),this.history.pause(!1),this.history.push({tool:["canvas"],action:"reset",params:[e]}),this.layerCanvasArr.length-1}isLayerLimitReached(){return this.layerCanvasArr.length>=16}getWidth(){return this.width}getHeight(){return this.height}copy(e){if(e.getWidth()<1||e.getHeight()<1||isNaN(e.getWidth())||isNaN(e.getHeight()))throw new Error("invalid canvas size");let t=e.getLayers();for(;this.layerCanvasArr.length>t.length;)this.removeLayer(this.layerCanvasArr.length-1);e.getWidth()==this.width&&e.getHeight()==this.height||this.init(e.getWidth(),e.getHeight());for(let e=0;e<t.length;e++)e>=this.layerCanvasArr.length?this.addLayer():(this.layerCanvasArr[e].width=this.width,this.layerCanvasArr[e].height=this.height),this.layerOpacity(e,t[e].opacity),this.layerCanvasArr[e].name=t[e].name,this.layerCanvasArr[e].mixModeStr=t[e].mixModeStr,this.layerCanvasArr[e].getContext("2d").drawImage(t[e].context.canvas,0,0);this.updateIndices()}getLayerCount(){return this.layerCanvasArr.length}resize(e,t,n="smooth"){if(!e||!t||e===this.width&&t===this.height||isNaN(e)||isNaN(t)||e<1||t<1)return!1;let i,r;if(e=Math.max(e,1),t=Math.max(t,1),"pixelated"===n){i=$.canvas(e,t);let n=i.getContext("2d");n.imageSmoothingEnabled=!1;for(let r=0;r<this.layerCanvasArr.length;r++){r>0&&n.clearRect(0,0,e,t);let a=this.layerCanvasArr[r];n.drawImage(a,0,0,e,t),a.width=e,a.height=t,a.getContext("2d").drawImage(i,0,0)}}else{if("smooth"!==n)throw new Error("unknown resize algorithm");i=$.canvas(),r=$.canvas();for(let n=0;n<this.layerCanvasArr.length;n++)$.resizeCanvas(this.layerCanvasArr[n],e,t,i,r)}return this.width=e,this.height=t,!0}resizeCanvas(e){const t=Math.round(e.left)+this.width+Math.round(e.right),n=Math.round(e.top)+this.height+Math.round(e.bottom),i=Math.round(e.left),r=Math.round(e.top);if(isNaN(t)||isNaN(n)||t<1||n<1)throw new Error("KlCanvas.resizeCanvas - invalid canvas size");for(let a=0;a<this.layerCanvasArr.length;a++){const o=$.canvas(this.width,this.height);let s=this.layerCanvasArr[a],l=this.layerCanvasArr[a].getContext("2d");o.getContext("2d").drawImage(s,0,0),this.layerCanvasArr[a].width=t,this.layerCanvasArr[a].height=n,l.save(),0===a&&e.fillColor&&(l.fillStyle=$.ColorConverter.toRgbStr(e.fillColor),l.fillRect(0,0,t,n),l.clearRect(i,r,this.width,this.height)),l.drawImage(o,i,r),l.restore()}this.width=t,this.height=n}addLayer(e){if(this.isLayerLimitReached())return!1;let t=$.canvas(this.width,this.height);if(!t.getContext("2d"))throw new Error("kl-create-canvas-error");return t.mixModeStr="source-over",void 0===e?(this.layerCanvasArr[this.layerCanvasArr.length]=t,e=Math.max(0,this.layerCanvasArr.length-1)):(this.layerCanvasArr.splice(e+1,0,t),e++),t.name=ce("layers-layer")+" "+(this.layerCanvasArr.length+this.layerNrOffset),this.history.pause(!0),this.layerOpacity(e,1),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"addLayer",params:[e-1]}),e}duplicateLayer(e){if(!this.layerCanvasArr[e]||this.isLayerLimitReached())return!1;let t=$.canvas(this.width,this.height);return this.layerCanvasArr.splice(e+1,0,t),t.name=this.layerCanvasArr[e].name+" "+ce("layers-copy"),t.mixModeStr=this.layerCanvasArr[e].mixModeStr,t.getContext("2d").drawImage(this.layerCanvasArr[e],0,0),this.history.pause(!0),this.layerOpacity(e+1,this.layerCanvasArr[e].opacity),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"duplicateLayer",params:[e]}),e+1}getLayerContext(e,t){if(this.layerCanvasArr[e])return this.layerCanvasArr[e].getContext("2d");if(t)return null;throw new Error("layer of index "+e+" not found (in "+this.layerCanvasArr.length+" layers)")}removeLayer(e){return!!this.layerCanvasArr[e]&&(this.layerCanvasArr.splice(e,1),this.updateIndices(),this.history.push({tool:["canvas"],action:"removeLayer",params:[e]}),Math.max(0,e-1))}renameLayer(e,t){return!!this.layerCanvasArr[e]&&(this.layerCanvasArr[e].name=t,this.history.push({tool:["canvas"],action:"renameLayer",params:[e,t]}),!0)}layerOpacity(e,t){this.layerCanvasArr[e]&&(t=Math.max(0,Math.min(1,t)),this.layerCanvasArr[e].opacity=t,this.history.push({tool:["canvas"],action:"layerOpacity",params:[e,t]}),this.emitChange())}moveLayer(e,t){if(0!==t&&this.layerCanvasArr[e]){const n=this.layerCanvasArr[e];this.layerCanvasArr.splice(e,1);const i=Math.max(0,Math.min(e+t,this.layerCanvasArr.length));return this.layerCanvasArr.splice(i,0,n),this.updateIndices(),this.history.push({tool:["canvas"],action:"moveLayer",params:[e,t]}),i}}mergeLayers(e,t,n){if(!this.layerCanvasArr[e]||!this.layerCanvasArr[t]||e===t)return;if(e>t){let n=e;e=t,t=n}let i=this.layerCanvasArr[t].opacity;if(0!==i&&i){let r=this.layerCanvasArr[e].getContext("2d");r.save(),"as-alpha"===n?($.convertToAlphaChannelCanvas(this.layerCanvasArr[t]),r.globalCompositeOperation="destination-in",r.globalAlpha=i,this.layerCanvasArr[e].getContext("2d").drawImage(this.layerCanvasArr[t],0,0)):(n&&(r.globalCompositeOperation=n),r.globalAlpha=i,this.layerCanvasArr[e].getContext("2d").drawImage(this.layerCanvasArr[t],0,0)),r.restore(),n&&(r.save(),r.fillStyle="rgba(0,0,0,0.01)",r.fillRect(-.9999999,-.9999999,1,1),r.restore())}return this.updateIndices(),this.history.pause(!0),this.removeLayer(t),this.history.pause(!1),this.history.push({tool:["canvas"],action:"mergeLayers",params:[e,t,n]}),e}rotate(e){for(;e<0;)e+=360;if((e%=360)%90!=0||0===e)return;let t=$.canvas();0===e||180===e?(t.width=this.width,t.height=this.height):90!==e&&270!==e||(t.width=this.height,t.height=this.width);let n=t.getContext("2d");for(let i=0;i<this.layerCanvasArr.length;i++)n.clearRect(0,0,t.width,t.height),n.save(),n.translate(t.width/2,t.height/2),n.rotate(e*Math.PI/180),180===e?n.drawImage(this.layerCanvasArr[i],-t.width/2,-t.height/2):90!==e&&270!==e||n.drawImage(this.layerCanvasArr[i],-t.height/2,-t.width/2),this.layerCanvasArr[i].width=t.width,this.layerCanvasArr[i].height=t.height,this.layerCanvasArr[i].getContext("2d").clearRect(0,0,this.layerCanvasArr[i].width,this.layerCanvasArr[i].height),this.layerCanvasArr[i].getContext("2d").drawImage(t,0,0),n.restore();this.width=t.width,this.height=t.height}flip(e,t,n){if(!e&&!t)return;let i=$.canvas(this.width,this.height);i.width=this.width,i.height=this.height;let r=i.getContext("2d");for(let a=0;a<this.layerCanvasArr.length;a++)(!n&&0!==n||a===n)&&(r.save(),r.clearRect(0,0,i.width,i.height),r.translate(i.width/2,i.height/2),r.scale(e?-1:1,t?-1:1),r.drawImage(this.layerCanvasArr[a],-i.width/2,-i.height/2),r.restore(),this.layerCanvasArr[a].getContext("2d").clearRect(0,0,this.layerCanvasArr[a].width,this.layerCanvasArr[a].height),this.layerCanvasArr[a].getContext("2d").drawImage(i,0,0))}layerFill(e,t,n){let i=this.layerCanvasArr[e].getContext("2d");i.save(),n&&(i.globalCompositeOperation=n),i.fillStyle="rgba("+t.r+","+t.g+","+t.b+",1)",i.fillRect(0,0,this.layerCanvasArr[e].width,this.layerCanvasArr[e].height),i.restore(),i.save(),i.fillStyle="rgba(0,0,0,0.01)",i.fillRect(-.9999999,-.9999999,1,1),i.restore(),this.history.push({tool:["canvas"],action:"layerFill",params:[e,t,n]})}floodFill(e,t,n,i,r,a,o,s,l){if(t<0||n<0||t>=this.width||n>=this.height||0===r)return;if(a=Math.round(a),!["above","current","all"].includes(o))throw new Error("invalid sampleStr");let h,c,d,u,p,g,m;if("all"===o){let i=1===this.layerCanvasArr.length?this.layerCanvasArr[0]:this.getCompleteCanvas(1);c=i.getContext("2d"),d=c.getImageData(0,0,this.width,this.height),u=d.data,h=Ne(u,this.width,this.height,t,n,a,Math.round(s),l),i=null,c=null,d=null,u=null,p=this.layerCanvasArr[e].getContext("2d"),g=p.getImageData(0,0,this.width,this.height)}else{let i="above"===o?e+1:e;if(i>=this.layerCanvasArr.length)return;c=this.layerCanvasArr[i].getContext("2d"),d=c.getImageData(0,0,this.width,this.height),u=d.data,h=Ne(u,this.width,this.height,t,n,a,Math.round(s),l),e!==i&&(c=null,d=null,u=null),p=e===i?c:this.layerCanvasArr[e].getContext("2d"),g=e===i?d:p.getImageData(0,0,this.width,this.height)}if(m=g.data,1===r)for(let e=0;e<this.width*this.height;e++)255===h.data[e]&&(m[4*e]=i.r,m[4*e+1]=i.g,m[4*e+2]=i.b,m[4*e+3]=255);else for(let e=0;e<this.width*this.height;e++)255===h.data[e]&&(m[4*e]=$.mix(m[4*e],i.r,r),m[4*e+1]=$.mix(m[4*e+1],i.g,r),m[4*e+2]=$.mix(m[4*e+2],i.b,r),m[4*e+3]=$.mix(m[4*e+3],255,r));p.putImageData(g,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[e,g]})}drawShape(e,t){Ue(this.layerCanvasArr[e].getContext("2d"),t),this.history.push({tool:["canvas"],action:"drawShape",params:[e,$.copyObj(t)]})}text(e,t){Xe(this.layerCanvasArr[e],$.copyObj(t)),this.history.push({tool:["canvas"],action:"text",params:[e,$.copyObj(t)]})}replaceLayer(e,t){this.layerCanvasArr[e].getContext("2d").putImageData(t,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[e,t]})}clearLayer(e){let t=this.layerCanvasArr[e].getContext("2d");t.save(),t.clearRect(0,0,this.layerCanvasArr[e].width,this.layerCanvasArr[e].height),t.restore(),this.history.push({tool:["canvas"],action:"clearLayer",params:[e]})}getLayers(){return this.layerCanvasArr.map((e=>({context:e.getContext("2d"),opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr})))}getLayersFast(){return this.layerCanvasArr.map((e=>({canvas:e,opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr})))}getLayerIndex(e,t){for(let t=0;t<this.layerCanvasArr.length;t++)if(this.layerCanvasArr[t]===e)return t;if(!t)throw new Error("layer not found (in "+this.layerCanvasArr.length+" layers)");return null}getLayer(e,t){if(this.layerCanvasArr[e])return{context:this.layerCanvasArr[e].getContext("2d"),opacity:this.layerCanvasArr[e].opacity,name:this.layerCanvasArr[e].name,id:e};if(!t)throw new Error("layer of index "+e+" not found (in "+this.layerCanvasArr.length+" layers)");return null}getColorAt(e,t){e=Math.floor(e),t=Math.floor(t);let n=this.pickCanvas.getContext("2d");n.save(),n.imageSmoothingEnabled=!1,n.clearRect(0,0,1,1);for(let i=0;i<this.layerCanvasArr.length;i++)n.globalAlpha=this.layerCanvasArr[i].opacity,n.globalCompositeOperation=this.layerCanvasArr[i].mixModeStr,n.drawImage(this.layerCanvasArr[i],-e,-t);n.restore();let i=n.getImageData(0,0,1,1);return new $.RGB(i.data[0],i.data[1],i.data[2])}getCompleteCanvas(e){return Ye(this.getProject(),e)}getProject(){return{width:this.width,height:this.height,layers:this.layerCanvasArr.map((e=>({name:e.name,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e})))}}addChangeListener(e){this.changeListenerArr.includes(e)||this.changeListenerArr.push(e)}removeChangeListener(e){for(let t=0;t<this.changeListenerArr.length;t++)if(this.changeListenerArr[t]===e)return void this.changeListenerArr.splice(t,1)}setMixMode(e,t){if(!this.layerCanvasArr[e])throw new Error("invalid layer");this.layerCanvasArr[e].mixModeStr=t,this.history.push({tool:["canvas"],action:"setMixMode",params:[e,""+t]})}setComposite(e,t){if(!this.layerCanvasArr[e])throw new Error("invalid layer");this.layerCanvasArr[e].compositeObj=t}destroy(){null!==this.layerCanvasArr&&(this.layerCanvasArr.forEach((e=>{$.freeCanvas(e)})),this.layerCanvasArr=null)}constructor(e,t=0){if(this.layerNrOffset=t,this.layerCanvasArr=[],this.pickCanvas=$.canvas(1,1),this.history=new ee,"copy"in e?(this.width=1,this.height=1):"width"in e&&"height"in e?(this.width=e.width,this.height=e.height):(this.width=1,this.height=1),this.init(this.width,this.height),this.changeListenerArr=[],"copy"in e)try{this.copy(e.copy)}catch(e){throw this.destroy(),e}else if("projectObj"in e){const t=[].concat(e.projectObj.layers);if(this.init(e.projectObj.width,e.projectObj.height),!t.length)throw new Error("project.layers needs at least 1 layer");for(let e=0;e<t.length;e++){if(t[e].mixModeStr&&!Ve.includes(t[e].mixModeStr))throw new Error("unknown mixModeStr "+t[e].mixModeStr);this.addLayer(),this.layerOpacity(e,t[e].opacity),this.layerCanvasArr[e].name=t[e].name,this.layerCanvasArr[e].mixModeStr=t[e].mixModeStr?t[e].mixModeStr:"source-over",this.layerCanvasArr[e].getContext("2d").drawImage(t[e].image,0,0)}}this.updateIndices()}},drawProject:Ye,WorkspaceSvgOverlay:Ge,KlCanvasWorkspace:class{getRenderedTransform(){const e=this.renderedTransformObj;return e.x=this.highResTransformObj.x,e.y=this.highResTransformObj.y,e.scale=this.highResTransformObj.scale,e.angle=this.highResTransformObj.angle,e.angle%(Math.PI/2)==0&&e.scale%1==0&&(e.x=Math.round(e.x),e.y=Math.round(e.y)),e}updateChangeListener(){this.klCanvas.addChangeListener((()=>{this.lastRenderedState=-1,this.reqFrame()}))}updateCursor(e,t){if(e===this.currentMode&&!t)return;const i=this.currentMode;if(this.currentMode=e,this.lastRenderedState=-1,this.currentMode===$e.Draw?this.rootEl.style.cursor="crosshair":this.currentMode===$e.Hand?this.rootEl.style.cursor="grab":this.currentMode===$e.HandGrabbing?this.rootEl.style.cursor="grabbing":this.currentMode===$e.Pick?this.rootEl.style.cursor="url('"+n(Ke)+"') 0 15, crosshair":this.currentMode===$e.Zoom?this.rootEl.style.cursor="url('"+n(Qe)+"') 7 7, zoom-in":this.currentMode===$e.Rotate?this.rootEl.style.cursor="grab":this.currentMode===$e.Rotating?this.rootEl.style.cursor="grabbing":this.currentMode===$e.Fill?this.rootEl.style.cursor="url('"+n(qe)+"') 1 12, crosshair":this.currentMode===$e.Text?this.rootEl.style.cursor="url('"+n(Je)+"') 1 12, crosshair":this.currentMode===$e.Shape&&(this.rootEl.style.cursor="crosshair"),[$e.Draw,$e.Pick,$e.Fill,$e.Text,$e.Shape].includes(this.globalMode)){const e=[$e.Hand,$e.HandGrabbing].includes(i),t=[$e.Hand,$e.HandGrabbing].includes(this.currentMode);!e&&t&&this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"]),e&&!t&&this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])}this.currentMode!==$e.Pick&&this.svgOverlay.updateColorPreview({isVisible:!1})}internalZoomByStep(e,t,n){let i=Math.log2(this.targetTransformObj.scale)/Math.abs(e);i+=e>0?1:-1,i=Math.round(i),i*=Math.abs(e);const r=Math.max(.0625,Math.min(64,Math.pow(2,i)));if(r===this.targetTransformObj.scale)return!1;const a=r/this.targetTransformObj.scale;this.targetTransformObj.scale=r;let o=$.Matrix.getIdentity();o=$.Matrix.multiplyMatrices(o,$.Matrix.createTranslationMatrix(t,n)),o=$.Matrix.multiplyMatrices(o,$.Matrix.createScaleMatrix(a)),o=$.Matrix.multiplyMatrices(o,$.Matrix.createTranslationMatrix(-t,-n));let s=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];return s=$.Matrix.multiplyMatrixAndPoint(o,s),this.targetTransformObj.x=s[0],this.targetTransformObj.y=s[1],this.transformIsDirty=!0,!0}mixTransformObj(e,t,n){if(e.angle===t.angle)return e.scale=$.mix(e.scale,t.scale,n),e.x=$.mix(e.x,t.x,n),e.y=$.mix(e.y,t.y,n),void(e.angle=$.mix(e.angle,t.angle,n));const i=this.klCanvas.getWidth(),r=this.klCanvas.getHeight(),a=this.canvasToWorkspaceCoord({x:i/2,y:r/2},e),o=this.canvasToWorkspaceCoord({x:i/2,y:r/2},t);e.x=$.mix(a.x,o.x,n),e.y=$.mix(a.y,o.y,n),e.scale=$.mix(e.scale,t.scale,n),e.angle=$.mix(e.angle,t.angle,n);const s=this.canvasToWorkspaceCoord({x:-i/2,y:-r/2},e);e.x=s.x,e.y=s.y}render(){this.doResizeCanvas&&(this.doResizeCanvas=!1,this.renderTargetCanvas.width=this.renderWidth,this.renderTargetCanvas.height=this.renderHeight),this.renderContext(this.renderTargetCtx)}testBgVisible(){const e=[[0,0],[this.renderWidth,0],[this.renderWidth,this.renderHeight],[0,this.renderHeight]],t=this.getRenderedTransform();let n=$.Matrix.getIdentity();n=$.Matrix.multiplyMatrices(n,$.Matrix.createScaleMatrix(1/t.scale)),n=$.Matrix.multiplyMatrices(n,$.Matrix.createRotationMatrix(-t.angle)),n=$.Matrix.multiplyMatrices(n,$.Matrix.createTranslationMatrix(-t.x,-t.y));for(let t=0;t<e.length;t++){let i=[e[t][0],e[t][1],0,1];if(i=$.Matrix.multiplyMatrixAndPoint(n,i),!(0<=i[0]&&i[0]<=this.klCanvas.getWidth()&&0<=i[1]&&i[1]<=this.klCanvas.getHeight()))return!0}return!1}renderContext(e){const t=this.klCanvas.getWidth(),n=this.klCanvas.getHeight(),i=this.getRenderedTransform();i.scale>=4||1===i.scale&&0===i.angle?e.imageSmoothingEnabled=!1:(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="low"),e.save();{if(this.bgVisible?(e.fillStyle="rgb(158,158,158)",e.fillRect(0,0,this.renderWidth,this.renderHeight)):e.clearRect(0,0,this.renderWidth,this.renderHeight),this.bgVisible){e.save(),e.translate(i.x,i.y),e.scale(i.scale,i.scale),e.rotate(i.angle),e.imageSmoothingEnabled=!1;const r=1;e.globalAlpha=.2,e.drawImage(this.emptyCanvas,-r/i.scale,-r/i.scale,t+2*r/i.scale,n+2*r/i.scale),e.globalAlpha=1,e.globalCompositeOperation="destination-out",e.drawImage(this.emptyCanvas,0,0,t,n),e.restore()}e.translate(i.x,i.y),e.scale(i.scale,i.scale),e.rotate(i.angle);const r=this.klCanvas.getLayersFast();for(let i=0;i<r.length;i++)r[i].opacity>0&&(e.globalAlpha=r[i].opacity,e.globalCompositeOperation=r[i].mixModeStr,r[i].canvas.compositeObj?(this.compositeCanvas.width!==r[i].canvas.width||this.compositeCanvas.height!==r[i].canvas.height?(this.compositeCanvas.width=r[i].canvas.width,this.compositeCanvas.height=r[i].canvas.height):this.compositeCtx.clearRect(0,0,this.compositeCanvas.width,this.compositeCanvas.height),this.compositeCtx.drawImage(r[i].canvas,0,0),r[i].canvas.compositeObj.draw(this.compositeCtx),e.drawImage(this.compositeCanvas,0,0,t,n)):e.drawImage(r[i].canvas,0,0,t,n));e.globalAlpha=1}e.restore(),$e.Rotate===this.currentMode||$e.Rotating===this.currentMode?this.svgOverlay.updateCompass({isVisible:!0,angleDeg:i.angle/Math.PI*180}):this.svgOverlay.updateCompass({isVisible:!1})}workspaceToCanvasCoord(e){const t=this.getRenderedTransform();let n=$.Matrix.getIdentity();n=$.Matrix.multiplyMatrices(n,$.Matrix.createScaleMatrix(1/t.scale)),n=$.Matrix.multiplyMatrices(n,$.Matrix.createRotationMatrix(-t.angle)),n=$.Matrix.multiplyMatrices(n,$.Matrix.createTranslationMatrix(-t.x,-t.y));let i=[e.x,e.y,0,1];return i=$.Matrix.multiplyMatrixAndPoint(n,i),{x:i[0],y:i[1]}}canvasToWorkspaceCoord(e,t){let n=$.Matrix.getIdentity();n=$.Matrix.multiplyMatrices(n,$.Matrix.createTranslationMatrix(t.x,t.y)),n=$.Matrix.multiplyMatrices(n,$.Matrix.createRotationMatrix(t.angle)),n=$.Matrix.multiplyMatrices(n,$.Matrix.createScaleMatrix(t.scale));let i=[e.x,e.y,0,1];return i=$.Matrix.multiplyMatrixAndPoint(n,i),{x:i[0],y:i[1]}}snapAngleRad(e,t,n){let i=180*e/Math.PI;const r=Math.abs(i%t);return Math.min(r,t-r)<=n&&(i=Math.round(i/t)*t),i/180*Math.PI}minimizeAngleRad(e){return(e%=2*Math.PI)>Math.PI?e-=2*Math.PI:e<-Math.PI&&(e+=2*Math.PI),e}resetInputProcessor(){this.currentInputProcessor=null,this.updateCursor(this.globalMode),this.reqFrame(!0)}reqFrame(e){this.animationFrameRequested=!0,e&&(this.lastRenderedState=-1)}updateLoop(){window.requestAnimationFrame((()=>this.updateLoop()));const e=te.getState(),t=this.lastRenderedState<e,n=performance.now(),i=60*(n-this.lastRenderTime)/1e3;this.lastRenderTime=n,(this.animationFrameRequested||t)&&(this.animationFrameRequested=!1,this.checkChange(i))}checkChange(e){const t=te.getState(),n=this.lastRenderedState<t||this.highResTransformObj.scale!==this.targetTransformObj.scale||this.highResTransformObj.x!==this.targetTransformObj.x||this.highResTransformObj.y!==this.targetTransformObj.y;if(!this.doAnimateTranslate&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else if((this.highResTransformObj.x===this.targetTransformObj.x||Math.abs(this.highResTransformObj.x-this.targetTransformObj.x)<.5)&&(this.highResTransformObj.y===this.targetTransformObj.y||Math.abs(this.highResTransformObj.y-this.targetTransformObj.y)<.5)&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.doAnimateTranslate=!1,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else{this.reqFrame();const t=Math.min(1,.3*e);this.mixTransformObj(this.highResTransformObj,this.targetTransformObj,t),this.bgVisible=!0,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale})}if(this.pointer&&this.currentMode==$e.Draw&&!this.usesCssCursor?this.svgOverlay.updateCursor({x:this.pointer.x,y:this.pointer.y,isVisible:!0}):this.svgOverlay.updateCursor({isVisible:!1}),n){this.lastRenderedState=t;const e=performance.now();this.render(),this.renderTime=$.mix(this.renderTime,performance.now()-e,.05)}}getElement(){return this.rootEl}setCanvas(e){this.klCanvas=e,this.lastDrawEvent=null,this.resetView(),this.updateChangeListener(),this.lastRenderedState=-1,this.reqFrame()}setSize(e,t){const n=this.renderWidth,i=this.renderHeight;e===n&&t===i||(this.doResizeCanvas=!0,this.renderWidth=e,this.renderHeight=t,this.svgOverlay.setSize(e,t),this.targetTransformObj.x+=(e-n)/2,this.targetTransformObj.y+=(t-i)/2,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.bgVisible=this.testBgVisible(),this.lastRenderedState=-1,this.reqFrame())}setMode(e){"draw"===e&&(this.globalMode=$e.Draw,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"fill"===e&&(this.globalMode=$e.Fill,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"text"===e&&(this.globalMode=$e.Text,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"shape"===e&&(this.globalMode=$e.Shape,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"hand"===e&&(this.globalMode=$e.Hand,this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"])),"pick"===e&&(this.globalMode=$e.Pick,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"]))}setEnabled(e){}setCursorSize(e){this.brushRadius=e/2,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale}),null===this.pointer&&(clearTimeout(this.hideBrushCursorTimeout),this.svgOverlay.updateCursor({x:this.renderWidth/2,y:this.renderHeight/2,isVisible:!0}),this.hideBrushCursorTimeout=setTimeout((()=>{null===this.pointer&&this.svgOverlay.updateCursor({isVisible:!1})}),500))}zoomByStep(e){this.internalZoomByStep(e,this.renderWidth/2,this.renderHeight/2)&&(this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}))}resetView(e){this.targetTransformObj.scale=1,this.targetTransformObj.angle=0,this.targetTransformObj.x=(this.renderWidth-this.klCanvas.getWidth())/2,this.targetTransformObj.y=(this.renderHeight-this.klCanvas.getHeight())/2,e?(this.doAnimateTranslate=!0,this.transformIsDirty=!0):this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.bgVisible=this.testBgVisible(),this.reqFrame(),e&&this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}fitView(){const e=[[0,0],[this.klCanvas.getWidth(),0],[this.klCanvas.getWidth(),this.klCanvas.getHeight()],[0,this.klCanvas.getHeight()],[this.klCanvas.getWidth()/2,this.klCanvas.getHeight()/2]];let t=$.Matrix.getIdentity();t=$.Matrix.multiplyMatrices(t,$.Matrix.createRotationMatrix(this.targetTransformObj.angle));for(let n=0;n<e.length;n++){let i=[e[n][0],e[n][1],0,1];i=$.Matrix.multiplyMatrixAndPoint(t,i),e[n][0]=i[0],e[n][1]=i[1]}const n={x0:null,y0:null,x1:null,y1:null};for(let t=0;t<e.length;t++)(null===n.x0||e[t][0]<n.x0)&&(n.x0=e[t][0]),(null===n.y0||e[t][1]<n.y0)&&(n.y0=e[t][1]),(null===n.x1||e[t][0]>n.x1)&&(n.x1=e[t][0]),(null===n.y1||e[t][1]>n.y1)&&(n.y1=e[t][1]);const i=n.x1-n.x0,r=n.y1-n.y0,{width:a}=$.fitInto(i,r,this.renderWidth-40,this.renderHeight-40,1),o=a/i;this.targetTransformObj.x=this.renderWidth/2-(e[4][0]-e[0][0])*o,this.targetTransformObj.y=this.renderHeight/2-(e[4][1]-e[0][1])*o,this.targetTransformObj.scale=o,this.doAnimateTranslate=!0,this.transformIsDirty=!0,this.reqFrame(),this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}setAngle(e,t){const n={x:this.renderWidth/2,y:this.renderHeight/2},i=this.targetTransformObj.angle,r=e/180*Math.PI;t?this.targetTransformObj.angle+=r:this.targetTransformObj.angle=r,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,4));let a=$.Matrix.getIdentity();a=$.Matrix.multiplyMatrices(a,$.Matrix.createTranslationMatrix(n.x,n.y)),a=$.Matrix.multiplyMatrices(a,$.Matrix.createRotationMatrix(this.targetTransformObj.angle-i)),a=$.Matrix.multiplyMatrices(a,$.Matrix.createTranslationMatrix(-n.x,-n.y));let o=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];o=$.Matrix.multiplyMatrixAndPoint(a,o),this.targetTransformObj.x=o[0],this.targetTransformObj.y=o[1],this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.transformIsDirty=!0,this.reqFrame(!0)}translateView(e,t){this.targetTransformObj.x+=40*e,this.targetTransformObj.y+=40*t,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.reqFrame(!0)}getIsDrawing(){return this.isDrawing}getScale(){return this.targetTransformObj.scale}getAngleDeg(){return 180*this.targetTransformObj.angle/Math.PI}getMaxScale(){return 64}getMinScale(){return.0625}requestFrame(){this.lastRenderedState=-1,this.reqFrame()}setLastDrawEvent(e,t,n){null!==e?(this.lastDrawEvent||(this.lastDrawEvent={x:0,y:0,pressure:0}),this.lastDrawEvent.x=e,this.lastDrawEvent.y=t,this.lastDrawEvent.pressure=n):this.lastDrawEvent=null}constructor(e){const t=this;this.rootEl=$.el({css:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0",cursor:"crosshair",userSelect:"none",colorScheme:"only light"}}),this.klCanvas=e.klCanvas,this.onViewChange=e.onViewChange,this.renderTargetCanvas=$.canvas(e.width,e.height),this.renderTargetCtx=this.renderTargetCanvas.getContext("2d"),this.renderWidth=e.width,this.renderHeight=e.height,this.compositeCanvas=$.canvas(1,1),this.compositeCtx=this.compositeCanvas.getContext("2d"),this.doResizeCanvas=!1,this.oldTransformObj=null,this.targetTransformObj={x:0,y:0,scale:1,angle:0},this.highResTransformObj={x:0,y:0,scale:1,angle:0},this.renderedTransformObj={x:null,y:null,scale:null,angle:null},this.cursorPos={x:0,y:0},this.usesCssCursor=!1,this.bgVisible=!0,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.svgOverlay=new Ge({width:e.width,height:e.height}),$.css(this.renderTargetCanvas,{userSelect:"none",pointerEvents:"none"}),$.createCheckerDataUrl(8,(e=>{this.renderTargetCanvas.style.background="url("+e+")"})),this.rootEl.appendChild(this.renderTargetCanvas),this.rootEl.appendChild(this.svgOverlay.getElement()),$.addEventListener(this.rootEl,"touchend",(e=>(e.preventDefault(),!1))),$.addEventListener(this.rootEl,"contextmenu",(e=>(e.preventDefault(),!1))),$.addEventListener(this.rootEl,"dragstart",(e=>(e.preventDefault(),!1))),this.emptyCanvas=$.canvas(1,1);this.emptyCanvas.getContext("2d").fillRect(0,0,1,1);this.keyListener=new $.KeyListener({onDown:(e,t,n,i)=>{if("alt"===e&&t.preventDefault(),!i)if(this.currentInputProcessor)this.currentInputProcessor.onKeyDown(e,t,n,i);else{if([$e.Draw,$e.Pick,$e.Fill,$e.Text,$e.Shape].includes(this.globalMode)&&"space"===n)return this.currentInputProcessor=this.inputProcessorObj.spaceHand,void this.currentInputProcessor.onKeyDown(e,t,n,i);if([$e.Draw,$e.Hand,$e.Fill,$e.Text,$e.Shape].includes(this.globalMode)&&"alt"===n)return this.currentInputProcessor=this.inputProcessorObj.altPicker,void this.currentInputProcessor.onKeyDown(e,t,n,i);if(["r","shift+r"].includes(n))return this.currentInputProcessor=this.inputProcessorObj.rotate,void this.currentInputProcessor.onKeyDown(e,t,n,i);if("z"===n)return this.currentInputProcessor=this.inputProcessorObj.zoom,void this.currentInputProcessor.onKeyDown(e,t,n,i)}},onUp:(e,t,n)=>{this.currentInputProcessor&&this.currentInputProcessor.onKeyUp(e,t,n)}}),this.updateChangeListener(),this.currentMode=$e.Draw,this.globalMode=$e.Draw,this.renderTime=0,this.lastDrawEvent=null,this.linetoolProcessor=new $.EventChain.LinetoolProcessor({onDraw:t=>{const n=()=>{const e=this.getRenderedTransform();let t=$.Matrix.getIdentity();return t=$.Matrix.multiplyMatrices(t,$.Matrix.createScaleMatrix(1/e.scale)),t=$.Matrix.multiplyMatrices(t,$.Matrix.createRotationMatrix(-e.angle)),t=$.Matrix.multiplyMatrices(t,$.Matrix.createTranslationMatrix(-e.x,-e.y)),t};if("line"===t.type&&!this.lastDrawEvent){const e=n();let i=[t.x1,t.y1,0,1];return i=$.Matrix.multiplyMatrixAndPoint(e,i),void(this.lastDrawEvent={x:i[0],y:i[1],pressure:t.pressure1})}if("x"in t||"x0"in t){const e=n();if("x"in t){let n=[t.x,t.y,0,1];n=$.Matrix.multiplyMatrixAndPoint(e,n),t.x=n[0],t.y=n[1]}if("x0"in t){t.x0=this.lastDrawEvent.x,t.y0=this.lastDrawEvent.y,t.pressure0=this.lastDrawEvent.pressure;let n=[t.x1,t.y1,0,1];n=$.Matrix.multiplyMatrixAndPoint(e,n),t.x1=n[0],t.y1=n[1],this.lastDrawEvent={x:t.x1,y:t.y1,pressure:t.pressure1}}}["down","move"].includes(t.type)&&(this.lastDrawEvent=t),e.onDraw(t)}}),this.pointer=null,this.isDrawing=!1,this.inputProcessorObj={draw:{onPointer:e=>{this.reqFrame(),this.updateCursor($e.Draw);const t=this.keyListener.getComboStr(),n={scale:this.highResTransformObj.scale};if(n.shiftIsPressed="shift"===t,n.pressure=e.pressure,n.isCoalesced=!!e.isCoalesced,"pointerdown"===e.type)this.isDrawing=!0,n.type="down";else{if(!e.button)return"pointerup"===e.type?(this.isDrawing=!1,n.type="up",this.linetoolProcessor.process(n),void this.resetInputProcessor()):void 0;n.type="move"}n.x=e.relX,n.y=e.relY,this.linetoolProcessor.process(n)},onKeyDown:(e,t,n,i)=>{},onKeyUp:(e,t,n)=>{}},fill:{onPointer:t=>{if(this.reqFrame(),this.updateCursor($e.Fill),"pointerdown"===t.type){const n=this.workspaceToCanvasCoord({x:t.relX,y:t.relY});e.onFill(Math.floor(n.x),Math.floor(n.y))}else if("pointerup"===t.type)return void this.resetInputProcessor()},onKeyDown:(e,t,n,i)=>{},onKeyUp:(e,t,n)=>{}},text:{onPointer:t=>{if(this.reqFrame(),this.updateCursor($e.Text),"pointerdown"===t.type){const n=this.workspaceToCanvasCoord({x:t.relX,y:t.relY});e.onText(Math.floor(n.x),Math.floor(n.y),this.renderedTransformObj.angle)}else if("pointerup"===t.type)return void this.resetInputProcessor()},onKeyDown:(e,t,n,i)=>{},onKeyUp:(e,t,n)=>{}},shape:{onPointer:t=>{this.reqFrame(),this.updateCursor($e.Shape);const n=this.workspaceToCanvasCoord({x:t.relX,y:t.relY});"pointerdown"===t.type?(this.isDrawing=!0,e.onShape("down",n.x,n.y,this.renderedTransformObj.angle)):"pointermove"===t.type?e.onShape("move",n.x,n.y,this.renderedTransformObj.angle):"pointerup"===t.type&&(this.isDrawing=!1,e.onShape("up",n.x,n.y,this.renderedTransformObj.angle),this.resetInputProcessor())},onKeyDown:(e,t,n,i)=>{},onKeyUp:(e,t,n)=>{}},hand:{onPointer:e=>{this.updateCursor($e.Hand),["left","middle"].includes(e.button)?(this.updateCursor($e.HandGrabbing),this.targetTransformObj.x+=e.dX,this.targetTransformObj.y+=e.dY,this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.doAnimateTranslate=!1,this.transformIsDirty=!0,this.reqFrame(!0)):"pointerup"===e.type&&this.resetInputProcessor()},onKeyDown:(e,t,n,i)=>{},onKeyUp:(e,t,n)=>{}},spaceHand:{onPointer:e=>{this.updateCursor($e.Hand),["left","middle"].includes(e.button)&&(this.updateCursor($e.HandGrabbing),this.targetTransformObj.x+=e.dX,this.targetTransformObj.y+=e.dY,this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.doAnimateTranslate=!1,this.transformIsDirty=!0,this.reqFrame(!0))},onKeyDown:(e,t,n,i)=>{"space"!==n?this.resetInputProcessor():this.updateCursor($e.Hand)},onKeyUp:(e,t,n)=>{this.resetInputProcessor()}},zoom:{onPointer:e=>{if(this.updateCursor($e.Zoom),"left"===e.button&&!e.isCoalesced&&0!=e.dX){const t=e.pageX-e.relX,n=e.pageY-e.relY;this.internalZoomByStep(e.dX/175,e.downPageX-t,e.downPageY-n),this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale})}},onKeyDown:(e,t,n,i)=>{"z"!==n?this.resetInputProcessor():this.updateCursor($e.Zoom)},onKeyUp:(e,t,n)=>{this.resetInputProcessor()}},picker:{onPointer:t=>{if(this.updateCursor($e.Pick),["left","right"].includes(t.button)&&!t.isCoalesced||"pointerup"===t.type){const n=this.workspaceToCanvasCoord({x:t.relX,y:t.relY}),i=this.klCanvas.getColorAt(n.x,n.y);e.onPick(i,"pointerup"===t.type),this.svgOverlay.updateColorPreview({x:t.relX,y:t.relY,color:i,isVisible:"pointerup"!==t.type}),"pointerup"===t.type&&this.resetInputProcessor()}},onKeyDown:(e,t,n,i)=>{},onKeyUp:(e,t,n)=>{}},altPicker:{onPointer:t=>{if(this.updateCursor($e.Pick),["left","right"].includes(t.button)&&!t.isCoalesced||"pointerup"===t.type){const n=this.workspaceToCanvasCoord({x:t.relX,y:t.relY}),i=this.klCanvas.getColorAt(n.x,n.y);e.onPick(i,"pointerup"===t.type),this.svgOverlay.updateColorPreview({x:t.relX,y:t.relY,color:i,isVisible:"pointerup"!==t.type})}},onKeyDown:(e,t,n,i)=>{"alt"!==n?this.resetInputProcessor():this.updateCursor($e.Pick)},onKeyUp:(e,t,n)=>{this.resetInputProcessor()}},rotate:{onPointer:e=>{if(this.updateCursor("left"===e.button?$e.Rotating:$e.Rotate),"pointerdown"===e.type&&"left"===e.button)this.oldTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj));else if("left"===e.button&&!e.isCoalesced&&this.oldTransformObj){const t=e.pageX-e.relX,n=e.pageY-e.relY,i={x:this.renderWidth/2,y:this.renderHeight/2},r=$.Vec2.angle(i,{x:e.downPageX-t,y:e.downPageY-n});let a=$.Vec2.angle(i,{x:e.pageX-t,y:e.pageY-n})-r;this.targetTransformObj=JSON.parse(JSON.stringify(this.oldTransformObj)),this.targetTransformObj.angle+=a,this.keyListener.isPressed("shift")&&(this.targetTransformObj.angle=Math.round(this.targetTransformObj.angle/Math.PI*8)*Math.PI/8,a=this.targetTransformObj.angle-this.oldTransformObj.angle),this.targetTransformObj.angle=this.minimizeAngleRad(this.targetTransformObj.angle);let o=$.Matrix.getIdentity();o=$.Matrix.multiplyMatrices(o,$.Matrix.createTranslationMatrix(i.x,i.y)),o=$.Matrix.multiplyMatrices(o,$.Matrix.createRotationMatrix(a)),o=$.Matrix.multiplyMatrices(o,$.Matrix.createTranslationMatrix(-i.x,-i.y));let s=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];s=$.Matrix.multiplyMatrixAndPoint(o,s),this.targetTransformObj.x=s[0],this.targetTransformObj.y=s[1],this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.transformIsDirty=!0,this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}},onKeyDown:(e,t,n,i)=>{["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(n)?this.updateCursor($e.Rotate):this.resetInputProcessor()},onKeyUp:(e,t,n)=>{const i=this.keyListener.getComboStr();["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(i)?this.updateCursor($e.Rotate):this.resetInputProcessor()}}},this.currentInputProcessor=null,this.angleIsExtraSticky=!1,this.pinchZoomer=new $.EventChain.PinchZoomer({onPinch:e=>{if("move"===e.type){this.oldTransformObj||(this.oldTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.angleIsExtraSticky=this.targetTransformObj.angle%(Math.PI/2)==0),this.targetTransformObj=JSON.parse(JSON.stringify(this.oldTransformObj)),e.scale=Math.max(.0625,Math.min(64,this.targetTransformObj.scale*e.scale))/this.targetTransformObj.scale,this.targetTransformObj.scale*=e.scale,this.targetTransformObj.angle+=e.angleRad,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,this.angleIsExtraSticky?12:4)),this.targetTransformObj.angle%(Math.PI/2)!=0&&(this.angleIsExtraSticky=!1),e.angleRad=this.targetTransformObj.angle-this.oldTransformObj.angle;{let t=$.Matrix.getIdentity();t=$.Matrix.multiplyMatrices(t,$.Matrix.createTranslationMatrix(e.relX,e.relY)),t=$.Matrix.multiplyMatrices(t,$.Matrix.createScaleMatrix(e.scale)),t=$.Matrix.multiplyMatrices(t,$.Matrix.createRotationMatrix(e.angleRad)),t=$.Matrix.multiplyMatrices(t,$.Matrix.createTranslationMatrix(-e.relX,-e.relY)),t=$.Matrix.multiplyMatrices(t,$.Matrix.createTranslationMatrix(e.relX-e.downRelX,e.relY-e.downRelY));let n=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];n=$.Matrix.multiplyMatrixAndPoint(t,n),this.targetTransformObj.x=n[0],this.targetTransformObj.y=n[1]}this.highResTransformObj=$.copyObj(this.targetTransformObj),this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle}),this.reqFrame(),this.transformIsDirty=!0,this.lastRenderedState=-1}else"end"===e.type&&(this.oldTransformObj=null)}});const n=()=>{let e=JSON.parse(JSON.stringify(this.targetTransformObj));t.fitView(),this.lastRenderedState=-1,this.reqFrame(),e.scale===this.targetTransformObj.scale&&e.angle===this.targetTransformObj.angle||this.onViewChange({changed:["scale","angle"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale})};this.mainDoubleTapper=new $.EventChain.DoubleTapper({onDoubleTap:n}),this.middleDoubleTapper=new $.EventChain.DoubleTapper({onDoubleTap:n}),this.middleDoubleTapper.setAllowedButtonArr(["middle"]),this.twoFingerTap=new $.EventChain.NFingerTapper({fingers:2,onTap:()=>{e.onUndo()}}),this.threeFingerTap=new $.EventChain.NFingerTapper({fingers:3,onTap:()=>{e.onRedo()}}),this.pointerEventChain=new $.EventChain.EventChain({chainArr:[this.twoFingerTap,this.threeFingerTap,this.mainDoubleTapper,this.middleDoubleTapper,this.pinchZoomer,new $.EventChain.OnePointerLimiter,new $.EventChain.CoalescedExploder]}),this.pointerEventChain.setChainOut((e=>{if(this.cursorPos.x=e.relX,this.cursorPos.y=e.relY,"pointerup"===e.type&&"touch"===e.pointerType?(this.pointer=null,this.lastRenderedState=-1,this.reqFrame()):(this.pointer||(this.pointer={x:0,y:0}),this.pointer.x=e.relX,this.pointer.y=e.relY),this.currentInputProcessor)this.currentInputProcessor.onPointer(e);else{let t=this.keyListener.getComboStr();this.globalMode===$e.Draw?["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(this.currentInputProcessor=this.inputProcessorObj.draw,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(e)):(this.updateCursor($e.Draw),this.reqFrame()):this.globalMode===$e.Hand?"pointerdown"===e.type&&["left","middle"].includes(e.button)?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(e)):this.updateCursor($e.Hand):this.globalMode===$e.Pick?"pointerdown"===e.type&&["left","right"].includes(e.button)?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(e)):this.updateCursor($e.Pick):this.globalMode===$e.Fill?"pointerdown"===e.type&&"left"===e.button?(this.currentInputProcessor=this.inputProcessorObj.fill,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(e)):(this.updateCursor($e.Fill),this.reqFrame()):this.globalMode===$e.Text?"pointerdown"===e.type&&"left"===e.button?(this.currentInputProcessor=this.inputProcessorObj.text,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(e)):(this.updateCursor($e.Text),this.reqFrame()):this.globalMode===$e.Shape&&(["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(this.currentInputProcessor=this.inputProcessorObj.shape,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(e)):(this.updateCursor($e.Shape),this.reqFrame()))}})),$.addEventListener(this.rootEl,"wheel",(e=>{e.preventDefault()})),setTimeout((()=>{this.pointerListener=new $.PointerListener({target:this.rootEl,fixScribble:!0,onPointer:e=>{if("pointerdown"===e.type&&"middle"===e.button)try{e.eventPreventDefault()}catch(e){}this.pointerEventChain.chainIn(e)},onWheel:e=>{if(this.isDrawing)return;this.reqFrame(),this.internalZoomByStep(-e.deltaY/(this.keyListener.isPressed("shift")?8:2),e.relX,e.relY)&&this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}),this.lastRenderedState=-1},onEnterLeave:e=>{e||this.isDrawing||(this.pointer=null,this.lastRenderedState=-1)},maxPointers:4})}),1),this.brushRadius=1,this.animationFrameRequested=!1,this.lastRenderedState=-2,this.lastRenderTime=performance.now(),window.requestAnimationFrame((()=>this.updateLoop())),this.resetView()}},KlCanvasPreview:et,filterLibStatus:hn,filterLib:cn,UndoRedoCatchup:class{ignoreTest(){return!this.doIgnore&&(this.doIgnore=!0,setTimeout((()=>{this.doIgnore=!1}),0),!0)}undo(){if(!this.ignoreTest())return!1;if(!te.canUndo())return!1;const e=te.undo();te.pause(!0);const t=this.getInitState(),n=this.getKlCanvas().getWidth(),i=this.getKlCanvas().getHeight();this.getKlCanvas().copy(t.canvas);let r=t.focus;this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(r));const a={};for(let e in si.brushes)si.brushes.hasOwnProperty(e)&&(a[e]=new si.brushes[e],a[e].setContext(this.getCurrentLayerCtx()));a.SketchyBrush.setSeed(t.brushes.SketchyBrush.getSeed());for(let t=0;t<e.length;t++)(t=>{if("brush"===e[t].tool[0]){const n=a[e[t].tool[1]];if(e[t].actions)for(let i=0;i<e[t].actions.length;i++){const r=e[t].actions[i].params;n[e[t].actions[i].action].apply(n,r)}else{const i=e[t].params;n[e[t].action].apply(n,i)}}else if("canvas"===e[t].tool[0]){const n=e[t].params,i=this.getKlCanvas()[e[t].action].apply(this.getKlCanvas(),n);if("number"==typeof i){r=i,this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(r));for(let e in a)a.hasOwnProperty(e)&&a[e].setContext(this.getCurrentLayerCtx())}}else if("filter"===e[t].tool[0]){const n=[{context:this.getCurrentLayerCtx(),canvas:this.getKlCanvas(),input:e[t].params[0].input,history:new si.DecoyKlHistory}];si.filterLib[e[t].tool[1]][e[t].action].apply(null,n)}else if("misc"===e[t].tool[0]&&"focusLayer"===e[t].action){r=e[t].params[0],this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(e[t].params[0]));for(let e in a)a.hasOwnProperty(e)&&a[e].setContext(this.getCurrentLayerCtx())}else if("misc"===e[t].tool[0]&&"importImage"===e[t].action){const n=this.getKlCanvas().addLayer();if("number"==typeof n){r=n,e[t].params[1]&&this.getKlCanvas().renameLayer(r,e[t].params[1]),this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(r));for(let e in a)a.hasOwnProperty(e)&&a[e].setContext(this.getCurrentLayerCtx())}this.getCurrentLayerCtx().drawImage(e[t].params[0],0,0)}})(t);return n===this.getKlCanvas().getWidth()&&i===this.getKlCanvas().getHeight()||(this.klCanvasWorkspace.resetView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),this.layerManager.update(r),this.layerPreview.setLayer(this.getKlCanvas().getLayer(r)),this.brushUiObj.sketchyBrush.setSeed(a.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(null),te.pause(!1),!0}redo(){if(!this.ignoreTest())return!1;if(!te.canRedo())return!1;const e=te.redo();te.pause(!0);const t=this.getKlCanvas().getWidth(),n=this.getKlCanvas().getHeight();let i;const r={};for(let e in si.brushes)si.brushes.hasOwnProperty(e)&&(r[e]=new si.brushes[e],r[e].setContext(this.getCurrentLayerCtx()));r.SketchyBrush.setSeed(this.brushUiObj.sketchyBrush.getSeed());for(let t=0;t<e.length;t++)(t=>{if("brush"===e[t].tool[0]){const n=r[e[t].tool[1]];if(e[t].actions)for(let i=0;i<e[t].actions.length;i++){const r=e[t].actions[i].params;n[e[t].actions[i].action].apply(n,r)}else{const i=e[t].params;n[e[t].action].apply(n,i)}}else if("canvas"===e[t].tool[0]){const n=e[t].params,a=this.getKlCanvas()[e[t].action].apply(this.getKlCanvas(),n);if("number"==typeof a){i=a,this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(i));for(let e in r)r.hasOwnProperty(e)&&r[e].setContext(this.getCurrentLayerCtx())}}else if("filter"===e[t].tool[0]){const n=[{context:this.getCurrentLayerCtx(),canvas:this.getKlCanvas(),input:e[t].params[0].input,history:new si.DecoyKlHistory}];si.filterLib[e[t].tool[1]][e[t].action].apply(null,n)}else if("misc"===e[t].tool[0]&&"focusLayer"===e[t].action){i=e[t].params[0],this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(e[t].params[0]));for(let e in r)r.hasOwnProperty(e)&&r[e].setContext(this.getCurrentLayerCtx())}else if("misc"===e[t].tool[0]&&"importImage"===e[t].action){const n=this.getKlCanvas().addLayer();if("number"==typeof n){i=n,e[t].params[1]&&this.getKlCanvas().renameLayer(i,e[t].params[1]),this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(i));for(let e in r)r.hasOwnProperty(e)&&r[e].setContext(this.getCurrentLayerCtx())}this.getCurrentLayerCtx().drawImage(e[t].params[0],0,0)}})(t);t===this.getKlCanvas().getWidth()&&n===this.getKlCanvas().getHeight()||(this.klCanvasWorkspace.resetView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg()));const a=this.getKlCanvas().getLayerIndex(this.getCurrentLayerCtx().canvas);return this.layerManager.update(a),this.layerPreview.setLayer(this.getKlCanvas().getLayer(a)),this.brushUiObj.sketchyBrush.setSeed(r.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(null),te.pause(!1),!0}catchup(e){if(e&&e.bufferUpdate){const t=this.getInitState(),n=t.brushes,i=[e.bufferUpdate];let r=t.canvas.getLayerContext(t.focus);const a=t.canvas;let o=t.focus;(e=>{if("brush"===i[0].tool[0]){let e=n[i[0].tool[1]];if(i[0].actions)for(let t=0;t<i[0].actions.length;t++){const n=i[0].actions[t].params;e[i[0].actions[t].action].apply(e,n)}else{const t=i[0].params;e[i[0].action].apply(e,t)}}else if("canvas"===i[0].tool[0]){const e=i[0].params,t=a[i[0].action].apply(a,e);if("number"==typeof t){o=t,r=a.getLayerContext(o);for(let e in n)n.hasOwnProperty(e)&&n[e].setContext(r)}}else if("filter"===i[0].tool[0]){const e=[{context:r,canvas:a,input:i[0].params[0].input,history:new si.DecoyKlHistory}];si.filterLib[i[0].tool[1]][i[0].action].apply(null,e)}else if("misc"===i[0].tool[0]&&"focusLayer"===i[0].action){o=i[0].params[0],r=a.getLayerContext(i[0].params[0]);for(let e in n)n.hasOwnProperty(e)&&n[e].setContext(r)}else if("misc"===i[0].tool[0]&&"importImage"===i[0].action){const e=a.addLayer();if("number"==typeof e){o=e,i[0].params[1]&&this.getKlCanvas().renameLayer(o,i[0].params[1]),r=a.getLayerContext(o);for(let e in n)n.hasOwnProperty(e)&&n[e].setContext(r)}r.drawImage(i[0].params[0],0,0)}})(),t.focus=o}}constructor(e,t,n,i,r,a,o,s,l,h){this.brushUiObj=e,this.layerPreview=t,this.layerManager=n,this.handUi=i,this.klCanvasWorkspace=r,this.getInitState=a,this.getKlCanvas=o,this.getCurrentLayerCtx=s,this.setCurrentLayerCtx=l,this.getCurrentBrush=h,this.doIgnore=!1}},renderText:Xe,floodFillBits:Ne,ShapeTool:function(e){let t,n,i;this.onDown=function(e,r,a){t=e,n=r,i=a},this.onMove=function(r,a){e.onShape(!1,t,n,r,a,i)},this.onUp=function(r,a){e.onShape(!0,t,n,r,a,i)}},drawShape:Ue,PSD:Dt,setDbName:Yt,indexedDb:Nt,ProjectStore:class{async lowLevelStore(e){await new Promise(((t,n)=>{Gt(e,t,n)}))}async lowLevelRead(){return await Jn(Wt)}async lowLevelClear(){await Jn(Kt)}emit(e,t){this.listeners.forEach((n=>{n.onUpdate(e,t)}))}updateTimestamp(){J.setItem("indexedDbUpdatedAt",""+(new Date).getTime())}async read(){let e,t;try{e=await this.lowLevelRead()}catch(e){throw this.accessHasFailed=!0,new Error("db-error: "+e)}if(!e)return null;try{t=await qn.readStorageProject(e)}catch(e){throw new Error("format-error: "+e)}return t}async store(e){try{const t=qn.createStorageProject(e);await this.lowLevelStore(t)}catch(e){throw this.accessHasFailed=!0,new Error("db-error: "+e)}{const e=await this.lowLevelRead();let t=null;try{t=await qn.readStorageProject(e)}catch(e){throw await this.lowLevelClear(),this.updateTimestamp(),setTimeout((()=>this.emit()),0),new Error("format-error: "+e)}this.updateTimestamp(),setTimeout((()=>this.emit(t.timestamp,t.thumbnail)),0)}}async clear(){await this.lowLevelClear(),this.updateTimestamp(),setTimeout((()=>this.emit()),0)}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){for(let t=0;t<this.listeners.length;t++)if(e===this.listeners[t])return void this.listeners.splice(t,1)}isBroken(){return this.accessHasFailed}constructor(){this.listeners=[],this.accessHasFailed=!1,window.addEventListener("storage",(e=>{if("indexedDbUpdatedAt"===e.key&&0!==this.listeners.length)try{(async()=>{const e=await this.read();e?this.emit(e.timestamp,e.thumbnail):this.emit()})()}catch(e){0===e.message.indexOf("db-error")&&(this.accessHasFailed=!0)}}))}},loadAgPsd:async function(){return ei||(ei=await a("krCjW"),$.BbLog.emit({type:"loaded-agpsd"})),ei},SaveToComputer:class{save(e){const t=this;function n(e,n,i){let r=e.toDataURL(i).match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),a=atob(r[3]),o=new ArrayBuffer(a.length),s=new Uint8Array(o);for(let e=0;e<s.length;e++)s[e]=a.charCodeAt(e);let l=new Blob([s],{type:r[1]});"function"==typeof t.customSave?t.customSave(l,n):ii.saveAs(l,n)}if(t.saveReminder.reset(),e||(e=t.getExportType()),"png"===e){let e="png",i="image/png",r=$.getDate()+this.filenameBase+"."+e,a=t.getKlCanvas().getCompleteCanvas(1);try{n(a,r,i)}catch(e){let n=new Image;n.width=t.getKlCanvas().getWidth(),n.height=t.getKlCanvas().getHeight(),n.src=a.toDataURL(i),si.exportDialog(t.klRootEl,n)}}else if("layers"===e){let e="png",i="image/png",r=$.getDate()+this.filenameBase,a=t.getKlCanvas().getLayersFast();for(let t=0;t<a.length;t++){let o=a[t],s=[r,"_",(""+(t+1)).padStart(2,"0"),"_",o.name,".",e];n(o.canvas,s.join(""),i)}}else if("psd"===e){let e=t.getKlCanvas().getLayersFast(),n={width:t.getKlCanvas().getWidth(),height:t.getKlCanvas().getHeight(),children:[],canvas:t.getKlCanvas().getCompleteCanvas(1)};for(let t=0;t<e.length;t++){let i=e[t];n.children.push({name:i.name,opacity:i.opacity,canvas:i.canvas,blendMode:si.PSD.blendKlToPsd(i.mixModeStr),left:0,top:0})}si.loadAgPsd().then((e=>{let i=e.writePsdBuffer(n),r=new Blob([i],{type:"application/octet-stream"});"function"==typeof t.customSave?t.customSave(r,$.getDate()+this.filenameBase+".psd"):ii.saveAs(r,$.getDate()+this.filenameBase+".psd")})).catch((()=>{alert("Error: failed to load PSD library")}))}}constructor(e,t,n,i,r,a){this.customSave=e,this.saveReminder=t,this.klRootEl=n,this.getExportType=i,this.getKlCanvas=r,this.filenameBase=a}},calcSliderFalloffFactor:ve,Checkbox:pe,input:ge,Select:me,ImageToggle:fe,ImageRadioList:ye,RadioList:class{getValue(){for(let e=0;e<this.inputs.length;e++)if(this.inputs[e].checked)return this.inputs[e].value;return null}getElement(){return this.el}constructor({name:e,init:t,items:n,ignoreFocus:i}){this.inputs=[],this.el=$.el({className:"kl-radio"}),n.forEach((n=>{let r=$.el({tagName:"label"}),a=$.el({tagName:"input",parent:r,custom:{name:e,value:n.value,type:"radio"}});i&&a.setAttribute("data-ignore-focus","true"),t===n.value&&(a.checked=!0),r.append(n.label),this.el.append(r),this.inputs.push(a)}))}},penPressureToggle:be,KlSlider:we,HexColorDialog:Se,KlColorSlider:function(e){const t=this;let i=function(e){};const r=document.createElement("div");r.style.position="relative",r.className="colorSlider";const a=$.el({css:{display:"flex",alignItems:"center"}}),o=e.width;let s=e.svHeight;const l=e.height,h=e.onPick;let c={r:parseInt(e.startValue.r,10),g:parseInt(e.startValue.g,10),b:parseInt(e.startValue.b,10)},d=$.ColorConverter.toHSV(e.startValue),u={r:255,g:255,b:255},p=$.ColorConverter._RGBtoHSV(u);const g=$.el({}),m=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"> <defs> <linearGradient id="value" gradientTransform="rotate(90)"> <stop offset="0" stop-color="rgba(0,0,0,0)"/> <stop offset="100%" stop-color="rgba(0,0,0,1)"/> </linearGradient> <linearGradient id="hue" gradientTransform="rotate(0)"> <stop offset="0" stop-color="#fff"/> <stop id="hue-stop" offset="100%" stop-color="#f00"/> </linearGradient> </defs> <rect x="0" y="0" width="100" height="100" fill="url(\'#hue\')"/> <rect x="0" y="0" width="100" height="100" fill="url(\'#value\')"/></svg>',"image/svg+xml").documentElement,f=m.getElementById("hue-stop");$.setAttributes(f,{"stop-color":"#f0f"}),$.css(m,{width:o+"px",height:s+"px"}),g.appendChild(m);const y=document.createElement("div");$.css(y,{position:"relative",height:l+"px"});const x=document.createElement("div"),b=document.createElement("div");function v(e){d=0===e.s?new $.HSV(d.h,e.s,e.v):new $.HSV(e.h,e.s,e.v)}function w(){const e=$.ColorConverter.toRGB(new $.HSV(d.h,100,100));$.setAttributes(f,{"stop-color":"#"+$.ColorConverter.toHexString(e)})}function C(){const e=d.s/100*o-7,t=(1-d.v/100)*s-6;$.css(M,{left:e+"px",top:t+"px"})}function S(){x.style.backgroundColor="rgb("+c.r+","+c.g+","+c.b+")",$.testIsWhiteBestContrast(c)?($.css(L,{filter:"invert(1)"}),$.css(A,{filter:"invert(1)"})):($.css(L,{filter:""}),$.css(A,{filter:""}))}w(),r.style.width=o+"px",r.oncontextmenu=function(){return!1};const E=document.createElement("div");$.css(E,{width:o+"px",height:s+"px",overflow:"hidden",display:"block",position:"relative",cursor:"crosshair",boxShadow:"rgb(188, 188, 188) 0 0 0 1px"});const M=document.createElement("div");$.css(M,{width:"12px",height:"12px",borderRadius:"6px",position:"absolute",pointerEvents:"none",boxShadow:"0px 0px 0 1px #000, inset 0px 0px 0 1px #fff"}),E.appendChild(g),E.appendChild(M),C(),r.appendChild(E),r.appendChild(y),a.appendChild(x),$.css(x,{display:"flex",justifyContent:"space-between",width:2.5*l+"px",height:l+"px",boxShadow:"rgb(188, 188, 188) 0 0 0 1px",colorScheme:"only light"}),$.css(y,{overflow:"hidden",position:"relative",width:o+"px",height:l+"px",cursor:"ew-resize",boxShadow:"rgb(188, 188, 188) 0 0 0 1px",marginTop:"1px",marginBottom:"1px"}),$.css(b,{width:"1px",height:l+"px",background:"#000",borderLeft:"1px solid #fff",position:"absolute",top:"0",left:parseInt(""+(d.h/360*o-1))+"px"});const k={h:0,s:0,v:0};let I,T;const L=$.el({title:ce("eyedropper")+" [Alt]",className:"color-picker-preview-button",css:{width:"30px",height:"30px",backgroundImage:"url("+n(Ee)+")",backgroundRepeat:"no-repeat",backgroundSize:"70%",backgroundPosition:"center"}});let R=!1;L.onclick=function(){!1===R?($.removeClassName(L,"color-picker-preview-button-hover"),$.addClassName(L,"color-picker-preview-button-active"),R=!0,i(!0)):(i(!1),t.pickingDone())};new $.PointerListener({target:L,onEnterLeave:function(e){R||(e?$.addClassName(L,"color-picker-preview-button-hover"):$.removeClassName(L,"color-picker-preview-button-hover"))}});x.appendChild(L);const A=$.el({content:"#",className:"color-picker-preview-button",title:ce("manual-color-input"),css:{height:"100%",width:l+"px",lineHeight:l+"px",fontSize:.65*l+"px"},onClick:function(){Se({klRootEl:e.klRootEl,color:new $.RGB(c.r,c.g,c.b),onClose:function(e){e&&(t.setColor(e),h(new $.RGB(c.r,c.g,c.b)))}})}});new $.PointerListener({target:A,onEnterLeave:function(e){e?$.addClassName(A,"color-picker-preview-button-hover"):$.removeClassName(A,"color-picker-preview-button-hover")}});x.appendChild(A),S(),setTimeout((function(){!function(e){const t=new Image;$.css(t,{position:"absolute",left:"0",top:"0",display:"none",pointerEvents:"none"});const n=$.canvas(o,l),i=n.getContext("2d"),r=i.createLinearGradient(0,0,o,0);for(let e=0;e<1;e+=.01){const t=$.ColorConverter.toRGB(new $.HSV(360*e,100,100));let n=parseInt(""+t.r).toString(16),i=parseInt(""+t.g).toString(16),a=parseInt(""+t.b).toString(16);1===n.length&&(n="0"+n),1===i.length&&(i="0"+i),1===a.length&&(a="0"+a),r.addColorStop(e,"#"+n+i+a)}i.fillStyle=r,i.fillRect(0,0,o,l),e.appendChild(t),t.alt="hue",t.src=n.toDataURL("image/png"),t.style.display="block"}(y),y.appendChild(b),I=new $.PointerListener({target:g,maxPointers:1,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&($.css(E,{boxShadow:"0px 0px 0px 1px rgb(255,255,255)",zIndex:"1"}),"left"===e.button?(k.s=e.relX/o*100,k.v=100-e.relY/s*100,d=new $.HSV(d.h,k.s,k.v),c=$.ColorConverter.toRGB(d),C(),S(),h($.ColorConverter.toRGB(d))):(k.s=d.s,k.v=d.v)),"pointermove"===e.type&&["left","right"].includes(e.button)){let t=1;"right"===e.button&&(t=.5),k.s+=e.dX/o*100*t,k.v-=e.dY/s*100*t,d=new $.HSV(d.h,k.s,k.v),c=$.ColorConverter.toRGB(d),C(),S(),h($.ColorConverter.toRGB(d))}"pointerup"===e.type&&$.css(E,{boxShadow:"0 0 0 1px rgb(188, 188, 188)",zIndex:"0"})}}),T=new $.PointerListener({target:y,maxPointers:1,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&($.css(y,{boxShadow:"0px 0px 0px 1px rgba(255,255,255,1)"}),"left"===e.button?(k.h=e.relX/o*359.99,d=new $.HSV(k.h,d.s,d.v),c=$.ColorConverter.toRGB(d),b.style.left=Math.round(d.h/359.99*o)-1+"px",w(),S(),h($.ColorConverter.toRGB(d))):k.h=d.h),"pointermove"===e.type&&["left","right"].includes(e.button)){const t=Math.abs(e.pageY-e.downPageY),n=ve(t,"right"===e.button);k.h+=e.dX/o*359.99*n,"right"===e.button&&(k.h=k.h%359.99,k.h<0&&(k.h+=359.99)),k.h=Math.min(359.99,k.h),d=new $.HSV(k.h,d.s,d.v),c=$.ColorConverter.toRGB(d),b.style.left=Math.round(d.h/359.99*o)-1+"px",w(),S(),h($.ColorConverter.toRGB(d))}"pointerup"===e.type&&$.css(y,{boxShadow:"rgb(188, 188, 188) 0 0 0 1px"})}})}),1);const P=$.el({parent:a,title:ce("secondary-color")+" [X]",css:{cursor:"pointer",marginLeft:"5px",width:"22px",height:"22px",boxShadow:"rgb(188, 188, 188) 0px 0px 0px 1px",colorScheme:"only light"},onClick:function(e){e.preventDefault(),O()}});function D(){P.style.backgroundColor=$.ColorConverter.toRgbStr(u)}function O(){let e=p;p=d,v(e),e=u,u=c,c=e,b.style.left=parseInt(""+(d.h/359*o-1))+"px",w(),C(),S(),D(),h(new $.RGB(c.r,c.g,c.b))}D(),this.setColor=function(e){c={r:parseInt(e.r,10),g:parseInt(e.g,10),b:parseInt(e.b,10)},v($.ColorConverter.toHSV(e)),b.style.left=parseInt(""+(d.h/359*o-1))+"px",w(),C(),S()},this.getColor=function(){return new $.RGB(c.r,c.g,c.b)},this.getSecondaryRGB=function(){return new $.RGB(u.r,u.g,u.b)},this.setPickCallback=function(e){i=e},this.pickingDone=function(){R&&(R=!1,$.removeClassName(L,"color-picker-preview-button-active"))},this.enable=function(e){e?(r.style.pointerEvents="",r.style.opacity="1",a.style.pointerEvents="",a.style.opacity="1"):(r.style.pointerEvents="none",r.style.opacity="0.5",a.style.pointerEvents="none",a.style.opacity="0.5")},this.setHeight=function(e){(e=parseInt(""+(e-2*l-3),10))!==s&&(s=e,$.css(m,{width:o+"px",height:s+"px"}),E.style.height=s+"px",C())},this.swapColors=function(){O()},this.getElement=function(){return r},this.getOutputElement=function(){return a}},KlSmallColorSlider:Me,PointSlider:ke,ColorOptions:Ie,Options:Te,BoxToggle:Xn,StatusOverlay:class{updateUiState(){this.el&&(setTimeout((()=>{}),100),"left"===this.uiState?this.el.style.left="271px":this.el.style.removeProperty("left"))}init(){this.el=$.el({className:"top-overlay",onClick:$.handleClick}),this.isWide&&(this.el.style.width="100%"),this.updateUiState(),this.innerEl=$.el({className:"top-overlay-inner"}),this.angleIm=new Image,this.angleIm.src=n(Le),$.css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginLeft:"5px",borderRadius:"10px"}),this.innerInnerEl=document.createElement("div"),this.innerInnerEl.style.display="inline-block",this.innerEl.appendChild(this.innerInnerEl),this.innerEl.appendChild(this.angleIm),this.el.appendChild(this.innerEl),this.container.appendChild(this.el),this.el.style.display="none"}setWide(e){this.isWide=!!e,this.el&&(this.isWide?(this.el.style.width="100%",this.el.style.left=""):(this.el.style.removeProperty("width"),this.el.style.left="left"===this.uiState?"271px":""))}setUiState(e){this.uiState=e,this.updateUiState()}out(e,t){e&&"object"==typeof e?"transform"===e.type?(this.angleIm.style.display="inline-block",this.angleIm.style.transform="rotate("+e.angleDeg+"deg)",e.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255, 255, 255, 0.7)":this.angleIm.style.boxShadow="",this.innerInnerEl.innerHTML=Math.round(100*e.scale)+"%"):this.angleIm.style.display="none":"string"==typeof e&&(this.angleIm.style.display="none",this.innerInnerEl.innerHTML=e),t&&(this.innerEl.style.animation="",setTimeout((()=>this.innerEl.style.animation="top-overlay-pulse 0.5s ease-out"),20),this.timeout3&&clearTimeout(this.timeout3),this.timeout3=window.setTimeout((()=>this.innerEl.style.animation=""),520)),this.timeout&&clearTimeout(this.timeout),this.timeout2&&clearTimeout(this.timeout2),this.el.style.animationName=t?"consoleInFast":"consoleIn",this.el.style.opacity="1",this.timeout=window.setTimeout((()=>{this.el.style.opacity="0",this.el.style.animationName="consoleOut",this.timeout2=window.setTimeout((()=>{this.el.style.display="none",this.timeout2=0}),450),this.timeout=0}),1200),this.el.style.display="flex"}constructor(e){this.container=e,this.init()}},CropCopy:Re,FreeTransform:ot,FreeTransformCanvas:st,Cropper:lt,LayerPreview:function(e){let t,n=$.el({}),i=!0;const r=300;let a,o=-2,s={width:0,height:0},l=$.canvas(),h=l.getContext("2d"),c=0,d=!1,u="right",p=$.el({css:{display:"flex",alignItems:"center",height:"40px",color:"#666"}}),g=$.el({css:{minWidth:"40px",height:"40px",display:"flex",justifyContent:"center",alignItems:"center"}}),m=$.canvas(30,30),f=m.getContext("2d");m.title=ce("layers-active-layer"),$.css(m,{boxShadow:"0 0 0 1px #9e9e9e",colorScheme:"only light"});let y=$.el({css:{flexGrow:"1",paddingLeft:"10px",fontSize:"13px",overflow:"hidden",position:"relative"}}),x=$.el({content:"",css:{cssFloat:"left",whiteSpace:"nowrap"}}),b=$.el({css:{backgroundImage:"linear-gradient(to right, rgba(221,221,221,0) 0%, rgba(221,221,221,0.8) 100%)",position:"absolute",right:"0",top:"0",width:"50px",height:"100%"}}),v=$.el({css:{position:"absolute",left:"10px",top:"0",width:"90px",height:"100%"}});e.onClick&&($.addEventListener(v,"click",(function(){e.onClick()})),$.addEventListener(m,"click",(function(){e.onClick()})));let w=$.el({content:ce("opacity")+"<br>100%",css:{minWidth:"60px",fontSize:"12px",textAlign:"center",background:"#dddddd",color:"#555"}});const C=$.el({onClick:$.handleClick,css:{pointerEvents:"none",background:"#fff",position:"absolute",right:"280px",top:"10px",border:"1px solid #aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",transition:"opacity 300ms ease-in-out",userSelect:"none",display:"block",webkitTouchCallout:"none",colorScheme:"only light"}});let S=$.canvas(r,r);C.append(S);let E=S.getContext("2d");$.css(S,{display:"block"}),n.appendChild(p),p.appendChild(g),g.appendChild(m),p.appendChild(y),y.appendChild(x),y.appendChild(b),y.appendChild(v),p.appendChild(w);let M=h.createPattern($.createCheckerCanvas(4),"repeat"),k=f.createPattern($.createCheckerCanvas(4),"repeat");function I(){0!==c&&(c--,f.save(),f.globalAlpha=Math.pow((30-c)/30,2),f.drawImage(l,0,0),f.restore(),c>0&&requestAnimationFrame(I))}function T(e){if(!i)return;x.textContent=t.name,w.innerHTML=ce("opacity")+"<br>"+Math.round(100*t.opacity)+"%";let n=t.context.canvas;if(n.width!==s.width||n.height!==s.height){let t=$.fitInto(n.width,n.height,30,30,1);m.width=Math.round(t.width),m.height=Math.round(t.height),e=!0}l.width=m.width,l.height=m.height,h.save(),h.imageSmoothingEnabled=!1,h.fillStyle=M,h.fillRect(0,0,l.width,l.height),h.drawImage(n,0,0,l.width,l.height),h.restore(),e?(c=0,f.save(),f.drawImage(l,0,0),f.restore()):(c=30,I()),R(),o=te.getState(),s.width=n.width,s.height=n.height}function L(){T(!0)}function R(){if(!d||!t)return;let e=t.context.canvas,i=$.fitInto(e.width,e.height,r,r,1);S.width=Math.round(i.width),S.height=Math.round(i.height),E.save(),S.width>e.width?E.imageSmoothingEnabled=!1:(E.imageSmoothingEnabled=!0,E.imageSmoothingQuality="high"),E.fillStyle=k,E.fillRect(0,0,S.width,S.height),E.drawImage(e,0,0,S.width,S.height),E.restore();const a=n.getBoundingClientRect();$.css(C,{top:Math.max(10,a.top+20-S.height/2)+"px"})}function A(){try{e.klRootEl.removeChild(C)}catch(e){}}setInterval((function(){if(!t)return;te.getState()!==o&&(t.opacity=t.context.canvas.opacity,T(!1))}),2e3),new $.PointerListener({target:m,onEnterLeave:function(t){!function(t){d!==t&&(clearTimeout(a),d=t,t?a=setTimeout((function(){R(),C.style.opacity="0",e.klRootEl.appendChild(C),setTimeout((function(){C.style.opacity="1"}),20)}),250):(C.style.opacity="0",a=setTimeout(A,320)))}(t)}}),this.getElement=function(){return n},this.setIsVisible=function(e){if(i===e)return;i=e,p.style.display=i?"flex":"none",n.style.marginBottom=i?"":"10px";let t=te.getState();e&&o!==t&&L()},this.setLayer=function(e){t=e,L()},this.setUiState=function(e){u=""+e,"left"===u?$.css(C,{left:"280px",right:""}):$.css(C,{left:"",right:"280px"})}},FittedImage:function(e){let t=$.fitInto(e.image.width,e.image.height,e.width,e.height,1),n=parseInt(""+t.width),i=parseInt(""+t.height),r=$.canvas(n,i);r.getContext("2d").drawImage(e.image,0,0,n,i),$.css(r,{display:"block",boxShadow:"0 0 0 1px #aaa"}),this.getElement=function(){return r}},KlImageDropper:function(e){let t=$.el({content:"Drop to import",css:{paddingTop:"100px",position:"absolute",left:"0",top:"0",width:"100%",height:"100%",background:"rgba(50, 50, 50, 0.7)",color:"#fff",textShadow:"2px 2px #000",textAlign:"center",fontSize:"25px"}}),n=$.el({css:{marginTop:"50px",display:"flex",justifyContent:"center"}}),i={width:"200px",padding:"50px",margin:"10px",borderRadius:"20px",border:"1px dashed #fff",background:"#00aefe",fontWeight:"bold"},r=$.el({content:"As Layer",css:i}),a=$.el({content:"As New Image",css:i});t.appendChild(n),n.appendChild(r),n.appendChild(a);let o=0,s=0,l=0;function h(){o=0,s=0,l=0;try{e.target.removeChild(t)}catch(e){}}function c(e){try{return!e.dataTransfer.types.includes("text/plain")}catch(e){}return!1}function d(){let e="0 0 20px 4px #fff";s>0?(r.style.boxShadow=e,a.style.boxShadow=""):l>0?(r.style.boxShadow="",a.style.boxShadow=e):(r.style.boxShadow="",a.style.boxShadow="")}$.addEventListener(r,"dragenter",(function(){s++,d()})),$.addEventListener(r,"dragleave",(function(){s--,d()})),$.addEventListener(a,"dragenter",(function(){l++,d()})),$.addEventListener(a,"dragleave",(function(){l--,d()})),$.addEventListener(window,"dragover",(function(e){c(e)&&(e.stopPropagation(),e.preventDefault())}),!1),$.addEventListener(window,"dragenter",(function(n){e.enabledTest()&&c(n)&&(0===o&&e.target.appendChild(t),o++)}),!1),$.addEventListener(window,"dragleave",(function(n){c(n)&&0!==o&&(o=Math.max(0,o-1),0===o&&e.target.removeChild(t))}),!1),$.addEventListener(window,"drop",(function(n){if(!c(n)||0===n.dataTransfer.files.length)return void h();n.stopPropagation(),n.preventDefault();let i="default";s>0?i="layer":l>0&&(i="image"),e.onDrop(n.dataTransfer.files,i),o>0&&e.target.removeChild(t),o=0,s=0,l=0,d()}),!1),$.addEventListener(t,"pointerdown",(function(){h()})),new $.KeyListener({onDown:function(e){o>0&&"esc"===e&&h()}})},OverlayToolspace:function(e){const t=150,n=90,i=20,r=25;let a=!1;const o=$.el({css:{position:"absolute",left:"500px",top:"500px",background:"rgb(221, 221, 221)",display:"none",border:"1px solid #fff",boxShadow:"0 0 10px rgba(0,0,0,0.5)",colorScheme:"only light"}}),s={color:null,size:null,opacity:null},l=new Me({width:t,heightSV:n,heightH:i,color:e.brushSettingService.getColor(),callback:function(t){h.style.backgroundColor="rgb("+t.r+","+t.g+","+t.b+")",e.brushSettingService.setColor(t,p)}}),h=$.el({css:{width:t+"px",height:i+"px",pointerEvents:"none"}});{const t=e.brushSettingService.getColor();h.style.backgroundColor="rgb("+t.r+","+t.g+","+t.b+")"}function c(e){l.setColor(e),h.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")"}o.appendChild(h),o.appendChild(l.getElement());const d=new we({label:ce("brush-size"),width:t,height:r,min:0,max:500,initValue:50,resolution:225,eventResMs:1e3/30,onChange:function(t){e.brushSettingService.setSize(t)},formatFunc:function(e){return 2*e<10?Math.round(20*e)/10:Math.round(2*e)}});$.css(d.getElement(),{marginTop:"2px"}),o.appendChild(d.getElement());const u=new we({label:ce("opacity"),width:t,height:r,min:0,max:1,initValue:1,resolution:225,eventResMs:1e3/30,onChange:function(t){e.brushSettingService.setOpacity(t)},formatFunc:function(e){return Math.round(100*e)}});$.css(u.getElement(),{margin:"2px 0"}),o.appendChild(u.getElement());const p=function(e){"color"===e.type&&(a?c(e.value):s.color=e.value),"size"===e.type&&(a?d.setValue(e.value):s.size=e.value),"opacity"===e.type&&(a?u.setValue(e.value):s.opacity=e.value),"sliderConfig"===e.type&&(d.update(e.value.sizeSlider),u.update(e.value.opacitySlider))};e.brushSettingService.subscribe(p);{const t=e.brushSettingService.getSliderConfig();d.update(t.sizeSlider),u.update(t.opacitySlider),d.setValue(e.brushSettingService.getSize()),u.setValue(e.brushSettingService.getOpacity())}function g(){o.style.display=a?"block":"none",a&&m&&(o.style.left=m.x-Math.round(t/2)+"px",o.style.top=m.y-Math.round(n+3*i/2)+"px")}let m=null;$.addEventListener(document,"pointermove",(function(e){m={x:e.pageX,y:e.pageY}})),new $.KeyListener({onDown:function(t,n,i,r){if(!r)return a?(a=!1,void g()):void(e.enabledTest()&&m&&["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(i)&&(n.preventDefault(),a=!0,null!==s.color&&(c(s.color),s.color=null),null!==s.size&&(d.setValue(s.size),s.size=null),null!==s.opacity&&(u.setValue(s.opacity),s.opacity=null),g()))},onUp:function(e,t,n){["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(n)&&a&&(a=!1,l.end(),g())},onBlur:function(){a&&(a=!1,l.end(),g())}}),this.getElement=function(){return o}},ToolspaceTopRow:function(e){let t=document.createElement("div");function i(e){let t=6+(e.extraPadding?e.extraPadding:0),n=$.el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.contain?t+"px 0":""}}),i=$.el({css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});return i.style.pointerEvents="none",n.appendChild(i),n.pointerListener=new $.PointerListener({target:n,onEnterLeave:function(e){e?$.addClassName(n,"toolspace-row-button-hover"):$.removeClassName(n,"toolspace-row-button-hover")}}),n}$.css(t,{height:"36px",display:"flex",backgroundImage:"linear-gradient(to top, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.6) 100%)"});let r=null;"function"==typeof e.onLogo&&(r=i({onClick:e.onLogo,title:ce("home"),image:e.logoImg?e.logoImg:n(ht),contain:!0}),r.style.width="45px",r.style.borderRight="1px solid rgb(212, 212, 212)");let a=i({onClick:e.onNew,title:ce("file-new"),image:n(ct),extraPadding:1,contain:!0}),o=i({onClick:e.onImport,title:ce("file-import"),image:n(dt),extraPadding:1,contain:!0}),s=i({onClick:e.onSave,title:ce("file-save"),image:n(ut),extraPadding:1,contain:!0}),l=null;$.canShareFiles()&&e.onShare&&(l=i({onClick:e.onShare,title:ce("file-share"),image:n(pt),contain:!0}));let h=null;e.onHelp&&(h=i({onClick:e.onHelp,title:ce("help"),image:n(gt),contain:!0})),r&&t.appendChild(r),t.appendChild(a),t.appendChild(o),t.appendChild(s),l&&t.appendChild(l),h&&t.appendChild(h),this.getElement=function(){return t}},ToolDropdown:vt,ToolspaceToolRow:function(e){let t=document.createElement("div");$.css(t,{height:"54px",display:"flex",backgroundImage:"linear-gradient(to top, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.6) 100%)"});let i="draw";function r(t,n){i!==t&&(i=t,s.setActive(i),"hand"===i?$.addClassName(l,"toolspace-row-button-activated"):$.removeClassName(l,"toolspace-row-button-activated"),n&&e.onActivate(i))}function a(e){let t=e.doLighten?"6px 0":"8px 0",n=$.el({className:"toolspace-row-button nohighlight",onClick:e.onClick,css:{padding:e.contain?"10px 0":""}}),i=$.el({css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%",transform:e.doMirror?"scale(-1, 1)":"",pointerEvents:"none",opacity:e.doLighten?"0.75":"1"}});return n.appendChild(i),n.pointerListener=new $.PointerListener({target:n,onEnterLeave:function(e){e?$.addClassName(n,"toolspace-row-button-hover"):$.removeClassName(n,"toolspace-row-button-hover")}}),n.setIsSmall=function(i){n.style.padding=e.contain?i?t:"10px 0":""},n}function o(e){let t=document.createElement("div");$.css(t,{flexGrow:"1",position:"relative"});let n=$.createSvg({elementType:"svg",width:"67px",height:"54px",viewBox:"0 0 100 100",preserveAspectRatio:"none"});$.css(n,{position:"absolute",left:"0",top:"0"});let i=$.createSvg({elementType:"defs",childrenArr:[{elementType:"filter",id:"innershadow",x0:"-50%",y0:"-50%",width:"200%",height:"200%",childrenArr:[{elementType:"feGaussianBlur",in:"SourceAlpha",stdDeviation:"10",result:"blur"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"SourceAlpha",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"SourceGraphic",operator:"over",result:"firstfilter"},{elementType:"feGaussianBlur",in:"firstfilter",stdDeviation:"10",result:"blur2"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"firstfilter",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"firstfilter",operator:"over"}]}]}),r=$.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M0,0 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});r.onclick=function(){e.onLeft(),$.removeClassName(r,"toolspace-svg-triangle-button-hover")};let a=$.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M100,100 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});a.onclick=function(){e.onRight(),$.removeClassName(a,"toolspace-svg-triangle-button-hover")},t.leftPointerListener=new $.PointerListener({target:r,onEnterLeave:function(e){e?$.addClassName(r,"toolspace-svg-triangle-button-hover"):$.removeClassName(r,"toolspace-svg-triangle-button-hover")}}),t.rightPointerListener=new $.PointerListener({target:a,onEnterLeave:function(e){e?$.addClassName(a,"toolspace-svg-triangle-button-hover"):$.removeClassName(a,"toolspace-svg-triangle-button-hover")}}),n.appendChild(i),n.appendChild(r),n.appendChild(a),t.appendChild(n);let o=$.el({css:{backgroundImage:"url('"+e.leftImage+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",left:"10px",top:"8px",pointerEvents:"none"}});t.appendChild(o);let s=$.el({css:{backgroundImage:"url('"+(e.rightImage?e.rightImage:e.leftImage)+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",right:"10px",bottom:"8px",transform:e.rightImage?"":"scale(-1, 1)",pointerEvents:"none"}});return t.appendChild(s),t.setIsEnabledLeft=function(e){e?($.removeClassName(r,"toolspace-row-button-disabled"),$.removeClassName(o,"toolspace-row-button-disabled")):($.addClassName(r,"toolspace-row-button-disabled"),$.addClassName(o,"toolspace-row-button-disabled"))},t.setIsEnabledRight=function(e){e?($.removeClassName(a,"toolspace-row-button-disabled"),$.removeClassName(s,"toolspace-row-button-disabled")):($.addClassName(a,"toolspace-row-button-disabled"),$.addClassName(s,"toolspace-row-button-disabled"))},t}let s=new vt({klRootEl:e.klRootEl,onChange:function(e){r(e,!0)}});t.appendChild(s.getElement());let l=a({onClick:function(){r("hand",!0)},image:n(wt),contain:!0,doLighten:!0});l.style.borderRight="1px solid rgb(212, 212, 212)",l.title=ce("tool-hand"),t.appendChild(l);let h=o({onLeft:e.onZoomIn,onRight:e.onZoomOut,leftImage:n(Ct),rightImage:n(St)});h.title=ce("tool-zoom"),t.appendChild(h);let c=a({onClick:e.onZoomIn,image:n(Ct),contain:!0});c.title=ce("zoom-in"),t.appendChild(c);let d=a({onClick:e.onZoomOut,image:n(St),contain:!0});d.title=ce("zoom-out"),t.appendChild(d);let u=o({onLeft:e.onUndo,onRight:e.onRedo,leftImage:n(Et),rightImage:null});u.title=ce("tool-undo-redo"),u.setIsEnabledLeft(!1),u.setIsEnabledRight(!1),t.appendChild(u);let p=a({onClick:e.onUndo,image:n(Et),contain:!0});p.title=ce("undo"),$.addClassName(p,"toolspace-row-button-disabled"),t.appendChild(p);let g=a({onClick:e.onRedo,image:n(Et),contain:!0,doMirror:!0});g.title=ce("redo"),$.addClassName(g,"toolspace-row-button-disabled"),t.appendChild(g),c.style.display="none",d.style.display="none",p.style.display="none",g.style.display="none",this.getElement=function(){return t},this.setIsSmall=function(e){$.css(t,{height:e?"36px":"54px"}),s.setIsSmall(e),l.setIsSmall(e),c.setIsSmall(e),d.setIsSmall(e),p.setIsSmall(e),g.setIsSmall(e),e?(h.style.display="none",u.style.display="none",c.style.display="block",d.style.display="block",p.style.display="block",g.style.display="block"):(h.style.display="block",u.style.display="block",c.style.display="none",d.style.display="none",p.style.display="none",g.style.display="none")},this.setEnableZoomIn=function(e){e?$.removeClassName(c,"toolspace-row-button-disabled"):$.addClassName(c,"toolspace-row-button-disabled"),h.setIsEnabledLeft(e)},this.setEnableZoomOut=function(e){e?$.removeClassName(d,"toolspace-row-button-disabled"):$.addClassName(d,"toolspace-row-button-disabled"),h.setIsEnabledRight(e)},this.setEnableUndo=function(e){e?$.removeClassName(p,"toolspace-row-button-disabled"):$.addClassName(p,"toolspace-row-button-disabled"),u.setIsEnabledLeft(e)},this.setEnableRedo=function(e){e?$.removeClassName(g,"toolspace-row-button-disabled"):$.addClassName(g,"toolspace-row-button-disabled"),u.setIsEnabledRight(e)},this.setActive=function(e){r(e)},this.getActive=function(){return i}},ToolspaceStabilizerRow:function(e){let t=$.el({tagName:"label",content:ce("stabilizer")+"&nbsp;",title:ce("stabilizer-title"),css:{display:"flex",alignItems:"center",fontSize:"13px",color:"rgba(0,0,0,0.6)"}}),n=new me({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]],initValue:e.smoothing,onChange:function(t){e.onSelect(parseInt(t))}});t.appendChild(n.getElement()),new $.PointerListener({target:t,onWheel:function(e){n.setDeltaValue(e.deltaY)}}),this.getElement=function(){return t}},TabRow:function(e){let t=this,i=$.el({className:"tabrow",css:{height:"35px"}}),r=[],a=null;const o=$.el({css:{width:"10px",height:"10px",backgroundImage:`url('${n(Mt)}')`,backgroundSize:"cover",position:"absolute",right:"-10px",bottom:"0",pointerEvents:"none"}}),s=$.el({css:{width:"10px",height:"10px",backgroundImage:`url('${n(Mt)}')`,backgroundSize:"cover",position:"absolute",left:"-10px",bottom:"0",transform:"scale(-1,1)",pointerEvents:"none"}});function l(e,n,r){let l={id:e.id,isVisible:!("isVisible"in e)||e.isVisible,onOpen:e.onOpen,onClose:e.onClose,update:function(e){h.className=e===l?r?"tabrow-tab tabrow-tab-opened-accented":"tabrow-tab tabrow-tab-opened":"tabrow-tab",h.style.display=l.isVisible?"block":"none"}},h=$.el({content:"label"in e?e.label:"",title:"title"in e?e.title:void 0,className:n===l.id?r?"tabrow-tab tabrow-tab-opened-accented":"tabrow-tab tabrow-tab-opened":"tabrow-tab",css:{lineHeight:"35px",display:l.isVisible?"block":"none",zIndex:"0"},onClick:function(){a!==l&&t.open(l.id)}});l.div=h,"image"in e&&$.css(h,{backgroundImage:"url('"+e.image+"')",backgroundSize:"28px"}),"css"in e&&$.css(h,e.css),i.appendChild(h);new $.PointerListener({target:h,onEnterLeave:function(e){e?$.addClassName(h,"tabrow-tab-hover"):$.removeClassName(h,"tabrow-tab-hover")}});return n===l.id?(l.onOpen(),l.div.appendChild(o),l.div.appendChild(s)):l.onClose(),l}for(let t=0;t<e.tabArr.length;t++)r.push(l(e.tabArr[t],e.initialId,e.useAccent));for(let t=0;t<r.length;t++)r[t].id===e.initialId&&(a=r[t]);if(null===a)throw"invalid initialId";function h(){for(let e=0;e<r.length;e++)r[e].update(a)}this.getElement=function(){return i},this.open=function(e){for(let t=0;t<r.length;t++)if(r[t].id===e){if(a===r[t])return;return a.onClose(),a=r[t],a.onOpen(),a.div.appendChild(o),a.div.appendChild(s),void h()}throw"TabRow.open - invalid tabId"},this.getOpenedTabId=function(){return""+a.id},this.setIsVisible=function(e,t){for(let n=0;n<r.length;n++)if(r[n].id===e)return r[n].isVisible=!!t,void h();throw"TabRow.setIsVisible - invalid tabId"}},ToolspaceCollapser:function(e){let t=!0,i="right";function r(){o.style.transform="left"===i?t?"rotate(180deg)":"":t?"":"rotate(180deg)"}let a=$.el({css:{width:"36px",height:"36px",background:"rgba(100, 100, 100, 0.9)",color:"#fff",position:"absolute",top:"0",textAlign:"center",lineHeight:"36px",cursor:"pointer",userSelect:"none",padding:"6px",boxSizing:"border-box"},title:ce("toggle-show-tools"),onClick:function(n){n.preventDefault(),t=!t,r(),e.onChange()}}),o=$.el({parent:a,css:{backgroundImage:`url(${n(It)})`,width:"100%",height:"100%",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",userSelect:"none"}});a.oncontextmenu=function(){return!1},this.isOpen=function(){return t},this.setDirection=function(e){i=e,r()},this.getElement=function(){return a}},BrowserStorageUi:Gn,SaveReminder:class{showPopup(){if(!this.projectStore||!this.getProject||!this.getProject())throw new Error("projectStore and getProject need to be set");const e=Math.round((performance.now()-this.lastSavedAt)/1e3/60),t=$.el({});t.append($.el({content:ce("save-reminder-text",{a:"<strong>"+e,b:"</strong>"}),css:{marginBottom:"20px"}}));const n=$.el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px"}}),i=$.el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px",paddingBottom:"0"}});t.append(n,i);const r=$.el({tagName:"button",className:"kl-button",content:ce("save-reminder-save-psd"),onClick:()=>this.onSaveAsPsd()});n.append(r,$.el({content:ce("save-reminder-psd-layers"),css:{marginTop:"10px"}}));const a=new Gn(this.projectStore,this.getProject,this,{hideClearButton:!0});i.append(a.getElement()),si.popup({target:this.getEl(),message:`<b>${ce("save-reminder-title")}</b>`,div:t,ignoreBackground:!0,callback:()=>{a.destroy(),$.destroyEl(r),this.closeFunc=null,this.lastReminderShownAt=performance.now()},closefunc:e=>{this.closeFunc=e}}),setTimeout((()=>{r.focus()}),40)}init(){function e(e){e.preventDefault(),e.returnValue=""}null===this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),this.showReminder&&setInterval((()=>{if("visible"!==document.visibilityState)return;let e=Math.abs(this.history.getActionNumber()-this.lastSavedActionNumber);0===si.dialogCounter.get()&&!this.isDrawing()&&this.lastReminderShownAt+12e5<performance.now()&&e>=100&&this.showPopup()}),5e3),this.history.addListener((()=>{let t=this.history.getActionNumber();this.lastSavedActionNumber!==t?$.setEventListener(window,"onbeforeunload",e):$.setEventListener(window,"onbeforeunload",null)})),this.changeTitle&&document.addEventListener("visibilitychange",(()=>{if("visible"===document.visibilityState)document.title=this.title,clearInterval(this.unsavedInterval);else{let e=this.history.getActionNumber();if(this.lastSavedActionNumber!==e){document.title=ce("unsaved")+" - "+this.title;let e=0;this.unsavedInterval=setInterval((()=>{e=(e+1)%2,document.title=1===e?ce("unsaved")+" · "+this.title:ce("unsaved")+" - "+this.title}),18e4)}}})))}reset(){null!==this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),$.setEventListener(window,"onbeforeunload",null),this.closeFunc&&this.closeFunc())}constructor(e,t,n,i,r,a,o,s,l,h="Klecks"){this.history=e,this.showReminder=t,this.changeTitle=n,this.onSaveAsPsd=i,this.isDrawing=r,this.projectStore=a,this.getProject=o,this.getEl=s,this.getBBox=l,this.title=h,this.lastSavedActionNumber=null}},ToolspaceScroller:class{update(){this.toolspace.scrollHeight>this.toolspace.offsetHeight+3?(this.upInterval||(this.upBtn.style.display=0===this.toolspace.scrollTop?"none":"block"),this.downInterval||(this.downBtn.style.display=this.toolspace.scrollTop+this.toolspace.offsetHeight+1>=this.toolspace.scrollHeight?"none":"block")):(this.upBtn.style.display="none",this.downBtn.style.display="none")}updateUiState(e){$.css(this.upBtn,{left:"left"===e?"0":null,right:"right"===e?"0":null}),$.css(this.downBtn,{left:"left"===e?"0":null,right:"right"===e?"0":null})}constructor(e){this.toolspace=e.toolspace,this.upBtn=$.el({parent:this.toolspace.parentNode,title:ce("scroll"),className:"kl-scroller",css:{top:"0",transform:"rotate(180deg)"}}),this.downBtn=$.el({parent:this.toolspace.parentNode,title:ce("scroll"),className:"kl-scroller",css:{bottom:"0"}}),this.updateUiState(e.uiState);new $.PointerListener({target:this.upBtn,onPointer:e=>{"pointerdown"===e.type&&(this.upInterval=setInterval((()=>{this.toolspace.scrollBy(0,-13),this.update()}),20)),"pointerup"===e.type&&(clearInterval(this.upInterval),setTimeout((()=>{this.upInterval=null,this.update()}),50))}}),new $.PointerListener({target:this.downBtn,onPointer:e=>{"pointerdown"===e.type&&(this.downInterval=setInterval((()=>{this.toolspace.scrollBy(0,13),this.update()}),20)),"pointerup"===e.type&&(clearInterval(this.downInterval),setTimeout((()=>{this.downInterval=null,this.update()}),50))}});const t=e=>{this.toolspace.scrollBy(0,Math.round(.7*e.deltaY)),this.update()};this.upBtn.addEventListener("wheel",t),this.downBtn.addEventListener("wheel",t),this.update();new MutationObserver((()=>this.update())).observe(this.toolspace,{attributes:!0,childList:!0,subtree:!0}),window.addEventListener("resize",(()=>this.update())),ne.subscribe((e=>{this.upBtn.style.opacity=e>=1?"0":"",this.downBtn.style.opacity=e>=1?"0":""}))}},dialogCounter:ne,popup:de,Popup:ue,exportDialog:function(e,t){let n,i,r,a,o,s,l,h,c,d,u,p;n=44,p=22,i=function(){},a=!1,o=!1,r=document.createElement("div"),$.css(r,{width:"308px"}),s=document.createElement("div"),l=new Image,l.src=t.src,s.appendChild(l),s.appendChild(t),$.css(s,{width:"264px",height:"176px",marginTop:"21px",marginLeft:"21px",position:"relative",overflow:"hidden",boxShadow:"0 0 10px 4px rgba(255,255,255, 0)",border:"1px solid rgba(255, 255, 255, 1)",transition:"box-shadow 0.7s linear"}),$.css(t,{position:"absolute",left:"0",top:"0",width:"264px",height:"176px",opacity:"0"}),h={width:264,height:264/t.width*t.height},h.height<176&&(h.height=176,h.width=h.height/t.height*t.width),$.css(l,{position:"absolute",top:"88px",left:"132px",width:h.width+"px",height:h.height+"px",marginLeft:-h.width/2+"px",marginTop:-h.height/2+"px"}),function e(){a||(o=!o,o?$.css(s,{border:"1px solid rgba(0, 0, 0, 1)"}):$.css(s,{border:"1px solid rgba(200, 200, 200, 1)"}),setTimeout(e,510))}(),c=document.createElement("div"),c.innerHTML="Right-Click or Press-Hold on the image, then save.",c.ontouchstart=function(){return!1},$.css(c,{fontSize:"17.6px",color:"#666",padding:"10px",textAlign:"center"}),r.appendChild(s),r.appendChild(c),d=!1,t.ontouchstart=function(){$.css(s,{boxShadow:"0 0 10px 8px rgba(0,255,255, 1)"}),d=!0,u=setTimeout((function(){d=!1,$.css(s,{boxShadow:"0 0 10px 4px rgba(0,255,255, 0)"})}),1500)},t.ontouchmove=function(){$.css(s,{boxShadow:"0 0 10px 4px rgba(0,255,255, 0)"}),d=!1,clearTimeout(u)},t.ontouchend=function(){$.css(s,{boxShadow:"0 0 10px 4px rgba(0,255,255, 0)"}),d=!1,clearTimeout(u)},de({target:e,message:"<b>Save Image</b>",div:r,buttons:["Close"],callback:function(e){a=!0}})},clipboardDialog:function(e,t,n,i,r,a){const o=document.createElement("div"),s=t.width<550||t.height<550;let l=$.el({content:ce("crop-drag-to-crop"),css:{textAlign:"center"}});o.appendChild(l);let h=new Re({width:s?340:540,height:s?300:350,canvas:n});function c(){const e=h.getCroppedImage().toDataURL("image/png");setTimeout((async function(){try{const t=await fetch(e),n=await t.blob();await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]),setTimeout((function(){r.out(ce("cropcopy-copied"),!0)}),200)}catch(e){console.error(e.name,e.message)}}),0)}$.css(h.getEl(),{marginTop:"10px",marginLeft:"-20px",borderTop:"1px solid #bbb",borderBottom:"1px solid #bbb"}),o.appendChild(h.getEl());let d,u=new $.KeyListener({onDown:function(e,t,n){"ctrl+c"===n&&(c(),d())}});function p(){d()}$.addEventListener(window,"blur",p),de({target:e,message:"<b>"+(a?`${ce("cropcopy-title-copy")} / ${ce("cropcopy-title-crop")}`:`${ce("cropcopy-title-copy")}`)+"</b>",div:o,style:s?{}:{width:"500px"},buttons:a?[ce("cropcopy-btn-copy"),ce("cropcopy-btn-crop"),"Cancel"]:[ce("cropcopy-btn-copy"),"Cancel"],primaries:[ce("cropcopy-btn-copy")],callback:function(e){if(e===ce("cropcopy-btn-copy"))c();else if(e===ce("cropcopy-btn-crop")){let e=h.getRect();i({left:Math.round(-e.x),right:Math.round(e.x+e.width-n.width),top:Math.round(-e.y),bottom:Math.round(e.y+e.height-n.height)})}$.removeEventListener(window,"blur",p),h.destroy(),u.destroy()},clickOnEnter:ce("cropcopy-btn-copy"),closefunc:function(e){d=e}})},showImportAsLayerDialog:function(e){let t=document.createElement("div");if($.appendTextDiv(t,ce("import-as-layer-description")),e.klCanvas.isLayerLimitReached()){let e=$.el({content:ce("import-as-layer-limit-reached"),css:{background:"#ff0",padding:"10px",marginTop:"5px",marginBottom:"5px",border:"1px solid #e7d321",borderRadius:"5px"}});t.appendChild(e)}let n=e.bbox.width<550,i=$.el({css:{display:"flex"}}),r=$.el({tagName:"button",content:"1:1",css:{marginRight:"10px"},onClick:function(){l.reset()}}),a=$.el({tagName:"button",content:ce("import-as-layer-fit"),css:{marginRight:"10px"},onClick:function(){l.setTransformFit()}}),o=$.el({tagName:"button",content:ce("center"),css:{marginRight:"10px"},onClick:function(){l.setTransformCenter()}});i.appendChild(r),i.appendChild(a),i.appendChild(o),t.appendChild(i);let s=[];{let t=e.klCanvas.getLayers();for(let e=0;e<t.length;e++)s.push({image:t[e].context.canvas,opacity:t[e].opacity,mixModeStr:t[e].mixModeStr})}s.push({image:e.importImage,opacity:1,mixModeStr:"source-over"});let l=new st({elementWidth:n?340:540,elementHeight:n?280:350,imageWidth:e.klCanvas.getLayerContext(0).canvas.width,imageHeight:e.klCanvas.getLayerContext(0).canvas.height,layers:s,transformIndex:s.length-1});function h(e,t){l.move(e,t)}$.css(l.getElement(),{marginTop:"10px",marginLeft:"-20px"}),t.appendChild(l.getElement());let c=new $.KeyListener({onDown:function(e){"left"===e&&h(-1,0),"right"===e&&h(1,0),"up"===e&&h(0,-1),"down"===e&&h(0,1)}});de({target:e.target,message:`<b>${ce("import-as-layer-title")}</b>`,div:t,style:n?null:{width:"500px"},buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(t){c.destroy(),l.destroy(),$.destroyEl(r),$.destroyEl(a),$.destroyEl(o),"Ok"===t?e.callback(l.getTransformation(),l.getIsPixelated()):e.callback()}})},newImageDialog:function(e){let t=e.currentColor,n=e.secondaryColor,i=e.maxCanvasSize,r=e.canvasWidth,a=e.canvasHeight,o=e.workspaceWidth,s=e.workspaceHeight,l=e.onConfirm,h=e.onCancel;function c(e,t,n,r,a){return $.fitInto(e,t,Math.min(i,n-a),Math.min(i,r-a),1)}let d=document.createElement("div"),u=document.createElement("div"),p=document.createElement("div"),g=document.createElement("input"),m=document.createElement("div"),f=document.createElement("input"),y=document.createElement("div");u.style.position="relative",u.style.width="145px",u.style.height="35px",u.style.lineHeight="30px",p.style.width="145px",p.style.height="35px",p.style.lineHeight="30px",m.innerText=ce("new-px"),m.style.color="#888",m.style.fontSize="12px",m.style.marginLeft="5px",m.style.cssFloat="right",y.innerText=ce("new-px"),y.style.color="#888",y.style.fontSize="12px",y.style.marginLeft="5px",y.style.cssFloat="right",g.setAttribute("data-ignore-focus","true"),f.setAttribute("data-ignore-focus","true"),g.type="number",g.min="1",g.max=i,g.style.cssFloat="right",g.style.width="70px",f.type="number",f.min="1",f.max=i,f.style.cssFloat="right",f.style.width="70px",g.value=r,f.value=a,g.onclick=function(){this.focus(),z()},f.onclick=function(){this.focus(),z()},u.appendChild(m),u.appendChild(g),$.appendTextDiv(u,ce("width")+": "),p.appendChild(y),p.appendChild(f),$.appendTextDiv(p,ce("height")+": ");let x=document.createElement("div");x.style.marginTop="5px",x.style.color="#888";let b=document.createElement("div"),v=document.createElement("button");b.style.marginBottom="10px";let w=document.createElement("button"),C=document.createElement("button"),S=document.createElement("button"),E=document.createElement("button"),M=document.createElement("button");w.textContent=ce("new-current"),v.textContent=ce("new-fit"),M.textContent=ce("new-oversize"),S.textContent=ce("new-landscape"),E.textContent=ce("new-portrait"),C.textContent=ce("new-square"),w.style.marginRight="5px",v.style.marginRight="5px",M.style.marginRight="5px",S.style.marginTop="5px",S.style.marginRight="5px",E.style.marginTop="5px",E.style.marginRight="5px",b.appendChild(w),b.appendChild(v),b.appendChild(M),b.appendChild(C),b.appendChild(S),b.appendChild(E),w.onclick=function(){g.value=r,f.value=a,z()},v.onclick=function(){g.value=o,f.value=s,z()},M.onclick=function(){g.value=o+500,f.value=s+500,z()},C.onclick=function(){let e=c(1,1,o,s,50);g.value=""+Math.round(e.width),f.value=""+Math.round(e.height),z()},S.onclick=function(){let e=c(4,3,o,s,50);g.value=""+Math.round(e.width),f.value=""+Math.round(e.height),z()},E.onclick=function(){let e=c(3,4,o,s,50);g.value=""+Math.round(e.width),f.value=""+Math.round(e.height),z()};let k=new me({isFocusable:!0,optionArr:[["screen",ce("new-screen")],["16 9",ce("new-video")+" 16:9"],["3 2","3:2"],["5 3","5:3"],["2 1","2:1"],["paper",ce("new-din-paper")+" √2:1"],["9 16","9:16"],["2 3","2:3"],["3 5","3:5"],["1 2","1:2"],["1 1.4142135623730951","1:√2"]],onChange:function(e){if("screen"===e)g.value=""+window.screen.width,f.value=""+window.screen.height;else if("paper"===e){let e=c(Math.sqrt(2),1,o,s,50);g.value=""+Math.round(e.width),f.value=""+Math.round(e.height)}else{let t=e.split(" "),n=c(parseFloat(t[0]),parseFloat(t[1]),o,s,50);g.value=""+Math.round(n.width),f.value=""+Math.round(n.height)}z(),k.setValue(null)}});setTimeout((()=>{k.setValue(null)}),0),$.css(k.getElement(),{width:"80px"}),b.appendChild(k.getElement());let I={r:255,g:255,b:255,a:1},T=[{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1},{r:0,g:0,b:0,a:0}];T.push({r:t.r,g:t.g,b:t.b,a:1}),T.push({r:n.r,g:n.g,b:n.b,a:1});let L=new Ie({colorArr:T,onChange:function(e){I=e,A.style.backgroundColor="rgba("+e.r+","+e.g+","+e.b+", "+e.a+")"}}),R=document.createElement("div");$.css(R,{boxSizing:"border-box",width:"340px",height:"140px",display:"table",backgroundColor:"#9e9e9e",padding:"10px",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",marginLeft:"-20px",colorScheme:"only light"});let A=document.createElement("div");$.css(A,{width:"200px",height:"100px",backgroundColor:"#fff",marginLeft:"auto",marginRight:"auto",color:"#aaa",fontSize:"16px",fontWeight:"bold",textAlign:"center",verticalAlign:"center",display:"table",overflow:"hidden",boxShadow:"0px 0px 3px rgba(0,0,0,0.5)"});let P=document.createElement("div");P.style.display="table-cell",P.style.verticalAlign="middle",P.appendChild(A),R.appendChild(P);let D=$.appendTextDiv(A,"");D.style.display="table-cell",D.style.verticalAlign="middle";let O=parseInt(g.value),B=parseInt(f.value);function z(){g.value=""+Math.min(i,parseInt(g.value)),f.value=""+Math.min(i,parseInt(f.value));let e=parseInt(g.value),t=parseInt(f.value);(e<1||e>i||t<1||t>i)&&(e>i?e=i:t>i&&(t=i),g.value=""+e,f.value=""+t);let n=[[1,2],[2,1],[2,3],[3,2],[3,4],[4,3],[4,5],[5,4],[16,9],[9,16],[3,2],[2,3],[5,3],[3,5],[2,1],[1,2],[1.414,1],[1,1.414]],r=$.reduce(e,t),a=null,o=null;for(let e=0;e<n.length;e++)(0===e||Math.abs(n[e][0]/n[e][1]-r[0]/r[1])<o)&&(a=n[e],o=Math.abs(n[e][0]/n[e][1]-r[0]/r[1]));x.innerText=o>0&&o<.005?ce("new-ratio")+": ~"+a[0]+":"+a[1]:ce("new-ratio")+": "+r[0]+":"+r[1],O=e,B=t;let s=e,l=function(e,t){let n=e,i=t;for(;;){if(!(n%=i))return i;if(!(i%=n))return n}}(e,t);e/=l,t/=l,e*=260,t*=260,e>260&&(t*=260/e,e=260),t>100&&(e*=100/t,t=100),A.style.width=e+"px",A.style.height=t+"px",$.createCheckerDataUrl(parseInt(""+e/s*30),(function(e){R.style.background="url("+e+")"}))}g.onchange=function(){(""===g.value||parseInt(g.value)<0)&&(g.value="1"),z()},g.onkeyup=function(){z()},f.onchange=function(){(""===f.value||parseFloat(f.value)<0)&&(f.value="1"),z()},f.onkeyup=function(){z()},z(),d.appendChild(b);let H=$.el({parent:d,css:{display:"flex",justifyContent:"space-between",alignItems:"flex-end"}}),F=$.el({parent:H});F.appendChild(u),F.appendChild(p),F.appendChild(x),H.appendChild(L.getElement()),d.appendChild(R),de({target:e.klRootEl,message:`<b>${ce("new-title")}</b>`,div:d,buttons:["Ok","Cancel"],callback:function(e){g.onclick=null,f.onclick=null,w.onclick=null,v.onclick=null,M.onclick=null,C.onclick=null,S.onclick=null,E.onclick=null,g.onchange=null,g.onkeyup=null,f.onchange=null,f.onkeyup=null,k.destroy(),L.destroy(),"Cancel"===e||parseInt(g.value)<=0||parseInt(f.value)<=0||isNaN(parseInt(g.value))||isNaN(parseInt(f.value))?h():l(parseInt(g.value),parseInt(f.value),I)},clickOnEnter:"Ok"})},textToolDialog:function(e){let t=$.el({}),i=e.bbox.width<550,r=e.bbox.height<630,a=i?340:540,o=i?r?210:260:r?230:350,s=1,l=e.klCanvas.getLayersFast(),h=$.canvas(e.klCanvas.getWidth(),e.klCanvas.getHeight()),c=h.getContext("2d"),d=$.canvas(a,o),u=d.getContext("2d"),p=$.canvas(a,o),g=p.getContext("2d"),m=$.canvas(a,o),f=m.getContext("2d");$.css(m,{display:"block"});let y=$.el({parent:t,css:{position:"relative",width:a+"px",marginLeft:"-20px",cursor:"move",colorScheme:"only light",touchAction:"none"},onClick:function(){W.focus()}});$.el({parent:y,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",pointerEvents:"none"}}),y.appendChild(m);let x=f.createPattern($.createCheckerCanvas(8),"repeat"),b=$.canvas(1,1);function v(){c.clearRect(0,0,h.width,h.height);let t={...e.color,a:Y.getValue()},n=Xe(h,{x:e.x,y:e.y,textStr:W.value,align:N.getValue(),isItalic:U.getValue(),isBold:X.getValue(),size:parseFloat(j.value),font:O.getValue(),color:$.ColorConverter.toRgbaStr(t),angleRad:e.angleRad});n.width=Math.max(n.width,1),n.height=Math.max(n.height,1);let i=$.rotate(n.x,n.y,-e.angleRad/Math.PI*180),r=$.rotate(n.width,n.height,-e.angleRad/Math.PI*180),y=e.x+i.x+r.x/2,v=e.y+i.y+r.y/2,w=$.fitInto(n.width,n.height,a-100,o-100);s=Math.min(1,w.width/n.width),s=Math.min(4,s*Math.pow(2,R)),u.save(),s>=4?u.imageSmoothingEnabled=!1:(u.imageSmoothingEnabled=!0,u.imageSmoothingQuality=s>=1?"low":"medium"),u.clearRect(0,0,m.width,m.height),u.translate(a/2,o/2),u.scale(s,s),u.rotate(e.angleRad),u.drawImage(l[e.layerIndex].canvas,-y,-v),u.drawImage(h,-y,-v),u.restore(),g.save(),g.fillStyle="rgb(158,158,158)",g.fillRect(0,0,a,o);{g.save(),g.translate(a/2,o/2),g.scale(s,s),g.rotate(e.angleRad),g.imageSmoothingEnabled=!1;let t=1/s;g.globalAlpha=.2,g.drawImage(b,-y-t,-v-t,h.width+2*t,h.height+2*t),g.globalAlpha=1,g.globalCompositeOperation="destination-out",g.drawImage(b,-y,-v,h.width,h.height),g.restore()}s>=4?g.imageSmoothingEnabled=!1:(g.imageSmoothingEnabled=!0,g.imageSmoothingQuality=s>=1?"low":"medium"),g.save(),g.translate(a/2,o/2),g.scale(s,s),g.rotate(e.angleRad);for(var C=0;C<e.layerIndex;C++)l[C].opacity>0&&(g.globalAlpha=l[C].opacity,g.globalCompositeOperation=l[C].mixModeStr,g.drawImage(l[C].canvas,-y,-v));g.restore(),g.globalAlpha=l[e.layerIndex].opacity,g.globalCompositeOperation=l[e.layerIndex].mixModeStr,g.drawImage(d,0,0),g.save(),g.translate(a/2,o/2),g.scale(s,s),g.rotate(e.angleRad);for(let t=e.layerIndex+1;t<l.length;t++)l[t].opacity>0&&(g.globalAlpha=l[t].opacity,g.globalCompositeOperation=l[t].mixModeStr,g.drawImage(l[t].canvas,-y,-v));g.restore(),g.restore(),f.save(),f.fillStyle=x,f.fillRect(0,0,m.width,m.height),f.drawImage(p,0,0),f.restore(),f.save(),f.globalCompositeOperation="difference",f.strokeStyle="#fff",f.lineWidth=1,f.strokeRect(Math.round(a/2-n.width/2*s),Math.round(o/2-n.height/2*s),Math.round(n.width*s),Math.round(n.height*s)),f.restore()}function w(t,n){let i=$.rotate(t,n,-e.angleRad/Math.PI*180);e.x+=i.x/s,e.y+=i.y/s,v()}b.getContext("2d").fillRect(0,0,1,1);let C=new $.PointerListener({target:m,pointers:1,onPointer:function(e){"pointermove"===e.type&&e.button&&(e.eventPreventDefault(),w(-e.dX,-e.dY))},onWheel:function(e){A(-e.deltaY)}});const S=e=>{e.preventDefault()};$.addEventListener(m,"wheel",S);let E=$.el({parent:t,css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"10px"}}),M=$.el({parent:t,css:i?{}:{display:"flex",alignItems:"center",justifyContent:"space-between"}}),k=$.el({parent:M,css:{display:"flex",alignItems:"center",marginTop:"5px"}}),I=$.el({parent:M,css:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:"5px",width:i?"":"300px"}}),T=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];T.unshift({r:e.secondaryColor.r,g:e.secondaryColor.g,b:e.secondaryColor.b,a:1}),T.unshift({r:e.color.r,g:e.color.g,b:e.color.b,a:1});let L=new Ie({colorArr:T,initialIndex:0,onChange:function(t){e.color=t,v()}});L.getElement().title=ce("text-color"),L.getElement().style.marginLeft="-5px",E.appendChild(L.getElement());let R=0;function A(e){R=Math.min(2,Math.max(-2,R+e)),v(),H.disabled=!P(1),F.disabled=!P(-1)}function P(e){return R!==Math.min(2,Math.max(-2,R+e))}let D,O,B,z=$.el({parent:E,css:{}}),H=$.el({parent:z,content:`<img height="20" src="${n(Ct)}">`,title:ce("zoom-in"),tagName:"button",onClick:function(){A(1)},css:{fontWeight:"bold"}}),F=$.el({parent:z,content:`<img height="20" src="${n(St)}">`,title:ce("zoom-out"),tagName:"button",onClick:function(){A(-1)},css:{fontWeight:"bold",marginLeft:"5px"}}),j=$.el({parent:k,tagName:"input",title:ce("text-size"),custom:{type:"number",min:1,max:1e4,value:e.size},css:{width:"60px"},onChange:function(){j.value=""+Math.max(1,Math.min(1e4,parseInt(j.value))),v()}}),_=new $.PointerListener({target:j,onWheel:function(e){j.value=""+Math.max(1,Math.min(1e3,parseInt(j.value)-e.deltaY)),v()}});D=$.el({css:{fontSize:"15px",marginLeft:"10px"}}),O=new me({isFocusable:!0,optionArr:[["sans-serif","Sans-serif"],["serif","Serif"],["monospace","Monospace"],["cursive","Cursive"],["fantasy","Fantasy"]],initValue:e.font,onChange:function(e){v()}}),D.appendChild(O.getElement()),k.appendChild(D),B=new $.PointerListener({target:O.getElement(),onWheel:function(e){O.setDeltaValue(e.deltaY)}});let N=new ye({optionArr:[{id:"left",title:ce("text-left"),image:n(Tt)},{id:"center",title:ce("text-center"),image:n(Lt)},{id:"right",title:ce("text-right"),image:n(Rt)}],initId:e.align,onChange:function(e){v()}});I.appendChild(N.getElement());let U=new fe({image:n(At),title:ce("text-italic"),initValue:e.isItalic,onChange:function(e){v()}});I.appendChild(U.getElement());let X=new fe({image:n(Pt),title:ce("text-bold"),initValue:e.isBold,onChange:function(e){v()}});I.appendChild(X.getElement());let Y=new we({label:ce("opacity"),width:150,height:30,min:0,max:1,initValue:e.opacity,resolution:225,eventResMs:1e3/30,onChange:function(e){v()},formatFunc:function(e){return Math.round(100*e)}});I.appendChild(Y.getElement());let V,W=$.el({parent:t,tagName:"textarea",custom:{placeholder:ce("text-placeholder"),"data-ignore-focus":"true"},css:{whiteSpace:"nowrap",overflow:"auto",width:"100%",height:"70px",resize:"vertical",marginTop:"10px"},onChange:function(){v()}});W.addEventListener("input",v),setTimeout((function(){W.focus(),W.select()}));let G=new $.KeyListener({onDown:function(e,t,n){$.isInputFocused(!0)||("left"===e&&w(-1,0),"right"===e&&w(1,0),"up"===e&&w(0,-1),"down"===e&&w(0,1))}});function K(){window.scrollTo(0,0)}window.addEventListener("scroll",K),de({target:e.klRootEl,message:`<b>${ce("text-title")}</b>`,div:t,buttons:["Ok","Cancel"],style:i?{}:{width:"500px"},callback:function(t){let n={x:e.x,y:e.y,textStr:W.value,align:N.getValue(),isItalic:U.getValue(),isBold:X.getValue(),color:e.color,size:j.value,font:O.getValue(),opacity:Y.getValue()};window.removeEventListener("scroll",K),W.removeEventListener("input",v),$.destroyEl(W),C.destroy(),_.destroy(),B.destroy(),$.removeEventListener(m,"wheel",S),$.destroyEl(y),$.destroyEl(H),$.destroyEl(F),$.destroyEl(j),L.destroy(),O.destroy(),G.destroy(),N.destroy(),U.destroy(),X.destroy(),Y.destroy(),"Ok"===t&&e.onConfirm(n)},autoFocus:!1,clickOnEnter:"Ok",ignoreBackground:!0,closefunc:function(e){V=e}}),v()},showImportImageDialog:function(e){const t=$.el({}),n=e.bbox.width<550||e.bbox.height<550,i=n?{}:{width:"500px"};let r;const a=new Re({width:n?340:540,height:n?300:400,canvas:e.image.canvas,isNotCopy:!0,onChange:function(e,t){r&&o(e,t)}});function o(t,n){const i=$.fitInto(t,n,e.maxSize,e.maxSize);i.width<t?(r.innerHTML=`<span style="color:#f00">${t} X ${n}</span> ⟶ ${Math.round(i.width)} X ${Math.round(i.height)}`,r.title=ce("import-too-large")):(r.innerHTML=`${t} X ${n}`,r.title="")}$.css(a.getEl(),{marginLeft:"-20px",borderTop:"1px solid #bbb",borderBottom:"1px solid #bbb"}),a.getEl().title=ce("crop-drag-to-crop"),t.appendChild(a.getEl()),r=$.el({parent:t,css:{marginTop:"10px",textAlign:"center",color:"#888",lineHeight:"20px"}}),o(e.image.width,e.image.height);let s,l=!1;if("psd"===e.image.type){const n={background:"rgba(255,255,0,0.5)",padding:"10px",marginTop:"5px",marginBottom:"5px",border:"1px solid #e7d321",borderRadius:"5px"};if(e.image.layers){if(s=new pe({init:l,label:ce("import-flatten"),callback:function(e){l=e}}),t.appendChild(s.getElement()),e.image.warningArr){const i=$.el({content:ce("import-psd-limited-support"),css:n});i.appendChild($.el({tagName:"a",content:"Details",onClick:function(){!function(e){let t=[],n={mask:"Masks not supported. Mask was applied.",clipping:"Clipping not supported. Clipping layers were merged.",group:"Groups not supported. Layers were ungrouped.",adjustment:"Adjustment layers not supported.","layer-effect":"Layer effects not supported.","smart-object":"Smart objects not supported.","blend-mode":"Unsupported layer blend mode.","bits-per-channel":"Unsupported color depth. Only 8bit per channel supported."};for(let i=0;i<e.length;i++)t.push("- "+n[e[i]]);alert(t.join("\n"))}(e.image.warningArr)}})),t.appendChild(i)}}else{const e=$.el({content:ce("import-psd-unsupported"),css:n});t.appendChild(e)}}de({target:e.target,message:`<b>${ce("import-title")}</b>`,div:t,style:i,buttons:[ce("import-btn-as-layer"),ce("import-btn-as-image"),"Cancel"],callback:function(t){const n=a.getCroppedImage(),i=a.getRect();a.destroy(),s&&s.destroy(),t===ce("import-btn-as-layer")?e.callback({type:"as-layer",image:n}):t===ce("import-btn-as-image")?"psd"===e.image.type?(l&&(e.image.layers=null),e.callback({type:"as-image-psd",image:e.image,cropObj:i})):"image"===e.image.type&&e.callback({type:"as-image",image:n}):e.callback({type:"cancel"})},autoFocus:"As Image"})},showIframePopup:Wn,imgurUpload:function(e,t,i,r){let a=document.createElement("input");a.type="text",a.value=ce("upload-title-untitled");let o=$.el({tagName:"textarea",custom:{rows:2},css:{width:"100%",maxWidth:"100%"}}),s=document.createElement("div");s.textContent=ce("upload-name")+":";let l=$.el({content:ce("upload-caption")+":",css:{marginTop:"10px"}}),h=document.createElement("div");h.innerHTML=`<br/><a href="https://imgur.com/tos" target="_blank" rel="noopener noreferrer">${ce("upload-tos")}</a> ${ce("upload-tos-2")}`;const c=new si.RadioList({name:"filetype",init:"jpeg",items:[{label:"JPG",value:"jpeg"},{label:"PNG",value:"png"}],ignoreFocus:!0});$.css(c.getElement(),{marginBottom:"10px"});let d=document.createElement("div"),u=document.createElement("div");u.className="info-hint",u.textContent=ce("upload-link-notice"),d.append(u,c.getElement(),s,a,l,o,h),si.popup({target:t,message:`<b>${ce("upload-title")}</b>`,type:"upload",div:d,buttons:[ce("upload-submit"),"Cancel"],clickOnEnter:ce("upload-submit"),primaries:[ce("upload-submit")],autoFocus:ce("upload-submit"),callback:async function(s){if(s===ce("upload-submit")||"Yes"===s||"Ok"===s)try{if(!r)throw new Error("imgur key missing");const s=await async function(e,t,i,r,a){let o=Kn(e.toDataURL("image/"+r)),s=window.open(),l=s.document.createElement("div"),h=s.document.createElement("img");h.src=n(Zn),l.appendChild(h),$.css(h,{filter:"invert(1)"}),s.document.body.style.backgroundColor="#121211",s.document.body.style.backgroundImage="linear-gradient(#2b2b2b 0%, #121211 50%)",s.document.body.style.backgroundRepeat="no-repeat";let c,d=s.document.createElement("div");d.style.marginTop="10px",l.appendChild(d),d.textContent=ce("upload-uploading"),s.document.body.appendChild(l),$.css(l,{marginLeft:"auto",marginRight:"auto",marginTop:"100px",fontFamily:"Arial, sans-serif",fontSize:"20px",textAlign:"center",transition:"opacity 0.3s ease-in-out",opacity:"0",color:"#ccc"}),setTimeout((function(){l.style.opacity="1"}),20);try{const e=new FormData;e.append("title",t),e.append("description",i),e.append("image",o),c=await fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID "+a},body:e})}catch(e){throw s.close(),new Error(e)}if(!c.ok)throw s.close(),new Error;let u=(await c.json()).data;return s.location.href=u.link.replace(/\.(jpg|png)/,""),u}(e.getCompleteCanvas(1),a.value,o.value,c.getValue(),r);si.popup({target:t,type:"ok",message:`<h3>${ce("upload-success")}</h3><br>${ce("upload-delete")}<br><a target='_blank' rel="noopener noreferrer" href='https://imgur.com/delete/${s.deletehash}'>imgur.com/<b>delete</b>/${s.deletehash}</a><br><br>`,buttons:["Ok"]}),i.reset()}catch(e){si.popup({target:t,type:"error",message:ce("upload-failed")+": "+e.message,buttons:["Ok"]})}}})},HandUi:function(e){let t=$.el({css:{margin:"10px"}}),i=!0,r=e.scale,a=e.angleDeg,o=$.el({css:{marginBottom:"10px",display:"flex"}}),s=$.el({css:{display:"flex",marginBottom:"10px"}}),l=$.el({css:{display:"flex"}});t.append(o,s,l);let h=$.el({css:{width:"55px",userSelect:"none"}});o.appendChild(h);let c=new Image;c.src=n(Le),$.css(c,{verticalAlign:"bottom",width:"20px",height:"20px",marginRight:"5px",borderRadius:"10px",background:"rgba(0,0,0,0.2)",userSelect:"none"}),o.appendChild(c);let d=$.el({css:{userSelect:"none"}});function u(){h.innerHTML=Math.round(100*r)+"%",d.innerHTML=Math.round(a)+"°",c.style.transform="rotate("+a+"deg)",c.style.boxShadow=a%90==0?"inset 0 0 0 1px rgba(255,255,255, 1), 0 0 0 1px rgba(0, 0, 0, 0.3)":""}o.appendChild(d),u();let p=$.el({tagName:"button",content:ce("hand-reset"),onClick:e.onReset});$.makeUnfocusable(p);let g=$.el({tagName:"button",content:ce("hand-fit"),css:{marginLeft:"10px"},onClick:e.onFit});$.makeUnfocusable(g),s.append(p,g);let m=$.el({tagName:"button",content:'<img height="20" src="'+n(kt)+'" alt="Rotate" style="transform: scale(-1, 1)"/>',onClick:function(){e.onAngleChange(-15,!0)}});$.makeUnfocusable(m);let f=$.el({tagName:"button",content:"0°",css:{marginLeft:"10px"},onClick:function(){e.onAngleChange(0)}});$.makeUnfocusable(f);let y=$.el({tagName:"button",content:'<img height="20" src="'+n(kt)+'" alt="Rotate"/>',css:{marginLeft:"10px"},onClick:function(){e.onAngleChange(15,!0)}});$.makeUnfocusable(y),l.append(m,f,y),this.getElement=function(){return t},this.setIsVisible=function(e){i=!!e,t.style.display=i?"block":"none",i&&u()},this.update=function(e,t){r=e,a=t,i&&u()}},FillUi:function(e){let t=$.el({css:{margin:"10px"}}),n=!0,i=$.el({parent:t,css:{marginBottom:"10px"}}),r=new we({label:ce("opacity"),width:250,height:30,min:0,max:1,initValue:1,onChange:function(e){},formatFunc:function(e){return Math.round(100*e)}});t.appendChild(r.getElement());let a=new we({label:ce("bucket-tolerance"),width:250,height:30,min:0,max:255,initValue:51,onChange:function(e){},formatFunc:function(e){return Math.round(e/255*100)}});$.css(a.getElement(),{marginTop:"10px"}),t.appendChild(a.getElement());let o,s,l,h,c=$.el({parent:t,css:{display:"flex",marginTop:"10px"}});o=$.el({content:ce("bucket-sample")+"&nbsp;",title:ce("bucket-sample-title"),css:{fontSize:"15px"}}),s=new me({optionArr:[["all",ce("bucket-sample-all")],["current",ce("bucket-sample-active")],["above",ce("bucket-sample-above")]],initValue:"all",onChange:function(e){}}),new $.PointerListener({target:s.getElement(),onWheel:function(e){s.setDeltaValue(e.deltaY)}}),o.appendChild(s.getElement()),c.appendChild(o),l=$.el({content:ce("bucket-grow")+"&nbsp;",title:ce("bucket-grow-title"),css:{fontSize:"15px",marginLeft:"10px"}}),h=new me({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"]],initValue:"0",onChange:function(e){}}),new $.PointerListener({target:h.getElement(),onWheel:function(e){h.setDeltaValue(e.deltaY)}}),l.appendChild(h.getElement()),c.appendChild(l);let d=!0,u=new pe({init:!0,label:ce("bucket-contiguous"),title:ce("bucket-contiguous-title"),callback:function(e){d=e},css:{marginTop:"10px",paddingRight:"5px",display:"inline-block"}});t.appendChild(u.getElement()),this.getElement=function(){return t},this.setIsVisible=function(r){n=!!r,t.style.display=n?"block":"none",n&&(i.appendChild(e.colorSlider.getElement()),i.appendChild(e.colorSlider.getOutputElement()))},this.getTolerance=function(){return a.getValue()},this.getOpacity=function(){return r.getValue()},this.getSample=function(){return s.getValue()},this.getGrow=function(){return parseInt(h.getValue(),10)},this.getContiguous=function(){return d}},TextUi:function(e){let t=$.el({css:{margin:"10px"}}),n=!0,i=$.el({parent:t,css:{marginBottom:"10px"}});$.el({parent:t,content:ce("text-instruction")}),this.getElement=function(){return t},this.setIsVisible=function(r){n=!!r,t.style.display=n?"block":"none",n&&(i.appendChild(e.colorSlider.getElement()),i.appendChild(e.colorSlider.getOutputElement()))}},ShapeUi:function(e){let t,n,i=$.el({css:{margin:"10px"}}),r=!0,a=$.el({parent:i,css:{marginBottom:"10px"}}),o=$.createSvg({elementType:"rect",x:"8",width:"19"}),s=$.createSvg({elementType:"svg",width:"35",height:"35"});s.appendChild(o),$.css(s,{display:"block"});let l=$.createSvg({elementType:"rect",x:"8",width:"19"}),h=$.createSvg({elementType:"svg",width:"35",height:"35"});h.appendChild(l),$.css(h,{display:"block"});let c=$.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),d=$.createSvg({elementType:"svg",width:"35",height:"35"});d.appendChild(c),$.css(d,{display:"block"});let u=$.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),p=$.createSvg({elementType:"svg",width:"35",height:"35"});p.appendChild(u),$.css(p,{display:"block"});let g=$.createSvg({elementType:"line",x1:"8",x2:"27"}),m=$.createSvg({elementType:"svg",width:"35",height:"35"});function f(){let e=$.clamp(Math.round(v.getValue()/10),1,10)+"px";$.css(o,{fill:"none",stroke:"black",strokeWidth:e}),$.css(l,{fill:"black",stroke:"none"}),$.css(c,{fill:"none",stroke:"black",strokeWidth:e}),$.css(u,{fill:"black",stroke:"none"}),$.css(g,{fill:"none",stroke:"black",strokeWidth:e}),E.getValue()?(o.setAttribute("y","8"),o.setAttribute("height","19"),l.setAttribute("y","8"),l.setAttribute("height","19"),c.setAttribute("ry","9.5"),u.setAttribute("ry","9.5")):(o.setAttribute("y","10.8"),o.setAttribute("height","13.399999999999999"),l.setAttribute("y","10.8"),l.setAttribute("height","13.399999999999999"),c.setAttribute("ry",""+(17.5-10.8)),u.setAttribute("ry",""+(17.5-10.8))),M.getValue()?(g.setAttribute("y1","27"),g.setAttribute("y2","8")):(g.setAttribute("y1","24.2"),g.setAttribute("y2","10.8"))}m.appendChild(g),$.css(m,{display:"block"});let y=$.el({parent:i,css:{display:"flex",justifyContent:"space-between",alignItems:"start"}}),x=new Te({optionArr:[{id:"rect-stroke",label:s,title:ce("shape-rect")+" "+ce("shape-stroke")},{id:"ellipse-stroke",label:d,title:ce("shape-ellipse")+" "+ce("shape-stroke")},{id:"line",label:m,title:ce("shape-line")},{id:"rect-fill",label:h,title:ce("shape-rect")+" "+ce("shape-fill")},{id:"ellipse-fill",label:p,title:ce("shape-ellipse")+" "+ce("shape-fill")}],initId:"rect",onChange:function(e){let i=e.split("-");t=i[0],n=i[1],$.css(E.getElement(),{display:"line"===t?"none":null}),$.css(M.getElement(),{display:"line"===t?null:"none"}),$.css(v.getElement(),{display:"line"!==t&&"fill"===n?"none":null})},changeOnInit:!0});x.getElement().style.width="120px",y.appendChild(x.getElement());let b=new pe({init:!1,label:ce("eraser"),callback:function(e){f()}});y.appendChild(b.getElement());let v=new we({label:ce("shape-line-width"),width:250,height:30,min:1,max:200,initValue:4,curve:"quadratic",onChange:function(e){f()},formatFunc:function(e){return Math.round(e)}});$.css(v.getElement(),{marginTop:"10px"}),i.appendChild(v.getElement());let w=new we({label:ce("opacity"),width:250,height:30,min:0,max:1,initValue:1,onChange:function(e){},formatFunc:function(e){return Math.round(100*e)}});$.css(w.getElement(),{marginTop:"10px"}),i.appendChild(w.getElement());let C=$.el({parent:i,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),S=new pe({init:!1,label:ce("shape-outwards"),callback:function(e){},css:{width:"50%",marginRight:"10px"}});C.appendChild(S.getElement());let E=new pe({init:!1,label:ce("shape-fixed"),callback:function(e){f()},css:{flexGrow:"1"}});C.appendChild(E.getElement());let M=new pe({init:!1,label:ce("shape-snap"),title:ce("shape-snap-title"),callback:function(e){f()},css:{flexGrow:"1"}});C.appendChild(M.getElement()),f(),this.getElement=function(){return i},this.setIsVisible=function(t){r=!!t,i.style.display=r?"block":"none",r&&(a.appendChild(e.colorSlider.getElement()),a.appendChild(e.colorSlider.getOutputElement()))},this.getShape=function(){return t},this.getMode=function(){return n},this.getIsEraser=function(){return b.getValue()},this.getOpacity=function(){return w.getValue()},this.getLineWidth=function(){return v.getValue()},this.getIsOutwards=function(){return S.getValue()},this.getIsFixed=function(){return E.getValue()},this.getIsSnap=function(){return M.getValue()}},FileTab:class{refresh(){}getElement(){return this.div}setIsVisible(e){e&&this.refresh()}triggerImport(){this.importButton.click()}constructor(e,t,i,r,a,o,s,l,h,c,d,u){this.exportType=r;const p=this;this.div=document.createElement("div");setTimeout((()=>{let e=document.createElement("div"),g=document.createElement("button"),m=document.createElement("button"),f=document.createElement("button"),y=document.createElement("button"),x=document.createElement("button");g.style.cssFloat="left",$.css(m,{cssFloat:"left",clear:"both"}),$.css(x,{cssFloat:"left",clear:"both"}),g.tabIndex=-1,m.tabIndex=-1,f.tabIndex=-1,y.tabIndex=-1,x.tabIndex=-1,g.innerHTML=`<img src='${n(ct)}' alt='icon' height='20'/>${ce("file-new")}`,m.innerHTML=`<img src='${n(ut)}' alt='icon' height='20'/>${ce("file-save")}`,f.innerHTML=`<img src='${n(pt)}' alt='icon' height='20'/>${ce("file-share")}`,y.innerHTML=`<img style='float:left' src='${n($n)}' height='20' alt='icon'/>${ce("file-upload")}`,x.innerHTML=`<img src='${n(Ce)}' alt='icon' height='20'/>${ce("file-copy")}`,x.title=ce("file-copy-title"),g.className="gridButton",m.className="gridButton",f.className="gridButton",y.className="gridButton",x.className="gridButton",this.importButton=document.createElement("input"),this.importButton.tabIndex=-1,this.importButton.type="file",this.importButton.multiple=!0,this.importButton.accept="image",this.importButton.size="71",this.importButton.textContent="Import";let b,v,w=this.importButton;!function(){w=document.createElement("div"),w.className="gridButton",w.style.position="relative",w.style.cursor="pointer",w.style.cssFloat="left";let e=document.createElement("div");e.style.width="120px",e.style.height="28px",e.style.overflow="hidden",e.style.cursor="pointer",e.style.position="relative",w.appendChild(e),e.appendChild(p.importButton);let t=document.createElement("button");t.innerHTML="<img style='float:left' height='20' src='"+n(dt)+"' alt='icon'/>"+ce("file-import"),t.tabIndex=-1,$.css(t,{width:"120px",display:"box",position:"absolute",left:"0",top:"0",cursor:"pointer"}),$.css(p.importButton,{display:"none"}),w.appendChild(t),t.onclick=function(){p.importButton.click()}}(),this.importButton.onchange=function(e){o(p.importButton.files,"default"),p.importButton.value=""},b=$.el({css:{fontSize:"15px",marginLeft:"10px",marginTop:"10px",cssFloat:"left",width:"calc(50% - 15px)",height:"30px"}}),v=new si.Select({optionArr:[["png",ce("file-save-png")],["psd",ce("file-save-psd")],["layers",ce("file-save-layers")]],initValue:r,onChange:function(e){a(r=e),s()}}),$.css(v.getElement(),{width:"120px",height:"30px"}),b.appendChild(v.getElement()),g.onclick=l,m.onclick=function(){s()},f.onclick=function(){f.disabled=!0,"function"==typeof h&&h((()=>{f.disabled=!1}))},y.onclick=function(){c()},x.onclick=function(){x.blur(),d()};let C=document.createElement("div");function S(){let e=document.createElement("div"),t=document.createElement("div"),n=document.createElement("div");return e.appendChild(t),e.appendChild(n),$.css(t,{clear:"both"}),$.css(n,{marginLeft:"10px",marginRight:"10px",marginTop:"10px",borderBottom:"1px solid rgba(0,0,0,0.2)",clear:"both"}),e}C.textContent="⚠️ "+ce("file-no-autosave"),$.css(C,{textAlign:"center",marginTop:"10px",background:"rgb(243, 243, 161)",padding:"5px 0px",color:"rgba(0,0,0,0.65)",fontSize:"15px"}),t&&(p.fileBrowserStorage=new Gn(t,i,u),$.css(p.fileBrowserStorage.getElement(),{margin:"10px"})),$.append(e,[C,g,w,$.el({css:{clear:"both"}}),m,b,$.el({css:{clear:"both"}}),x,"function"==typeof h&&$.canShareFiles()?f:null,$.el({css:{clear:"both"}}),S(),p.fileBrowserStorage?p.fileBrowserStorage.getElement():null,p.fileBrowserStorage?S():null,y]),this.div.appendChild(e)}),1)}},FilterTab:class{init(){const e=this;let t=$.hasWebGl(),n=si.filterLib,i=[];if($.BbLog.emit({type:"init-filters"}),!si.filterLibStatus.isLoaded)throw new Error("filters not loaded");function r(t,n){let r=document.createElement("button"),a=n[t].buttonLabel?n[t].buttonLabel:n[t].name,o='<img height="20" width="18" src="'+n[t].icon+'" alt="icon" />';return r.innerHTML=o+a,r.className="gridButton",$.css(r,{lineHeight:"20px",fontSize:"12px"}),r.tabIndex=-1,r.onclick=function(){if("apply"in n[t])if(n[t].isInstant)r.blur(),i(null),e.statusOverlay.out('"'+n[t].name+'" '+ce("filter-applied"),!0);else{let r,a=e.klColorSlider.getSecondaryRGB(),o=n[t].getDialog({context:e.getCurrentLayerCtx(),canvas:e.getKlCanvas(),maxWidth:e.getKlMaxCanvasSize(),maxHeight:e.getKlMaxCanvasSize(),bbox:e.klApp.getBBox(),currentColorRgb:{r:e.getCurrentColor().r,g:e.getCurrentColor().g,b:e.getCurrentColor().b},secondaryColorRgb:{r:a.r,g:a.g,b:a.b}});if(!o)return;o.errorCallback=function(e){setTimeout((function(){throw alert("Error: could not perform action"),e}),0),r()};let s={};"width"in o&&(s.width=o.width+"px"),si.popup({target:e.klApp.getEl(),message:"<b>"+n[t].name+"</b>",div:o.element,style:s,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){!function(e,r){if("Cancel"==e)return void(r.destroy&&r.destroy());let a;try{a=r.getInput()}catch(e){throw-1!==e.message.indexOf(".getInput is not a function")?"filterDialog.getInput is not a function, filter: "+n[t].name:e}i(a)}(e,o)},closefunc:function(e){r=e}})}else alert("Application not fully loaded");function i(i){!1===n[t].apply({context:e.getCurrentLayerCtx(),canvas:e.getKlCanvas(),history:te,input:i})&&alert("Couldn't apply the edit action"),!0===n[t].updateContext&&e.setCurrentLayer(e.getKlCanvas().getLayer(e.layerManager.getSelected())),!0===n[t].updatePos&&(e.klCanvasWorkspace.resetView(),e.handUi.update(e.klCanvasWorkspace.getScale(),e.klCanvasWorkspace.getAngleDeg())),e.layerManager.update()}},i[i.length]=r,r}function a(e,t){if(!t[e].webgl&&!t[e].ieFails)return;if(t[e].ieFails&&"Microsoft Internet Explorer"!==navigator.appName)return;let n=t[e].buttonLabel?t[e].buttonLabel:t[e].name,i=document.createElement("button"),r='<img style="opacity: 0.5" src="img/'+t[e].icon+'" />',a=t[e].name;return a.length>11&&(a="<span style='font-size: 12px'>"+n+"</span>"),i.innerHTML=r+a,i.className="gridButton",i.disabled=!0,i}function o(n,i,o){for(let s in i)!i.hasOwnProperty[s]&&n.includes(s)&&(e.isEmbed&&!i[s].inEmbed||(i[s].webgl&&t||i[s].neededWithWebGL||!i[s].webgl&&!t&&(!i[s].ieFails||"Microsoft Internet Explorer"!=navigator.appName)?o.appendChild(r(s,i)):(o.appendChild(a(s,i)),i[s]=void 0)))}let s=["cropExtend","flip","glPerspective","resize","rotate","transform"],l=[];for(let e in n)n.hasOwnProperty[e]||s.includes(e)||l.push(e);o(s,n,e.div);let h=document.createElement("div");if(h.className="gridHr",e.div.appendChild(h),o(l,n,e.div),!t){let t=$.appendTextDiv(e.div,"Some actions are disabled because WebGL isn't working.");t.style.margin="10px",$.css(t,{fontSize:"11px",color:"#555",background:"#ffe",padding:"10px",borderRadius:"10px",textAlign:"center"})}this.isInit=!0}getElement(){return this.div}show(){this.isInit||this.init(),this.div.style.display="block"}hide(){this.div.style.display="none"}constructor(e,t,n,i,r,a,o,s,l,h,c,d){this.klApp=e,this.klColorSlider=t,this.layerManager=n,this.setCurrentLayer=i,this.klCanvasWorkspace=r,this.handUi=a,this.getCurrentColor=o,this.getKlMaxCanvasSize=s,this.getKlCanvas=l,this.getCurrentLayerCtx=h,this.isEmbed=c,this.statusOverlay=d,this.isInit=!1,this.div=document.createElement("div")}},SettingsTab:class{getElement(){return this.el}constructor(e,t,i){const r=he.getLanguage();this.el=$.el({content:`\n${ce("settings-language")}: ${r.name} (${r.code})\n            `,css:{margin:"10px"}});const o=$.el({content:ce("settings-preferred-language")+":<br>",css:{marginTop:"10px"}}),s=[["auto",ce("auto")]].concat(oe.map((e=>[e.code,e.name+` (${e.code})`]))),l=new si.Select({initValue:J.getItem("klecks-language")?J.getItem("klecks-language"):"auto",optionArr:s,onChange:e=>{"auto"===e?J.removeItem("klecks-language"):J.setItem("klecks-language",e),h.style.display="block"}}),h=$.el({content:ce("settings-language-reload"),css:{display:"none",marginTop:"5px"}});function c(){return $.el({tagName:"a",content:ce("licenses"),onClick:()=>{a("hROkz").then((e=>{new ue({target:i,title:$.el({content:ce("licenses")}),content:$.el({content:$.el({content:e.licenses.replace(/\n/g,"<br>"),css:{padding:"20px"}}),css:{height:"100%",overflowY:"scroll"}}),width:800,isMaxHeight:!0})}))}})}if(o.append(l.getElement(),h),this.el.append(o),$.el({tagName:"button",parent:this.el,content:'<img height="20" width="18" src="'+n(oi)+'" alt="icon" style="margin-right: 5px"/>'+ce("switch-ui-left-right"),onClick:()=>e(),css:{marginTop:"20px"},custom:{tabIndex:"-1"}}),this.el.append($.el({className:"gridHr",css:{margin:"10px 0"}})),t){if(this.el.append(t),!t.innerHTML){$.el({parent:t,css:{textAlign:"center"}}).append($.el({content:`<img alt="icon" height="20" style="vertical-align:middle" src="${n(ai)}"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a> © 2022<br>`}),c())}}else{$.el({parent:this.el,css:{textAlign:"center"},content:`\n<img alt="Klecks" height="25" src="${n(ht)}"><br>\n<img alt="icon" height="20" style="vertical-align:middle" src="${n(ai)}"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a> © 2022<br>`}).append(c(),document.createTextNode(" | "),$.el({tagName:"a",content:ce("donate"),custom:{href:"https://kleki.com/donate/",target:"_blank"}}),document.createTextNode(" | "),$.el({tagName:"a",content:ce("source-code"),custom:{href:"https://klecks.org",target:"_blank"}}))}window.addEventListener("storage",(e=>{"klecks-language"===e.key&&l.setValue(J.getItem("klecks-language")?J.getItem("klecks-language"):"auto")}))}},klLayerManager:function(e,t,i){let r,a=e,o=[],s=t,l="right",h=$.el({onClick:$.handleClick,css:{position:"absolute",right:"280px",top:"500px",background:"#aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",pointerEvents:"none",padding:"0",border:"1px solid #aaa",transition:"opacity 0.3s ease-out",userSelect:"none",colorScheme:"only light"}});$.createCheckerDataUrl(4,(function(e){h.style.backgroundImage="url("+e+")"}));let c,d,u=$.canvas(200,200);u.style.display="block",h.appendChild(u);let p=!1,g=a.getLayers(),m=g.length-1,f=document.createElement("div");f.style.marginRight="10px",f.style.marginBottom="10px",f.style.marginLeft="10px",f.style.marginTop="10px",f.style.cursor="default";let y=document.createElement("div");function x(e){let t=document.createElement("div"),r=$.el({content:ce("layers-rename-name")+":",css:{marginRight:"5px"}});const o=$.el({css:{display:"flex"}});let l=document.createElement("input");l.value=a.getLayer(e).name,l.setAttribute("data-ignore-focus","true");const h=$.el({tagName:"Button",content:'<img src="'+n(Oe)+'" height="20"/>',title:ce("layers-rename-clear"),css:{marginLeft:"10px"},onClick:()=>{l.value="",l.focus()}}),c=[ce("layers-rename-sketch"),ce("layers-rename-colors"),ce("layers-rename-lines"),ce("background"),ce("layers-rename-foreground")],d=[],u=$.el({css:{display:"flex",flexWrap:"wrap",marginTop:"5px",marginLeft:"-5px"}});c.forEach((e=>{const t=$.el({parent:u,tagName:"Button",content:e,onClick:()=>{l.value=t.textContent},css:{margin:"5px 0 0 5px"}});d.push(t)})),t.appendChild(r),r.append(o,u),o.append(l,h),setTimeout((function(){l.focus(),l.select()}),10),de({target:i,message:`<b>${ce("layers-rename-title")}</b>`,div:t,buttons:[ce("layers-rename"),"Cancel"],primaries:[ce("layers-rename")],callback:function(t){if($.destroyEl(h),d.forEach((e=>{$.destroyEl(e)})),d.splice(0,d.length),t===ce("layers-rename")){if(l.value===a.getLayer(e).name)return;a.renameLayer(e,l.value),I(),te.pause(!0),s(e),te.pause(!1)}},clickOnEnter:ce("layers-rename")})}$.css(y,{width:"250px",position:"relative"});let b=$.el({});f.disableButtons=function(){},f.enableButtons=function(){};let v,w,C=document.createElement("button"),S=document.createElement("button"),E=document.createElement("button"),M=document.createElement("button"),k=document.createElement("button");function I(){function e(e){let t=a.getLayer(e).name,n=g[e].opacity,r=g[e].context.canvas,l=document.createElement("div");l.className="layerBox",o[e]=l,l.posY=35*(g.length-1)-35*e,$.css(l,{width:"250px",height:"34px",backgroundColor:"rgb( 220, 220, 220)",border:"1px solid #aaa",position:"absolute",left:"0 px",top:l.posY+"px",transition:"all 0.1s linear",borderRadius:"5px",boxSizing:"border-box"});let y=document.createElement("div");$.css(y,{position:"relative"});let v=document.createElement("div");$.css(v,{width:"250px",height:"34px"});let w,C=document.createElement("div");l.appendChild(y),y.appendChild(v),y.appendChild(C),l.spot=e;{let e=$.fitInto(r.width,r.height,30,30,1),t=l.thumb=$.canvas(e.width,e.height),n=t.getContext("2d");n.save(),t.width>r.width&&(n.imageSmoothingEnabled=!1),n.drawImage(r,0,0,t.width,t.height),n.restore(),$.css(l.thumb,{position:"absolute",left:(32-l.thumb.width)/2+"px",top:(32-l.thumb.height)/2+"px",colorScheme:"only light"}),$.createCheckerDataUrl(4,(function(e){t.style.backgroundImage="url("+e+")"}))}l.label=document.createElement("div"),l.lname=t,l.label.append(l.lname),$.css(l.label,{position:"absolute",left:"38px",top:"1px",fontSize:"13px",width:"170px",height:"20px",overflow:"hidden",color:"#666",whiteSpace:"nowrap"}),l.label.ondblclick=function(){x(l.spot)},l.opacityLabel=document.createElement("div"),l.opacity=n,l.opacityLabel.append(parseInt(""+100*l.opacity)+"%"),$.css(l.opacityLabel,{position:"absolute",left:"194px",top:"1px",fontSize:"13px",textAlign:"right",width:"50px",color:"#666",transition:"color 0.2s ease-in-out"});let S=new ke({init:l.opacity,width:204,pointSize:14,callback:function(e,t,n){return t?(w=a.getLayer(l.spot).opacity,void te.pause(!0)):n?(te.pause(!1),void(w!==e&&a.layerOpacity(l.spot,e))):(l.opacityLabel.innerHTML=Math.round(100*e)+"%",void a.layerOpacity(l.spot,e))}});$.css(S.getEl(),{position:"absolute",left:"39px",top:"17px"}),l.opacitySlider=S,$.setEventListener(l.thumb,"onpointerover",(function(e){if(0!==e.buttons&&(!e.pointerType||"touch"!==e.pointerType))return;let t=$.fitInto(r.width,r.height,250,250,1);u.width===t.width&&u.height===t.height||(u.width=t.width,u.height=t.height);let n=u.getContext("2d");n.save(),u.width>r.width&&(n.imageSmoothingEnabled=!1),n.imageSmoothingQuality="high",n.clearRect(0,0,u.width,u.height),n.drawImage(r,0,0,u.width,u.height),n.restore(),$.css(h,{top:e.clientY-u.height/2+"px",opacity:"0"}),!1===p&&(i.appendChild(h),p=!0),clearTimeout(d),d=setTimeout((function(){$.css(h,{opacity:"1"})}),20),clearTimeout(c)})),$.setEventListener(l.thumb,"onpointerout",(function(){clearTimeout(d),$.css(h,{opacity:"0"}),clearTimeout(c),c=setTimeout((function(){p&&(i.removeChild(h),p=!1)}),300)})),v.appendChild(l.thumb),v.appendChild(l.label),v.appendChild(l.opacityLabel),v.appendChild(S.getEl());let M=!1,k=!1;l.pointerListener=new $.PointerListener({target:v,maxPointers:1,onPointer:function(e){if("pointerdown"===e.type&&"left"===e.button)$.css(l,{transition:"box-shadow 0.3s ease-in-out"}),l.style.zIndex="1",L=l.spot,k=!1,l.isSelected||(k=!0,f.activateLayer(l.spot)),M=!0;else if("pointermove"===e.type&&"left"===e.button){M&&(M=!1,$.css(l,{boxShadow:"1px 3px 5px rgba(0,0,0,0.4)"})),l.posY+=e.dY;let t=Math.max(0,Math.min(35*(g.length-1),l.posY));l.style.top=t+"px",function(e,t){if((t=Math.min(g.length-1,Math.max(0,t)))===L)return;for(let n=0;n<g.length;n++){if(o[n].spot===e)continue;let i=o[n].spot;o[n].spot>e&&i--,i>=t&&i++,o[n].posY=35*(g.length-i-1),o[n].style.top=o[n].posY+"px"}L=t}(l.spot,T(l.posY))}if("pointerup"===e.type){$.css(l,{transition:"all 0.1s linear"}),setTimeout((function(){$.css(l,{boxShadow:""})}),20),l.posY=Math.max(0,Math.min(35*(g.length-1),l.posY)),l.style.zIndex="";let e=T(l.posY),t=l.spot;!function(e,t){if(isNaN(e)||isNaN(t))throw"layermanager - invalid move";for(let n=0;n<g.length;n++)!function(n){let i=o[n].spot;o[n].spot===e?i=t:(o[n].spot>e&&i--,i>=t&&i++),o[n].spot=i,o[n].posY=35*(g.length-i-1),o[n].style.top=o[n].posY+"px"}(n);if(e===t)return;a.moveLayer(m,t-e),g=a.getLayers(),m=t,E.disabled=0===m}(l.spot,e),t!=e&&(te.pause(!0),s(m),te.pause(!1)),t===e&&k&&s(m),k=!1}}}),b.appendChild(l)}for(r=te.getState(),o=[];b.firstChild;){let e=b.firstChild;e.pointerListener.destroy(),e.opacitySlider.destroy(),b.removeChild(e)}for(let t=0;t<g.length;t++)e(t);f.activateLayer(m),b.style.height=35*o.length+"px"}function T(e){let t=parseInt(""+(e/35+.5));return t=Math.min(g.length-1,Math.max(0,t)),t=g.length-t-1,t}f.appendChild(function(){let e=document.createElement("div");return setTimeout((function(){$.makeUnfocusable(C),$.makeUnfocusable(S),$.makeUnfocusable(E),$.makeUnfocusable(M),$.makeUnfocusable(k),C.style.cssFloat="left",S.style.cssFloat="left",E.style.cssFloat="left",M.style.cssFloat="left",k.style.cssFloat="left",C.title=ce("layers-new"),S.title=ce("layers-duplicate"),M.title=ce("layers-remove"),E.title=ce("layers-merge"),k.title=ce("layers-rename-title"),C.style.paddingLeft="5px",C.style.paddingRight="3px",M.style.paddingLeft="5px",M.style.paddingRight="3px",S.style.paddingLeft="5px",S.style.paddingRight="3px",E.style.paddingLeft="5px",E.style.paddingRight="3px",k.style.height="30px",k.style.lineHeight="20px",C.innerHTML="<img src='"+n(Ae)+"' height='20'/>",S.innerHTML="<img src='"+n(Pe)+"' height='20'/>",E.innerHTML="<img src='"+n(De)+"' height='20'/>",M.innerHTML="<img src='"+n(Oe)+"' height='20'/>",k.innerHTML="<img src='"+n(Be)+"' height='20'/>",C.style.marginRight="5px",M.style.marginRight="5px",S.style.marginRight="5px",E.style.marginRight="5px",e.appendChild(C),e.appendChild(M),e.appendChild(S),e.appendChild(E),e.appendChild(k),e.appendChild($.el({css:{clear:"both"}}));let t=document.createElement("div");t.style.clear="both",t.style.height="10px",e.appendChild(t),C.onclick=function(){!1!==a.addLayer(m)&&(g=a.getLayers(),16===g.length&&(C.disabled=!0,S.disabled=!0),M.disabled=!1,m+=1,I(),te.pause(!0),s(m),te.pause(!1))},S.onclick=function(){!1!==a.duplicateLayer(m)&&(g=a.getLayers(),16===g.length&&(C.disabled=!0,S.disabled=!0),M.disabled=!1,m++,I(),te.pause(!0),s(m),te.pause(!1))},M.onclick=function(){o.length<=1||(a.removeLayer(m),m>0&&m--,g=a.getLayers(),I(),te.pause(!0),s(m),te.pause(!1),1===g.length&&(M.disabled=!0),g.length<16&&(C.disabled=!1,S.disabled=!1))},E.onclick=function(){m<=0||function(e){let t=document.createElement("div");t.innerHTML=ce("layers-merge-description");let n=new Te({optionArr:[{id:e.mixModeStr,label:We(e.mixModeStr)},{id:"source-in",label:"source-in"},{id:"source-out",label:"source-out"},{id:"source-atop",label:"source-atop"},{id:"destination-in",label:"destination-in"},{id:"destination-out",label:"destination-out"},{id:"destination-atop",label:"destination-atop"},{id:"xor",label:"xor"}],initId:e.mixModeStr,onChange:function(e){l()},isSmall:!0});n.getElement().style.marginTop="5px",t.appendChild(n.getElement());const r=$.fitInto(e.topCanvas.width,e.topCanvas.height,200,200,1);let a=$.canvas(r.width,r.height);a.title=ce("preview");let o=document.createElement("div");o.innerHTML="<br/>",o.style.clear="both",t.appendChild(o),t.appendChild(a),$.css(a,{display:"block",marginLeft:"auto",marginRight:"auto",colorScheme:"only light"}),a.style.boxShadow="0 0 3px rgba(0,0,0,0.5)",$.createCheckerDataUrl(4,(function(e){a.style.backgroundImage="url("+e+")"}));let s=$.copyCanvas(a);function l(){let t=a.getContext("2d");t.save(),t.clearRect(0,0,a.width,a.height),a.width>e.topCanvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.bottomCanvas,0,0,a.width,a.height),"as-alpha"===n.getValue()?(t.globalCompositeOperation="destination-in",t.globalAlpha=e.topOpacity,t.drawImage(s,0,0,a.width,a.height)):(t.globalCompositeOperation=n.getValue(),t.globalAlpha=e.topOpacity,t.drawImage(e.topCanvas,0,0,a.width,a.height)),t.restore()}s.getContext("2d").drawImage(e.topCanvas,0,0,s.width,s.height),$.convertToAlphaChannelCanvas(s),l();let h=new $.KeyListener({onDown:function(e){"right"===e&&n.next(),"left"===e&&n.previous()}});de({target:i,message:`<b>${ce("layers-merge-modal-title")}</b>`,div:t,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(t){h.destroy(),n.destroy(),"Ok"===t&&e.callback(n.getValue())}})}({topCanvas:g[m].context.canvas,bottomCanvas:g[m-1].context.canvas,topOpacity:a.getLayer(m).opacity,mixModeStr:g[m].mixModeStr,callback:function(e){a.mergeLayers(m,m-1,e),g=a.getLayers(),m--,1===g.length&&(M.disabled=!0),g.length<16&&(C.disabled=!1,S.disabled=!1),I(),te.pause(!0),s(m),te.pause(!1)}})},k.onclick=function(){x(m)}}),1),e}()),v=$.el({content:ce("layers-blending")+"&nbsp;",css:{fontSize:"15px"}}),w=new me({optionArr:["source-over",null,"darken","multiply","color-burn",null,"lighten","screen","color-dodge",null,"overlay","soft-light","hard-light",null,"difference","exclusion",null,"hue","saturation","color","luminosity"].map((e=>e?[e,We(e)]:null)),onChange:function(e){a.setMixMode(m,e),f.update(m)},css:{marginBottom:"10px"}}),v.appendChild(w.getElement()),f.appendChild(v),y.appendChild(b),f.appendChild(y);let L=0;return setInterval((function(){if("block"!==f.style.display)return;let e=te.getState();if(e!==r){r=e;for(let e=0;e<o.length;e++)if(m===o[e].spot&&g[o[e].spot]){let t=o[e].thumb.getContext("2d");t.save(),t.clearRect(0,0,t.canvas.width,t.canvas.height),g[o[e].spot].context.canvas.width<o[e].thumb.width&&(t.imageSmoothingEnabled=!1),t.drawImage(g[o[e].spot].context.canvas,0,0,o[e].thumb.width,o[e].thumb.height),t.restore()}}}),1),f.update=function(e){g=a.getLayers(),(e||0===e)&&(m=e),M.disabled=1===g.length,16===g.length?(C.disabled=!0,S.disabled=!0):(C.disabled=!1,S.disabled=!1),setTimeout((function(){I()}),1)},f.getSelected=function(){return m},f.activateLayer=function(e){if(e<0||e>o.length-1)throw"invalid spotIndex "+e+", layerElArr.length "+o.length;m=e,w.setValue(g[m].mixModeStr);for(let e=0;e<o.length;e++)m===o[e].spot?(o[e].style.backgroundColor="rgb( 250, 250, 250)",o[e].label.style.color="#000",o[e].style.boxShadow="",o[e].style.border="1px solid var(--active-highlight-color)",o[e].opacitySlider.setActive(!0),o[e].isSelected=!0):(o[e].style.backgroundColor="rgb( 220, 220, 220)",o[e].label.style.color="#666",o[e].style.boxShadow="",o[e].style.border="1px solid rgb(158, 158, 158)",o[e].opacitySlider.setActive(!1),o[e].isSelected=!1);E.disabled=0===m},f.setUiState=function(e){l=""+e,"left"===l?$.css(h,{left:"280px",right:""}):$.css(h,{left:"",right:"280px"})},I(),f},klHistory:te,DecoyKlHistory:ee};class li{getElement(){return this.el}constructor(e){let t=document.createElement("div");function i(e){let t=6+(e.extraPadding?e.extraPadding:0),n=$.el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.content?"":e.contain?t+"px 0":""}});if(e.content)n.appendChild(e.content);else{let t=$.el({css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});t.style.pointerEvents="none",n.appendChild(t)}return n.pointerListener=new $.PointerListener({target:n,onEnterLeave:function(e){e?$.addClassName(n,"toolspace-row-button-hover"):$.removeClassName(n,"toolspace-row-button-hover")}}),n}this.el=t,$.css(t,{height:"36px",display:"flex",backgroundImage:"linear-gradient(to top, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.6) 100%)"});let r=i({onClick:e.onSubmit,title:ce("submit-title"),content:$.el({content:ce("submit"),className:"toolspace-row-button__submit",css:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}}),contain:!0});r.style.width="45px";let a=i({onClick:e.onHelp,title:ce("help"),image:n(gt),contain:!0}),o=i({onClick:e.onLeftRight,title:ce("switch-ui-left-right"),image:n(oi),contain:!0});t.appendChild(r),t.appendChild(o),t.appendChild(a)}}const hi=function(){let e={};var t;function n(e,t,n){return Math.max(e,Math.min(t,n))}function i(e){return{_:e,loadContentsOf:function(e){t=this._.gl,this._.loadContentsOf(e)},destroy:function(){t=this._.gl,this._.destroy()}}}function r(e){return i(y.fromElement(e))}function a(e,n){let i=t.UNSIGNED_BYTE;if(t.getExtension("OES_texture_float")&&t.getExtension("OES_texture_float_linear")){let e=new y(100,100,t.RGBA,t.FLOAT);try{e.drawTo((function(){i=t.FLOAT}))}catch(e){}e.destroy()}this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=e,this.height=n,this._.texture=new y(e,n,t.RGBA,i),this._.spareTexture=new y(e,n,t.RGBA,i),this._.extraTexture=this._.extraTexture||new y(0,0,t.RGBA,i),this._.flippedShader=this._.flippedShader||new m(null,"        uniform sampler2D texture;        varying vec2 texCoord;        void main() {            gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));        }    ","flippedShader"),this._.isInitialized=!0}function o(e,t,n){return this._.isInitialized&&e._.width==this.width&&e._.height==this.height||a.call(this,t||e._.width,n||e._.height),e._.use(),this._.texture.drawTo((function(){m.getDefaultShader().drawRect()})),this}function s(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function l(e,t,n,i){(n||this._.texture).use(),this._.spareTexture.drawTo((function(){e.uniforms(t).drawRect()})),this._.spareTexture.swapWith(i||this._.texture)}function h(e){return e.parentNode.insertBefore(this,e),e.parentNode.removeChild(e),this}function c(){let e=new y(this._.texture.width,this._.texture.height,t.RGBA,t.UNSIGNED_BYTE);return this._.texture.use(),e.drawTo((function(){m.getDefaultShader().drawRect()})),i(e)}function d(){let e=this._.texture.width,n=this._.texture.height,i=new Uint8Array(e*n*4);return this._.texture.drawTo((function(){t.readPixels(0,0,e,n,t.RGBA,t.UNSIGNED_BYTE,i)})),i}function u(e){return function(){return t=this._.gl,e.apply(this,arguments)}}function p(e,t,n,i,r,a,o,s){let l=n-r,h=i-a,c=o-r,d=s-a,u=e-n+r-o,p=t-i+a-s,g=l*d-c*h,m=(u*d-c*p)/g,f=(l*p-u*h)/g;return[n-e+m*n,i-t+m*i,m,o-e+f*o,s-t+f*s,f,e,t,1]}function g(e){let t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],h=e[8],c=t*a*h-t*o*l-n*r*h+n*o*s+i*r*l-i*a*s;return[(a*h-o*l)/c,(i*l-n*h)/c,(n*o-i*a)/c,(o*s-r*h)/c,(t*h-i*s)/c,(i*r-t*o)/c,(r*l-a*s)/c,(n*s-t*l)/c,(t*a-n*r)/c]}!function(){function e(){}try{document.createElement("canvas").getContext("experimental-webgl")}catch(e){}if(!t||-1!==t.getSupportedExtensions().indexOf("OES_texture_float_linear"))return;let n,i;(function(e){if(!e.getExtension("OES_texture_float"))return!1;let t=e.createFramebuffer(),n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0);let i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,e.FLOAT,new Float32Array([2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));let r=e.createProgram(),a=e.createShader(e.VERTEX_SHADER),o=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(a,"      attribute vec2 vertex;      void main() {        gl_Position = vec4(vertex, 0.0, 1.0);      }    "),e.shaderSource(o,"      uniform sampler2D texture;      void main() {        gl_FragColor = texture2D(texture, vec2(0.5));      }    "),e.compileShader(a),e.compileShader(o),e.attachShader(r,a),e.attachShader(r,o),e.linkProgram(r);let s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0]),e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);let l=new Uint8Array(4);return e.useProgram(r),e.viewport(0,0,1,1),e.bindTexture(e.TEXTURE_2D,i),e.drawArrays(e.POINTS,0,1),e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,l),127===l[0]||128===l[0]})(t)&&(n=WebGLRenderingContext.prototype.getExtension,i=WebGLRenderingContext.prototype.getSupportedExtensions,WebGLRenderingContext.prototype.getExtension=function(t){return"OES_texture_float_linear"===t?(void 0===(i=this).$OES_texture_float_linear$&&Object.defineProperty(i,"$OES_texture_float_linear$",{enumerable:!1,configurable:!1,writable:!1,value:new e}),i.$OES_texture_float_linear$):n.call(this,t);var i},WebGLRenderingContext.prototype.getSupportedExtensions=function(){let e=i.call(this);return-1===e.indexOf("OES_texture_float_linear")&&e.push("OES_texture_float_linear"),e})}(),e.canvas=function(){let e=document.createElement("canvas");try{t=e.getContext("experimental-webgl",{premultipliedAlpha:!1})}catch(e){t=null}if(!t)throw"This browser does not support WebGL";return e._={gl:t,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},e.texture=u(r),e.draw=u(o),e.update=u(s),e.replace=u(h),e.contents=u(c),e.getPixelArray=u(d),e.brightnessContrast=u(v),e.hexagonalPixelate=u(H),e.hueSaturation=u(E),e.colorHalftone=u(O),e.triangleBlur=u(P),e.unsharpMask=u(I),e.perspective=u(N),e.matrixWarp=u(_),e.bulgePinch=u(j),e.tiltShift=u(A),e.dotScreen=u(B),e.edgeWork=u(z),e.lensBlur=u(R),e.zoomBlur=u(D),e.noise=u(M),e.denoise=u(S),e.curves=u(C),e.swirl=u(U),e.ink=u(F),e.vignette=u(L),e.vibrance=u(T),e.sepia=u(k),e.invert=u(X),e.toAlpha=u(Y),e},e.splineInterpolate=w;var m=function(){function e(e){return"[object Number]"==Object.prototype.toString.call(e)}function n(e,n,i){let r=t.createShader(e);if(t.shaderSource(r,n),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw"compile error: "+i+" - "+t.getShaderInfoLog(r);return r}let i=null;function r(e){let n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,e);return null!==n&&0!==n.precision}function a(e,a,o){if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=t.createProgram(),e=e||"    attribute vec2 vertex;    attribute vec2 _texCoord;    varying vec2 texCoord;    void main() {        texCoord = _texCoord;        gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);    }",a=a||"    uniform sampler2D texture;    varying vec2 texCoord;    void main() {        gl_FragColor = texture2D(texture, texCoord);    }",null===i&&(i=r(t.HIGH_FLOAT)?"highp":r(t.MEDIUM_FLOAT)?"mediump":"lowp"),a="precision "+i+" float;"+a,t.attachShader(this.program,n(t.VERTEX_SHADER,e,o+"(vertex)")),t.attachShader(this.program,n(t.FRAGMENT_SHADER,a,o+"(fragment)")),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))throw"link error: "+t.getProgramInfoLog(this.program)}return a.prototype.destroy=function(){t.deleteProgram(this.program),this.program=null},a.prototype.uniforms=function(n){for(var i in t.useProgram(this.program),n){if(!n.hasOwnProperty(i))continue;let a=t.getUniformLocation(this.program,i);if(null===a)continue;let o=n[i];if(r=o,"[object Array]"==Object.prototype.toString.call(r))switch(o.length){case 1:t.uniform1fv(a,new Float32Array(o));break;case 2:t.uniform2fv(a,new Float32Array(o));break;case 3:t.uniform3fv(a,new Float32Array(o));break;case 4:t.uniform4fv(a,new Float32Array(o));break;case 9:t.uniformMatrix3fv(a,!1,new Float32Array(o));break;case 16:t.uniformMatrix4fv(a,!1,new Float32Array(o));break;default:throw"dont't know how to load uniform \""+i+'" of length '+o.length}else{if(!e(o))throw'attempted to set uniform "'+i+'" to invalid value '+(o||"undefined").toString();t.uniform1f(a,o)}}var r;return this},a.prototype.textures=function(e){for(var n in t.useProgram(this.program),e)e.hasOwnProperty(n)&&t.uniform1i(t.getUniformLocation(this.program,n),e[n]);return this},a.prototype.drawRect=function(e,n,i,r){let a,o=t.getParameter(t.VIEWPORT);n=n!==a?(n-o[1])/o[3]:0,e=e!==a?(e-o[0])/o[2]:0,i=i!==a?(i-o[0])/o[2]:1,r=r!==a?(r-o[1])/o[3]:1,null==t.vertexBuffer&&(t.vertexBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,t.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([e,n,e,r,i,n,i,r]),t.STATIC_DRAW),null==t.texCoordBuffer&&(t.texCoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,t.texCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=t.getAttribLocation(this.program,"vertex"),t.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=t.getAttribLocation(this.program,"_texCoord"),t.enableVertexAttribArray(this.texCoordAttribute)),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,t.vertexBuffer),t.vertexAttribPointer(this.vertexAttribute,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,t.texCoordBuffer),t.vertexAttribPointer(this.texCoordAttribute,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLE_STRIP,0,4)},a.getDefaultShader=function(){return t.defaultShader=t.defaultShader||new a,t.defaultShader},a}();function f(e){let t=e.length;this.xa=[],this.ya=[],this.u=[],this.y2=[],e.sort((function(e,t){return e[0]-t[0]}));for(var n=0;n<t;n++)this.xa.push(e[n][0]),this.ya.push(e[n][1]);this.u[0]=0,this.y2[0]=0;for(n=1;n<t-1;++n){let e=this.xa[n+1]-this.xa[n-1],t=(this.xa[n]-this.xa[n-1])/e,i=t*this.y2[n-1]+2;this.y2[n]=(t-1)/i;let r=(this.ya[n+1]-this.ya[n])/(this.xa[n+1]-this.xa[n])-(this.ya[n]-this.ya[n-1])/(this.xa[n]-this.xa[n-1]);this.u[n]=(6*r/e-t*this.u[n-1])/i}this.y2[t-1]=0;for(n=t-2;n>=0;--n)this.y2[n]=this.y2[n]*this.y2[n+1]+this.u[n]}f.prototype.interpolate=function(e){let t=0,n=this.ya.length-1;for(;n-t>1;){let i=n+t>>1;this.xa[i]>e?n=i:t=i}let i=this.xa[n]-this.xa[t],r=(this.xa[n]-e)/i,a=(e-this.xa[t])/i;return r*this.ya[t]+a*this.ya[n]+((r*r*r-r)*this.y2[t]+(a*a*a-a)*this.y2[n])*(i*i)/6};var y=function(){function e(e,n,i,r){this.gl=t,this.id=t.createTexture(),this.width=e,this.height=n,this.format=i,this.type=r,t.bindTexture(t.TEXTURE_2D,this.id),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e&&n&&t.texImage2D(t.TEXTURE_2D,0,this.format,e,n,0,this.format,this.type,null)}e.fromElement=function(n){let i=new e(0,0,t.RGBA,t.UNSIGNED_BYTE);return i.loadContentsOf(n),i},e.prototype.loadContentsOf=function(e){this.width=e.width||e.videoWidth,this.height=e.height||e.videoHeight,t.bindTexture(t.TEXTURE_2D,this.id),t.texImage2D(t.TEXTURE_2D,0,this.format,this.format,this.type,e)},e.prototype.initFromBytes=function(e,n,i){this.width=e,this.height=n,this.format=t.RGBA,this.type=t.UNSIGNED_BYTE,t.bindTexture(t.TEXTURE_2D,this.id),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,n,0,t.RGBA,this.type,new Uint8Array(i))},e.prototype.destroy=function(){t.deleteTexture(this.id),this.id=null},e.prototype.use=function(e){t.activeTexture(t.TEXTURE0+(e||0)),t.bindTexture(t.TEXTURE_2D,this.id)},e.prototype.unuse=function(e){t.activeTexture(t.TEXTURE0+(e||0)),t.bindTexture(t.TEXTURE_2D,null)},e.prototype.ensureFormat=function(e,n,i,r){if(1==arguments.length){let t=arguments[0];e=t.width,n=t.height,i=t.format,r=t.type}e==this.width&&n==this.height&&i==this.format&&r==this.type||(this.width=e,this.height=n,this.format=i,this.type=r,t.bindTexture(t.TEXTURE_2D,this.id),t.texImage2D(t.TEXTURE_2D,0,this.format,e,n,0,this.format,this.type,null))},e.prototype.drawTo=function(e){if(t.framebuffer=t.framebuffer||t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,t.framebuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.id,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");t.viewport(0,0,this.width,this.height),e(),t.bindFramebuffer(t.FRAMEBUFFER,null)};let n=null;function i(e){null==n&&(n=document.createElement("canvas")),n.width=e.width,n.height=e.height;let t=n.getContext("2d");return t.clearRect(0,0,n.width,n.height),t}return e.prototype.fillUsingCanvas=function(e){return e(i(this)),this.format=t.RGBA,this.type=t.UNSIGNED_BYTE,t.bindTexture(t.TEXTURE_2D,this.id),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),this},e.prototype.toImage=function(e){this.use(),m.getDefaultShader().drawRect();let r=this.width*this.height*4,a=new Uint8Array(r),o=i(this),s=o.createImageData(this.width,this.height);t.readPixels(0,0,this.width,this.height,t.RGBA,t.UNSIGNED_BYTE,a);for(var l=0;l<r;l++)s.data[l]=a[l];o.putImageData(s,0,0),e.src=n.toDataURL()},e.prototype.swapWith=function(e){let t;t=e.id,e.id=this.id,this.id=t,t=e.width,e.width=this.width,this.width=t,t=e.height,e.height=this.height,this.height=t,t=e.format,e.format=this.format,this.format=t},e}();function x(e,t){return new m(null,e+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {        vec2 coord = texCoord * texSize;        "+t+"        gl_FragColor = texture2D(texture, coord / texSize);        vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);        if (coord != clampedCoord) {            /* fade to transparent if we are outside the image */            gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));        }    }","warp")}var b="    float random(vec3 scale, float seed) {        /* use the fragment position for a different seed per-pixel */        return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);    }";function v(e,i){return t.brightnessContrast=t.brightnessContrast||new m(null,"        uniform sampler2D texture;        uniform float brightness;        uniform float contrast;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.rgb += brightness;            if (contrast > 0.0) {                color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;            } else {                color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;            }            gl_FragColor = color;        }    ","brightnessContrast"),l.call(this,t.brightnessContrast,{brightness:n(-1,e,1),contrast:n(-1,i,1)}),this}function w(e){let t=new f(e),i=[];for(var r=0;r<256;r++)i.push(n(0,Math.floor(256*t.interpolate(r/255)),255));return i}function C(e,n,i){e=w(e),1==arguments.length?n=i=e:(n=w(n),i=w(i));let r=[];for(var a=0;a<256;a++)r.splice(r.length,0,e[a],n[a],i[a],255);return this._.extraTexture.initFromBytes(256,1,r),this._.extraTexture.use(1),t.curves=t.curves||new m(null,"        uniform sampler2D texture;        uniform sampler2D map;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.r = texture2D(map, vec2(color.r)).r;            color.g = texture2D(map, vec2(color.g)).g;            color.b = texture2D(map, vec2(color.b)).b;            gl_FragColor = color;        }    ","curves"),t.curves.textures({map:1}),l.call(this,t.curves,{}),this}function S(e){t.denoise=t.denoise||new m(null,"        uniform sampler2D texture;        uniform float exponent;        uniform float strength;        uniform vec2 texSize;        varying vec2 texCoord;        void main() {            vec4 center = texture2D(texture, texCoord);            vec4 color = vec4(0.0);            float total = 0.0;            for (float x = -4.0; x <= 4.0; x += 1.0) {                for (float y = -4.0; y <= 4.0; y += 1.0) {                    vec4 sample = texture2D(texture, texCoord + vec2(x, y) / texSize);                    float weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));                    weight = pow(weight, exponent);                    color += sample * weight;                    total += weight;                }            }            gl_FragColor = color / total;        }    ","denoise");for(var n=0;n<2;n++)l.call(this,t.denoise,{exponent:Math.max(0,e),texSize:[this.width,this.height]});return this}function E(e,i){return t.hueSaturation=t.hueSaturation||new m(null,"        uniform sampler2D texture;        uniform float hue;        uniform float saturation;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */            float angle = hue * 3.14159265;            float s = sin(angle), c = cos(angle);            vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;            float len = length(color.rgb);            color.rgb = vec3(                dot(color.rgb, weights.xyz),                dot(color.rgb, weights.zxy),                dot(color.rgb, weights.yzx)            );                        /* saturation adjustment */            float average = (color.r + color.g + color.b) / 3.0;            if (saturation > 0.0) {                color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));            } else {                color.rgb += (average - color.rgb) * (-saturation);            }                        gl_FragColor = color;        }    ","hueSaturation"),l.call(this,t.hueSaturation,{hue:n(-1,e,1),saturation:n(-1,i,1)}),this}function M(e){return t.noise=t.noise||new m(null,"        uniform sampler2D texture;        uniform float amount;        varying vec2 texCoord;        float rand(vec2 co) {            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);        }        void main() {            vec4 color = texture2D(texture, texCoord);                        float diff = (rand(texCoord) - 0.5) * amount;            color.r += diff;            color.g += diff;            color.b += diff;                        gl_FragColor = color;        }    ","noise"),l.call(this,t.noise,{amount:n(0,e,1)}),this}function k(e){return t.sepia=t.sepia||new m(null,"        uniform sampler2D texture;        uniform float amount;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            float r = color.r;            float g = color.g;            float b = color.b;                        color.r = min(1.0, (r * (1.0 - (0.607 * amount))) + (g * (0.769 * amount)) + (b * (0.189 * amount)));            color.g = min(1.0, (r * 0.349 * amount) + (g * (1.0 - (0.314 * amount))) + (b * 0.168 * amount));            color.b = min(1.0, (r * 0.272 * amount) + (g * 0.534 * amount) + (b * (1.0 - (0.869 * amount))));                        gl_FragColor = color;        }    ","sepia"),l.call(this,t.sepia,{amount:n(0,e,1)}),this}function I(e,n){return t.unsharpMask=t.unsharpMask||new m(null,"        uniform sampler2D blurredTexture;        uniform sampler2D originalTexture;        uniform float strength;        uniform float threshold;        varying vec2 texCoord;        void main() {            vec4 blurred = texture2D(blurredTexture, texCoord);            vec4 original = texture2D(originalTexture, texCoord);            gl_FragColor = mix(blurred, original, 1.0 + strength);        }    ","unsharpMask"),this._.extraTexture.ensureFormat(this._.texture),this._.texture.use(),this._.extraTexture.drawTo((function(){m.getDefaultShader().drawRect()})),this._.extraTexture.use(1),this.triangleBlur(e),t.unsharpMask.textures({originalTexture:1}),l.call(this,t.unsharpMask,{strength:n}),this._.extraTexture.unuse(1),this}function T(e){return t.vibrance=t.vibrance||new m(null,"        uniform sampler2D texture;        uniform float amount;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            float average = (color.r + color.g + color.b) / 3.0;            float mx = max(color.r, max(color.g, color.b));            float amt = (mx - average) * (-amount * 3.0);            color.rgb = mix(color.rgb, vec3(mx), amt);            gl_FragColor = color;        }    ","vibrance"),l.call(this,t.vibrance,{amount:n(-1,e,1)}),this}function L(e,i){return t.vignette=t.vignette||new m(null,"        uniform sampler2D texture;        uniform float size;        uniform float amount;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        float dist = distance(texCoord, vec2(0.5, 0.5));            color.rgb *= smoothstep(0.8, size * 0.799, dist * (amount + size));                        gl_FragColor = color;        }    ","vignette"),l.call(this,t.vignette,{size:n(0,e,1),amount:n(0,i,1)}),this}function R(e,i,r){t.lensBlurPrePass=t.lensBlurPrePass||new m(null,"        uniform sampler2D texture;        uniform float power;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color = pow(color, vec4(power));            gl_FragColor = vec4(color);        }    ","lensBlurPrePass");let a="        uniform sampler2D texture0;        uniform sampler2D texture1;        uniform vec2 delta0;        uniform vec2 delta1;        uniform float power;        varying vec2 texCoord;        "+b+"        vec4 sample(vec2 delta) {            /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(delta, 151.7182), 0.0);                        vec4 color = vec4(0.0);            float total = 0.0;            for (float t = 0.0; t <= 30.0; t++) {                float percent = (t + offset) / 30.0;                color += texture2D(texture0, texCoord + delta * percent);                total += 1.0;            }            return color / total;        }    ";t.lensBlur0=t.lensBlur0||new m(null,a+"        void main() {            gl_FragColor = sample(delta0);        }    ","lensBlur0"),t.lensBlur1=t.lensBlur1||new m(null,a+"        void main() {            gl_FragColor = (sample(delta0) + sample(delta1)) * 0.5;        }    ","lensBlur1"),t.lensBlur2=t.lensBlur2||new m(null,a+"        void main() {            vec4 color = (sample(delta0) + 2.0 * texture2D(texture1, texCoord)) / 3.0;            gl_FragColor = pow(color, vec4(power));        }    ","lensBlur2").textures({texture1:1});let o=[];for(var s=0;s<3;s++){let t=r+s*Math.PI*2/3;o.push([e*Math.sin(t)/this.width,e*Math.cos(t)/this.height])}let h=Math.pow(10,n(-1,i,1));return l.call(this,t.lensBlurPrePass,{power:h}),this._.extraTexture.ensureFormat(this._.texture),l.call(this,t.lensBlur0,{delta0:o[0]},this._.texture,this._.extraTexture),l.call(this,t.lensBlur1,{delta0:o[1],delta1:o[2]},this._.extraTexture,this._.extraTexture),l.call(this,t.lensBlur0,{delta0:o[1]}),this._.extraTexture.use(1),l.call(this,t.lensBlur2,{power:1/h,delta0:o[2]}),this}function A(e,n,i,r,a,o){t.tiltShift=t.tiltShift||new m(null,"        uniform sampler2D texture;        uniform float blurRadius;        uniform float gradientRadius;        uniform vec2 start;        uniform vec2 end;        uniform vec2 delta;        uniform vec2 texSize;        varying vec2 texCoord;        "+b+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));            float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;            for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","tiltShift");let s=i-e,h=r-n,c=Math.sqrt(s*s+h*h);return l.call(this,t.tiltShift,{blurRadius:a,gradientRadius:o,start:[e,n],end:[i,r],delta:[s/c,h/c],texSize:[this.width,this.height]}),l.call(this,t.tiltShift,{blurRadius:a,gradientRadius:o,start:[e,n],end:[i,r],delta:[-h/c,s/c],texSize:[this.width,this.height]}),this}function P(e){return t.triangleBlur=t.triangleBlur||new m(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+b+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta * percent);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","triangleBlur"),l.call(this,t.triangleBlur,{delta:[e/this.width,0]}),l.call(this,t.triangleBlur,{delta:[0,e/this.height]}),this}function D(e,n,i){return t.zoomBlur=t.zoomBlur||new m(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float strength;        uniform vec2 texSize;        varying vec2 texCoord;        "+b+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;            vec2 toCenter = center - texCoord * texSize;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = 0.0; t <= 40.0; t++) {                float percent = (t + offset) / 40.0;                float weight = 4.0 * (percent - percent * percent);                vec4 sample = texture2D(texture, texCoord + toCenter * percent * strength / texSize);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","zoomBlur"),l.call(this,t.zoomBlur,{center:[e,n],strength:i,texSize:[this.width,this.height]}),this}function O(e,n,i,r){return t.colorHalftone=t.colorHalftone||new m(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float angle;        uniform float scale;        uniform vec2 texSize;        varying vec2 texCoord;                float pattern(float angle) {            float s = sin(angle), c = cos(angle);            vec2 tex = texCoord * texSize - center;            vec2 point = vec2(                c * tex.x - s * tex.y,                s * tex.x + c * tex.y            ) * scale;            return (sin(point.x) * sin(point.y)) * 4.0;        }                void main() {            vec4 color = texture2D(texture, texCoord);            vec3 cmy = 1.0 - color.rgb;            float k = min(cmy.x, min(cmy.y, cmy.z));            cmy = (cmy - k) / (1.0 - k);            cmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);            k = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);            gl_FragColor = vec4(1.0 - cmy - k, color.a);        }    ","colorHalftone"),l.call(this,t.colorHalftone,{center:[e,n],angle:i,scale:Math.PI/r,texSize:[this.width,this.height]}),this}function B(e,n,i,r){return t.dotScreen=t.dotScreen||new m(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float angle;        uniform float scale;        uniform vec2 texSize;        varying vec2 texCoord;                float pattern() {            float s = sin(angle), c = cos(angle);            vec2 tex = texCoord * texSize - center;            vec2 point = vec2(                c * tex.x - s * tex.y,                s * tex.x + c * tex.y            ) * scale;            return (sin(point.x) * sin(point.y)) * 4.0;        }                void main() {            vec4 color = texture2D(texture, texCoord);            float average = (color.r + color.g + color.b) / 3.0;            gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);        }    ","dotScreen"),l.call(this,t.dotScreen,{center:[e,n],angle:i,scale:Math.PI/r,texSize:[this.width,this.height]}),this}function z(e){return t.edgeWork1=t.edgeWork1||new m(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+b+"        void main() {            vec2 color = vec2(0.0);            vec2 total = vec2(0.0);                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec3 sample = texture2D(texture, texCoord + delta * percent).rgb;                float average = (sample.r + sample.g + sample.b) / 3.0;                color.x += average * weight;                total.x += weight;                if (abs(t) < 15.0) {                    weight = weight * 2.0 - 1.0;                    color.y += average * weight;                    total.y += weight;                }            }            gl_FragColor = vec4(color / total, 0.0, 1.0);        }    ","edgeWork1"),t.edgeWork2=t.edgeWork2||new m(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+b+"        void main() {            vec2 color = vec2(0.0);            vec2 total = vec2(0.0);                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec2 sample = texture2D(texture, texCoord + delta * percent).xy;                color.x += sample.x * weight;                total.x += weight;                if (abs(t) < 15.0) {                    weight = weight * 2.0 - 1.0;                    color.y += sample.y * weight;                    total.y += weight;                }            }            float c = clamp(10000.0 * (color.y / total.y - color.x / total.x) + 0.5, 0.0, 1.0);            gl_FragColor = vec4(c, c, c, 1.0);        }    ","edgeWork2"),l.call(this,t.edgeWork1,{delta:[e/this.width,0]}),l.call(this,t.edgeWork2,{delta:[0,e/this.height]}),this}function H(e,n,i){return t.hexagonalPixelate=t.hexagonalPixelate||new m(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float scale;        uniform vec2 texSize;        varying vec2 texCoord;        void main() {            vec2 tex = (texCoord * texSize - center) / scale;            tex.y /= 0.866025404;            tex.x -= tex.y * 0.5;                        vec2 a;            if (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));            else a = vec2(ceil(tex.x), ceil(tex.y));            vec2 b = vec2(ceil(tex.x), floor(tex.y));            vec2 c = vec2(floor(tex.x), ceil(tex.y));                        vec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);            vec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);            vec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);            vec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);                        float alen = length(TEX - A);            float blen = length(TEX - B);            float clen = length(TEX - C);                        vec2 choice;            if (alen < blen) {                if (alen < clen) choice = a;                else choice = c;            } else {                if (blen < clen) choice = b;                else choice = c;            }                        choice.x += choice.y * 0.5;            choice.y *= 0.866025404;            choice *= scale / texSize;            gl_FragColor = texture2D(texture, choice + center / texSize);        }    ","hexagonalPixelate"),l.call(this,t.hexagonalPixelate,{center:[e,n],scale:i,texSize:[this.width,this.height]}),this}function F(e){return t.ink=t.ink||new m(null,"        uniform sampler2D texture;        uniform float strength;        uniform vec2 texSize;        varying vec2 texCoord;        void main() {            vec2 dx = vec2(1.0 / texSize.x, 0.0);            vec2 dy = vec2(0.0, 1.0 / texSize.y);            vec4 color = texture2D(texture, texCoord);            float bigTotal = 0.0;            float smallTotal = 0.0;            vec3 bigAverage = vec3(0.0);            vec3 smallAverage = vec3(0.0);            for (float x = -2.0; x <= 2.0; x += 1.0) {                for (float y = -2.0; y <= 2.0; y += 1.0) {                    vec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;                    bigAverage += sample;                    bigTotal += 1.0;                    if (abs(x) + abs(y) < 2.0) {                        smallAverage += sample;                        smallTotal += 1.0;                    }                }            }            vec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);            gl_FragColor = vec4(color.rgb - dot(edge, edge) * strength * 100000.0, color.a);        }    ","ink"),l.call(this,t.ink,{strength:e*e*e*e*e,texSize:[this.width,this.height]}),this}function j(e,i,r,a){return t.bulgePinch=t.bulgePinch||x("        uniform float radius;        uniform float strength;        uniform vec2 center;    ","        coord -= center;        float distance = length(coord);        if (distance < radius) {            float percent = distance / radius;            if (strength > 0.0) {                coord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);            } else {                coord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);            }        }        coord += center;    "),l.call(this,t.bulgePinch,{radius:r,strength:n(-1,a,1),center:[e,i],texSize:[this.width,this.height]}),this}function _(e,n,i){if(t.matrixWarp=t.matrixWarp||x("        uniform mat3 matrix;        uniform bool useTextureSpace;    ","        if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;        vec3 warp = matrix * vec3(coord, 1.0);        coord = warp.xy / warp.z;        if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;    "),4==(e=Array.prototype.concat.apply([],e)).length)e=[e[0],e[1],0,e[2],e[3],0,0,0,1];else if(9!=e.length)throw"can only warp with 2x2 or 3x3 matrix";return l.call(this,t.matrixWarp,{matrix:n?g(e):e,texSize:[this.width,this.height],useTextureSpace:0|i}),this}function N(e,t){let n=p.apply(null,t),i=p.apply(null,e),r=function(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}(g(n),i);return this.matrixWarp(r)}function U(e,n,i,r){return t.swirl=t.swirl||x("        uniform float radius;        uniform float angle;        uniform vec2 center;    ","        coord -= center;        float distance = length(coord);        if (distance < radius) {            float percent = (radius - distance) / radius;            float theta = percent * percent * angle;            float s = sin(theta);            float c = cos(theta);            coord = vec2(                coord.x * c - coord.y * s,                coord.x * s + coord.y * c            );        }        coord += center;    "),l.call(this,t.swirl,{radius:i,center:[e,n],angle:r,texSize:[this.width,this.height]}),this}function X(){return t.invert=t.invert||new m(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        gl_FragColor = vec4(1.0 - color.r, 1.0 - color.g, 1.0 - color.b, color.a);    }","invert"),l.call(this,t.invert,{texSize:[this.width,this.height]}),this}function Y(e,n){return t.toAlpha=t.toAlpha||new m(null,"    uniform bool isInverted;    uniform vec4 replace;    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        float alpha = (color.r + color.g + color.b) / 3.0;        if (isInverted) alpha = 1.0 - alpha;        alpha = min(color.a, alpha);        if (replace.a > 0.0) color = replace;        gl_FragColor = vec4(color.r, color.g, color.b, alpha);    }","toAlpha"),l.call(this,t.toAlpha,{isInverted:e?1:0,replace:n?[n.r/255,n.g/255,n.b/255,n.a]:[0,0,0,0],texSize:[this.width,this.height]}),this}return e}();let ci=null;try{ci=hi.canvas()}catch(e){}function di(){if(!ci||ci._.gl.isContextLost())try{ci=hi.canvas()}catch(e){}return ci}const ui={getDialog(e){let t=document.createElement("div"),n={element:t},i=e.context,r=e.canvas;if(!i||!r)return!1;let a=r.getLayers(),o=r.getLayerIndex(i.canvas),s=$.fitInto(i.canvas.width,i.canvas.height,280,200,1),l=parseInt(""+s.width),h=parseInt(""+s.height),c=$.canvas(l,h);{const e=c.getContext("2d");e.save(),c.width>i.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(i.canvas,0,0,l,h),e.restore()}return setTimeout((function(){let e=0,i=0;t.innerHTML=ce("filter-bright-contrast-description")+"<br/><br/>";let r=di();if(!r)return;let s=r.texture(c);r.draw(s).update();let d=new we({label:ce("filter-bright-contrast-brightness"),width:300,height:30,min:0,max:100,initValue:50*(e+1),eventResMs:60,onChange:function(t){e=t/50-1,r.draw(s).brightnessContrast(e,i).update(),m.render()}}),u=new we({label:ce("filter-bright-contrast-contrast"),width:300,height:30,min:0,max:100,initValue:50*(i+1),eventResMs:60,onChange:function(t){i=t/50-1,r.draw(s).brightnessContrast(e,i).update(),m.render()}});d.getElement().style.marginBottom="10px",t.appendChild(d.getElement()),t.appendChild(u.getElement());let p=document.createElement("div");$.css(p,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let g=[];for(let e=0;e<a.length;e++)g.push({image:e===o?r:a[e].context.canvas,opacity:a[e].opacity,mixModeStr:a[e].mixModeStr});let m=new et({width:parseInt(""+l),height:parseInt(""+h),layers:g}),f=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+l)+"px",height:parseInt(""+h)+"px"}});f.appendChild(m.getElement()),p.appendChild(f),t.appendChild(p);try{r.draw(s).brightnessContrast(e,i).update(),m.render()}catch(e){t.errorCallback(e)}n.destroy=()=>{d.destroy(),u.destroy(),s.destroy()},n.getInput=function(){return n.destroy(),{brightness:e,contrast:i}}}),1),n},apply(e){let t=e.context,n=e.input.brightness,i=e.input.contrast,r=e.history;if(!t||null===n||null===i||!r)return!1;r.pause(!0);let a=di();if(!a)return!1;let o=a.texture(t.canvas);return a.draw(o).brightnessContrast(n,i).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),o.destroy(),r.pause(!1),r.push({tool:["filter","glBrightnessContrast"],action:"apply",params:[{input:e.input}]}),!0}},pi={getDialog(e){const t=e.canvas;if(!t)return!1;const n=$.canvas();{let e=$.fitInto(t.getWidth(),t.getHeight(),560,400,1),i=parseInt(""+e.width),r=parseInt(""+e.height),a=i/t.getWidth();n.width=i,n.height=r,n.style.display="block",n.getContext("2d").drawImage(t.getCompleteCanvas(a),0,0,i,r)}const i=document.createElement("div"),r={element:i};i.innerHTML=ce("filter-crop-description")+"<br/><br/>";let a=0,o=0,s=0,l=0,h=!1,c=!1,d=!1,u=!1;const p=e.maxWidth,g=e.maxHeight;let m;const f=$.el({css:{lineHeight:"30px",height:"35px"}}),y=$.el({css:{lineHeight:"30px",height:"35px"}});i.appendChild(f),i.appendChild(y);const x=ge({init:0,type:"number",min:-t.getWidth(),max:p,css:{width:"75px",marginRight:"20px"},callback:function(e){h=!0,S()}}),b=ge({init:0,type:"number",min:-t.getWidth(),max:p,css:{width:"75px"},callback:function(e){c=!0,S()}}),v=ge({init:0,type:"number",min:-t.getHeight(),max:g,css:{width:"75px",marginRight:"20px"},callback:function(e){d=!0,S()}}),w=ge({init:0,type:"number",min:-t.getHeight(),max:g,css:{width:"75px"},callback:function(e){u=!0,S()}}),C={display:"inline-block",width:"60px"};function S(){a=parseInt(x.value),o=parseInt(b.value),s=parseInt(v.value),l=parseInt(w.value);let e=t.getWidth()+a+o,n=t.getHeight()+s+l;e<=0&&(h&&(a=-t.getWidth()-o+1,x.value=""+a),c&&(o=-t.getWidth()-a+1,b.value=""+o),e=1),e>p&&(h&&(a=-t.getWidth()-o+p,x.value=""+a),c&&(o=-t.getWidth()-a+p,b.value=""+o),e=p),n<=0&&(d&&(s=-t.getHeight()-l+1,v.value=""+s),u&&(l=-t.getHeight()-s+1,w.value=""+l),n=1),n>g&&(d&&(s=-t.getHeight()-l+g,v.value=""+s),u&&(l=-t.getHeight()-s+g,w.value=""+l),n=g),O.setTransform({x:-a,y:-s,width:e,height:n}),h=!1,c=!1,d=!1,u=!1}f.append($.el({content:ce("filter-crop-left")+":",css:C}),x,$.el({content:ce("filter-crop-right")+":",css:C}),b),y.append($.el({content:ce("filter-crop-top")+":",css:C}),v,$.el({content:ce("filter-crop-bottom")+":",css:C}),w);let E=!0,M=new pe({init:!0,label:ce("filter-crop-rule-thirds"),allowTab:!0,callback:function(e){E=e,O.showThirds(E)}});i.appendChild($.el({css:{clear:"both"}}));let k={r:0,g:0,b:0,a:0};const I=[{r:0,g:0,b:0,a:0},{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];I.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),I.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1});const T=new Ie({label:ce("filter-crop-fill"),colorArr:I,onChange:function(e){k=e,function(e){let t;0===e.a?(t="rgba(0,0,0,0.5)",P.style.background="",n.style.background=""):(t=e.r+e.g+e.b<382.5?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)",P.style.background=$.ColorConverter.toRgbStr(e),$.createCheckerDataUrl(parseInt(""+50*m),(function(e){n.style.background="url("+e+")"})));n.style.boxShadow="0 0 3px 1px "+t}(e)}}),L=$.el({css:{display:"flex",justifyContent:"space-between"}});function R(e){const i=$.fitInto(e.width,e.height,260,180,1);m=i.width/e.width;const r=$.centerWithin(340,220,i.width,i.height);n.style.width=t.getWidth()*m+"px",n.style.height=t.getHeight()*m+"px",D.style.left=r.x-e.x*m+"px",D.style.top=r.y-e.y*m+"px",a=parseInt(""+-e.x),s=parseInt(""+-e.y),o=parseInt(""+(e.x+e.width-t.getWidth())),l=parseInt(""+(e.y+e.height-t.getHeight())),x.value=""+a,v.value=""+s,b.value=""+o,w.value=""+l,$.createCheckerDataUrl(parseInt(""+50*m),(function(e){A.style.background="url("+e+")",0!==k.a&&(n.style.background="url("+e+")")})),A.style.backgroundPosition=r.x+"px "+r.y+"px",O.setScale(m)}i.appendChild(L),L.appendChild(M.getElement()),L.appendChild(T.getElement());const A=$.el({css:{width:"340px",marginTop:"10px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",position:"relative",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",userSelect:"none",colorScheme:"only light",touchAction:"none"}});A.oncontextmenu=function(){return!1};const P=$.el({css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"}});A.appendChild(P);const D=document.createElement("div");D.style.position="absolute",D.style.left="0px",D.style.top="0px",A.appendChild(D);$.appendTextDiv(D,"").appendChild(n),n.style.boxShadow="0 0 3px 1px rgba(0,0,0,0.5)",n.style.position="absolute",n.style.left="0px",n.style.top="0px",i.appendChild(A);const O=new lt({x:0,y:0,width:t.getWidth(),height:t.getHeight(),scale:m,callback:R,maxW:p,maxH:g});return R(O.getTransform()),D.appendChild(O.getElement()),r.destroy=()=>{O.destroy(),M.destroy()},r.getInput=function(){return r.destroy(),{left:a,right:o,top:s,bottom:l,fillColor:0===k.a?null:k}},r},apply(e){const t=e.canvas,n=e.history;return!(!t||!n||isNaN(e.input.left)||isNaN(e.input.right)||isNaN(e.input.top)||isNaN(e.input.bottom))&&(n.pause(!0),t.resizeCanvas(e.input),n.pause(!1),n.push({tool:["filter","cropExtend"],action:"apply",params:[{input:JSON.parse(JSON.stringify(e.input))}]}),!0)}},gi={getDialog(e){let t=e.context,n=e.canvas;if(!t||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(t.canvas),a=$.fitInto(t.canvas.width,t.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=$.canvas(o,s);{const e=l.getContext("2d");e.save(),l.width>t.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.canvas,0,0,o,s),e.restore()}let h,c=document.createElement("div"),d={element:c};return setTimeout((function(){t.canvas.width,c.innerHTML=ce("filter-curves-description")+"<br/><br/>";let e={r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]},n=di();if(!n)return;let a,u=n.texture(l);n.draw(u).update();let p=new function(e){let t=document.createElement("div");t.oncontextmenu=function(){return!1},t.style.position="relative",t.style.marginBottom="10px";let n="All",i=e.curves;a=new Te({optionArr:[{id:"All",label:ce("filter-curves-all")},{id:"Red",label:ce("red")},{id:"Green",label:ce("green")},{id:"Blue",label:ce("blue")}],initialId:"All",onChange:function(e){n=e,"All"===n&&(i={r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]});let t=i.r;"Green"===n&&(t=i.g),"Blue"===n&&(t=i.b),p.setPos(0,s-t[0][1]*s),g.setPos(t[1][0]*o,s-t[1][1]*s),m.setPos(t[2][0]*o,s-t[2][1]*s),f.setPos(o,s-t[3][1]*s),y()}}),t.appendChild(a.getElement());let r=document.createElement("div");$.css(r,{position:"relative",marginTop:"10px",colorScheme:"only light"}),t.appendChild(r);let o=300,s=100,l=$.canvas(o,s);$.css(l,{background:"#c6c6c6",boxShadow:"0 0 0 1px rgba(0,0,0,0.3)"});let h=l.getContext("2d");function c(e){return Math.max(0,Math.min(1,e))}function d(e,t,n,i){let a=t,l=e,h=document.createElement("div");return $.css(h,{position:"absolute",left:e-7+"px",top:t-7+"px",width:"14px",height:"14px",background:"#fff",cursor:"move",borderRadius:"14px",boxShadow:"inset 0 0 0 2px #000",userSelect:"none",touchAction:"none"}),h.pointerListener=new $.PointerListener({target:h,maxPointers:1,onPointer:function(r){r.eventPreventDefault(),"pointerdown"===r.type&&(l=e,a=t),"left"===r.button&&"pointermove"===r.type&&(i||(l+=r.dX),e=Math.max(0,Math.min(o,l)),a+=r.dY,t=Math.max(0,Math.min(s,a)),$.css(h,{left:e-7+"px",top:t-7+"px"}),n({x:e,y:t}))}}),r.appendChild(h),h.setPos=function(n,i){a=t=i,l=e=n,$.css(h,{left:e-7+"px",top:t-7+"px"})},h}function u(e,t,r){"All"===n&&(i.r[e]=[c(t/o),c(1-r/s)],i.g[e]=[c(t/o),c(1-r/s)],i.b[e]=[c(t/o),c(1-r/s)]),"Red"===n&&(i.r[e]=[c(t/o),c(1-r/s)]),"Green"===n&&(i.g[e]=[c(t/o),c(1-r/s)]),"Blue"===n&&(i.b[e]=[c(t/o),c(1-r/s)])}r.appendChild(l);let p=d(0,s,(function(e){u(0,e.x,e.y),y()}),!0),g=d(o/3,s/3*2,(function(e){u(1,e.x,e.y),y()})),m=d(o/3*2,s/3,(function(e){u(2,e.x,e.y),y()})),f=d(o,0,(function(e){u(3,e.x,e.y),y()}),!0);function y(){l.width=l.width,h=l.getContext("2d");let t={r:[],g:[],b:[]};for(let e=0;e<i.r.length;e++)t.r.push(i.r[e]),t.g.push(i.g[e]),t.b.push(i.b[e]);function r(e){h.beginPath();let t=new $.SplineInterpolator(e);for(let e=0;e<100;e++){let n=t.interpolate(e/100);n=Math.max(0,Math.min(1,n)),0===e?h.moveTo(e/100*o,s-n*s):h.lineTo(e/100*o,s-n*s)}h.stroke()}h.save(),"All"===n?(h.strokeStyle="black",r(t.r)):(h.globalAlpha=.5,h.strokeStyle="red",r(t.r),h.strokeStyle="green",r(t.g),h.strokeStyle="blue",r(t.b)),h.restore(),e.callback(t)}y(),this.getDiv=function(){return t},this.destroy=function(){p.pointerListener.destroy(),g.pointerListener.destroy(),m.pointerListener.destroy(),f.pointerListener.destroy()}}({curves:e,callback:function(t){e=t,function(){try{n.draw(u).curves(e.r,e.g,e.b).update(),h&&h.render()}catch(e){c.errorCallback(e)}}()}});c.appendChild(p.getDiv());let g=document.createElement("div");$.css(g,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let m=[];for(let e=0;e<i.length;e++)m.push({image:e===r?n:i[e].context.canvas,opacity:i[e].opacity,mixModeStr:i[e].mixModeStr});h=new et({width:parseInt(""+o),height:parseInt(""+s),layers:m});let f=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});f.appendChild(h.getElement()),g.appendChild(f),c.appendChild(g),d.destroy=()=>{p.destroy(),u.destroy(),a.destroy()},d.getInput=function(){return d.destroy(),{curves:e}}}),1),d},apply(e){let t=e.context,n=e.input.curves,i=e.history;if(!t||null===n||!i)return!1;i.pause(!0);let r=di();if(!r)return!1;let a=r.texture(t.canvas);return r.draw(a).curves(n.r,n.g,n.b).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(r,0,0),a.destroy(),i.pause(!1),i.push({tool:["filter","glCurves"],action:"apply",params:[{input:e.input}]}),!0}};var mi;mi=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("3lQWP");const fi={getDialog(e){let t=e.context,i=e.canvas;if(!t||!i)return!1;let r=i.getLayers(),a=i.getLayerIndex(t.canvas),o=$.fitInto(t.canvas.width,t.canvas.height,280,200,1),s=parseInt(""+o.width),l=parseInt(""+o.height),h=document.createElement("div"),c={element:h},d=!0,u=!1,p=!0;h.innerHTML=ce("filter-flip-description")+"<br/><br/>";let g=new pe({init:d,label:ce("filter-flip-horizontal")+" ⟷",allowTab:!0,callback:function(e){d=e,S()},css:{marginBottom:"10px"}}),m=new pe({init:u,label:ce("filter-flip-vertical")+" ↕",allowTab:!0,callback:function(e){u=e,S()},css:{marginBottom:"10px"}});h.appendChild(g.getElement()),h.appendChild(m.getElement());let f=document.createElement("div");$.setEventListener(f,"onpointerdown",(function(){return!1})),f.textContent=ce("filter-flip-image"),f.style.width="150px",f.style.height="30px",f.style.paddingTop="10px",f.style.textAlign="center",f.style.cssFloat="left",f.style.paddingBottom="0px",f.style.borderTopLeftRadius="10px",f.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",f.style.background="url("+n(mi)+") no-repeat 12px 16px",f.style.backgroundSize="8%",f.style.backgroundColor="#9e9e9e";let y=document.createElement("div");$.setEventListener(y,"onpointerdown",(function(){return!1})),y.textContent=ce("filter-flip-layer"),y.style.width="150px",y.style.height="30px",y.style.paddingTop="10px",y.style.textAlign="center",y.style.cssFloat="left",y.style.paddingBottom="0px",y.style.borderTopRightRadius="10px",y.style.cursor="pointer",y.style.backgroundColor="rgba(0, 0, 0, 0.1)",y.style.backgroundSize="8%",$.setEventListener(f,"onpointerover",(function(){!1===p&&(f.style.backgroundColor="#ccc")})),$.setEventListener(f,"onpointerout",(function(){!1===p&&(f.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),$.setEventListener(y,"onpointerover",(function(){!0===p&&(y.style.backgroundColor="#ccc")})),$.setEventListener(y,"onpointerout",(function(){!0===p&&(y.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),f.onclick=function(){p=!0,y.style.background="",y.style.backgroundColor="rgba(0, 0, 0, 0.1)",y.style.boxShadow="",y.style.cursor="pointer",f.style.background="url("+n(mi)+") no-repeat 12px 16px",f.style.backgroundSize="8%",f.style.backgroundColor="#9e9e9e",f.style.cursor="default",f.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",S()},y.onclick=function(){p=!1,f.style.background="",f.style.backgroundColor="rgba(0, 0, 0, 0.1)",f.style.boxShadow="",f.style.cursor="pointer",y.style.background="url("+n(mi)+") no-repeat 12px 16px",y.style.backgroundSize="8%",y.style.backgroundColor="#9e9e9e",y.style.cursor="default",y.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",S()};let x=document.createElement("div");x.appendChild(f),x.appendChild(y),h.appendChild(x);let b=document.createElement("div");$.css(b,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let v={image:$.canvas(Math.round(s),Math.round(l)),opacity:1,mixModeStr:"source-over"},w=new et({width:Math.round(s),height:Math.round(l),layers:[v]}),C=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+s)+"px",height:parseInt(""+l)+"px"}});function S(){let e=v.image.getContext("2d");e.save(),e.clearRect(0,0,v.image.width,v.image.height),p&&(d&&(e.translate(v.image.width,0),e.scale(-1,1)),u&&(e.translate(0,v.image.height),e.scale(1,-1)));for(let t=0;t<r.length;t++)e.save(),p||a!==t||(d&&(e.translate(v.image.width,0),e.scale(-1,1)),u&&(e.translate(0,v.image.height),e.scale(1,-1))),e.canvas.width>r[t].context.canvas.width&&(e.imageSmoothingEnabled=!1),e.globalAlpha=r[t].opacity,e.globalCompositeOperation=r[t].mixModeStr,e.drawImage(r[t].context.canvas,0,0,v.image.width,v.image.height),e.restore();w.render(),e.restore()}return C.appendChild(w.getElement()),b.appendChild(C),setTimeout(S,0),h.appendChild(b),c.destroy=()=>{g.destroy(),m.destroy()},c.getInput=function(){return c.destroy(),{horizontal:d,vertical:u,flipCanvas:p}},c},apply(e){let t=e.context,n=e.canvas,i=e.history,r=e.input.horizontal,a=e.input.vertical,o=e.input.flipCanvas;return!!(t&&n&&i)&&(i.pause(!0),n.flip(r,a,o?null:n.getLayerIndex(t.canvas)),i.pause(!1),i.push({tool:["filter","flip"],action:"apply",params:[{input:e.input}]}),!0)}},yi={getDialog(e){let t=e.context,n=e.canvas;if(!t||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(t.canvas),a=$.fitInto(t.canvas.width,t.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=$.canvas(o,s);{const e=l.getContext("2d");e.save(),l.width>t.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.canvas,0,0,o,s),e.restore()}let h=document.createElement("div"),c={element:h};return setTimeout((function(){let e=0,t=0;h.innerHTML=ce("filter-hue-sat-description")+"<br/><br/>";let n=di();if(!n)return;let a=n.texture(l);n.draw(a).update();let d=new we({label:ce("filter-hue-sat-hue"),width:300,height:30,min:-100,max:100,initValue:100*e,eventResMs:60,onChange:function(i){e=i/100,n.draw(a).hueSaturation(e,t).update(),m.render()}}),u=new we({label:ce("filter-hue-sat-saturation"),width:300,height:30,min:0,max:100,initValue:50*(t+1),eventResMs:60,onChange:function(i){t=i/50-1,n.draw(a).hueSaturation(e,t).update(),m.render()}});d.getElement().style.marginBottom="10px",h.appendChild(d.getElement()),h.appendChild(u.getElement());let p=document.createElement("div");$.css(p,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let g=[];for(let e=0;e<i.length;e++)g.push({image:e===r?n:i[e].context.canvas,opacity:i[e].opacity,mixModeStr:i[e].mixModeStr});let m=new et({width:parseInt(""+o),height:parseInt(""+s),layers:g}),f=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});f.appendChild(m.getElement()),p.appendChild(f),h.appendChild(p);try{n.draw(a).hueSaturation(e,t).update(),m.render()}catch(e){h.errorCallback(e)}c.destroy=()=>{d.destroy(),u.destroy(),a.destroy()},c.getInput=function(){return c.destroy(),{hue:e,Saturation:t}}}),1),c},apply(e){let t=e.context,n=e.input.hue,i=e.history,r=e.input.Saturation;if(!t||null===n||null===r||!i)return!1;i.pause(!0);let a=di();if(!a)return!1;let o=a.texture(t.canvas);return a.draw(o).hueSaturation(n,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),o.destroy(),i.pause(!1),i.push({tool:["filter","glHueSaturation"],action:"apply",params:[{input:e.input}]}),!0}},xi={apply(e){let t=e.context,n=e.history;if(!t||!n)return!1;n.pause(!0);let i=di();if(!i)return!1;let r=i.texture(t.canvas);return i.draw(r).invert().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(i,0,0),r.destroy(),n.pause(!1),n.push({tool:["filter","invert"],action:"apply",params:[{input:e.input}]}),!0}},bi={getDialog(e){let t=e.context,i=e.canvas;if(!t||!i)return!1;let r=e.bbox.width<550,a=i.getLayers(),o=i.getLayerIndex(t.canvas),s=$.fitInto(t.canvas.width,t.canvas.height,r?280:490,r?200:240,1),l=parseInt(""+s.width),h=parseInt(""+s.height),c=Math.min(l,t.canvas.width),d=Math.min(h,t.canvas.height),u=$.canvas(c,d);{const e=u.getContext("2d");e.save(),c>t.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.canvas,0,0,c,d),e.restore()}let p=l/t.canvas.width,g=document.createElement("div"),m={element:g};r||(m.width=500);let f=[];return setTimeout((function(){g.innerHTML=ce("filter-perspective-description")+"<br/><br/>";let e=di();if(!e)return;let t,i,s,y,x,b,v,w,C=e.texture(u);function S(){try{e.draw(C).perspective([t.x,t.y,i.x,i.y,s.x,s.y,y.x,y.y].map(((e,t)=>t%2==0?e/l*c:e/h*d)),[x.x,x.y,b.x,b.y,v.x,v.y,w.x,w.y].map(((e,t)=>t%2==0?e/l*c:e/h*d))).update(),P.render()}catch(e){g.errorCallback(e)}}function E(e,t,n){let i=document.createElement("div");i.x=e,i.y=t,$.css(i,{width:"14px",height:"14px",backgroundColor:"#fff",boxShadow:"inset 0 0 0 2px #000",borderRadius:"14px",position:"absolute",cursor:"move",left:i.x-7+"px",top:i.y-7+"px",userSelect:"none",touchAction:"none"});let r=new $.PointerListener({target:i,maxPointers:1,onPointer:function(e){e.eventPreventDefault(),"left"===e.button&&"pointermove"===e.type&&(i.x+=e.dX,i.y+=e.dY,i.style.left=i.x-7+"px",i.style.top=i.y-7+"px",n&&n(),S())}});return i.copy=function(e){i.x=e.x,i.y=e.y,i.style.left=i.x-7+"px",i.style.top=i.y-7+"px"},f.push(r),i}function M(){x.copy(t),b.copy(i),v.copy(s),w.copy(y)}e.draw(C).update(),t=E(0,0,M),i=E(l,0,M),s=E(l,h,M),y=E(0,h,M),x=E(0,0),b=E(l,0),v=E(l,h),w=E(0,h);let k=!1,I=document.createElement("div");$.setEventListener(I,"onpointerdown",(function(){return!1})),I.textContent=ce("filter-perspective-before"),I.style.width="150px",I.style.height="30px",I.style.marginLeft=r?"0":"100px",I.style.paddingTop="10px",I.style.textAlign="center",I.style.cssFloat="left",I.style.paddingBottom="0px",I.style.borderTopLeftRadius="10px",I.style.cursor="pointer",I.style.backgroundColor="rgba(0, 0, 0, 0.1)",I.style.backgroundSize="8%";let T=document.createElement("div");$.setEventListener(T,"onpointerdown",(function(){return!1})),T.textContent=ce("filter-perspective-after"),T.style.width="150px",T.style.height="30px",T.style.paddingTop="10px",T.style.textAlign="center",T.style.cssFloat="left",T.style.paddingBottom="0px",T.style.borderTopRightRadius="10px",T.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",T.style.background="url("+n(mi)+") no-repeat 12px 16px",T.style.backgroundSize="8%",T.style.backgroundColor="#9e9e9e",$.setEventListener(I,"onpointerover",(function(){!1===k&&(I.style.backgroundColor="#ccc")})),$.setEventListener(I,"onpointerout",(function(){!1===k&&(I.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),$.setEventListener(T,"onpointerover",(function(){!0===k&&(T.style.backgroundColor="#ccc")})),$.setEventListener(T,"onpointerout",(function(){!0===k&&(T.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),I.onclick=function(){I.style.background="url("+n(mi)+") no-repeat 12px 16px",I.style.backgroundSize="8%",I.style.backgroundColor="#9e9e9e",I.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",I.style.cursor="default",T.style.background="",T.style.backgroundColor="rgba(0, 0, 0, 0.1)",T.style.boxShadow="",T.style.cursor="pointer",x.style.display="none",b.style.display="none",v.style.display="none",w.style.display="none",t.style.display="block",i.style.display="block",s.style.display="block",y.style.display="block",t.copy(x),i.copy(b),s.copy(v),y.copy(w),k=!0,S()},T.onclick=function(){k=!1,T.style.background="url("+n(mi)+") no-repeat 12px 16px",T.style.backgroundSize="8%",T.style.backgroundColor="#9e9e9e",T.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",T.style.cursor="default",I.style.background="",I.style.backgroundColor="rgba(0, 0, 0, 0.1)",I.style.boxShadow="",I.style.cursor="pointer",t.style.display="none",i.style.display="none",s.style.display="none",y.style.display="none",x.style.display="block",b.style.display="block",v.style.display="block",w.style.display="block",x.copy(t),b.copy(i),v.copy(s),w.copy(y)};let L=document.createElement("div");L.appendChild(I),L.appendChild(T),g.appendChild(L);let R=document.createElement("div");R.oncontextmenu=function(){return!1},$.css(R,{width:r?"340px":"540px",marginLeft:"-20px",height:r?"260px":"300px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let A=[];for(let t=0;t<a.length;t++){let n=t===o?e:a[t].context.canvas;A.push({image:n,opacity:a[t].opacity,mixModeStr:a[t].mixModeStr})}let P=new et({width:parseInt(""+l),height:parseInt(""+h),layers:A}),D=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+l)+"px",height:parseInt(""+h)+"px"}});D.appendChild(P.getElement()),R.appendChild(D),D.appendChild(x),D.appendChild(b),D.appendChild(v),D.appendChild(w),t.style.display="none",i.style.display="none",s.style.display="none",y.style.display="none",D.appendChild(t),D.appendChild(i),D.appendChild(s),D.appendChild(y),g.appendChild(R),S(),m.destroy=()=>{for(let e=0;e<f.length;e++)f[e].destroy();C.destroy()},m.getInput=function(){return m.destroy(),{before:[t.x/p,t.y/p,i.x/p,i.y/p,s.x/p,s.y/p,y.x/p,y.y/p],after:[x.x/p,x.y/p,b.x/p,b.y/p,v.x/p,v.y/p,w.x/p,w.y/p]}}}),1),m},apply(e){let t=e.context,n=e.history,i=e.input.before,r=e.input.after;if(!(t&&i&&r&&n))return!1;n.pause(!0);let a=di();if(!a)return!1;let o=a.texture(t.canvas);t.canvas.width,t.canvas.height;return a.draw(o).perspective(i,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),o.destroy(),n.pause(!1),n.push({tool:["filter","glPerspective"],action:"apply",params:[{input:e.input}]}),!0}};var vi;vi=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("8uSvm");const wi={getDialog(e){let t=e.canvas;if(!t)return!1;let i=$.fitInto(t.getWidth(),t.getHeight(),280,200,1),r=parseInt(""+i.width),a=parseInt(""+i.height),o=r/t.getWidth(),s=t.getCompleteCanvas(1),l=document.createElement("div"),h={element:l},c=t.getWidth(),d=t.getHeight();l.innerHTML=ce("filter-resize-description")+"<br/><br/>";let u=e.maxWidth,p=e.maxHeight,g=$.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),m=$.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),f=$.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+u,value:""+t.getWidth()}}),y=$.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+p,value:""+t.getHeight()}});f.onclick=function(){this.focus(),v=!0,T()},y.onclick=function(){this.focus(),b=!0,T()},f.onchange=function(){v=!0,T()},y.onchange=function(){b=!0,T()},g.append(ce("width")+": ",f),m.append(ce("height")+": ",y);let x=$.el({css:{background:"url("+n(vi)+") no-repeat 140px 5px",backgroundSize:"50px 52px"}});x.append(g,m),l.appendChild(x);let b=!1,v=!1,w=t.getWidth()/t.getHeight();let C=!0,S=new pe({init:!0,label:ce("constrain-proportions"),allowTab:!0,callback:function(e){C=e,C?(f.value=""+t.getWidth(),y.value=""+t.getHeight(),x.style.background="url("+n(vi)+") no-repeat 140px 5px",x.style.backgroundSize="50px 52px",T()):x.style.background=""}});l.appendChild($.el({css:{clear:"both"}}));let E=new me({isFocusable:!0,optionArr:[["smooth",ce("algorithm-smooth")],["pixelated",ce("algorithm-pixelated")]],title:ce("scaling-algorithm"),initValue:"smooth",onChange:function(){T()}}),M=$.el({parent:l,css:{display:"flex",justifyContent:"space-between"}});M.appendChild(S.getElement()),M.appendChild(E.getElement());let k=$.canvas(r,a);k.style.imageRendering="pixelated";let I=k.getContext("2d");function T(){if(0===f.value.length&&v||0===y.value.length&&b)return b=!1,void(v=!1);if(f.value=""+Math.max(1,parseInt(f.value)),y.value=""+Math.max(1,parseInt(y.value)),C&&(b&&(f.value=""+parseInt(""+parseInt(y.value)*w)),v&&(y.value=""+parseInt(""+parseInt(f.value)/w)),parseInt(f.value)>u||parseInt(y.value)>p)){let e=$.fitInto(parseInt(f.value),parseInt(y.value),u,p,1);f.value=""+parseInt(""+e.width),y.value=""+parseInt(""+e.height)}parseInt(f.value)>u&&(f.value=""+u),parseInt(y.value)>p&&(y.value=""+p),b=!1,v=!1,c=parseInt(f.value),d=parseInt(y.value);let e=$.fitInto(c,d,280,200,1),n=parseInt(""+e.width),i=parseInt(""+e.height);o=n/c;let r=$.centerWithin(340,220,n,i);"smooth"===E.getValue()?(k.style.imageRendering=o>1?"pixelated":"",k.width=t.getWidth(),k.height=t.getHeight(),I.save(),I.imageSmoothingQuality="high",I.drawImage(s,0,0),$.resizeCanvas(k,c,d),I.restore()):(k.style.imageRendering="pixelated",k.width=c,k.height=d,I.save(),I.imageSmoothingEnabled=!1,I.drawImage(s,0,0,k.width,k.height),I.restore()),k.style.width=Math.max(1,n)+"px",k.style.height=Math.max(1,i)+"px",R.style.left=r.x+"px",R.style.top=r.y+"px",R.style.width=Math.max(1,n)+"px",R.style.height=Math.max(1,i)+"px"}let L=document.createElement("div");$.css(L,{width:"340px",marginLeft:"-20px",height:"220px",display:"table",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",position:"relative",userSelect:"none",colorScheme:"only light"});let R=$.appendTextDiv(L,"");return R.appendChild(k),R.style.width=r+"px",R.style.height=a+"px",R.style.position="absolute",R.style.overflow="hidden",R.style.boxShadow="0 0 5px rgba(0,0,0,0.8)",R.style.overflow="hidden",$.createCheckerDataUrl(8,(function(e){L.style.background="url("+e+")"})),l.appendChild(L),T(),h.destroy=()=>{S.destroy()},h.getInput=function(){return h.destroy(),{width:c,height:d,algorithm:E.getValue()}},h},apply(e){let t=e.canvas,n=e.history,i=e.input.width,r=e.input.height,a=e.input.algorithm;return!(!t||!n)&&(n.pause(!0),t.resize(i,r,a),n.pause(!1),n.push({tool:["filter","resize"],action:"apply",params:[{input:e.input}]}),!0)}},Ci={getDialog(e){let t=e.canvas;if(!t)return!1;let n=$.fitInto(t.getWidth(),t.getHeight(),280,200,1),i=parseInt(""+n.width),r=parseInt(""+n.height),a=i/t.getWidth(),o=$.canvas(i,r);o.style.display="block",o.getContext("2d").drawImage(t.getCompleteCanvas(a),0,0,i,r);let s=document.createElement("div"),l={element:s},h=0;s.innerHTML=ce("filter-rotate-description")+"<br/><br/>";function c(){if(m.style.WebkitTransform="rotate("+h+"deg)",m.style.MozTransform="rotate("+h+"deg)",m.style.OTransform="rotate("+h+"deg)",m.style.msTransform="rotate("+h+"deg)",90===Math.abs(h%180)){let e=$.fitInto(r,i,280,200,1),t=parseInt(""+e.height)/i;m.style.WebkitTransform="rotate("+h+"deg) scale("+t+")",m.style.MozTransform="rotate("+h+"deg) scale("+t+")",m.style.OTransform="rotate("+h+"deg) scale("+t+")",m.style.msTransform="rotate("+h+"deg) scale("+t+")"}}let d=document.createElement("button");d.innerHTML="<span style='font-size: 1.3em'>⟳</span> 90°";let u=document.createElement("button");u.innerHTML="<span style='font-size: 1.3em'>⟲</span> 90°",u.style.marginRight="5px",d.onclick=function(){h+=90,c()},u.onclick=function(){h-=90,c()},s.appendChild(u),s.appendChild(d);let p=document.createElement("div");$.css(p,{width:"340px",marginLeft:"-20px",height:"220px",display:"table",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",colorScheme:"only light"});let g=document.createElement("div");g.style.display="table-cell",g.style.verticalAlign="middle";let m=$.appendTextDiv(g,"");return m.appendChild(o),p.appendChild(g),m.style.width=i+"px",m.style.height=r+"px",m.style.marginLeft="auto",m.style.marginRight="auto",m.style.boxShadow="0 0 5px rgba(0,0,0,0.8)",m.style.overflow="hidden",$.createCheckerDataUrl(4,(function(e){m.style.background="url("+e+")"})),m.style.transition="all 0.2s ease-out",s.appendChild(p),c(),l.getInput=function(){return{deg:h}},l},apply(e){let t=e.canvas,n=e.history,i=e.input.deg;return!(!t||!n)&&(n.pause(!0),t.rotate(i),n.pause(!1),n.push({tool:["filter","rotate"],action:"apply",params:[{input:e.input}]}),!0)}},Si={getDialog(e){let t=e.context,n=e.canvas;if(!t||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(t.canvas),a=$.fitInto(t.canvas.width,t.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Math.min(o,t.canvas.width),h=Math.min(s,t.canvas.height),c=$.canvas(l,h);{const e=c.getContext("2d");e.save(),l>t.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.canvas,0,0,l,h),e.restore()}let d=l/t.canvas.width,u=o/t.canvas.width,p=document.createElement("div"),g={element:p},m=[];return setTimeout((function(){let e=20,t=200;p.innerHTML=ce("filter-tilt-shift-description")+"<br/><br/>";let n=di();if(!n)return;let a,l,h=n.texture(c);function f(){try{n.draw(h).tiltShift(a.x/u*d,a.y/u*d,l.x/u*d,l.y/u*d,e*d,t*d).update(),C.render()}catch(e){p.errorCallback(e)}}function y(e,t){let n=$.el({css:{width:"14px",height:"14px",backgroundColor:"#fff",boxShadow:"inset 0 0 0 2px #000",borderRadius:"14px",position:"absolute",cursor:"move",left:e-7+"px",top:t-7+"px",userSelect:"none",touchAction:"none"}});n.x=e,n.y=t;let i=new $.PointerListener({target:n,maxPointers:1,onPointer:function(e){e.eventPreventDefault(),"left"===e.button&&"pointermove"===e.type&&(n.x+=e.dX,n.y+=e.dY,n.style.left=n.x-7+"px",n.style.top=n.y-7+"px",f())}});return m.push(i),n}n.draw(h).update(),a=y(parseInt(""+o/6),parseInt(""+s/2)),l=y(parseInt(""+(o-o/6)),parseInt(""+(s-s/3)));let x=new we({label:ce("filter-tilt-shift-blur"),width:300,height:30,min:0,max:200,initValue:e,eventResMs:60,onChange:function(t){e=t,f()}});x.getElement().style.marginBottom="10px",p.appendChild(x.getElement());let b=new we({label:ce("filter-tilt-shift-gradient"),width:300,height:30,min:0,max:1e3,initValue:t,eventResMs:60,onChange:function(e){t=e,f()}});p.appendChild(b.getElement());let v=document.createElement("div");v.oncontextmenu=function(){return!1},$.css(v,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let w=[];for(let e=0;e<i.length;e++)w.push({image:e===r?n:i[e].context.canvas,opacity:i[e].opacity,mixModeStr:i[e].mixModeStr});let C=new et({width:parseInt(""+o),height:parseInt(""+s),layers:w}),S=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});S.appendChild(C.getElement()),v.appendChild(S),S.appendChild(a),S.appendChild(l),p.appendChild(v),f(),g.destroy=()=>{for(let e=0;e<m.length;e++)m[e].destroy();x.destroy(),b.destroy(),h.destroy()},g.getInput=function(){return g.destroy(),{a:{x:a.x/u,y:a.y/u},b:{x:l.x/u,y:l.y/u},blur:e,gradient:t}}}),1),g},apply(e){let t=e.context,n=e.history,i=e.input.a,r=e.input.b,a=e.input.blur,o=e.input.gradient;if(!t||!n)return!1;n.pause(!0);let s=di();if(!s)return!1;let l=s.texture(t.canvas);return s.draw(l).tiltShift(i.x,i.y,r.x,r.y,a,o).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(s,0,0),l.destroy(),n.pause(!1),n.push({tool:["filter","glTiltShift"],action:"apply",params:[{input:e.input}]}),!0}},Ei={getDialog(e){let t,n=e.context,i=e.canvas;if(!n||!i)return!1;let r,a=e.bbox.width<550,o=i.getLayers(),s=i.getLayerIndex(n.canvas),l=$.fitInto(n.canvas.width,n.canvas.height,a?280:490,a?200:240,1),h=parseInt(""+l.width),c=parseInt(""+l.height),d=Math.min(h,n.canvas.width),u=Math.min(c,n.canvas.height),p=h/n.canvas.width,g={x:0,y:0,width:0,height:0};{let e={x1:null,y1:null,x2:null,y2:null},i=n.getImageData(0,0,n.canvas.width,n.canvas.height);if(i.data[3]>0&&i.data[i.data.length-1]>0)e.x1=0,e.y1=0,e.x2=n.canvas.width-1,e.y2=n.canvas.height-1;else for(t=3;t<i.data.length;t+=4)if(i.data[t]>0){let i=(t-3)/4%n.canvas.width,r=Math.floor((t-3)/4/n.canvas.width);(e.x1>i||null===e.x1)&&(e.x1=i),null===e.y1&&(e.y1=r),(e.x2<i||null===e.x2)&&(e.x2=i),(e.y2<r||null===e.y2)&&(e.y2=r)}if(null===e.x1||null===e.y1)return alert(ce("filter-transform-empty")),!1;g.x=e.x1,g.y=e.y1,g.width=e.x2-e.x1+1,g.height=e.y2-e.y1+1}const m={x:g.x+g.width/2,y:g.y+g.height/2,width:g.width,height:g.height,angleDeg:0};let f=document.createElement("div"),y={element:f};a||(y.width=500),f.innerHTML=ce("filter-transform-description");let x=new $.KeyListener({onDown:function(e){$.isInputFocused(!0)||("left"===e&&(S.value=""+(parseFloat(S.value)-1),G()),"right"===e&&(S.value=""+(parseFloat(S.value)+1),G()),"up"===e&&(C.value=""+(parseFloat(C.value)-1),G()),"down"===e&&(C.value=""+(parseFloat(C.value)+1),G()))}}),b=document.createElement("div"),v=document.createElement("div"),w=document.createElement("div"),C=document.createElement("input"),S=document.createElement("input"),E=document.createElement("input");if(b.style.width="100px",b.style.height="30px",v.style.width="100px",v.style.height="30px",v.style.display="inline-block",b.style.display="inline-block",w.style.display="inline-block",w.style.width="150px",w.style.height="30px",C.type="number",S.type="number",E.type="number",S.style.width="70px",C.style.width="70px",E.style.width="70px",C.value="0",S.value="0",E.value="0",C.onclick=function(){this.focus(),G()},S.onclick=function(){this.focus(),G()},E.onclick=function(){this.focus(),G()},C.onchange=function(){G()},S.onchange=function(){G()},E.onchange=function(){G()},C.onkeyup=function(){G()},S.onkeyup=function(){G()},E.onkeyup=function(){G()},b.append("X: ",S),v.append("Y: ",C),w.append(ce("filter-transform-rotation")+": ",E),!a){$.el({parent:f,css:{marginTop:"10px"}}).append(b,v,w)}const M={marginLeft:"10px",marginTop:"10px"},k=$.el({parent:f,css:{display:"flex",flexWrap:"wrap",marginLeft:"-10px"}}),I=$.el({parent:k,tagName:"button",content:ce("filter-transform-flip")+" X",onClick:()=>{const e=r.getTransform();r.setSize(-e.width,e.height)},css:M}),T=$.el({parent:k,tagName:"button",content:ce("filter-transform-flip")+" Y",onClick:()=>{const e=r.getTransform();r.setSize(e.width,-e.height)},css:M}),L=$.el({parent:k,tagName:"button",content:"-90°",onClick:()=>{const e=r.getTransform();e.angleDeg-=90,e.angleDeg%=360,r.setAngleDeg(e.angleDeg),E.value=""+Math.round(e.angleDeg),W()},css:M}),R=$.el({parent:k,tagName:"button",content:"+90°",onClick:()=>{const e=r.getTransform();e.angleDeg+=90,e.angleDeg%=360,r.setAngleDeg(e.angleDeg),E.value=""+Math.round(e.angleDeg),W()},css:M}),A=$.el({parent:k,tagName:"button",content:"2x",onClick:()=>{const e=r.getTransform();B.getValue()?r.setSize(r.getRatio()*e.height*2,2*e.height):r.setSize(2*e.width,2*e.height)},css:M}),P=$.el({parent:k,tagName:"button",content:"1/2x",onClick:()=>{const e=r.getTransform();r.setSize(Math.round(e.width/2),Math.round(e.height/2))},css:M}),D=$.el({parent:k,tagName:"button",content:ce("center"),onClick:()=>{const e=r.getTransform();r.setPos({x:n.canvas.width/2,y:n.canvas.height/2}),r.setAngleDeg(e.angleDeg),W()},css:M});let O=!0,B=new pe({init:!0,label:ce("filter-transform-constrain"),title:ce("constrain-proportions"),allowTab:!0,callback:function(e){O=e,r.setConstrained(O)},css:{display:"inline-block"}}),z=!1,H=new pe({init:!0,label:ce("filter-transform-snap"),title:ce("filter-transform-snap-title"),allowTab:!0,callback:function(e){z=e,r.setSnapping(z)},css:{display:"inline-block",marginLeft:"10px"}});const F=$.el({});F.append(B.getElement(),H.getElement()),f.appendChild($.el({css:{clear:"both",height:"10px"}}));const j=$.el({parent:f,css:{display:"flex",justifyContent:"space-between"}});let _=new me({isFocusable:!0,optionArr:[["smooth",ce("algorithm-smooth")],["pixelated",ce("algorithm-pixelated")]],initValue:"smooth",title:ce("scaling-algorithm"),onChange:function(){W(!0)}});j.append(F,_.getElement());let N=document.createElement("div");N.oncontextmenu=function(){return!1},$.css(N,{width:a?"340px":"540px",marginLeft:"-20px",height:a?"260px":"300px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let U=[];for(let e=0;e<o.length;e++){let t;if(e===s){t=$.canvas(parseInt(""+d),parseInt(""+u)),t.getContext("2d").drawImage(o[e].context.canvas,0,0,t.width,t.height)}else t=o[e].context.canvas;U.push({image:t,opacity:o[e].opacity,mixModeStr:o[e].mixModeStr})}let X,Y=new et({width:parseInt(""+h),height:parseInt(""+c),layers:U}),V=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+h)+"px",height:parseInt(""+c)+"px"}});function W(e=!1){if(!r)return;let t=r.getTransform();if(JSON.stringify(t)===X&&!e)return;X=JSON.stringify(t),p<1&&(t.x*=p,t.y*=p,t.width*=p,t.height*=p);let n=U[s].image,i=n.getContext("2d");i.save(),i.clearRect(0,0,n.width,n.height),$.drawTransformedImageWithBounds(i,o[s].context.canvas,t,g,"pixelated"===_.getValue()||$.testShouldPixelate(t,t.width/m.width,t.height/m.height)),i.restore(),Y.render()}function G(){r.setPos({x:parseInt(S.value)+m.x,y:parseInt(C.value)+m.y}),r.setAngleDeg(parseInt(E.value)),W()}return V.appendChild(Y.getElement()),N.appendChild(V),r=new ot({x:m.x,y:m.y,width:m.width,height:m.height,angleDeg:m.angleDeg,isConstrained:!0,snapX:[0,n.canvas.width],snapY:[0,n.canvas.height],callback:function(e){S.value=""+Math.round(e.x-m.x),C.value=""+Math.round(e.y-m.y),E.value=""+Math.round(e.angleDeg),W()},scale:p}),$.css(r.getElement(),{position:"absolute",left:"0",top:"0"}),V.appendChild(r.getElement()),W(),f.appendChild(N),y.destroy=()=>{x.destroy(),r.destroy(),B.destroy(),H.destroy(),$.destroyEl(I),$.destroyEl(T),$.destroyEl(L),$.destroyEl(R),$.destroyEl(A),$.destroyEl(P),$.destroyEl(D)},y.getInput=function(){const e=r.getTransform();let t={transform:e,bounds:g,isPixelated:"pixelated"===_.getValue()||$.testShouldPixelate(e,e.width/m.width,e.height/m.height)};return y.destroy(),JSON.parse(JSON.stringify(t))},y},apply(e){const t=e.context,n=e.history;if(!t||!n)return!1;n.pause(!0);const i=e.input;let r=$.copyCanvas(t.canvas);return t.clearRect(0,0,t.canvas.width,t.canvas.height),$.drawTransformedImageWithBounds(t,r,i.transform,i.bounds,i.isPixelated),n.pause(!1),n.push({tool:["filter","transform"],action:"apply",params:[{input:i}]}),!0}},Mi={getDialog(e){let t=e.canvas,n=e.context;if(!t||!n)return!1;let i=t.getLayers(),r=t.getLayerIndex(n.canvas),a=$.fitInto(n.canvas.width,n.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Math.min(o,n.canvas.width),h=Math.min(s,n.canvas.height),c=$.canvas(l,h);{const e=c.getContext("2d");e.save(),l>n.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(n.canvas,0,0,l,h),e.restore()}let d=l/n.canvas.width,u=document.createElement("div"),p={element:u};return setTimeout((function(){let e=10;u.innerHTML=ce("filter-triangle-blur-description")+"<br/><br/>";let t=di();if(!t)return;let n=t.texture(c);t.draw(n).update();let a=new we({label:ce("radius"),width:300,height:30,min:1,max:200,initValue:e,eventResMs:60,onChange:function(i){e=i,t.draw(n).triangleBlur(e*d).update(),g.render()}});u.appendChild(a.getElement());let l=document.createElement("div");$.css(l,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let h=[];for(let e=0;e<i.length;e++)h.push({image:e===r?t:i[e].context.canvas,opacity:i[e].opacity,mixModeStr:i[e].mixModeStr});let g=new et({width:parseInt(""+o),height:parseInt(""+s),layers:h}),m=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});m.appendChild(g.getElement()),l.appendChild(m),u.appendChild(l);try{t.draw(n).triangleBlur(e*d).update(),g.render()}catch(e){u.errorCallback(e)}p.destroy=()=>{n.destroy(),a.destroy()},p.getInput=function(){return p.destroy(),{radius:e}}}),1),p},apply(e){let t=e.context,n=e.history,i=e.input.radius;if(!t||!i||!n)return!1;n.pause(!0);let r=di();if(!r)return!1;let a=r.texture(t.canvas);return r.draw(a).triangleBlur(i).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(r,0,0),a.destroy(),n.pause(!1),n.push({tool:["filter","glBlur"],action:"apply",params:[{input:e.input}]}),!0}},ki={getDialog(e){let t=e.context,n=e.canvas;if(!t||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(t.canvas),a=$.fitInto(t.canvas.width,t.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Math.min(o,t.canvas.width),h=Math.min(s,t.canvas.height),c=$.canvas(l,h);{const e=c.getContext("2d");e.save(),l>t.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.canvas,0,0,l,h),e.restore()}let d=l/t.canvas.width,u=document.createElement("div"),p={element:u};return setTimeout((function(){let e=2,t=.51;u.innerHTML=ce("filter-unsharp-mask-description")+"<br/><br/>";let n=di();if(!n)return;let a=n.texture(c);n.draw(a).update();let l=new we({label:ce("radius"),width:300,height:30,min:0,max:200,initValue:2,eventResMs:60,onChange:function(i){e=i,n.draw(a).unsharpMask(e*d,t).update(),f.render()},curve:[[0,0],[.1,2],[.5,50],[1,200]]}),h=new we({label:ce("filter-unsharp-mask-strength"),width:300,height:30,min:0,max:50,initValue:5.1,eventResMs:60,onChange:function(i){t=i/10,n.draw(a).unsharpMask(e*d,t).update(),f.render()},curve:[[0,0],[.1,2],[.5,10],[1,50]]});l.getElement().style.marginBottom="10px",u.appendChild(l.getElement()),u.appendChild(h.getElement());let g=document.createElement("div");$.css(g,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let m=[];for(let e=0;e<i.length;e++)m.push({image:e===r?n:i[e].context.canvas,opacity:i[e].opacity,mixModeStr:i[e].mixModeStr});let f=new et({width:parseInt(""+o),height:parseInt(""+s),layers:m}),y=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});y.appendChild(f.getElement()),g.appendChild(y),u.appendChild(g);try{n.draw(a).unsharpMask(e*d,t).update(),f.render()}catch(e){u.errorCallback(e)}p.destroy=()=>{l.destroy(),h.destroy(),a.destroy()},p.getInput=function(){return p.destroy(),{radius:e,strength:t}}}),1),p},apply(e){let t=e.context,n=e.history,i=e.input.radius,r=e.input.strength;if(!t||null===i||null===r||!n)return!1;n.pause(!0);let a=di();if(!a)return!1;let o=a.texture(t.canvas);return a.draw(o).unsharpMask(i,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),o.destroy(),n.pause(!1),n.push({tool:["filter","glUnsharpMask"],action:"apply",params:[{input:e.input}]}),!0}},Ii={getDialog(e){let t=e.context,n=e.canvas;if(!t||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(t.canvas),a=$.fitInto(t.canvas.width,t.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=$.canvas(o,s);{const e=l.getContext("2d");e.save(),l.width>t.canvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.canvas,0,0,o,s),e.restore()}let h=document.createElement("div"),c={element:h};return setTimeout((function(){h.appendChild($.el({content:ce("filter-to-alpha-description"),css:{marginBottom:"5px"}}));let t=di();if(!t)return;let n=t.texture(l);function a(){t.draw(n).toAlpha("inverted-luminance"===d,p).update(),x.render()}t.draw(n).update();let d="inverted-luminance",u=new Te({optionArr:[{id:"inverted-luminance",label:ce("filter-to-alpha-inverted-lum")},{id:"luminance",label:ce("filter-to-alpha-lum")}],initialId:d,onChange:function(e){d=e,a()}});h.appendChild(u.getElement());let p={r:0,g:0,b:0,a:1},g=[null,{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];g.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),g.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1});let m=new Ie({label:ce("filter-to-alpha-replace"),colorArr:g,initialIndex:1,onChange:function(e){p=e,a()}});m.getElement().style.marginTop="10px",h.appendChild(m.getElement());let f=document.createElement("div");$.css(f,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let y=[];for(let e=0;e<i.length;e++)y.push({image:e===r?t:i[e].context.canvas,opacity:i[e].opacity,mixModeStr:i[e].mixModeStr});let x=new et({width:parseInt(""+o),height:parseInt(""+s),layers:y}),b=$.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});b.appendChild(x.getElement()),f.appendChild(b),h.appendChild(f),setTimeout((function(){try{a()}catch(e){h.errorCallback(e)}}),1),c.destroy=()=>{n.destroy(),u.destroy()},c.getInput=function(){return c.destroy(),{sourceId:d,selectedRgbaObj:p}}}),1),c},apply(e){let t=e.context,n=e.history,i=e.input.sourceId,r=e.input.selectedRgbaObj;if(!t||!i||!n)return!1;n.pause(!0);let a=di();if(!a)return!1;let o=a.texture(t.canvas);return a.draw(o).toAlpha("inverted-luminance"===i,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),o.destroy(),n.pause(!1),n.push({tool:["filter","toAlpha"],action:"apply",params:[{input:e.input}]}),!0}};let Ti;function Li(e,t){t.getDialog&&(e.getDialog=t.getDialog),e.apply=t.apply}var Ri;Ri=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("5hfiK");var Ai;Ai=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("9qnYn");var Pi;Pi=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("eVFTk");var Di,Oi;function Bi(e,t,i){var r;function o(e){x.reset(e),le.update(0),Q(x.getLayer(0)),O.resetView(),ie.update(O.getScale(),O.getAngleDeg()),C=!1}const s=()=>({width:i?i.clientWidth||i.offsetWidth:window.innerWidth,height:i?i.clientHeight||i.offsetHeight:window.innerHeight});let l=Math.min(4096,Math.max(2048,Math.max(window.screen.width,window.screen.height))),h=t.embed?"left":J.getItem("uiState")?J.getItem("uiState"):"right";const c=(null===(r=t.app)||void 0===r?void 0:r.filenameBase)?t.app.filenameBase:"image",d=t.projectStore;let u=document.createElement("div");u.className="g-root";const p=s();let g=Math.max(0,p.width),m=Math.max(0,p.height);const f=270;let y="png",x=new si.KlCanvas(e?{projectObj:e}:{width:Math.max(10,Math.min(l,p.width<820?g:g-f)),height:Math.max(10,Math.min(l,m))},t.embed?-1:0);x.setHistory(te);let b,v=null;function w(e){return 1==e?.5:2==e?.84:3==e?.965:4==e?.9825:5==e?.99125:e}t.saveReminder||(t.saveReminder={init:()=>{},reset:()=>{}});let C=!0;e?(e.layers.forEach((e=>{e.image=null})),e=null):(te.pause(!0),x.addLayer(),x.layerFill(0,{r:255,g:255,b:255}),te.pause(!1));try{v={canvas:new si.KlCanvas({copy:x},t.embed?-1:0),focus:x.getLayerCount()-1,brushes:{}}}catch(e){throw"kl-create-canvas-error"===e.message&&x.destroy(),e}for(let e in si.brushes)si.brushes.hasOwnProperty(e)&&(v.brushes[e]=new si.brushes[e],v.canvas&&v.brushes[e].setContext(v.canvas.getLayerContext(v.focus)));let S,E,M=new $.RGB(0,0,0),k=0,I=x.getLayerContext(x.getLayerCount()-1);function T(e){L.emitSize(e),O&&O.setCursorSize(2*e)}const L=new si.BrushSettingService((e=>{G.setColor(e),S.setColor(e),M=$.copyObj(e)}),(e=>{S.setSize(e),O.setCursorSize(2*e)}),(e=>{S.setOpacity(e)}),(()=>G.getColor()),(()=>F[E].getSize()),(()=>F[E].getOpacity()),(()=>({sizeSlider:si.brushesUI[E].sizeSlider,opacitySlider:si.brushesUI[E].opacitySlider})));let R=new $.EventChain.LineSmoothing({smoothing:w(1)}),A=new $.EventChain.LineSanitizer,P=new $.EventChain.EventChain({chainArr:[A,R]});P.setChainOut((function(e){"down"===e.type&&(_.style.pointerEvents="none",S.startLine(e.x,e.y,e.pressure),O.requestFrame()),"move"===e.type&&(S.goLine(e.x,e.y,e.pressure,!1,e.isCoalesced),O.setLastDrawEvent(e.x,e.y,e.pressure),O.requestFrame()),"up"===e.type&&(_.style.pointerEvents="",S.endLine(),O.requestFrame()),"line"===e.type&&(S.getBrush().drawLineSegment(e.x0,e.y0,e.x1,e.y1),O.requestFrame())}));let D={size:20,align:"left",isBold:!1,isItalic:!1,font:"sans-serif",opacity:1};const O=new si.KlCanvasWorkspace({klCanvas:x,width:Math.max(0,g-f),height:m,onDraw:P.chainIn,onPick:function(e,t){L.setColor(e),t&&(G.pickingDone(),O.setMode(K.getActive()))},onFill:function(e,t){let n=x.getLayerIndex(I.canvas);x.floodFill(n,e,t,G.getColor(),re.getOpacity(),re.getTolerance(),re.getSample(),re.getGrow(),re.getContiguous()),O.requestFrame()},onText:function(e,t,n){si.dialogCounter.get()>0||si.textToolDialog({klRootEl:u,bbox:s(),klCanvas:x,layerIndex:x.getLayerIndex(I.canvas),x:e,y:t,angleRad:n,color:G.getColor(),secondaryColor:G.getSecondaryRGB(),size:D.size,align:D.align,isBold:D.isBold,isItalic:D.isItalic,font:D.font,opacity:D.opacity,onConfirm:function(e){let t=e.color;t.a=e.opacity,D.size=e.size,D.align=e.align,D.isBold=e.isBold,D.isItalic=e.isItalic,D.font=e.font,D.opacity=e.opacity;let i=x.getLayerIndex(I.canvas);x.text(i,{textStr:e.textStr,x:e.x,y:e.y,size:e.size,font:e.font,align:e.align,isBold:e.isBold,isItalic:e.isItalic,angleRad:n,color:$.ColorConverter.toRgbaStr(t)}),O.requestFrame()}})},onShape:function(e,t,n,i){"down"===e&&se.onDown(t,n,i),"move"===e&&se.onMove(t,n),"up"===e&&se.onUp(t,n)},onViewChange:function(e){e.changed.includes("scale")&&j.out({type:"transform",scale:e.scale,angleDeg:180*e.angle/Math.PI}),K.setEnableZoomIn(e.scale!==O.getMaxScale()),K.setEnableZoomOut(e.scale!==O.getMinScale()),ie.update(e.scale,180*e.angle/Math.PI)},onUndo:function(){te.canUndo()&&ue.undo()&&j.out(ce("undo"),!0)},onRedo:function(){te.canRedo()&&ue.redo()&&j.out(ce("redo"),!0)}});let B=new $.KeyListener({onDown:function(e,n,i){if(si.dialogCounter.get()>0)return;if($.isInputFocused(!0))return;if(!(A.getIsDrawing()||O.getIsDrawing())){if("plus"===i&&O.zoomByStep(B.isPressed("shift")?.125:.5),"minus"===i&&O.zoomByStep(B.isPressed("shift")?-.125:-.5),"home"===i&&O.fitView(),"end"===i&&O.resetView(!0),["ctrl+z","cmd+z"].includes(i)&&(n.preventDefault(),ue.undo()),(["ctrl+y","cmd+y"].includes(i)||($.sameKeys("ctrl+shift+z",i)||$.sameKeys("cmd+shift+z",i))&&"z"===e)&&(n.preventDefault(),ue.redo()),t.embed||(["ctrl+s","cmd+s"].includes(i)&&(n.preventDefault(),me.save()),["ctrl+shift+s","cmd+shift+s"].includes(i)&&(n.preventDefault(),(async()=>{if(d){let e=!0;try{await d.store(x.getProject())}catch(t){e=!1,setTimeout((()=>{throw new Error("keyboard-shortcut: failed to store browser storage, "+t)}),0),j.out("❌ "+ce("file-storage-failed"),!0)}e&&(t.saveReminder.reset(),j.out(ce("file-storage-stored"),!0))}})()),["ctrl+c","cmd+c"].includes(i)&&(n.preventDefault(),be(!0))),["ctrl+a","cmd+a"].includes(i)&&n.preventDefault(),B.comboOnlyContains(["left","right","up","down"])&&("left"===e&&O.translateView(1,0),"right"===e&&O.translateView(-1,0),"up"===e&&O.translateView(0,1),"down"===e&&O.translateView(0,-1)),["r+left","r+right"].includes(i)&&("left"===e&&(O.setAngle(-15,!0),ie.update(O.getScale(),O.getAngleDeg())),"right"===e&&(O.setAngle(15,!0),ie.update(O.getScale(),O.getAngleDeg()))),["r+up"].includes(i)&&(O.setAngle(0),ie.update(O.getScale(),O.getAngleDeg())),"sqbr_open"===i&&S.decreaseSize(.03/O.getScale()),"sqbr_close"===i&&S.increaseSize(.03/O.getScale()),"enter"===i&&(x.layerFill(x.getLayerIndex(I.canvas),G.getColor()),j.out(ce("filled"),!0)),["delete","backspace"].includes(i)){let e=x.getLayerIndex(I.canvas);0!==e||F.eraserBrush.getIsTransparentBg()?x.clearLayer(e):x.layerFill(e,{r:255,g:255,b:255},"source-in"),j.out(ce("cleared-layer"),!0)}"e"===i&&(n.preventDefault(),O.setMode("draw"),K.setActive("draw"),b.open("draw"),xe(),ne.open("eraserBrush")),"b"===i&&(n.preventDefault(),O.setMode("draw"),K.setActive("draw"),b.open("draw"),xe(),ne.open(k)),"g"===i&&(n.preventDefault(),O.setMode("fill"),K.setActive("fill"),b.open("fill"),xe()),"t"===i&&(n.preventDefault(),O.setMode("text"),K.setActive("text"),b.open("text"),xe()),"u"===i&&(n.preventDefault(),O.setMode("shape"),K.setActive("shape"),b.open("shape"),xe()),"x"===i&&(n.preventDefault(),G.swapColors())}},onUp:function(e,t){}});function z(e,t,n){function i(e,t){let n=parseInt(e),i=parseInt(t);return n>l&&(i*=l/n,n=l),i>l&&(n*=l/i,i=l),n=parseInt(""+n),i=parseInt(""+i),{width:n,height:i}}function r(e){let n=i(e.width,e.height),r=$.canvas(e.width,e.height);r.getContext("2d").drawImage(e,0,0),$.resizeCanvas(r,n.width,n.height),o({width:n.width,height:n.height,image:r,layerName:t})}function a(e,t){function n(e,t,n){t.width=t.width,t.getContext("2d").drawImage(e,-n.x,-n.y),e.width=n.width,e.height=n.height,e.getContext("2d").drawImage(t,0,0)}if(t&&(t.width!==e.width||t.height!==e.height)){let i=$.canvas(t.width,t.height);if(e.width=t.width,e.height=t.height,e.layers||n(e.canvas,i,t),e.layers)for(let r=0;r<e.layers.length;r++){n(e.layers[r].image,i,t)}}let r,a=i(e.width,e.height);if(e.width=a.width,e.height=a.height,e.layers||$.resizeCanvas(e.canvas,e.width,e.height),e.layers)for(let t=0;t<e.layers.length;t++){let n=e.layers[t];$.resizeCanvas(n.image,e.width,e.height)}r=e.layers?x.reset({width:e.width,height:e.height,layers:e.layers}):x.reset({width:e.width,height:e.height,image:e.canvas}),le.update(r),Q(x.getLayer(r)),O.resetView(),ie.update(O.getScale(),O.getAngleDeg()),C=!1}function h(e){si.showImportAsLayerDialog({target:u,bbox:s(),klCanvas:x,importImage:e,callback:function(n,i){if(!n)return;te.pause(!0),x.addLayer();let r=x.getLayers().length-1;t&&x.renameLayer(r,t);let a=x.getLayerContext(r);$.drawTransformedImageWithBounds(a,e,n,null,i),Q(x.getLayer(r)),le.update(r),te.pause(!1),te.push({tool:["misc"],action:"importImage",params:[$.copyCanvas(a.canvas),t]})}})}!e||isNaN(e.width)||isNaN(e.height)||e.width<=0||e.height<=0?si.popup({target:u,type:"error",message:ce("import-broken-file"),buttons:["Ok"]}):("default"!==n&&n||si.showImportImageDialog({image:e,target:u,bbox:s(),maxSize:l,callback:function(e){"as-image"===e.type?r(e.image):"as-image-psd"===e.type?a(e.image,e.cropObj):"as-layer"===e.type?h(e.image):e.type}}),"layer"===n&&h(e.canvas),"image"===n&&("psd"===e.type?a(e):r(e.canvas)))}function H(e,t){function n(){si.popup({target:u,type:"warning",message:ce("import-psd-unsupported")+"<br /><br />",buttons:["Ok"]})}let i=!1;for(let r,a=0;r=e[a];a++){let a=r.name.split(".");a=a[a.length-1].toLowerCase(),"psd"===a?function(i){let r=4096;if(i.size>=1073741824)return void si.popup({target:u,type:"error",message:"File too big. Unable to import.<br /><br />",buttons:["Ok"]});let a,o=1===e.length&&i.size>=26214400,s=!0;o&&si.popup({target:u,message:ce("import-opening"),callback:function(e){s=!1,a=null},closefunc:function(e){a=e}});let l=new FileReader;l.onload=function(e){si.loadAgPsd().then((function(l){if(!o||s)try{let o;if(o=l.readPsd(e.target.result,{skipLayerImageData:!0,skipThumbnail:!0,skipCompositeImageData:!0}),o.width>r||o.height>r)return a&&a(),void si.popup({target:u,type:"error",message:ce("import-psd-too-large").replace(/{x}/g,"4096")+"<br /><br />"+ce("import-psd-size")+": "+o.width+" x "+o.height+" pixels<br /><br />",buttons:["Ok"]});o=null;try{o=l.readPsd(e.target.result)}catch(e){}if(o){let e=si.PSD.readPsd(o);"image"===t&&e.error&&n(),a&&a(),z(e,i.name,t)}else o=l.readPsd(e.target.result,{skipLayerImageData:!0,skipThumbnail:!0}),"image"===t&&n(),a&&a(),z({type:"psd",width:o.width,height:o.height,canvas:o.canvas,error:!0},i.name,t)}catch(e){a&&a(),si.popup({target:u,type:"error",message:"Failed to load PSD.<br /><br />",buttons:["Ok"]})}})).catch((()=>{a(),alert("Error: failed to load PSD library")}))},l.readAsArrayBuffer(i)}(r):r.type.match("image.*")?function(e){window.URL=window.URL||window.webkitURL;let n=window.URL.createObjectURL(e),i=new Image;i.src=n,$.loadImage(i,(function(){z({type:"image",width:i.width,height:i.height,canvas:i},e.name,t)}))}(r):i=!0}i&&si.popup({target:u,message:ce("import-unsupported-file"),type:"error",buttons:["OK"]})}t.embed||(new si.KlImageDropper({target:u,onDrop:function(e,t){si.dialogCounter.get()>0||H(e,t)},enabledTest:function(){return 0===si.dialogCounter.get()}}),$.addEventListener(window,"paste",(function(e){si.dialogCounter.get()>0||(e.stopPropagation(),e.preventDefault(),e.clipboardData.files[0]?function(e,t){0==e.clipboardData&&"function"==typeof t&&t(void 0);let n=e.clipboardData.items;if(null==n)"function"==typeof t&&t(void 0);else for(let e=0;e<n.length;e++){if(-1==n[e].type.indexOf("image"))continue;let i=n[e].getAsFile();"function"==typeof t&&t(i)}}(e,(function(e){if(e){let t=new Image;t.onload=function(){URL.revokeObjectURL(t.src),z({type:"image",width:t.width,height:t.height,canvas:t},null,"default")};let n=window.URL||window.webkitURL;t.src=n.createObjectURL(e)}})):e.clipboardData.items[0]&&e.clipboardData.items[0].getAsString((function(e){if((e=e.trim()).match(/^https?/)){let t=new Image;t.onload=function(){z({type:"image",width:t.width,height:t.height,canvas:t},null,"default")},t.onerror=function(e){console.log("error loading",e)},t.crossOrigin="Anonymous",t.src=e}else if(e.match(/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/)){let t=$.ColorConverter.hexToRGB(e.replace("#",""));L.setColor(t)}})))}),!1));const F={};for(let e in si.brushesUI)if(si.brushesUI.hasOwnProperty(e)){let t=new si.brushesUI[e].Ui({onSizeChange:T,onOpacityChange:function(e){L.emitOpacity(e)},onConfigChange:()=>{L.emitSliderConfig({sizeSlider:si.brushesUI[E].sizeSlider,opacitySlider:si.brushesUI[E].opacitySlider})}});F[e]=t,t.getElement().style.padding="10px"}$.css(u,{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"});let j=new si.StatusOverlay(u);const _=$.el({}),N=$.el({parent:_});_.oncontextmenu=function(){return!1},_.onclick=$.handleClick;let U,X,Y=new si.ToolspaceCollapser({onChange:function(){V()}});function V(){g<820?(Y.getElement().style.display="block",Y.setDirection(h),Y.isOpen()?("left"===h?($.css(Y.getElement(),{left:"271px",right:""}),$.css(O.getElement(),{left:"271px"})):($.css(Y.getElement(),{left:"",right:"271px"}),$.css(O.getElement(),{left:"0"})),_.style.display="block",O.setSize(Math.max(0,g-f),m),j.setWide(!1)):("left"===h?($.css(Y.getElement(),{left:"0",right:""}),$.css(O.getElement(),{left:"0"})):($.css(Y.getElement(),{left:"",right:"0"}),$.css(O.getElement(),{left:"0"})),_.style.display="none",O.setSize(Math.max(0,g),m),j.setWide(!0))):(Y.getElement().style.display="none","left"===h?$.css(O.getElement(),{left:"271px"}):$.css(O.getElement(),{left:"0"}),_.style.display="block",O.setSize(Math.max(0,g-f),m),j.setWide(!1))}function W(){"left"===h?($.css(_,{left:"0",right:"",borderLeft:"none",borderRight:"1px solid rgb(135, 135, 135)"}),$.css(O.getElement(),{left:"271px"})):($.css(_,{left:"",right:"0",borderLeft:"1px solid rgb(135, 135, 135)",borderRight:"none"}),$.css(O.getElement(),{left:"0"})),j.setUiState(h),he.setUiState(""+h),le.setUiState(""+h),V(),Ce.updateUiState(h)}V(),setTimeout((function(){U=new si.OverlayToolspace({enabledTest:function(){return 0===si.dialogCounter.get()&&!A.getIsDrawing()},brushSettingService:L}),u.appendChild(U.getElement())}),0),$.append(u,[O.getElement(),_,Y.getElement()]),$.css(_,{position:"absolute",right:"0",top:"0",bottom:"0",width:"269px",overflow:"hidden",backgroundColor:"#ddd",borderLeft:"1px solid rgb(135, 135, 135)",userSelect:"none",touchAction:"none"}),X=t.embed?new li({onHelp:()=>{Wn(t.embed.url+"/help.html",!!t.embed,u,s())},onSubmit:()=>{si.popup({target:u,message:ce("submit-prompt"),buttons:[ce("submit"),"Cancel"],callback:async e=>{if(e!==ce("submit"))return;let n=$.el({parent:u,className:"upload-overlay",content:'<div class="spinner"></div> '+ce("submit-submitting")});t.embed.onSubmit((()=>{t.saveReminder.reset(),u.removeChild(n)}),(()=>{u.removeChild(n)}))}})},onLeftRight:()=>{h="left"===h?"right":"left",W()}}):new si.ToolspaceTopRow({logoImg:t.logoImg,onLogo:t.onLogo,onNew:function(){pe()},onImport:function(){fe&&fe.triggerImport()},onSave:function(){me.save()},onShare:t.isShare?function(){ge()}:null,onHelp:t.helpPath?function(){Wn(t.helpPath+"/help.html",!!t.embed,u,s())}:null}),$.addClassName(X.getElement(),"toolspace-row-shadow"),X.getElement().style.marginBottom="10px",N.appendChild(X.getElement());let G,K=new si.ToolspaceToolRow({klRootEl:u,onActivate:function(e){if("draw"===e)O.setMode("draw");else if("hand"===e)O.setMode("hand");else if("fill"===e)O.setMode("fill");else if("text"===e)O.setMode("text");else{if("shape"!==e)throw new Error("unknown activeStr");O.setMode("shape")}b.open(e),xe(),G.pickingDone()},onZoomIn:function(){O.zoomByStep(B.isPressed("shift")?.125:.5)},onZoomOut:function(){O.zoomByStep(B.isPressed("shift")?-.125:-.5)},onUndo:function(){ue.undo()},onRedo:function(){ue.redo()}});function Q(e){I=e.context,S.setContext(e.context),he.setLayer(e)}K.setIsSmall(m<540),te.addListener((function(){K.setEnableUndo(te.canUndo()),K.setEnableRedo(te.canRedo())})),$.addClassName(K.getElement(),"toolspace-row-shadow"),N.appendChild(K.getElement()),G=new si.KlColorSlider({width:250,height:30,svHeight:100,startValue:new $.RGB(0,0,0),onPick:function(e){M=e,S.setColor(e),L.emitColor(e),G.pickingDone()},klRootEl:u}),G.setHeight(Math.max(163,Math.min(400,m-505))),G.setPickCallback((function(e){e?O.setMode("pick"):(O.setMode(K.getActive()),xe())}));let q=document.createElement("div"),Z=document.createElement("div");$.css(Z,{margin:"10px",display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"flex-end"});let ee=new si.ToolspaceStabilizerRow({smoothing:1,onSelect:function(e){R.setSmoothing(w(e))}});q.appendChild(Z),$.append(Z,[G.getElement(),G.getOutputElement(),ee.getElement()]);let ne=new si.TabRow({initialId:"penBrush",useAccent:!0,tabArr:function(){let e=[];function t(e){return{id:e,image:si.brushesUI[e].image,title:si.brushesUI[e].tooltip,onOpen:function(){var t;F[e].getElement().style.display="block","eraserBrush"!==(t=e)&&(k=t),G&&("eraserBrush"===t?G.enable(!1):G.enable(!0)),E=t,S=F[t],S.setColor(M),S.setContext(I),O.setMode("draw"),K.setActive("draw"),xe(),G.pickingDone(),L.emitSliderConfig({sizeSlider:si.brushesUI[e].sizeSlider,opacitySlider:si.brushesUI[e].opacitySlider}),T(F[e].getSize()),L.emitOpacity(F[e].getOpacity())},onClose:function(){F[e].getElement().style.display="none"}}}let n=Object.keys(F);for(let i=0;i<n.length;i++)e.push(t(n[i]));return e}()});q.appendChild(ne.getElement());for(let e in si.brushesUI)si.brushesUI.hasOwnProperty(e)&&q.appendChild(F[e].getElement());const ie=new si.HandUi({scale:1,angleDeg:0,onReset:function(){O.resetView(!0),ie.update(O.getScale(),O.getAngleDeg())},onFit:function(){O.fitView(),ie.update(O.getScale(),O.getAngleDeg())},onAngleChange:function(e,t){O.setAngle(e,t),ie.update(O.getScale(),O.getAngleDeg())}});let re=new si.FillUi({colorSlider:G}),ae=new si.TextUi({colorSlider:G}),oe=new si.ShapeUi({colorSlider:G}),se=new si.ShapeTool({onShape:function(e,t,n,i,r,a){let o=x.getLayerIndex(I.canvas),s={type:oe.getShape(),x1:t,y1:n,x2:i,y2:r,angleRad:a,isOutwards:oe.getIsOutwards(),opacity:oe.getOpacity(),isEraser:oe.getIsEraser()};"line"===oe.getShape()?(s.strokeRgb=G.getColor(),s.lineWidth=oe.getLineWidth(),s.isAngleSnap=oe.getIsSnap()||B.isPressed("shift")):(s.isFixedRatio=oe.getIsFixed()||B.isPressed("shift"),"stroke"===oe.getMode()?(s.strokeRgb=G.getColor(),s.lineWidth=oe.getLineWidth()):s.fillRgb=G.getColor()),e?(x.setComposite(o,null),x.drawShape(o,s)):x.setComposite(o,{draw:function(e){si.drawShape(e,s)}}),O.requestFrame()}});const le=si.klLayerManager(x,(function(e){Q(x.getLayer(e)),te.push({tool:["misc"],action:"focusLayer",params:[e]})}),u),he=new si.LayerPreview({klRootEl:u,onClick:function(){b.open("layers")}});he.setIsVisible(m>=579),he.setLayer(x.getLayer(x.getLayerIndex(I.canvas)));const de=new si.FilterTab(this,G,le,Q,O,ie,(()=>M),(()=>l),(()=>x),(()=>I),!!t.embed,j),ue=new si.UndoRedoCatchup(F,he,le,ie,O,(()=>{if(!v)throw new Error("initState not initialized");return v}),(()=>x),(()=>I),(e=>{I=e}),(()=>S));function pe(){si.newImageDialog({klRootEl:u,currentColor:M,secondaryColor:G.getSecondaryRGB(),maxCanvasSize:l,canvasWidth:x.getWidth(),canvasHeight:x.getHeight(),workspaceWidth:s().width<820?g:g-f,workspaceHeight:m,onConfirm:function(e,t,n){o({width:e,height:t,color:1===n.a?n:null})},onCancel:function(){}})}function ge(e){$.shareCanvas({canvas:x.getCompleteCanvas(1),fileName:$.getDate()+c+".png",title:$.getDate()+c+".png",callback:e||function(){}})}te.addListener((e=>{ue.catchup(e)}));const me=new si.SaveToComputer("function"==typeof t.customSave?(e,n)=>{si.popup({target:u,message:ce("submit-prompt"),buttons:[ce("submit"),"Cancel"],callback:async i=>{if(i!==ce("submit"))return;let r=$.el({parent:u,className:"upload-overlay",content:'<div class="spinner"></div> '+ce("submit-submitting")});t.customSave(e,n,(()=>{t.saveReminder.reset(),u.removeChild(r)}),(()=>{u.removeChild(r)}))}})}:null,t.saveReminder,u,(()=>y),(()=>x),c),fe=t.embed?null:new si.FileTab(u,d,(()=>x.getProject()),y,(e=>{y=e}),H,(()=>{me.save()}),pe,t.isShare?ge:null,(()=>{si.imgurUpload(x,u,t.saveReminder,t.app&&t.app.imgurKey?t.app.imgurKey:null)}),be,t.saveReminder),ye=new si.SettingsTab((()=>{h="left"===h?"right":"left",W(),t.embed||J.setItem("uiState",h)}),t.aboutEl,u);function xe(){if(!b)return;let e=K.getActive(),t=b.getOpenedTabId(),n=Object.keys({draw:{},hand:{},fill:{},text:{},shape:{}});for(let i=0;i<n.length;i++)e===n[i]?b.setIsVisible(n[i],!0):(b.setIsVisible(n[i],!1),t===n[i]&&b.open(e))}function be(e){si.clipboardDialog(u,s(),x.getCompleteCanvas(1),(function(e){if(0===e.left&&0===e.right&&0===e.top&&0===e.bottom)return;let t={context:I,canvas:x,input:e,history:te};si.filterLib.cropExtend.apply(t),le.update(),O.resetView(),ie.update(O.getScale(),O.getAngleDeg())}),j,e)}b=new si.TabRow({initialId:"draw",tabArr:[{id:"draw",title:ce("tool-brush"),image:n(mt),onOpen:function(){"eraserBrush"===E&&G.enable(!1),$.append(Z,[G.getElement(),G.getOutputElement(),ee.getElement()]),q.style.display="block"},onClose:function(){q.style.display="none"},css:{minWidth:"45px"}},{id:"hand",title:ce("tool-hand"),image:n(wt),isVisible:!1,onOpen:function(){ie.setIsVisible(!0)},onClose:function(){ie.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"fill",title:ce("tool-paint-bucket"),image:n(ft),isVisible:!1,onOpen:function(){G.enable(!0),re.setIsVisible(!0)},onClose:function(){re.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"text",title:ce("tool-text"),image:n(yt),isVisible:!1,onOpen:function(){G.enable(!0),ae.setIsVisible(!0)},onClose:function(){ae.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"shape",title:ce("tool-shape"),image:n(xt),isVisible:!1,onOpen:function(){G.enable(!0),oe.setIsVisible(!0)},onClose:function(){oe.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"layers",title:ce("tab-layers"),image:n(Di),onOpen:function(){le.update(),le.style.display="block"},onClose:function(){le.style.display="none"},css:{minWidth:"45px"}},{id:"edit",title:ce("tab-edit"),image:n(Ri),onOpen:function(){de.show()},onClose:function(){de.hide()},css:{minWidth:"45px"}},{id:"file",title:ce("tab-file"),image:n(Ai),isVisible:!t.hideFile&&!!fe,onOpen:function(){fe&&(fe.getElement().style.display="block",fe.setIsVisible(!0))},onClose:function(){fe&&(fe.getElement().style.display="none",fe.setIsVisible(!1))},css:{minWidth:"45px"}},{id:"settings",title:ce("tab-settings"),image:n(Pi),onOpen:function(){ye.getElement().style.display="block"},onClose:function(){ye.getElement().style.display="none"},css:{minWidth:"45px"}}]});const ve=$.el({css:{width:"270px",position:"absolute",bottom:"0",left:"0"}});if(t.bottomBar){ve.append(t.bottomBar);new MutationObserver((()=>we())).observe(N,{attributes:!0,childList:!0,subtree:!0})}function we(){if(!t.bottomBar)return;const e=s(),n=617<e.height&&N.scrollHeight+50<e.height;ve.style.display=n?"":"none"}$.append(N,[he.getElement(),b.getElement(),q,ie.getElement(),re.getElement(),ae.getElement(),oe.getElement(),le,de.getElement(),fe?fe.getElement():null,ye.getElement(),$.el({css:{height:"10px"}}),ve||null]);const Ce=new si.ToolspaceScroller({toolspace:_,uiState:h});this.importImage=e=>{if(e.content){window.URL=window.URL||window.webkitURL;let t=window.URL.createObjectURL(e.content),n=new Image;n.src=t,$.loadImage(n,(function(){z({type:"image",width:n.width,height:n.height,canvas:n},e.name||"","image")}))}else o({width:e.width||x.getWidth(),height:e.height||x.getHeight(),color:e.color||{r:255,g:255,b:255,a:1},layerName:e.name})},this.getBBox=s,this.getEl=()=>u,this.resize=(e,t)=>{window.scrollY>0&&window.scrollTo(0,0),g===Math.max(0,e)&&m===Math.max(0,t)||(g=Math.max(0,e),m=Math.max(0,t),V(),we(),he.setIsVisible(m>=579),G.setHeight(Math.max(163,Math.min(400,m-505))),K.setIsSmall(m<540))},this.out=e=>{j.out(e)},this.getPNG=function(){return Kn(x.getCompleteCanvas(1).toDataURL("image/png"))},this.getPSD=async function(){return await async function(e){let t=e.getLayersFast(),n={width:e.getWidth(),height:e.getHeight(),children:[]};for(let e=0;e<t.length;e++){let i=t[e];n.children.push({name:i.name,opacity:i.opacity,canvas:i.canvas,blendMode:si.PSD.blendKlToPsd(i.mixModeStr),left:0,top:0})}let i=(await a("krCjW")).writePsdBuffer(n);return new Blob([i],{type:"application/octet-stream"})}(x)},this.getProject=()=>x.getProject(),this.swapUiLeftRight=()=>{h="left"===h?"right":"left",t.embed||J.setItem("uiState",h),W()},this.saveAsPsd=()=>{me.save("psd")},this.isDrawing=()=>A.getIsDrawing()||O.getIsDrawing(),this.resize(g,m),W();{$.addEventListener(window,"resize",(()=>{const e=s();this.resize(e.width,e.height)})),$.addEventListener(window,"orientationchange",(()=>{const e=s();this.resize(e.width,e.height)}));const e=$.el({parent:i||document.body,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",pointerEvents:"none",zIndex:"-1",userSelect:"none"}});try{new ResizeObserver((()=>{const e=s();this.resize(e.width,e.height)})).observe(e)}catch(t){e.parentNode.removeChild(e)}$.addEventListener(this.getEl(),"wheel",(e=>{e.preventDefault()}));const t=e=>{e.preventDefault()};window.addEventListener("gesturestart",t),window.addEventListener("gesturechange",t),window.addEventListener("gestureend",t)}}function zi(e){let t=document.body;try{t=document.getElementById("loading-screen").parentNode}catch(e){}let n=document.createElement("div");n.style.textAlign="center",n.style.background="#fff",n.style.padding="20px",n.innerHTML="<h1>App failed to initialize</h1>",n.innerHTML+="Error: "+(e.message?e.message:""+e),t.append(n),console.error(e)}Di=a("ecdQ7").getBundleURL("86cou")+a("budCC").resolve("lJ2Hv"),hn.isLoaded||(Ti=Oi,Li(cn.glBrightnessContrast,ui),Li(cn.cropExtend,pi),Li(cn.glCurves,gi),Li(cn.flip,fi),Li(cn.glHueSaturation,yi),Li(cn.invert,xi),Li(cn.glPerspective,bi),Li(cn.resize,wi),Li(cn.rotate,Ci),Li(cn.glTiltShift,Si),Li(cn.transform,Ei),Li(cn.glBlur,Mi),Li(cn.glUnsharpMask,ki),Li(cn.toAlpha,Ii),hn.isLoaded=!0),(async()=>{let e,t=!1;try{$.addEventListener(window,"DOMContentLoaded",(()=>{t=!0})),await he.setLanguage(le)}catch(e){return void zi(e)}async function n(){try{$.removeEventListener(window,"DOMContentLoaded",n);let t=new si.ProjectStore,i=null;try{const e=await t.read();e&&(i=e.project)}catch(t){let n;n=0===t.message.indexOf("db-error")?"Failed to access Browser Storage":(t.message.indexOf("format-error"),"Failed to restore from Browser Storage"),setTimeout((function(){throw e&&e.out(n),new Error("Initial browser storage error, "+t)}),100)}!function(t,n){if(e)throw"onKlProjectObjLoaded called more than once";let i=document.body,r=document.getElementById("loading-screen");try{i=r.parentNode,i.removeChild(r)}catch(e){}const a=(i.currentStyle||window.getComputedStyle(i)).position;"relative"!==a&&"fixed"!==a&&"absolute"!==a&&(i.style.position="relative");const o=new si.SaveReminder(te,!1,!0,(()=>e?e.saveAsPsd():null),(()=>!!e&&e.isDrawing()),n,(()=>t),(()=>e?e.getEl():i),(()=>e?e.getBBox():{}));e=new Bi(t,{saveReminder:o,projectStore:n,onLogo:()=>{},hideFile:!1,isShare:!0,helpPath:"."},i),o.init(),t&&setTimeout((()=>{e.out(ce("file-storage-restored"))}),100),i.appendChild(e.getEl())}(i,t)}catch(e){zi(e)}}t?n():$.addEventListener(window,"DOMContentLoaded",n)})();